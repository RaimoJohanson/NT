{"version":3,"sources":["static/assets/images/logo-est.png","static/assets/tara/tara-logo-et.png","logo.svg","process/Base.tsx","postMessage.tsx","i18n.ts","components/LogRows.tsx","components/MessageLog.tsx","components/Process.tsx","byNameStore.tsx","components/Arena.tsx","components/SendButton.tsx","process/Counter.tsx","components/Popup.tsx","components/Client.tsx","process/TokenRing.tsx","process/client/types.tsx","process/consentService/types.tsx","util.tsx","process/consentService/declarationAPI.tsx","process/consentService/ui.tsx","process/consentService/referenceAPI.tsx","process/serviceProvider/types.tsx","process/consentService/validationAPI.tsx","process/consentService/reportingAPI.tsx","process/serviceProvider/messages.tsx","process/client/messages.tsx","process/client/EnduserUI.tsx","process/client/views.tsx","process/client/constructor.tsx","process/consentService/constructor.tsx","process/consentService/views.tsx","process/serviceProvider/views.tsx","process/serviceProvider/constructor.tsx","config.tsx","components/Theatre.tsx","process/consentService/altUI/backendAPI.tsx","components/veera/footer.tsx","components/veera/header.tsx","components/veera/layout.tsx","components/tabs/Tab.tsx","components/tabs/Tabs.tsx","process/consentService/altUI/ConsentModal.tsx","process/consentService/altUI/MyConsents.tsx","process/consentService/altUI/ConsentHistory.tsx","process/consentService/altUI/CSEnduserUI.tsx","process/consentService/altUI/ria.tsx","App.tsx","serviceWorker.ts","store.tsx","index.tsx","static/assets/images/user-icon.svg","static/assets/images/login.svg"],"names":["module","exports","MESSAGE","handlers","addHandlerClass","impl","c","handler","type","undefined","addHandler","name","p","a","handle","obj","values","createMessage","message","arena","sender","receivers","length","GenericMessageHandler","this","process","action","mem","updateMem","queue","concat","payload","send","error","extra","withResponse","response","uiMap","addUi","url","defaultRender","JSON","stringify","renderers","addRenderer","view","renderer","updateDb","newdb","db","STATE_UPDATE","INITIALIZED","StateUpdateMessage","statusUpdateChannel","StateUpdater","store","ui","_cachedState","_storeUnsubscriber","_messageListener","_channel","URL","window","location","href","open","Math","random","subscribe","stateChanged","processMessage","addEventListener","removeEventListener","state","ps","theatre","arenas","byName","selectProcess","getState","postMessage","origin","e","console","unregisterListeners","msg","data","dispatch","registeredUpdaters","BackendStateUpdater","setter","caster","log","ev","receiveNewState","newState","withUpdater","target","opener","channelId","Object","assign","setState","BackendAPI","updater","m","split","i18n","use","Backend","LanguageDetector","initReactI18next","init","fallbackLng","debug","backend","loadPath","pathname","includes","interpolation","escapeValue","__","props","labels","suffix","join","proc","t","map","pref","styleNameFor","fullname","id","prop","replace","person","business","formatProcess","className","formatLogtime","epochSeconds","Date","toLocaleString","formatHeader","owner","showPopup","onClick","now","names","r","i","formatBody","max","key","value","substring","defaultRenderer","LogRow","findLogRenderer","addLogRenderers","keys","forEach","addLogRenderer","LogView","ref","React","filterFn","showSelf","current","scroll","scrollHeight","index","_this","show","onHide","closePopup","size","Body","Footer","Button","variant","logLines","rows","filter","slice","maxRows","popup","line","formatLogLine","MessageLog","connect","ownProps","selectArena","LogButton","Header","Title","ModalFooter","children","render","findRenderer","ProcessUI","visible","setVisible","UILink","button","useStore","launch","push","registerListeners","launchUI","el","addByName","old","allNames","n","reduceByName","reducer","k","fromArray","reduce","MESSAGE_DELAY","createProcess","reduceProcesses","CREATE_PROCESS","FLUSH_QUEUE","reduceArena","reduceMessage","fixNowAndRandom","queueListener","queued","flat","d","getQueued","setTimeout","delayedSender","shift","Arena","useTranslation","processes","role","parseOrRaw","s","startsWith","parse","f","Array","from","elements","u","out","options","selected","checked","o","Send","preventDefault","messageToAction","currentTarget","form","handleClick","title","text","SimpleSend","Counter","CounterDefaultView","IncrementMessageHandler","DecrementMessageHandler","incrementMessage","decrementMessage","Popup","LOGIN","alt","src","require","ClientView","loading","changeView","aria-hidden","width","TokenNode","WithToken","WithoutToken","createTokenNode","next","token","initPassMessage","node","tokenMessage","updateNextMessage","SetTargetPopup","setShow","handleClose","handleShow","closeButton","htmlFor","readOnly","multiple","defaultValue","bsPrefix","Client","ClientIS","ClientDefaultView","ConsentService","ConsentServiceDefaultView","findFrom","items","example","find","hash","input","createHash","update","digest","address2org","address","match","renderText","stack","last","indent","l","prefix","pop","ul","addServiceDeclaration","cs","sd","serviceDeclarations","decl","serviceProviderId","serviceDeclarationId","withErrorResponse","withOkResponse","addPurposeDeclaration","pd","purposeDeclarations","clientId","purposeDeclarationId","services","sdRef","loginMessage","user","giveConsentMessage","con","consents","newConsent","dataSubject","revoked","updatedCS","addConsent","activeUser","activePurposeDeclaration","updatedCS2","setActivePD","callbackURL","fetchConsentReference","revokeConsentMessage","consentReference","validUntil","revokeAt","revokeIfReferenceEquals","revokeConsent","updateAPDforUser","refs","activatePurposeDeclarationMessage","ConsentReferenceResponseTypeName","fixRevoked","getConsentReference","req","_cs","consent","subjectId","ServiceProviderIS","ServiceProviderDefaultView","requestTypeName","responseTypeName","ValidationResponseTypeName","NotValidResponse","asyncId","valid","validateConsentReference","notValid","validFrom","purposeDeclaration","consentExpiration","toISOString","dataSubjectId","reportServiceUse","usageLog","addUsageRecord","addData","spis","datatype","rec","dbrec","subject","declareService","consentService","requestId","service","requestReference","serviceName","submitRequest","_send","report","result","serviceDeclarationIds","requiredServiceDeclarationIds","usageTime","reqState","validationRequestId","clientAddress","withInfligh","inflight","partyId","ifr","resp","removeInflight","usageReport","submitResponse","records","x","returnedDatatypes","selectServiceMessage","cachedConsentRefs","consentRefByUser","cachedConsentRef","consentServiceId","declarePurpose","cis","updateCSRef","csByUser","executeRequest","userConsentRefs","purposeId","conf","config","serviceAddress","_cis","newResponses","requestReferenceId","__cis","generateRequestReference","updateConsentRefInCache","validateConsentRef","SELECT_SERVICE","WAIT_FOR_CONSENT_REF","CONSENT_NOT_FOUND","SERVICE_V1","currentView","ClientView_","sendMessagesFor","withMessages","componentDidUpdate","actualView","returnButton","dangerouslySetInnerHTML","__html","EnduserUI","DeclarePurposePopup","sp","setOpts","useState","sdrefs","setSDRefs","declTemplate","onChange","decls","declId","description","prefillPurposeDeclaration","dt","sdref","placeholder","opts","spId","_spId","sdId","_sdId","addSDRef","hasUser","purpose","consentRef","consentRefDesc","dropdownToggle","forwardRef","updateConsentRefDropdown","style","Dropdown","Toggle","as","Menu","purposeView","updateMaxDuration","v","declarationPrefill","technicalDescription","needSignature","md","consentMaxDurationSeconds","prefillServiceDeclaration","DeclareServicePopup","allValues","sort","CS1Address","defaultArena","createServiceProvider","createData","diagnoos","arst","uuring","vastus","haigus","preparaat","seeria","jrk","uuesti","createConsentService","logRenderers","createCounter","initialTheatre","createArena","active","SELECT_ARENA","_Theatre","PureComponent","Theatre","ConsentServiceBackend","post","getValidUntil","floor","getConsents","ur","candidate","expiresIn","getServiceDeclaration","Number","CSBackend","createContext","ctx","useContext","rel","backendUse","login","VeeraLayout","Tab","label","activeTab","cursor","Component","Tabs","onClickTabItem","tab","child","ConsentModal","buttonText","dec","rowView","formatTimestamp","isConsentActive","handleRevoke","MyConsents","Table","header","consentDescription","ConsentHistory","getUsageLogRecords","usageRecordDescription","Modal","ActivePurposeDeclaration","signPopup","returnPopup","showConsentTab","bind","savedClientId","tabRef","toggleSignPopup","giveConsentByPurpose","activeDecl","showReturnPopup","close","ReturnScreen","Popover","MainView","getActivePurposeDeclaration","CSEnduserUI","context","backendLink","csb","createRef","document","body","classList","add","resetState","Provider","timestamp","withTime","Intl","DateTimeFormat","year","month","day","hour","minute","second","format","Ria","aria-label","data-tab","click","version","xmlns","viewBox","Page","changeLanguage","lng","basename","path","language","Loader","App","fallback","Boolean","hostname","rootReducer","combineReducers","middlewares","thunkMiddleware","middleWareEnhancer","applyMiddleware","createStore","composeWithDevTools","su","source","registerGlobalListener","configureStore","ReactDOM","getElementById","navigator","serviceWorker","ready","then","registration","unregister"],"mappings":"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","file":"static/js/main.a2efc993.chunk.js","sourcesContent":["module.exports = __webpack_public_path__ + \"static/media/logo-est.bca08fff.png\";","module.exports = __webpack_public_path__ + \"static/media/tara-logo-et.5947b56d.png\";","module.exports = __webpack_public_path__ + \"static/media/logo.25bf045c.svg\";","import { AnyAction } from 'redux';\n\nexport type InstanceName = string;\nexport type ProcessImplName = string;\nexport type ViewName = string;\n\n// state\n\nexport interface ProcessState<S> {\n\tname: string; // instantsi nimi\n\ttitle: string;\n\ttype: ProcessImplName; // implementatsiooni nimi?\n\tview: ViewName; // \"olek\", tegelikult defineerib vaate\n\tmem: S; // sisuline olek\n\tqueue: Message<any>[]; // outbound queue, reduceritest kasutamiseks?\n}\n\n// sõnumi-action\n\nexport const MESSAGE = \"Process/SEND_MESSAGE\";\n\nexport interface Message<PL extends Payload> extends AnyAction {\n\ttype: typeof MESSAGE;\n\tarena: string;\n\tsender: string;\n\treceivers: string[];\n\tmessage: PL;\n\tnow?: number;\n\trandom?: string;\n}\n\nexport interface Payload {\n\ttype: string;\n}\n\nexport interface ErrorPayload extends Payload {\n\ttype: \"error\";\n\terror: string;\n}\n\nexport interface OKPayload extends Payload {\n\ttype: \"ack\"\n\tresponse: \"OK\";\n}\n\nexport type MessageHandler<S, M extends Payload> = (process: ProcessState<S>, action: Message<M>) => ProcessState<S>;\n\nconst handlers : { [impl: string] : { [type: string]: MessageHandler<any, any> } } = {};\n\nexport function addHandler<P extends Payload>(impl: ProcessImplName, type: string, handler: MessageHandler<any, P>) {\n\tif (handlers[impl] === undefined) {\n\t\thandlers[impl] = {};\n\t}\n\n\thandlers[impl][type] = handler;\n}\n\nexport function addHandlerClass<P extends Payload, T extends GenericMessageHandler<any, ProcessState<any>, P, T>>(impl: ProcessImplName, c: { new(): T }) {\n\tlet handler = new c();\n\taddHandler<P>(impl, handler.name, (p, a) => handler.handle(p, a));\n\treturn (obj?: Partial<P>) => ( (values?: Partial<P>) => handler.createMessage({...(values === undefined ? {} : values), ...(obj === undefined ? {} : obj)}) );\n}\n\nexport function reduceMessage<T>(process: ProcessState<T>, action: Message<Payload>): ProcessState<T> {\n\t//\tconsole.log(`reduceMessage ${JSON.stringify(process)}, ${JSON.stringify(action)}`);\n\tif (action.type !== MESSAGE || !action.receivers.includes(process.name)) {\n\t\treturn process;\n\t}\n\n\tif (handlers[process.type] === undefined) {\n\t\tconsole.error(`No handler for ${process.name} (${process.type})`);\n\t\treturn process;\n\t}\n\n\tif (handlers[process.type][action.message.type] === undefined) {\n\t\tconsole.error(`No handler for ${process.name} (${process.type}) for message ${action.message.type} (${JSON.stringify(action.message)})`);\n\t\treturn process;\n\t}\n\n\treturn handlers[process.type][action.message.type](process, action);\n}\n\nexport function message<M extends Payload>(arena: string, sender: ProcessState<any>, receivers: string[], message: M): Message<M> {\n\treturn { \n\t\ttype: MESSAGE,\n\t\tarena: arena,\n\t\tsender: sender.name, \n\t\treceivers: receivers.length === 0 ? [sender.name] : receivers,\n\t\tmessage: message\n\t};\n}\n\nexport abstract class GenericMessageHandler<S, PS extends ProcessState<S>, M extends Payload, GMH extends GenericMessageHandler<S, PS, M, GMH>> {\n\tabstract name: string;\n\n\tcreateMessage(obj: any): (M & { type: GMH[\"name\"] }) { return { ...obj, type: this.name }; };\n\thandle(process: PS, action: Message<M>): PS { return { ...process, mem: this.updateMem(process.mem, action) }; };\n\tupdateMem(mem: S, action: Message<M>): S { return mem; };\n\n\tsend<NM extends Payload>(process: PS, message: Message<NM>): PS {\n\t\treturn { ...process, queue: process.queue.concat(message) };\n\t}\n\n\twithResponse<NM extends Payload>(process: PS, action: Message<M>, payload: NM): PS {\n\t\treturn this.send(process, message<NM>(action.arena, process, [action.sender], payload));\n\t}\n\n\twithErrorResponse(process: PS, action: Message<M>, error: string, extra?: any) {\n\t\treturn this.withResponse<ErrorPayload>(process, action, { type: \"error\", error: error, ...extra });\n\t}\n\n\twithOkResponse(process: PS, action: Message<M>) {\n\t\treturn this.withResponse<OKPayload>(process, action, { type: \"ack\", response: \"OK\"});\n\t}\n\t\n}\n\n\n// UId\nexport const uiMap : { [type: string /* ProcessImplName */]: string /* URL */ } = {};\n\nexport function addUi(impl: ProcessImplName, url: string) {\n\tuiMap[impl] = url;\n}\n\n// renderdus\n\nexport interface ProcessAndArena<S> {\n\tprocess: ProcessState<S>;\n\tarena: string;\n}\n\nexport type ProcessRenderer<S> = React.FC<ProcessAndArena<S>> | ((props: ProcessAndArena<S>) => string);\n\nconst defaultRender: ProcessRenderer<any> = ({process} : ProcessAndArena<any>) => JSON.stringify(process.mem);\n\nconst renderers : { [impl: string /* ProcessImplName */]: { [view: string /* ViewName */]: ProcessRenderer<any> } } = {};\n\nexport function addRenderer(impl: ProcessImplName, view: ViewName, renderer: ProcessRenderer<any>) {\n\tif (renderers[impl] === undefined) {\n\t\trenderers[impl] = {};\n\t}\n\n\trenderers[impl][view] = renderer;\n}\n\nexport function findRenderer<S>(process: ProcessState<S>): ProcessRenderer<S> {\n\tif (renderers[process.type] === undefined) {\n\t\tconsole.error(`No renderer for ${process.type}`);\n\t\treturn defaultRender;\n\t}\n\n\tif (renderers[process.type][process.view] === undefined) {\n\t\tconsole.error(`No renderer for ${process.type} and view ${process.view}`);\n\t\treturn defaultRender;\n\t}\n\n\treturn renderers[process.type][process.view];\n}\n\nexport function updateMem<S>(process: ProcessState<S>, mem: Partial<S>): ProcessState<S> {\n\treturn { ...process, mem: { ...process.mem, ...mem }};\n}\n\nexport function updateDb<T, S extends ({ db: T; })>(process: ProcessState<S>, newdb: Partial<T>): ProcessState<S> {\n\treturn updateMem<S>(process, { db: { ...process.mem.db, ...newdb} } as Partial<S>);\n}","import { Store } from 'redux';\nimport { InstanceName, ViewName, MESSAGE, Message, Payload } from './process/Base';\nimport { AppState } from './store';\n\nexport const STATE_UPDATE = \"STATE_UPDATE\";\nexport const INITIALIZED = \"INITIALIZED\";\n\ntype MessagingTarget = Window | ServiceWorker | null;\n\nexport class StateUpdateMessage<P> {\n    type!: typeof STATE_UPDATE;\n    view!: ViewName;\n    mem?: P;\n    statusUpdateChannel?: number;\n}\n\nfunction selectProcess(state: AppState, arena: string, process: InstanceName): StateUpdateMessage<any> {\n    let ps = state.theatre.arenas.byName[arena].process.byName[process];\n    if (ps === undefined) {\n        // no such process?\n        return { type: STATE_UPDATE, view: \"\" };\n    }\n    return { type: STATE_UPDATE, view: ps.view, mem: ps.mem}\n}\n\nclass StateUpdater {\n    arena: string;\n    process: InstanceName;\n    store: Store;\n    url: URL;\n    ui: MessagingTarget;\n\n    _cachedState: any;\n    _storeUnsubscriber: any = null;\n    _messageListener: ((message: MessageEvent) => any) | null = null;\n    _channel: number;\n\n    constructor(arena: string, process: InstanceName, store: Store, url: string, ui?: MessagingTarget) {\n        this.arena = arena;\n        this.process = process;\n        this.store = store;\n        this.url = new URL(url, window.location.href);\n        if (ui === undefined) {\n            this.ui = window.open(url, `${arena} - ${process}`);\n        } else {\n            this.ui = ui;\n        }\n        this._channel = Math.random();\n    }\n\n    registerListeners() {\n        this._storeUnsubscriber = this.store.subscribe(() => { this.stateChanged(); })\n        this._messageListener = (message) => { this.processMessage(message); };\n        window.addEventListener(\"message\", this._messageListener);\n        return this;\n    }\n\n    unregisterListeners() {\n        this._storeUnsubscriber();\n        this._storeUnsubscriber = null;\n\n        if (this._messageListener !== null) {\n            window.removeEventListener(\"message\", this._messageListener);\n            this._messageListener = null;\n        }\n\n        return this;\n    }\n\n    stateChanged() {\n        let state = selectProcess(this.store.getState(), this.arena, this.process);\n        if (state !== this._cachedState) {\n            // postMessage originiga, mis ei ole \"*\" ei tööta ffga?\n            // https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage#Example lõpp\n            try { \n            this.ui!.postMessage({...state, statusUpdateChannel: this._channel}, this.url.origin);\n            } catch (e) {\n                console.error(\"Error posting message, stopping\", e);\n                this.unregisterListeners();\n            }\n            this._cachedState = state;\n        }\n        return this;\n    }\n\n    processMessage(msg: MessageEvent): void {\n        switch (msg.data.type) {\n            case INITIALIZED:\n                this._cachedState = undefined; // force state update\n                this.stateChanged();\n                return;\n\n            default:\n                if (msg.data.statusUpdateChannel !== this._channel) {\n                    // not for us. \n                    return;\n                }\n\n                // only messages to self.\n                this.store.dispatch({ \n                    type: MESSAGE, \n                    arena: this.arena,\n                    sender: this.process,\n                    receivers: [this.process],\n                    message: { ...msg.data, statusUpdateChannel: undefined },\n                } as Message<Payload>);\n        }\n    }\n}\n\nconst registeredUpdaters : StateUpdater[] = [];\n\nexport function registerGlobalListener(store: Store) {\n    window.addEventListener(\"message\", ev => {\n        if (ev.data.type === INITIALIZED) {\n            let [arena, process] = ev.data.target.split(' - ');\n            let url = ev.data.url;\n            if (registeredUpdaters.find(su => su.arena === arena && su.process === process && su.ui === ev.source) === undefined) {\n                console.log(\"Unregistered childwindow, registering: \", ev.data);\n                registeredUpdaters.push(\n                    new StateUpdater(arena, process, store, url, ev.source as Window)\n                    .registerListeners()\n                    .stateChanged()\n                );\n                ev.preventDefault();\n            }\n        }\n    });\n}\n\nexport function launchUI(arena: string, process: InstanceName, url: string, store: Store) {\n    registeredUpdaters.push(new StateUpdater(arena, process, store, url).registerListeners());\n}\n\n\nexport class BackendStateUpdater<S, C extends BackendAPI<S>> {\n    state!: StateUpdateMessage<S>;\n\n    setter: (newState: BackendAPI<S>) => void;\n    caster: { new(s: StateUpdateMessage<S>): C };\n\n    constructor(setter: (newState: BackendAPI<S>) => void, caster: { new(s: StateUpdateMessage<S>): C }) {\n        this.setter = setter;\n        this.caster = caster;\n        console.log(\"setting listener\");\n        window.addEventListener(\"message\", (ev) => { this.receiveNewState(ev); });\n    }\n\n    setState(newState: StateUpdateMessage<S>) {\n        console.log(\"updating state:\", newState);\n        this.state = newState;\n        this.setter(new this.caster(newState).withUpdater(this));\n    }\n\n    resetState() {\n        this.postMessage(INITIALIZED, { target: window.name, url: window.location.href });\n    }\n\n    postMessage(type: string, message?: any) {\n        if (window.opener === null) {\n            this.setState({ type: STATE_UPDATE, view: \"\", mem: { \"error\": \"NO OPENER WINDOW\"}} as any);\n            return;          \n        }\n\n        const channelId = this.state !== undefined ? { statusUpdateChannel: this.state.statusUpdateChannel } : {};\n\n        let msg = Object.assign({}, (message === undefined ? {} : message), { type }, channelId);\n        console.log(\"posting message:\", msg);\n        window.opener.postMessage(msg);\n    }\n\n    receiveNewState(ev: MessageEvent) {\n        if (ev.data.type === STATE_UPDATE) {\n            this.setState(ev.data);\n        }\n    }\n}\n\nexport class BackendAPI<S> extends StateUpdateMessage<S> {\n    updater!: BackendStateUpdater<S, BackendAPI<S>>;\n\n    constructor(msg?: StateUpdateMessage<S>) {\n        super();\n        Object.assign(this, msg);\n    }\n\n    withUpdater(updater: BackendStateUpdater<S, BackendAPI<S>>) {\n        this.updater = updater;\n        return this;\n    }\n\n    post(msg: () => Payload) {\n        let m = msg();\n        this.updater.postMessage(m.type, m);\n    }  \n\n\n    arena(): string {\n        return window.name.split(\" - \")[0];\n    }\n}\n","import i18n from 'i18next';\nimport Backend from 'i18next-xhr-backend';\nimport LanguageDetector from 'i18next-browser-languagedetector';\nimport { initReactI18next } from 'react-i18next';\nimport { ProcessAndArena, ProcessState } from './process/Base';\n\ni18n\n  // load translation using xhr -> see /public/locales\n  // learn more: https://github.com/i18next/i18next-xhr-backend\n  .use(Backend)\n  // detect user language\n  // learn more: https://github.com/i18next/i18next-browser-languageDetector\n  .use(LanguageDetector)\n  // pass the i18n instance to react-i18next.\n  .use(initReactI18next)\n  // init i18next\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    fallbackLng: 'et',\n    debug: process.env.NODE_ENV !== \"production\",\n    backend: {\n      loadPath: (window.location.pathname.includes(\"/ui/\") ? \"../../\" : \"\") + 'locales/{{lng}}/{{ns}}.json'\n    },\n    \n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n  });\n\nexport default i18n;\n\nexport function _(...labels: string[]): string {\n  return i18n.t(labels.join(\".\"));\n}\n\nexport function __(props: ProcessAndArena<any>, ...labels: string[]): string {\n  const suffix = labels.join(\".\");\n  const arena = props.arena;\n  const proc = props.process.name;\n  const impl = props.process.type;\n  return i18n.t([\n    [ arena, proc ],\n    [ arena, impl ],\n    [ impl ],\n    []\n  ].map(pref => pref.concat(suffix).join(\".\")));\n}\n\nexport function styleNameFor(arena: string, name: string, type?: string): string {\n  return __({ arena: arena, process: { name: name, type: type! } as ProcessState<any> }, \"stylename\");\n}\n\nexport function person(id: string, prop: string): string {\n  return i18n.t([`person.${id}.${prop}`, `person.default.${prop}`]).replace(\"ISIKUKOOD\", id);\n}\n\nexport function fullname(id: string): string {\n  return person(id, \"name\");\n}\n\nexport function business(id: string, prop: string): string {\n  return i18n.t(`business.${id}.${prop}`);\n}\n","import { Message, ProcessState, Payload } from \"../process/Base\";\nimport React from \"react\";\nimport { styleNameFor } from \"../i18n\";\n\n\nexport function receivers(receivers: string[]) {\n    return receivers.length === 1 ? receivers[0] : `(${receivers.join(\", \")})`;\n}\n\nfunction formatProcess(arena: string, name: string) {\n    return (<span className={`msg-${ styleNameFor(arena, name) }`}>\n        { name }\n    </span>)\n}\n\nfunction formatProcessList(arena: string, names: string[]) {\n    if (names.length === 1) {\n        return formatProcess(arena, names[0]);\n    } else {\n        return (<>({ names.map(\n            (r, i) => (\n                <>{ i === 0 ? \", \" : undefined }{ formatProcess(arena, r) }</>\n            )\n        ) })</>)\n    }\n}\n\nexport function formatLogtime(epochSeconds: number): string {\n    // locale. Swedes got it right. As did Lithuanians and few other countries. YYYY-MM-DD dates.\n    return new Date(epochSeconds * 1000).toLocaleString(\"se\");\n}\n\nfunction formatHeader(msg: Message<Payload>, owner: ProcessState<any> | undefined, showPopup: ShowPopup) {\n\treturn (<>\n            <span onClick={ ev => showPopup(msg) }>\n                <span className=\"btn-link\">{ formatLogtime(msg.now!) }</span>\n                &nbsp;\n                { formatProcess(msg.arena, msg.sender) }\n                <span> » </span>\n                { formatProcessList(msg.arena, msg.receivers) }\n            </span>\n            </>\n        );\n}\n\nfunction cutJson(max: number) {\n    return (key: string, value: any) => (\n        typeof value !== \"string\" \n            ? value \n            : (value.length > max ? value.substring(0, max) + \"...\" : value)\n        );\n}\n\nfunction formatBody<M extends Payload>(msg: M) {\n\treturn `${msg.type}: ${JSON.stringify({ ...msg, type: undefined, statusUpdateChannel: undefined }, cutJson(40), \"  \")}`;\n}\n\nfunction defaultRenderer(msg: Message<any>, owner: ProcessState<any> | undefined, showPopup: ShowPopup) {\n    return (<>{formatHeader(msg, owner, showPopup)}:<br/>{formatBody(msg.message)}</>);\n}\n\ntype ShowPopup = (m: Message<any>) => void;\n\nexport function LogRow(arena: string, i: number, msg: Message<any>, owner: (ProcessState<any> | undefined), showPopup: ShowPopup) {\n    return (<span>{ findLogRenderer(msg)(msg, owner, showPopup) }</span>);\n}\n\nexport type LogRenderer = (msg: Message<any>, owner: ProcessState<any> | undefined, showPopup: ShowPopup ) => any;\nconst renderers : { [arena: string]: { [type: string]: LogRenderer } } = {};\n\nfunction findLogRenderer(msg: Message<any>): LogRenderer {\n    if (renderers[msg.arena] === undefined) {\n        return defaultRenderer;\n    }\n\n    if (renderers[msg.arena][msg.message.type] === undefined) {\n        return defaultRenderer;\n    }\n\n    return renderers[msg.arena][msg.message.type];\n}\n\nexport function addLogRenderer(arena: string, type: string, renderer: LogRenderer) {\n    if (renderers[arena] === undefined) {\n        renderers[arena] = {};\n    }\n\n    renderers[arena][type] = renderer;\n}\n\nexport type LogRendererMap = { [type: string]: LogRenderer };\n\nexport function addLogRenderers(arena: string, r: LogRendererMap) {\n    Object.keys(r).forEach(type => addLogRenderer(arena, type, r[type]))\n}\n\n////////////////////////\n\nexport const consentRefApiLogRenderers : LogRendererMap = {\n    // \"CS/getConsentReference\": (a, m) => `Rakendus ${m.sender} kysib nousolekuteenuselt ${receivers(m.receivers)} nqusolekuviidet isiku ${m.message.subjectId} ja eesmargideklaratsiooni ${m.message.purposeDeclarationId} kohta.`\n}\n","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { ProcessState, Message, Payload } from '../process/Base';\nimport { AppState } from '../store';\nimport { selectArena } from './Theatre';\nimport { LogRow, receivers, formatLogtime } from './LogRows';\nimport { Modal, Button, ModalFooter } from 'react-bootstrap';\nimport { __ } from '../i18n';\n\ninterface LogProps {\n  arena: string;\n  owner?: ProcessState<any>;\n  showSelf?: boolean;\n  maxRows?: number;\n  rows?: Message<any>[];\n  t?: any;\n  className?: string;\n}\n\n\nclass LogView extends React.Component<LogProps> {\n\n  ref: React.RefObject<any> = React.createRef();\n\n  state = {\n    msg: undefined as (Message<any> | undefined)\n  }\n\n  closePopup() {\n    this.setState({ msg: undefined });\n  }\n\n  showPopup(msg: Message<any>) {\n    this.setState({ msg });\n  }\n\n  componentDidUpdate() {\n    if (this.ref.current) this.ref.current.scroll(0, this.ref.current.scrollHeight);\n  }\n\n  filterFn : (msg: Message<Payload>) => boolean = (msg) => {\n    if (msg.receivers.length === 1 && msg.receivers.includes(msg.sender) && !this.props.showSelf) {\n      return false;\n    }\n\n    if (this.props.owner !== undefined && !(msg.sender === this.props.owner.name || msg.receivers.includes(this.props.owner.name))) {\n      return false;\n    }\n\n    return true;\n  }\n\n  formatLogLine(msg: Message<Payload>, index: number, owner?: ProcessState<any>) {\n    const _this = this;\n    return (<li className=\"log-item\" key={index}>\n      { LogRow(this.props.arena, index, msg, owner, msg => { _this.showPopup(msg) }) }\n    </li>);\n  }\n\n  popup() { \n    const msg = this.state.msg;\n    const _this = this;\n    const t = this.props.t || ((a: string) => a);\n\n    return (\n      <Modal show={msg !== undefined} onHide={() => _this.closePopup()} size=\"lg\">\n        <Modal.Body>\n        { msg === undefined ? \"No message?\" : (\n        <div>\n          <div className=\"row\">\n            <h4>Saatja:</h4>\n            <p>{ msg!.sender }</p>\n          </div>\n          <div className=\"row\">\n            <h4>Saaja:</h4>\n            <p>{ receivers(msg!.receivers) }</p>\n          </div>\n          <div className=\"row\">\n            <h4>Tüüp:</h4>\n            <p>{ msg!.message.type }</p>\n          </div>\n          <div className=\"row\">\n            <h4>Aeg:</h4>\n            <p>{ formatLogtime(msg.now!) }</p>\n          </div>\n          <div className=\"col\">\n            <pre className=\"text-left\">\n              { JSON.stringify({ \n                ...msg, \n                type: undefined, \n                statusUpdateChannel: undefined,\n                arena: undefined,\n                now: undefined,\n                random: undefined,\n              }, undefined, \"  \") }\n            </pre>\n          </div>\n        </div>\n        ) }\n        </Modal.Body>\n        <Modal.Footer>\n        <Button variant=\"secondary\" onClick={(ev: any) => _this.closePopup()}>{ t('close') }</Button>\n        </Modal.Footer>\n      </Modal>\n      );\n  }\n\n  render() {\n    const logLines = (this.props.rows!\n      .filter(this.filterFn)\n      .slice(-(this.props.maxRows || 4)));\n\n    if (logLines.length === 0) {\n      return <span className=\"no-msg-log\">{ __({arena: this.props.arena, process: (this.props.owner || {}) as ProcessState<any> }, \"no-log-lines\") }</span>;\n    }\n\n    return (\n      <>\n      { this.popup() }\n      <samp className=\"msg-log\" ref={this.ref}>\n        <ul className=\"log-view\">\n          { logLines.map((line, index) => this.formatLogLine(line, index, this.props.owner)) }\n        </ul>\n      </samp>\n      </>\n      );\n  }\n}\n\nfunction mapStateToProps(state: AppState, ownProps: LogProps) {\n  return { rows: selectArena(state, ownProps.arena).log };\n}\n\nexport const MessageLog = connect(mapStateToProps)(LogView);\n\n\nexport class LogButton extends React.PureComponent<LogProps, { show: boolean }> {\n  state = { show: false };\n\n  render() {\n    const t = this.props.t;\n    return (<>\n      <Modal show={this.state.show} onHide={() => this.setState({ show: false })} size=\"lg\">\n        <Modal.Header>\n          <Modal.Title>{ __({ arena: this.props.arena, process: this.props.owner! }, \"log\") }: { \n            this.props.owner !== undefined ? __({arena: this.props.arena, process: this.props.owner}, \"title\") : <></> }</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <div className=\"msg-log-popup\">\n            <MessageLog {...this.props} />\n          </div>\n        </Modal.Body>\n        <ModalFooter>\n          <Button variant=\"secondary\" onClick={(ev: any) => this.setState({ show: false })}>{ t('close') }</Button>\n        </ModalFooter>\n      </Modal>\n      <Button className={this.props.className} onClick={(ev: any) => this.setState({ show: true }) }>{ this.props.children }</Button>\n    </>)\n  }\n}","import * as React from 'react';\n\nimport { ProcessState, ProcessRenderer, findRenderer, uiMap } from '../process/Base';\nimport { useStore } from 'react-redux';\nimport { launchUI } from '../postMessage';\nimport { __ } from '../i18n';\nimport { LogButton } from './MessageLog';\nimport { Modal, ModalFooter, Button } from 'react-bootstrap';\n\nfunction render<S>({process, arena}: ProcessUIProps<S>): ReturnType<ProcessRenderer<S>> {\n\treturn (findRenderer(process))({process, arena});\n}\n\n// Protsessi-kasti komponent. \n\nexport interface ProcessUIProps<S> {\n\tprocess: ProcessState<S>;\n\tarena: string; // current arena.\n\tchildren?: any;\n\tbutton?: boolean;\n}\n\n\n\nexport function ProcessUI({process, arena}: ProcessUIProps<any>) {\n\tconst t = (...keys: string[]) => __({arena, process}, ...keys);\n\tconst [ visible, setVisible ] = React.useState(false);\n\treturn (\n\t\t<div className=\"col\">\n\t\t\t<div className={`card process style-${ t('stylename') }`} id={`proc-${process.name}`}>\n\t\t\t  <div className=\"card-header\">\n\t\t\t  <Modal show={visible} onHide={() => setVisible(false) } size=\"lg\">\n\t\t  \t\t<Modal.Header>\n\t\t\t\t  <Modal.Title>{ t(\"internal-state\") }: { t('title') }</Modal.Title>\n\t\t\t  \t</Modal.Header>\n\t\t\t\t<Modal.Body>\n\t\t\t\t  <div className=\"msg-log-popup\">\n\t\t\t\t\t<pre className=\"msg-log\">{ JSON.stringify(process, undefined, \"  \") }</pre>\n\t\t\t\t  </div>\n\t\t  \t\t</Modal.Body>\n\t\t  \t\t<ModalFooter>\n\t\t\t\t  <Button variant=\"secondary\" onClick={() => setVisible(false)}>{ t('close') }</Button>\n\t\t  \t\t</ModalFooter>\n\t\t      </Modal>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"process-name\"\n\t\t\t\t\t\tonClick={() => setVisible(true)}>\n\t\t\t\t\t\t\t{ t(\"title\") }\n\t\t\t\t\t</span>\n\t\t\t\t\t<LogButton arena={arena} owner={process} showSelf={true} maxRows={100} t={t} className=\"btn-log btn-light btn-sm\">log</LogButton>\n\t\t\t  </div>\n\t\t\t  <div className=\"card-body\">\n\t\t\t\t\t<span className=\"process-state\">{ render({process, arena}) }</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n}\n\nexport function UILink({arena, process, children, button }: ProcessUIProps<any>) {\n\tconst store = useStore();\n\tfunction launch() {\n\t\tlaunchUI(arena, process.name, uiMap[process.type], store);\n\t}\n\n\tconst el = button === true ? 'button' : 'div'\n\n\tif (uiMap[process.type] === undefined) {\n\t\treturn <></>;\n\t} else {\n\t\treturn React.createElement(el, {\n\t\t\tclassName: button !==  true ? \"process-uilink\" : \"btn btn-primary\",\n\t\t\tonClick: () => launch()\n\t\t}, children === undefined ? \"\\u2398\" : children);\n\t}\n}\n\n","\ntype NamedObject = { name: string };\n\nexport interface ByNameStore<T extends NamedObject> {\n\tbyName: { [k: string]: T },\n\tallNames: string[];\n}\n\nexport function addByName<T extends NamedObject>(old: ByNameStore<T> = emptyStore(), init: T): ByNameStore<T> {\n\treturn {\n\t\tbyName: { ...old.byName, [init.name]: init },\n\t\tallNames: old.allNames.filter(n => n !== init.name).concat(init.name),\n\t}\n}\n\nexport function reduceByName<T extends NamedObject>(old: ByNameStore<T> = emptyStore(), reducer: (i: T) => T): ByNameStore<T> {\n\treturn {\n\t\t...old,\n\t\tbyName: Object.assign({}, ...old.allNames.map((k) => ({[k]: reducer(old.byName[k])})))\n\t}\n}\n\nexport function emptyStore<T extends NamedObject>(): ByNameStore<T> {\n    return { byName: {}, allNames: [] };\n}\n\nexport function fromArray<T extends NamedObject>(a: T[]): ByNameStore<T> {\n\treturn a.reduce(addByName, emptyStore());\n}","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { Store } from 'redux';\n\nimport { ProcessState, MESSAGE, Message, reduceMessage, Payload } from '../process/Base';\n\nimport { ProcessUI } from './Process';\nimport { MessageLog } from './MessageLog';\n\nimport { ByNameStore, addByName, reduceByName, fromArray } from '../byNameStore';\nimport { AppState } from '../store';\nimport { selectArena } from './Theatre';\nimport { useTranslation } from 'react-i18next';\n\n// Arena -- ports protsesse, mis omavahel sõnumeid vahetavad. \n// arenal on nimi?\n\nconst MESSAGE_DELAY = 300; // ms\n\n\ntype ProcessStore = ByNameStore<ProcessState<any>>;\nconst createProcess: (old : ProcessStore, init: ProcessState<any>) => ProcessStore = addByName;\nconst reduceProcesses: (old: ProcessStore, reducer: (p: ProcessState<any>) => ProcessState<any>) => ProcessStore = reduceByName;\n\nexport interface ArenaState {\n  name: string;\n  process: ProcessStore;\n  log: Message<any>[];\n}\n\nexport function createArena(name: string, ps: ProcessState<any>[]): ArenaState {\n  return { name: name, process: fromArray(ps), log: [] };\n}\n\nexport const CREATE_PROCESS = \"Arena/CREATE_PROCESS\"; \n\nexport interface CreateProcess {\n  type: typeof CREATE_PROCESS;\n  arena: string; \n  process: ProcessState<any>;\n}\n\nexport const FLUSH_QUEUE = \"Arena/FLUSH_QUEUE\";\nexport interface FlushQueue {\n  type: typeof FLUSH_QUEUE;\n  arena: string;\n}\n\nexport type ArenaActionType = CreateProcess | FlushQueue | Message<any>;\n\n\nexport function reduceArena(state: ArenaState, action: ArenaActionType): ArenaState {\n  if (action.arena !== state.name) {\n    return state;\n  }\n\n  switch (action.type) {\n    case CREATE_PROCESS:\n      return { ...state, process: createProcess(state.process, action.process) };\n    case FLUSH_QUEUE:\n      return { ...state, process: reduceProcesses(state.process, (p) => ({ ...p, queue: [] })) };\n    case MESSAGE:\n      return { ...state, process: reduceProcesses(state.process, (p) => reduceMessage(p, action)), log: state.log.concat([action])  };\n    default:\n      return state;\n  }\n}\n\nfunction getQueuedForArena(p: ProcessStore): Message<any>[] {\n  return p.allNames.map((n) => p.byName[n].queue).flat(1).filter((d) => d !== undefined);\n}\n\nfunction getQueued(arenas: ByNameStore<ArenaState>): Message<any>[] {\n  return arenas.allNames.map(n => getQueuedForArena(arenas.byName[n].process)).flat(1);\n}\n\nexport function fixNowAndRandom<P extends Payload>(m: Message<P>): Message<P> {\n  return { ...m, now: (Date.now() / 1000) | 0, random: \"\" + Math.random() };\n}\n\nexport function queueListener(store: Store) {\n  let queued = getQueued(store.getState().theatre.arenas);\n\n  if (queued.length === 0) {\n    return;\n  }\n\n  let arenas = Object.keys(Object.assign({}, ...queued.map((m) => ({ [m.arena]: 1 }))))\n\n  arenas.forEach((a) => store.dispatch({ type: FLUSH_QUEUE, arena: a } as FlushQueue ));\n\n  // queued.forEach((m) => store.dispatch(m));\n\n  const delayedSender = (store: Store, queue: Message<any>[]) => {\n    if (queue.length > 0) {\n      store.dispatch(fixNowAndRandom(queue.shift()!))\n      window.setTimeout(() => { delayedSender(store, queue); }, MESSAGE_DELAY);\n    }\n  };\n  \n  window.setTimeout(() => { delayedSender(store, queued); }, MESSAGE_DELAY);\n}\n\ninterface ArenaProps {\n  arena: ArenaState;\n}\n\nfunction ArenaElement({ arena }: ArenaProps) {\n  const { t } = useTranslation();\n  const processes = arena.process.allNames.map((p) => <ProcessUI process={arena.process.byName[p]} arena={arena.name} key={p} />);\n  return (\n    <div>\n      <div className=\"row\">{ processes }</div>\n      <div className=\"card w-100 mt-4 mb-2\">\n        <div className=\"card-body\">\n          <h5 className=\"card-title\">{t('msg-log.title')}</h5>\n          {arena.log.length === 0 &&\n            <div className=\"d-flex align-items-center\">\n              <div className=\"spinner-grow spinner-grow-sm\" role=\"status\"></div>\n              <p className=\"card-text ml-1\">{t('msg-log.empty')}</p>\n            </div>\n          }\n          <MessageLog arena={arena.name} showSelf={false} maxRows={1000}/>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction mapStateToProps(state: AppState, props: ArenaProps) {\n  return { log: selectArena(state, props.arena.name).log };\n}\n\nexport const Arena = connect(mapStateToProps)(ArenaElement);\n\n\n","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { ProcessState, Payload, message, Message } from '../process/Base';\nimport { fixNowAndRandom } from './Arena';\n\ninterface SendProps<S, M extends Payload> {\n\tarena: string;\n\towner: ProcessState<S>;\n\ttarget?: string | string[];\n\tclassName?: string;\n\tmessage: (values?: any) => M;\n\ttext: string;\n\tmessageToAction: (props: SendProps<S, M>, values?: any) => Message<M>;\n\tonClick?: (ev?: any) => void;\n\ttitle?: string;\n}\n\nfunction fixTarget(owner: ProcessState<any>, target?: string | string[]): string[] {\n\tif (target !== undefined && typeof target === 'string') {\n\t\treturn [target];\n\t}\n\n\tif (target === undefined || target.length === 0) {\n\t\treturn [owner.name];\n\t}\n\n\treturn target;\n}\n\nfunction messageToAction<S, M extends Payload>(props: SendProps<S, M>, values: Partial<M>): Message<M> {\n\treturn fixNowAndRandom<M>(message(\n\t\tprops.arena,\n\t\tprops.owner,\n\t\tfixTarget(props.owner, props.target),\n\t\tprops.message(values)\n\t));\n}\n\nfunction parseOrRaw(s: any): any {\n\tif (typeof s === \"string\" && s.startsWith(\"{\")) {\n\t\treturn JSON.parse(s);\n\t}\n\n\treturn s;\n}\n\nfunction values(f: HTMLFormElement): any {\n\n\tif (f === undefined || f === null) {\n\t\treturn {};\n\t}\n\n\treturn Array.from(f.elements)\n\t\t\t.map((u, i) => f.elements[i] as any as { \n\t\t\t\tname: string;\n\t\t\t\tvalue: any;\n\t\t\t\ttype: string;\n\t\t\t\toptions?: HTMLOptionsCollection;\n\t\t\t\tchecked?: boolean;\n\t\t\t})\n\t\t\t.filter(e => (e.name !== undefined && e.name !== null && e.name !== \"\" && !e.name.startsWith(\"_\")))\n\t\t\t.map(e => {\n\t\t\t\tif (e.type === \"select-multiple\") {\n\t\t\t\t\tlet out: any[] = [];\n\t\t\t\t\tlet i: number;\n\t\t\t\t\tfor (i = 0; i < e.options!.length; i++) {\n\t\t\t\t\t\tif (e.options![i].selected) {\n\t\t\t\t\t\t\tout.push(parseOrRaw(e.options![i].value));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn { [e.name]: out };\n\t\t\t\t}\n\n\t\t\t\tif (e.type === \"checkbox\") {\n\t\t\t\t\tlet values: (string | undefined)[] = e.value.split(\"|\", 2);\n\t\t\t\t\tif (values.length === 1) {\n\t\t\t\t\t\tvalues.push(undefined);\n\t\t\t\t\t}\n\t\t\t\t\treturn { [e.name]: parseOrRaw(values[e.checked ? 0 : 1]) }\n\t\t\t\t}\n\t\t\t\treturn { [e.name]: parseOrRaw(e.value) }\n\t\t\t})\n\t\t\t.reduce((o, c) => ({ ...o, ...c }), {});\n}\n\nclass Send<S, M extends Payload> extends React.Component<SendProps<S, M>> {\n\n\thandleClick(ev: any) {\n\t\tev.preventDefault();\n\t\tthis.props.messageToAction(this.props, values(ev.currentTarget.form));\n\t\tif(this.props.onClick) this.props.onClick(ev);\n\t};\n\n\trender() {\n\t\treturn <button \n\t\t\tclassName={ this.props.className === undefined ? \"btn btn-primary\" : this.props.className } \n\t\t\tonClick={(ev) => this.handleClick(ev)}\n\t\t\ttitle={this.props.title}\n\t\t>{this.props.text}</button>\n\t}\n}\n\nexport const SimpleSend = connect(null, { messageToAction })(Send);\n\n","import { ProcessImplName, ViewName, ProcessState, Payload, GenericMessageHandler, Message, addHandlerClass, ProcessAndArena, addRenderer } from './Base';\nimport * as React from 'react';\nimport { SimpleSend } from '../components/SendButton';\nimport { MessageLog } from '../components/MessageLog';\n\nconst Counter : ProcessImplName = \"Counter\";\n\nconst CounterDefaultView : ViewName = \"_\";\n\n// \"rakenduse olek\"\nexport interface CounterState extends ProcessState<number> {\n\ttype: typeof Counter;\n\tview: typeof CounterDefaultView;\n}\n\n// \"bootloader\", tekitab rakenduse algoleku\nexport function createCounter(name: string) {\n\treturn {\n\t\tname: name,\n\t\ttype: Counter,\n\t\tview: CounterDefaultView,\n\t\tmem: 0,\n\t} as CounterState;\n}\n\nclass IncrementMessageHandler extends GenericMessageHandler<number, CounterState, Payload, IncrementMessageHandler> {\n\tname = \"Counter/INC\";\n\tupdateMem(mem: number, action: Message<Payload>) { return mem + 1; }\n}\n\n\nclass DecrementMessageHandler extends GenericMessageHandler<number, CounterState, Payload, DecrementMessageHandler> {\n\tname = \"Counter/DEC\";\n\tupdateMem(mem: number, action: Message<Payload>) { return mem - 1; }\n}\n\nconst incrementMessage = addHandlerClass(Counter, IncrementMessageHandler);\nconst decrementMessage = addHandlerClass(Counter, DecrementMessageHandler);\n\n\ninterface DefaultViewProps extends ProcessAndArena<number> {\n\tprocess: CounterState;\n\tarena: string;\n}\n\nconst counterRenderer : React.FC<DefaultViewProps> = ({process, arena}) => {\n\treturn (\n\t<div>\n\t\t<span className=\"process-state\">{ process.mem }</span>\n\t\t<span className=\"process-state\">\n\t\t\t<SimpleSend arena={arena} owner={process} text=\"+\" message={incrementMessage()}/>\n\t\t\t<SimpleSend arena={arena} owner={process} text=\"-\" message={decrementMessage()}/>\n\t\t</span>\n\t\t<span className=\"process-state\">\n\t\t\t<MessageLog arena={arena} owner={process} showSelf={true} maxRows={4}/>\n\t\t</span>\n\t</div>\n\t);\n};\n\n\naddRenderer(Counter, CounterDefaultView, counterRenderer);\n","import * as React from 'react';\n\ninterface PopupProps {\n    text: any;\n    open?: boolean; // initial state\n}\n\nexport class Popup extends React.Component<PopupProps, { open: boolean }> {\n    state = { open: false };\n\n    render() {\n        return (\n            <div>\n                <div className={ this.state.open ? \"popup-visible\" : \"popup-hidden\" }>\n                    <div className=\"popup-content\">\n                        <div className=\"popup-close\" onClick={() => this.setState({open: false})}></div>\n                        {this.props.children}\n                    </div>\n                </div>\n                <button className=\"btn btn-primary\" onClick={() => this.setState({open: true})}>{this.props.text}</button>\n            </div>\n        );\n    }\n}","import * as React from \"react\";\n\ninterface Props {}\n\ninterface State {\n  view: string;\n  loading: boolean;\n}\n\nconst LOGIN = \"login\";\nconst SELECT_SERVICE = \"selectService\";\nconst SERVICE_V1 = \"serviceV1\";\n\nconst Header = () => (\n  <div className=\"app-header\">\n    <div className=\"app-user-icon\">\n      <img alt=\"user icon\" src={require('./../static/assets/images/user-icon.svg')} />\n    </div>\n    <p className=\"app-user\">TERE MARI-LIIS MÄNNIK</p>\n  </div>\n);\n\nclass ClientView extends React.PureComponent<Props, State> {\n\n  state = {\n    view: LOGIN,\n    loading: false\n  };\n\n  changeView = (view: string) => {\n    this.setState({ loading: true });\n    setTimeout(() => {\n      this.setState({loading: false});\n      this.setState({view: view});\n    }, 1000);\n  };\n\n  render() {\n    switch (this.state.loading) {\n      case true:\n      return (\n        <div className=\"d-flex align-items-center\">\n          <strong>Loading...</strong>\n          <div className=\"spinner-border ml-auto\" role=\"status\" aria-hidden=\"true\"></div>\n        </div>\n      );\n      default:\n        switch (this.state.view) {\n          case LOGIN:\n          return (\n            <div>\n              <h4>Tere! Teenuse kasutamiseks logi palun sisse.</h4>\n              <button className=\"btn btn-light border\" onClick={() => this.changeView(SELECT_SERVICE)}>Logi sisse kasutajana Mari-Liis Männik 47302200234</button>\n              <p className=\"mt-4\">\n                <img alt=\"illustration\" src={require('./../static/assets/images/login.svg')} width=\"280\" />\n              </p>\n            </div>\n          );\n          case SELECT_SERVICE:\n          return (\n            <div>\n              <Header />\n              <h4>Vali teenus mida soovid kasutada:</h4>\n              <button className=\"btn btn-dark\" onClick={() => this.changeView(SERVICE_V1)}>Vaktsineerimiste meeldetuletused</button>\n            </div>\n          );\n          case SERVICE_V1:\n          return (\n            <div>\n              <Header />\n              <h4>Teenuse tekst TODO</h4>\n              <p className=\"text-left\">\n                <small>Enne nõusoleku andmist veendu, et oled tutvunud meie privaatsuspoliitika ja kasutustingimustega, mis on leiavad <a href=\"JavaScript:void(0);\">siin</a>. Nõusoleku andmiseks suuname Sind e-Tervise nõusolekute keskkonda, mida haldab Tervise- ja Heaolu Infosüsteemide Keskus.</small>\n              </p>\n              <button className=\"btn btn-lg btn-primary\">Annan nõusoleku</button>\n            </div>\n          );\n          default:\n          return(null)\n        }\n    }\n  }\n}\n\nexport default ClientView;","import * as React from 'react';\nimport { ProcessAndArena, ProcessImplName, ViewName, ProcessState, GenericMessageHandler, Payload, Message, message, addHandlerClass, addRenderer, addUi } from './Base';\nimport { SimpleSend } from '../components/SendButton';\nimport { MessageLog } from '../components/MessageLog';\nimport { Popup } from '../components/Popup';\nimport { Modal, Button } from 'react-bootstrap';\nimport { useTranslation } from 'react-i18next';\nimport ClientView from './../components/Client';\n\nconst TokenNode : ProcessImplName = \"TokenNode\";\n\nconst WithToken : ViewName = \"with\";\nconst WithoutToken : ViewName = \"without\";\n\ninterface NodeState {\n  token?: string; // token I have or undefined\n  next: string; // next station.\n}\n\ninterface NodePS extends ProcessState<NodeState> {\n  type: typeof TokenNode;\n  view: typeof WithToken | typeof WithoutToken;\n  title: string;\n}\n\nexport function createTokenNode(title: string, name: string, next: string, token?: string): NodePS {\n  return {\n    title: title,\n    name: name,\n    type: TokenNode,\n    view: token === undefined ? WithoutToken : WithToken,\n    mem: {\n      token: token,\n      next: next\n    },\n    queue: [],\n  };\n}\n\nclass InitPassHandler extends GenericMessageHandler<NodeState, NodePS, Payload, InitPassHandler> {\n  name = \"TokenNode/InitPass\";\n  handle(node: NodePS, action: Message<Payload>) {\n    if (node.view !== WithToken) {\n      console.error(`Invalid message, order to pass while I have no token? ${JSON.stringify(node)}`);\n      return node;\n    }\n\n    \n    return {\n      ...node,\n      queue: node.queue.concat(message(action.arena, node, [node.mem.next], tokenMessage({token: node.mem.token})())),\n      mem: { ...node.mem, token: undefined },\n      view: WithoutToken,\n    };\n  }\n}\n\nconst initPassMessage = addHandlerClass(TokenNode, InitPassHandler);\n\n\n// selle sõnumiga saadetakse reaalselt tokeneid.\ninterface TokenMessage extends Payload {\n  token: string;\n}\n\nclass PostTokenHandler extends GenericMessageHandler<NodeState, NodePS, TokenMessage, PostTokenHandler> {\n  name = \"TokenNode/PostToken\";\n  // sissetulev token\n  handle(node: NodePS, action: Message<TokenMessage>) {\n    if (node.view === WithToken) {\n      console.log(`${action.sender} sent token '${action.message.token}' to ${node.name}. We already have a token (${node.mem.token}). Will send the token back`);\n      // send it back.\n      return {\n        ...node,\n        queue: node.queue.concat(message(action.arena, node, [action.sender], action.message)),\n      };\n    } else {\n      // tokenit polnud, jätame meelde.\n      return {\n        ...node,\n        mem: { ...node.mem, token: action.message.token },\n        view: WithToken,\n      };\n\n    }\n  }\n}\n\nconst tokenMessage = addHandlerClass<TokenMessage, PostTokenHandler>(TokenNode, PostTokenHandler);\n\n\ninterface TargetPayload extends Payload {\n  target: string;\n}\n\nclass UpdateTargetHandler extends GenericMessageHandler<NodeState, NodePS, Payload, InitPassHandler> {\n  name = \"TokenNode/UpdateTarget\";\n  updateMem(mem: NodeState, action: Message<TargetPayload>) {\n    return { ...mem, next: action.message.target };\n  }\n}\n\nconst updateNextMessage = addHandlerClass(TokenNode, UpdateTargetHandler);\n\n\n////\n\ninterface NodeViewProps extends ProcessAndArena<NodeState> {\n  process: NodePS,\n}\n\nconst SetTargetPopup : React.FC<NodeViewProps> = ({process, arena}) => {\n\n  const { t } = useTranslation();\n  const [show, setShow] = React.useState(false);\n  const handleClose = () => setShow(false);\n  const handleShow = () => setShow(true);\n\n  switch(process.name) {\n    case \"a\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Teenusedeklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"baseName\">Andmekogu nimi:</label>\n                    <input name=\"baseName\" type=\"text\" className=\"form-control\" id=\"baseName\" value=\"test\" readOnly />\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"xtee\">Andmekogu X-tee:</label>\n                    <input name=\"xtee\" type=\"text\" className=\"form-control\" id=\"xtee\" value=\"123\" readOnly />\n                    <small id=\"xteeHelp\" className=\"form-text text-muted\">(alamsüsteemi) identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdName\">Teenusedeklaratsiooni nimi:</label>\n                    <input name=\"sdName\" type=\"text\" className=\"form-control\" id=\"sdName\" />\n                    <small id=\"sdNameHelp\" className=\"form-text text-muted\">Teenusedeklaratsiooni identifikaator inimloetaval kujul. Soovitatavalt teenuse kood/nimi ja vajadusel alamteenuse identifikaator.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdIdentifier\">Teenusedeklaratsiooni identifikaator:</label>\n                    <input name=\"sdIdentifier\" type=\"text\" className=\"form-control\" id=\"sdIdentifier\" />\n                    <small id=\"sdIdentifierHelp\" className=\"form-text text-muted\">Andmekogu poolt määratud teenusedeklaratsiooni masinloetav identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdDescription\">Teenuse andmekoosseisu kirjeldus:</label>\n                    <input name=\"sdDescription\" type=\"text\" className=\"form-control\" id=\"sdDescription\" />\n                    <small id=\"sdDescriptionHelp\" className=\"form-text text-muted\">Teenuse poolt tagastatava andmekoosseisu inimloetav kirjeldus. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <div className=\"form-check\">\n                      <input name=\"signature\" className=\"form-check-input\" type=\"checkbox\" id=\"signature\" />\n                      <label className=\"form-check-label\" htmlFor=\"signature\">Vajab digiallkirja?</label>\n                      <small id=\"signatureHelp\" className=\"form-text text-muted\">Märgista see väli, kui andmesubjekt peab selle teenuse andmetele nõusoleku andmisel nõusoleku digitaalselt allkirjastama.</small>\n                    </div>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text=\"Update\" message={updateNextMessage()}/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('register')}\n      </Button>\n      </>\n    )\n    case \"b\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Eesmärgideklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"applicationName\">Klientrakenduse nimi:</label>\n                    <input name=\"applicationName\" type=\"text\" className=\"form-control\" id=\"applicationName\" value=\"test\" readOnly />\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"applicationXtee\">Klientrakenduse X-tee:</label>\n                    <input name=\"applicationXtee\" type=\"text\" className=\"form-control\" id=\"applicationXtee\" value=\"123\" readOnly />\n                    <small id=\"applicationXteeHelp\" className=\"form-text text-muted\">(alamsüsteemi) identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dIdentifier\">Deklaratsiooni identifikaator:</label>\n                    <input name=\"dIdentifier\" type=\"text\" className=\"form-control\" id=\"dIdentifier\" />\n                    <small id=\"dIdentifierHelp\" className=\"form-text text-muted\">Klientrakenduse poolt määratud eesmärgideklaratsiooni identifikaator</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dataUsage\">Andmete kasutamise eesmärk:</label>\n                    <input name=\"dataUsage\" type=\"text\" className=\"form-control\" id=\"dataUsage\" />\n                    <small id=\"dataUsageHelp\" className=\"form-text text-muted\">Andmesubjekti andmete töötlemise eesmärk. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"services\">Kasutatavad teenused:</label>\n                    <select name=\"services\" className=\"custom-select\" multiple defaultValue={['1']} id=\"services\">\n                      <option value=\"1\">One</option>\n                      <option value=\"2\">Two</option>\n                      <option value=\"3\">Three</option>\n                    </select>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text=\"Update\" message={updateNextMessage()}/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('register')}\n      </Button>\n      </>\n    )\n    case \"c\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\" bsPrefix=\"client-app modal\">\n        <Modal.Header>\n          <Modal.Title>HealthStartup</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <ClientView />\n        </Modal.Body>\n        <Modal.Footer>\n          <Button variant=\"outline-dark\" onClick={handleClose}>Close</Button>\n        </Modal.Footer>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('continue')}\n      </Button>\n      </>\n    )\n    default:\n    return (\n      <Popup text=\"Set target\">\n        <form>\n          <input name=\"target\" size={20}/>\n          <SimpleSend arena={arena} owner={process} text=\"Update target\" message={updateNextMessage()}/>\n        </form>\n      </Popup>\n    )\n  }\n};\n\nconst tokenlessRenderer : React.FC<NodeViewProps> = ({process, arena}) => {\n  return (\n    <div>\n      {/*\n      <span className=\"process-state\">next: {process.mem.next}</span>\n      */}\n      <SetTargetPopup arena={arena} process={process}/>\n      <span className=\"process-state\">\n        <MessageLog arena={arena} owner={process} showSelf={true} maxRows={2}/>\n      </span>\n    </div>\n  )\n};\n\nconst tokenfulRenderer : React.FC<NodeViewProps> = ({process, arena}) => {\n  return (<div>\n    <span className=\"process-state\">{process.mem.token}</span>\n    <span className=\"process-state\">next: {process.mem.next}</span>\n    <span className=\"process-state d-none\"><SimpleSend arena={arena} owner={process} text=\"Pass the token\" message={initPassMessage()}/></span>\n    <SetTargetPopup arena={arena} process={process}/>\n    <span className=\"process-state\">\n      <MessageLog arena={arena} owner={process} showSelf={true} maxRows={4}/>\n    </span>\n  </div>);\n}\n\naddRenderer(TokenNode, WithToken, tokenfulRenderer);\naddRenderer(TokenNode, WithoutToken, tokenlessRenderer);\n\naddUi(TokenNode, \"/ui/dummy\");","import { ProcessImplName, ViewName, ProcessState } from \"../Base\";\nimport { PurposeDeclaration } from \"../consentService/types\";\n\n\nexport const ClientIS : ProcessImplName = \"ClientIS\";\nexport const ClientDefaultView : ViewName = \"loginView\";\n\nexport type PurposeDeclarationTemplate = Partial<PurposeDeclaration> & { purposeDeclarationId: string; }\n\n// the Client \"implements\" requests as defined in config\nexport interface ClientConfig {\n    // purpose declaration\n    purposeDeclarationId: string;\n    services: { // services it needs\n        serviceAddress: string;\n        serviceName: string;\n    }[];\n}\nexport interface ClientState {\n    ui: {\n        user?: string; // authenticated data subject id or null\n        service?: string;\n        response?: {\n            // used to match async messag\n            requestReferenceId: string;\n            purposeDeclarationId: string;\n            serviceAddress: string;\n            serviceName: string;\n            data: any;\n        }[];\n    };\n\n    db: {\n        consentServiceId: string; // should be per purpose\n        consentRefByUser: { [key: string]: { [key: string]: string | null; } }; // userid -> purposedeclarationid -> consentref\n        purpose: { // purposedeclarationid -> servicedesc[]\n            [key: string]: { \n                serviceAddress: string; // the actual communication address\n                serviceId: string;      // actual \"service\"\n            }[];\n         } \n    };\n\n    declTemplate?: PurposeDeclarationTemplate[];\n\n    config: ClientConfig[];\n}\n\nexport interface ClientPS extends ProcessState<ClientState> {\n    type: typeof ClientIS;\n    view: typeof ClientDefaultView;\n}\n","import { ViewName, ProcessImplName, ProcessState } from '../Base';\n\nexport const ConsentService : ProcessImplName = \"ConsentService\";\nexport const ConsentServiceDefaultView : ViewName = \"loginView\";\n\n\nexport interface ConsentServicePS extends ProcessState<ConsentServiceState> {\n    type: typeof ConsentService;\n    view: typeof ConsentServiceDefaultView;\n}\n\nexport interface ServiceDeclaration {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n    name: string;\n    description: string;\n    technicalDescription: string;\n    consentMaxDurationSeconds: number; // integer\n    needSignature: boolean;\n    validUntil?: number; // timestamp as seconds from unix epoch?\n    maxCacheSeconds?: number;\n}\n\nexport interface ServiceDeclarationRef {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n}\n\nexport interface PurposeDeclaration {\n    clientId: string;\n    purposeDeclarationId: string;\n    name: string;\n    description: string;\n    services: ServiceDeclarationRef[];\n    validUntil?: number; // seconds from unix epoch\n    options: any;\n}\n\nexport interface Consent {\n    dataSubject: string;\n    clientId: string;\n    purposeDeclarationId: string;\n    validFrom: number;\n    validUntil: number;\n    revoked: boolean;\n    consentReference: string; // used only in protocol\n}\n\nexport interface UsageRecord {\n    usageTime: number; // seconds from unix epoch\n    serviceProviderId: string;\n    requestReference: string;\n    consentReference?: string;\n    subjectId: string;\n    clientId: string;\n    serviceDeclarationIds: string[];\n    result: \"OK\" | \"ACCESS_DENIED\" | \"OTHER_FAIL\";\n}\n\nexport interface PurposeDeclarationRef {\n    clientId: string;\n    purposeDeclarationId: string;\n}\n\nexport interface ActivePurposeDeclarationRef extends PurposeDeclarationRef {\n    callbackURL?: string;\n}\n\nexport interface ConsentServiceState {\n    ui: {\n        user?: string;\n        activePurposeDeclaration: {\n            [userid: string]: ActivePurposeDeclarationRef;\n        };\n    }\n\n    db: {\n        serviceDeclarations: ServiceDeclaration[];\n        purposeDeclarations: PurposeDeclaration[];\n        consents: Consent[];\n        usageLog: UsageRecord[];\n    }\n}\n\nexport function findFrom<T extends U, U extends any>(items: T[], example: U): T | undefined {\n    return items.find(\n        i => { \n            return Object.keys(example).filter(\n                k => (i as T)[k] !== (example as U)[k]\n            ).length === 0\n        }\n    );\n}\n\n\n","import { createHash } from \"crypto\";\nimport React from \"react\";\n\n\nexport function hash(input: string): string {\n    return createHash(\"sha256\").update(input).digest(\"hex\").substring(0, 6);\n}\n\n// converts transport address to organization id\nexport function address2org(address: string): string {\n    let m = address.match(\"^([^/]+/[^/]+/[^/]+)(/.*)?$\");\n    if (m === null) {\n        // not an X-Road member id or more specific address?\n        return address;\n    }\n    \n    return m[1];\n}\n\nexport function renderText(t: string) {\n    type OutElement = { text: string; indent: number; children: OutElement[] };\n    let stack: OutElement[] = [];\n\n    function last(a: OutElement[]): OutElement {\n        return a[a.length - 1];\n    }\n\n    stack.push({ text: \"\", indent: -1, children: [] });\n\n    t.split(\"\\n\").forEach(l => {\n        let pref = l.match(\"^((  )+\\\\* )(.*)$\");\n        if (pref === null) {\n            pref = [\"\", \"\", \"\", l];\n        }\n\n        let prefix = pref[1];\n        let text = pref[3];\n\n        while (prefix.length <= last(stack).indent) {\n            // the same level -> back up, so it will be actually a new level?\n            stack.pop();\n        }\n\n        if (prefix.length > last(stack).indent) {\n            // new level\n            last(stack).children.push({ text: text, indent: prefix.length, children: [] })\n            stack.push(last(last(stack).children));\n        }\n    });\n\n    function ul(children: OutElement[]) {\n        if (children.length === 0) {\n            return <></>;\n        }\n\n        return (\n            <ul className=\"desc-markup\">{ \n                children.map(c => <li className=\"desc-markup\">{ c.text }{ ul(c.children) }</li>)\n            }</ul>\n        );\n    }\n\n    return stack[0].children.map(c => <><p className=\"desc-markup\">{ c.text }</p>{ ul(c.children) }</>);\n}","import { ServiceDeclaration, ConsentServiceState, findFrom, PurposeDeclaration, ConsentService, ConsentServicePS } from './types'\nimport { GenericMessageHandler, Message, addHandlerClass, updateDb } from '../Base';\nimport { address2org } from '../../util';\n\n// {Service,Purpose}Declaration API messages and their processing\n\ninterface ServiceDeclarationMessage extends ServiceDeclaration {\n    type: typeof AddServiceDeclarationMessage.name;\n}\n\nclass AddServiceDeclarationMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ServiceDeclarationMessage, AddServiceDeclarationMessage> {\n    name = \"CS/addServiceDeclaration\"; \n\n    addServiceDeclaration(cs: ConsentServicePS, sd: ServiceDeclaration): ConsentServicePS {\n        return updateDb(cs, { serviceDeclarations: cs.mem.db.serviceDeclarations.concat(sd) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<ServiceDeclarationMessage>) {\n        console.log(`addServiceDeclaration: ${JSON.stringify(msg)}`);\n\n        let decl = msg.message;\n\n        if (findFrom(\n            cs.mem.db.serviceDeclarations,\n            { serviceProviderId: decl.serviceProviderId, serviceDeclarationId: decl.serviceDeclarationId }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"duplicate_declaration\");\n        }\n\n        if (decl.serviceProviderId !== address2org(msg.sender)) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", {\n                 msg: \"serviceProvcderId in declaration and message do not match\"\n            });\n        }\n\n        if (decl.serviceDeclarationId === undefined || !decl.serviceDeclarationId.match(\"^[!-~]+$\")) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid service declaration id\"});\n        }\n\n        return this.withOkResponse(this.addServiceDeclaration(cs, { ...msg.message, type: undefined } as ServiceDeclaration), msg);\n    }\n}\n\nexport const addServiceDeclaration = addHandlerClass(ConsentService, AddServiceDeclarationMessage);\n\ninterface PurposeDeclarationMessage extends PurposeDeclaration {\n    type: typeof AddPurposeDeclarationMessage.name;\n}\n\nclass AddPurposeDeclarationMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, PurposeDeclarationMessage, AddPurposeDeclarationMessage> {\n    name = \"CS/addPurposeDeclaration\"; \n\n    addPurposeDeclaration(cs: ConsentServicePS, pd: PurposeDeclaration): ConsentServicePS {\n        return updateDb(cs, { purposeDeclarations: cs.mem.db.purposeDeclarations.concat(pd) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<PurposeDeclarationMessage>) {\n        console.log(`addPurposeDeclaration: ${JSON.stringify(msg)}`);\n\n        let decl = msg.message;\n\n        if (findFrom(\n            cs.mem.db.purposeDeclarations,\n            { clientId: decl.clientId, purposeDeclarationId: decl.purposeDeclarationId }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"duplicate_declaration\");\n        }\n\n        if (decl.clientId !== address2org(msg.sender)) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"clientId in declaration and message do not match\"});\n        }\n\n        if (decl.purposeDeclarationId === undefined || !decl.purposeDeclarationId.match(\"^[!-~]+$\")) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid purpose declaration id\"});\n        }\n\n        if (decl.services.length === 0 || decl.services.find(sdRef => {\n            // true if sdRerf does not match with any of existing servicedeclarations\n            return findFrom(cs.mem.db.serviceDeclarations, sdRef) === undefined;\n        }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid or missing SD reference(s)\"});\n        }\n\n        return this.withOkResponse(this.addPurposeDeclaration(cs, { ...msg.message, type: undefined } as PurposeDeclaration), msg);\n    }\n}\n\nexport const addPurposeDeclaration = addHandlerClass(ConsentService, AddPurposeDeclarationMessage);\n","import { Payload, GenericMessageHandler, Message, addHandlerClass, message, updateDb } from '../Base';\nimport { ConsentServiceState, ConsentServicePS, ConsentService, findFrom, Consent, PurposeDeclarationRef, ActivePurposeDeclarationRef } from './types';\nimport { fetchConsentReference } from '../client/messages';\n\n// messages that the ConsentService UI can send \n\nexport interface LoginMessage extends Payload {\n    type: typeof LoginMessageHandler.name;\n    user?: string;\n}\n\nclass LoginMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, LoginMessage, LoginMessageHandler> {\n    name = \"CS/UI/login\";\n\n    handle(cs: ConsentServicePS, action: Message<LoginMessage>): ConsentServicePS {\n        console.log(\"login message: \", action); \n        return { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, user: action.message.user } } };\n    }\n}\n\nexport const loginMessage = addHandlerClass<LoginMessage, LoginMessageHandler>(ConsentService, LoginMessageHandler);\n\ninterface ConsentMessage extends Consent, Payload {\n    type: typeof GiveConsentMessageHandler.name;\n}\n\nclass GiveConsentMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ConsentMessage, GiveConsentMessageHandler> {\n    name: string = \"CS/UI/giveConsent\";\n\n    addConsent(cs: ConsentServicePS, con: Consent): ConsentServicePS {\n        return updateDb<typeof cs.mem.db, ConsentServiceState>(cs, { consents: cs.mem.db.consents.concat(con) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<ConsentMessage>): ConsentServicePS {\n        let newConsent = msg.message;\n        if (findFrom(cs.mem.db.purposeDeclarations, { \n            clientId: newConsent.clientId,\n             purposeDeclarationId: newConsent.purposeDeclarationId\n        }) === undefined) {\n            console.error(\"Attempt to add consent for unknown purpose declaration: \", newConsent);\n            return cs;\n        }\n\n        if (findFrom(cs.mem.db.consents, {\n            clientId: msg.message.clientId,\n            purposeDeclarationId: msg.message.purposeDeclarationId,\n            dataSubject: msg.message.dataSubject,\n            revoked: false\n        }) !== undefined) {\n            console.error(\"Attempt to add duplicate consent?\");\n            return cs;\n        }\n\n        console.log(\"Adding consent: \", msg.message);\n\n        let updatedCS = this.addConsent(cs, { ...msg.message, type: undefined } as Consent);\n\n        let activeUser = cs.mem.ui.user;\n        if (activeUser === undefined || cs.mem.ui.activePurposeDeclaration[activeUser] === undefined) {\n            // no user, no active pd --> no callback\n            return updatedCS;\n        }\n\n        let decl = cs.mem.ui.activePurposeDeclaration[activeUser];\n\n        // forget that we had pd selected.\n        let updatedCS2 = setActivePD(updatedCS, activeUser, undefined);\n\n        if (decl.clientId !== msg.message.clientId || decl.purposeDeclarationId !== msg.message.purposeDeclarationId \n                || decl.callbackURL === undefined) {\n            return updatedCS2;\n        }\n\n        // if the client application asked for callback, we send it a message about the \n        // consent being signed. reusing UI message from client implementation.\n        return this.send(updatedCS2, message(msg.arena, updatedCS, [decl.callbackURL],\n            fetchConsentReference({ purposeDeclarationId: decl.purposeDeclarationId })()\n        ));\n\n    }\n}\n\nexport const giveConsentMessage = addHandlerClass<ConsentMessage, GiveConsentMessageHandler>(ConsentService, GiveConsentMessageHandler);\n\n\ninterface RevokeConsentMessage extends Payload {\n    type: typeof RevokeConsentMessageHandler.name;\n    consentReference: string;\n    revokeAt: number;\n}\n\nclass RevokeConsentMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, RevokeConsentMessage, RevokeConsentMessageHandler> {\n    name: string = \"CS/UI/revokeConsent\";\n\n    revokeIfReferenceEquals(con: Consent, ref: RevokeConsentMessage) : Consent {\n        if (con.consentReference === ref.consentReference) {\n            return { ...con, revoked: true, validUntil: ref.revokeAt};\n        } \n\n        return con;\n    }\n\n    revokeConsent(cs: ConsentServicePS, ref: RevokeConsentMessage): ConsentServicePS {\n        return updateDb(cs, { consents: cs.mem.db.consents.map(a => this.revokeIfReferenceEquals(a, ref))});\n    }\n    \n    handle(cs: ConsentServicePS, msg: Message<RevokeConsentMessage>): ConsentServicePS {\n        return this.revokeConsent(cs, msg.message);\n    }\n}\n\nexport const revokeConsentMessage = addHandlerClass<RevokeConsentMessage, RevokeConsentMessageHandler>(ConsentService, RevokeConsentMessageHandler);\n\nfunction updateAPDforUser<R extends { [ user: string]: ActivePurposeDeclarationRef }>(refs: R, user: string, ref?: ActivePurposeDeclarationRef): R {\n    return { ...refs, [user]: ref };\n}\n\nexport function setActivePD(cs: ConsentServicePS, user: string, ref?: ActivePurposeDeclarationRef): ConsentServicePS {\n    return { ...cs, mem: { ...cs.mem, ui: { \n        ...cs.mem.ui,\n         activePurposeDeclaration: updateAPDforUser(cs.mem.ui.activePurposeDeclaration, user, ref)\n    }}}\n}\n\ninterface ActivatePurposeDeclaration extends Payload, PurposeDeclarationRef {\n    type: typeof ActivatePurposeDeclarationHandler.name;\n    user?: string;\n}\n\nclass ActivatePurposeDeclarationHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ActivatePurposeDeclaration, ActivatePurposeDeclarationHandler> {\n    name = \"CS/UI/activatePurposeDeclaration\";\n\n    handle(cs: ConsentServicePS, action: Message<ActivatePurposeDeclaration>): ConsentServicePS {\n        return setActivePD(\n            cs,\n            action.message.user === undefined ? cs.mem.ui.user! : action.message.user,\n            {\n                clientId: action.message.clientId,\n                purposeDeclarationId: action.message.purposeDeclarationId,\n            }\n        );\n    }\n}\n\nexport const activatePurposeDeclarationMessage = addHandlerClass<ActivatePurposeDeclaration, ActivatePurposeDeclarationHandler>(ConsentService, ActivatePurposeDeclarationHandler);\n","import { GenericMessageHandler, Message, Payload, addHandlerClass, updateDb } from \"../Base\";\nimport { ConsentServiceState, ConsentServicePS, findFrom, ConsentService, Consent } from \"./types\";\nimport { setActivePD } from \"./ui\";\n\ninterface ConsentReferenceRequest extends Payload {\n    type: typeof GetConsentReferenceMessage.name;\n    clientId: string;\n    purposeDeclarationId: string;\n    subjectId: string;\n    callbackURL?: string;\n    code?: string;\n}\n\nexport const  ConsentReferenceResponseTypeName = \"CS/getConsentReference/response\";\nexport interface ConsentReferenceResponse extends Payload {\n    type: typeof ConsentReferenceResponseTypeName;\n    clientId: string; \n    purposeDeclarationId: string;\n    consentReference: string;\n}\n\nexport function fixRevoked(now: number): ((c: Consent) => Consent) {\n    return (c => ((!c.revoked && c.validUntil < now) ? { ...c, revoked: true } : c));\n}\n\nclass GetConsentReferenceMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ConsentReferenceRequest, GetConsentReferenceMessage> {\n    name: string = \"CS/getConsentReference\";\n\n    handle (cs: ConsentServicePS, msg: Message<ConsentReferenceRequest>): ConsentServicePS {\n\n        let req = msg.message;\n\n        // mark expired consents as revoked, as optimization\n        let _cs : ConsentServicePS = updateDb<typeof cs.mem.db, ConsentServiceState>(\n            cs, { consents: cs.mem.db.consents.map(fixRevoked(msg.now!)) }\n        );\n\n        const consent = findFrom(\n            _cs.mem.db.consents,\n            {\n                purposeDeclarationId: req.purposeDeclarationId,\n                dataSubject: req.subjectId,\n                revoked: false,\n            }\n        );\n\n        if (consent === undefined) {\n            return this.withErrorResponse(\n                setActivePD(_cs, req.subjectId, {\n                    clientId: req.clientId,\n                    purposeDeclarationId: req.purposeDeclarationId,\n                    callbackURL: req.callbackURL\n                }),\n                msg,\n                \"consent_not_found\"\n            );\n        }\n\n        return this.withResponse<ConsentReferenceResponse>(\n            _cs,\n            msg,\n            {\n                type: ConsentReferenceResponseTypeName,\n                clientId: msg.message.clientId,\n                purposeDeclarationId: msg.message.purposeDeclarationId,\n                consentReference: consent.consentReference\n            })\n    }\n}\n\nexport const getConsentReference = addHandlerClass<ConsentReferenceRequest, GetConsentReferenceMessage>(ConsentService, GetConsentReferenceMessage);\n\n","import { ProcessImplName, ViewName, ProcessState, Payload } from \"../Base\";\nimport { ServiceDeclaration } from \"../consentService/types\";\n\n\nexport const ServiceProviderIS : ProcessImplName = \"ServiceProviderIS\";\nexport const ServiceProviderDefaultView : ViewName = \"defaultView\";\n\nexport interface ServiceProviderPS extends ProcessState<ServiceProviderState> {\n    type: typeof ServiceProviderIS;\n    view: typeof ServiceProviderDefaultView;\n}\n\n\nexport interface SecretRecord {\n    key: string;\n    type: string;\n    subject: string;\n    data: any;\n} \n\nexport interface ServiceConfig {\n    consentService: string;\n    serviceName: string;\n    requiredServiceDeclarationIds: string[];\n    returnedDatatypes: string[];\n}\n\nexport const requestTypeName = \"SP/request\";\n\nexport interface ServiceRequest extends Payload {\n    type: typeof requestTypeName;\n    clientId: string;\n    serviceName: string;\n    subjectId: string;\n    consentReference?: string;\n    requestReference: string;\n}\n\nexport const responseTypeName = \"SP/request/response\";\n\nexport interface ServiceResponse extends Payload {\n    asyncId: string; // response correlation id\n    records : SecretRecord[];\n}\n\nexport interface RequestState extends ServiceRequest {\n    validationRequestId: string; // internal, to match response\n    validationResponse?: any;\n    clientAddress: string;\n}\n\nexport type ServiceDeclarationTemplate = Partial<ServiceDeclaration> & { serviceDeclarationId: string };\n\nexport interface ServiceProviderState { \n    db: SecretRecord[];\n    services: ServiceConfig[];\n    inflight: RequestState[]; // requests received but not properly responded\n    declTemplate?: ServiceDeclarationTemplate[];\n}\n","import { GenericMessageHandler, Payload, Message, addHandlerClass } from \"../Base\";\nimport { ConsentServicePS, ConsentServiceState, ConsentService } from \"./types\";\nimport { address2org } from \"../../util\";\n\n\nexport interface ValidationRequest extends Payload {\n    type: typeof ValidationRequestHandler.name;\n    asyncId: string; // internal identifier to help SP to match answer to a request\n    partyId: string;\n    consentReference: string;\n    requestReference: string;\n}\n\nexport const ValidationResponseTypeName = \"CS/validateConsentReference/response\";\nexport interface ValidationResponse extends Payload {\n    type: typeof ValidationResponseTypeName;\n    asyncId: string; // internal identifier. same as in the request\n    valid: boolean;\n    consentReference?: string;\n    consentExpiration?: string; // timestamp\n    validationExpiration?: string;\n    dataSubjectId?: string;\n    clientId?: string;\n    purposeDeclarationId?: string;\n    serviceDeclarationId?: string[];\n}\n\nconst NotValidResponse : ValidationResponse = {\n    type: ValidationResponseTypeName,\n    asyncId: \"\",\n    valid: false,\n}\n\nclass ValidationRequestHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ValidationRequest, ValidationRequestHandler> {\n    name = \"CS/validateConsentReference\";\n\n    notValid(cs: ConsentServicePS, action: Message<ValidationRequest>): ConsentServicePS {\n        return this.withResponse<ValidationResponse>(cs, action, { ...NotValidResponse, asyncId: action.message.asyncId });\n    }\n\n    handle(cs: ConsentServicePS, action: Message<ValidationRequest>): ConsentServicePS {\n        let consent = cs.mem.db.consents.find(c => c.consentReference === action.message.consentReference);\n\n        if (consent === undefined) {\n            console.log(\"No such consent found: \", action.message.consentReference);\n            return this.notValid(cs, action);\n        }\n\n        let now = action.now!;\n\n        if (consent.revoked || now < consent.validFrom || now > consent.validUntil) {\n            console.log(`Consent ${consent} is not valid`);\n            return this.notValid(cs, action);\n        }\n\n        let sender = address2org(action.sender);\n\n        // find services that the sender of the request is allowed to provide under the consent in question\n        let purposeDeclaration = cs.mem.db.purposeDeclarations.find(\n            pd => (pd.clientId === consent!.clientId && pd.purposeDeclarationId === consent!.purposeDeclarationId)\n        );\n\n        if (purposeDeclaration === undefined) {\n            console.error(\"Cannot find purposeDeclaration that matches to an existing consent?\");\n            return this.notValid(cs, action);\n        }\n\n        // services that the asking party is allowed to provide with this consent\n        let services = (purposeDeclaration.services\n            .filter(s => s.serviceProviderId === sender)\n            .map(s => s.serviceDeclarationId)\n        );\n\n        if (sender === consent.clientId) {\n            let response: ValidationResponse = {\n                type: ValidationResponseTypeName,\n                asyncId: action.message.asyncId,\n                valid: true,\n                consentReference: action.message.consentReference,\n                consentExpiration: new Date(consent.validUntil * 1000).toISOString(),\n                dataSubjectId: consent.dataSubject,\n                clientId: consent.clientId,\n                purposeDeclarationId: consent.purposeDeclarationId,\n                // this is not empty if the client and service provider are the same\n                // (data repurposing using the consent)\n                serviceDeclarationId: services,\n            }\n            return this.withResponse(cs, action, response);\n        }\n\n        // it was not the party that declared the purpose. if it is party whose service declaration was\n        // referenced from the purpose declaration, then it still might get the answer\n        if (services.length > 0) {\n            let response: ValidationResponse = {\n                type: ValidationResponseTypeName,\n                asyncId: action.message.asyncId,\n                valid: true,\n                consentReference: action.message.consentReference,\n                consentExpiration: new Date(consent.validUntil * 1000).toISOString(),\n                dataSubjectId: consent.dataSubject,\n                clientId: consent.clientId,\n                serviceDeclarationId: services,\n            }\n            return this.withResponse(cs, action, response);\n        }\n\n        // not the client, not the service provider => not authorized to get anything.\n        return this.notValid(cs, action);\n    }\n}\n\nexport const validateConsentReference = addHandlerClass<ValidationRequest, ValidationRequestHandler>(ConsentService, ValidationRequestHandler);\n\n","import { UsageRecord, ConsentServiceState, ConsentServicePS, ConsentService } from \"./types\";\nimport { GenericMessageHandler, Message, addHandlerClass, Payload, updateDb } from \"../Base\";\n\ninterface ServiceUseMessage extends UsageRecord, Payload {\n    type: typeof ReportServiceUseMessage.name;\n}\n\nclass ReportServiceUseMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ServiceUseMessage, ReportServiceUseMessage> {\n    name: string = \"CS/reportServiceUsage\";\n\n    addUsageRecord(cs: ConsentServicePS, sd: UsageRecord) {\n        return updateDb(cs, { usageLog : cs.mem.db.usageLog.concat(sd)});\n    }\n\n    handle (cs: ConsentServicePS, msg: Message<ServiceUseMessage>) {\n        return this.withOkResponse(this.addUsageRecord(cs, {...msg.message, type: undefined } as UsageRecord), msg);\n    }\n}\n\nexport const reportServiceUse = addHandlerClass<ServiceUseMessage, ReportServiceUseMessage>(ConsentService, ReportServiceUseMessage);\n\n","import { GenericMessageHandler, Payload, Message, message, addHandlerClass, ErrorPayload } from \"../Base\";\nimport { ServiceProviderState, ServiceProviderPS, ServiceProviderIS, SecretRecord, ServiceRequest, requestTypeName, RequestState, ServiceConfig } from \"./types\";\nimport { addServiceDeclaration } from \"../consentService/declarationAPI\";\nimport { validateConsentReference, ValidationResponse, ValidationResponseTypeName } from \"../consentService/validationAPI\";\nimport { reportServiceUse } from \"../consentService/reportingAPI\";\nimport { submitResponse } from \"../client/messages\";\nimport { hash, address2org } from \"../../util\";\nimport { UsageRecord } from \"../consentService/types\";\n\ninterface DataPayload extends Payload {\n    type: typeof DataEntryHandler.name;\n    key: string;\n    datatype?: string;\n    subject?: string;\n    data?: any;\n}\n\nclass DataEntryHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, DataPayload, DataEntryHandler> {\n    name = \"ServiceProvider/UI/addData\";\n\n    handle (spis: ServiceProviderPS, action: Message<DataPayload>): ServiceProviderPS {\n        if (action.message.datatype === undefined || action.message.datatype === \"\") {\n            return { ...spis, mem: { ...spis.mem, db: spis.mem.db.filter(r => (r.key !== action.message.key)) } };\n        }\n\n        let rec = action.message;\n        let dbrec : SecretRecord = { key: rec.key, type: rec.datatype!, subject: rec.subject!, data: rec.data! };\n\n        return { ...spis, mem: { ...spis.mem, db: spis.mem.db.concat(dbrec) } }\n    }\n}\n\nexport const addData = addHandlerClass<DataPayload, DataEntryHandler>(ServiceProviderIS, DataEntryHandler);\n\nclass SendDeclarationHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, Payload, SendDeclarationHandler> {\n    name = \"ServiceProvider/UI/declareService\";\n\n    handle(spis: ServiceProviderPS, action: Message<Payload>): ServiceProviderPS {\n        // FIXME: korrektne CS väärtus\n        return this.send(spis, message(action.arena, spis, [ spis.mem.services[0].consentService ], addServiceDeclaration()(action.message)))\n    }\n}\n\nexport const declareService = addHandlerClass(ServiceProviderIS, SendDeclarationHandler);\n\nfunction requestId(req: ServiceRequest, service: ServiceConfig): string {\n    let input = req.clientId + req.consentReference + req.requestReference + \n             req.serviceName + req.subjectId + service.consentService;\n    \n    return hash(input);\n}\n\nclass ProtectedRequestHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, ServiceRequest, ProtectedRequestHandler> {\n    name = requestTypeName;\n    handle(spis: ServiceProviderPS, action: Message<ServiceRequest>): ServiceProviderPS {\n\n        function _send<P extends Payload>(receivers: string[], m: P): Message<P> {\n            return message(action.arena, spis, receivers, m);     \n        }\n\n        let req : ServiceRequest = action.message;\n        // validate request (find service record from config)\n        let service = spis.mem.services.find(s => s.serviceName === req.serviceName);\n        if (service === undefined) {\n            // no reporting -- \"the request did not reach the relevant endpoint\"\n            return this.withErrorResponse(spis, action, \"invalid_request\");\n        }\n\n        if (req.clientId !== address2org(action.sender)) {\n            // FIXME: here we COULD report something?\n            return this.withErrorResponse(spis, action, \"invalid_request\");\n        }\n\n        if(!req.consentReference) {\n            const report : UsageRecord = { \n                result: \"ACCESS_DENIED\", \n                clientId : req.clientId,\n                subjectId: req.subjectId,\n                serviceDeclarationIds: service.requiredServiceDeclarationIds, \n                requestReference: req.requestReference,\n                serviceProviderId: address2org(spis.name),\n                usageTime : action.now!,\n            }\n            return this.send(\n                this.send(\n                    spis,\n                    _send([service.consentService],reportServiceUse()(report))\n                ),\n                _send<ErrorPayload>([action.sender], {type : \"error\", error : \"ACCESS_DENIED\"})\n            )\n        }\n\n        // store inflight query\n        // spis.mem.inflight += [inflight]\n        let reqState : RequestState = { \n            ...req,\n             validationRequestId: requestId(req, service),\n             clientAddress: action.sender,\n        }\n        let withInfligh : ServiceProviderPS = {\n            ...spis, mem: { ...spis.mem, inflight: spis.mem.inflight.concat(reqState) }\n        };\n\n        // send consent reference validation request\n        return this.send(\n            withInfligh, \n            message(\n                action.arena,\n                 withInfligh,\n                  [ service.consentService ],\n                  validateConsentReference()({\n                      asyncId: reqState.validationRequestId,\n                      partyId: spis.name,\n                      consentReference: req.consentReference,\n                      requestReference: req.requestReference,\n                  })\n            )\n        );\n    }\n}\n\nexport const submitRequest = addHandlerClass<ServiceRequest, ProtectedRequestHandler>(ServiceProviderIS, ProtectedRequestHandler);\n\n\nclass ValidationResponseHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, ValidationResponse, ValidationResponseHandler> {\n    name = ValidationResponseTypeName;\n\n    handle(spis: ServiceProviderPS, action: Message<ValidationResponse>): ServiceProviderPS {\n\n        function _send<P extends Payload>(receivers: string[], m: P): Message<P> {\n            return message(action.arena, spis, receivers, m);     \n        }\n        \n        const reqState = spis.mem.inflight.find(ifr => ifr.validationRequestId === action.message.asyncId);\n        const resp = action.message;\n\n        function removeInflight(spis: ServiceProviderPS): ServiceProviderPS {\n            return { ...spis, mem: { ...spis.mem, inflight: spis.mem.inflight.filter(\n                ifr => (reqState === undefined || ifr.requestReference !== reqState.requestReference)\n            ) }};\n        }\n\n\n        if (reqState === undefined) {\n            console.error(\"Failed to find original inflight request, ignoring the response.\");\n            return spis;\n        }\n\n        const service = spis.mem.services.find(s => s.serviceName === reqState.serviceName);\n        if (service === undefined) {\n            console.error(\"Failed to find the service specified in the original inflight request, ignoring the response.\");\n            return removeInflight(spis);\n        }\n\n        const usageReport : UsageRecord = { \n            result: \"OK\", // will be overwritten\n            clientId : reqState.clientId,\n            subjectId: reqState.subjectId,\n            serviceDeclarationIds: service.requiredServiceDeclarationIds, \n            consentReference: reqState.consentReference,\n            requestReference: reqState.requestReference,\n            serviceProviderId: address2org(spis.name),\n            usageTime : action.now!,\n        }\n\n        if (!resp.valid \n                || resp.clientId !== reqState.clientId \n                || resp.consentReference !== reqState.consentReference \n                || resp.dataSubjectId !== reqState.subjectId\n                || resp.serviceDeclarationId === undefined\n                // (there is a required serviceDeclarationId that is not on the consent)\n                || service.requiredServiceDeclarationIds\n                        .find(sd => !resp.serviceDeclarationId!.includes(sd))\n                ) {     \n            return this.send(\n                this.send(\n                    removeInflight(spis),\n                    _send([service.consentService], reportServiceUse()({...usageReport, result : \"ACCESS_DENIED\"}))\n                ),\n                _send<ErrorPayload>([reqState.clientAddress], {type : \"error\", error : \"ACCESS_DENIED\"})\n            )\n        };\n    \n        return this.send(\n            this.send(\n                removeInflight(spis),\n                _send([service.consentService], reportServiceUse()({...usageReport, result : \"OK\"}))\n            ),\n            _send(\n                [reqState.clientAddress],\n                submitResponse()({\n                    records : spis.mem.db\n                        .filter(x => x.subject === reqState.subjectId)\n                        .filter(x => service.returnedDatatypes.includes(x.type)),\n                    asyncId : reqState.requestReference    \n                })\n            )\n        );\n    }\n}\n\nexport const validationResponse = addHandlerClass<ValidationResponse, ValidationResponseHandler>(ServiceProviderIS, ValidationResponseHandler);\n","import { addHandlerClass, Payload, GenericMessageHandler, Message, message, ErrorPayload, updateDb } from \"../Base\";\nimport { ClientIS, ClientState, ClientPS } from \"./types\";\n\nimport { addPurposeDeclaration } from \"../consentService/declarationAPI\";\nimport { getConsentReference, ConsentReferenceResponse, ConsentReferenceResponseTypeName } from \"../consentService/referenceAPI\";\n\nimport { submitRequest } from \"../serviceProvider/messages\";\nimport { ServiceResponse, responseTypeName } from \"../serviceProvider/types\";\n\nimport { hash, address2org } from \"../../util\";\nimport { validateConsentReference } from \"../consentService/validationAPI\";\n\n\ninterface LoginMessage extends Payload {\n    type: typeof LoginMessageHandler.name;\n    user?: string;\n}\n\nclass LoginMessageHandler extends GenericMessageHandler<ClientState, ClientPS, LoginMessage, LoginMessageHandler> {\n    name = \"Client/UI/login\";\n\n    handle(cs: ClientPS, action: Message<LoginMessage>): ClientPS {\n        // reset cached responses when logging in.\n        return { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, user: action.message.user, service: undefined, response: [] } } };\n    }\n}\n\nexport const loginMessage = addHandlerClass<LoginMessage, LoginMessageHandler>(ClientIS, LoginMessageHandler);\n\ninterface SelectServiceMessage extends Payload {\n    type: typeof SelectServiceMessageHandler.name;\n    service?: string;\n}\n\nclass SelectServiceMessageHandler extends GenericMessageHandler<ClientState, ClientPS, SelectServiceMessage, SelectServiceMessageHandler> {\n    name = \"Client/UI/selectService\";\n\n    handle(cs: ClientPS, action: Message<SelectServiceMessage>): ClientPS {\n        let _cs = { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, service: action.message.service, response: [] } } };\n\n        if (_cs.mem.ui.service !== undefined) {\n            // if cached consentref is missing (not asked or known to not exist), ask automatically for new\n            let cachedConsentRefs = _cs.mem.db.consentRefByUser[_cs.mem.ui.user!];\n            let cachedConsentRef = cachedConsentRefs === undefined ? undefined : cachedConsentRefs[_cs.mem.ui.service!];\n            if (cachedConsentRef === undefined || cachedConsentRef === null) {\n                return this.send(_cs, message(action.arena, cs, [cs.mem.db.consentServiceId], \n                    getConsentReference({ \n                        clientId: address2org(cs.name),\n                        subjectId: cs.mem.ui.user,\n                        purposeDeclarationId: action.message.service,\n                        callbackURL: cs.name, // actual address for callback message\n                    })()\n                ));\n            }\n        }\n\n        return _cs;\n    }\n}\n\nexport const selectServiceMessage = addHandlerClass<SelectServiceMessage, SelectServiceMessageHandler>(ClientIS, SelectServiceMessageHandler);\n\n\n\nclass SendDeclarationHandler extends GenericMessageHandler<ClientState, ClientPS, Payload, SendDeclarationHandler> {\n    name = \"Client/UI/declarePurpose\";\n\n    handle(cis: ClientPS, action: Message<Payload>): ClientPS {\n        return this.send(cis, message(action.arena, cis, [ cis.mem.db.consentServiceId ], addPurposeDeclaration()(action.message)))\n    }\n}\n\nexport const declarePurpose = addHandlerClass(ClientIS, SendDeclarationHandler);\n\ninterface FetchConsentReferencePayload extends Payload {\n    type: typeof FetchConsentReferenceHandler.name;\n    purposeDeclarationId: string;\n}\n\nclass FetchConsentReferenceHandler extends GenericMessageHandler<ClientState, ClientPS, FetchConsentReferencePayload, FetchConsentReferenceHandler> {\n    name = \"Client/UI/fetchConsentReference\";\n\n    handle(cis: ClientPS, action: Message<FetchConsentReferencePayload>): ClientPS {\n        return this.send(\n            updateDb<typeof cis.mem.db, ClientState>({\n                ...cis,\n                mem: {\n                    ...cis.mem,\n                    ui: {\n                        ...cis.mem.ui,\n                        service: action.message.purposeDeclarationId\n                    }\n                }\n            }, { \n                consentRefByUser: updateCSRef(\n                    cis.mem.db.consentRefByUser,\n                    cis.mem.ui.user!,\n                    action.message.purposeDeclarationId,\n                    undefined\n                )\n             }), \n            message(action.arena, cis, [cis.mem.db.consentServiceId], getConsentReference({\n                clientId: address2org(cis.name),\n                purposeDeclarationId: action.message.purposeDeclarationId,\n                subjectId: cis.mem.ui.user,\n                callbackURL: cis.name, // actual address for callback message\n            })()\n        ))\n    }\n}\n\nexport const fetchConsentReference = addHandlerClass<FetchConsentReferencePayload, FetchConsentReferenceHandler>(ClientIS, FetchConsentReferenceHandler);\n\nfunction updateCSRef<T extends { [k: string]: any }>(csByUser: T, user: string, purposeDeclarationId: string, consentReference?: string | null): T {\n    return {\n        ...csByUser,\n        [user]: { ...csByUser[user], [purposeDeclarationId]: consentReference }\n    };\n}\n\nclass ConsentReferenceResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ConsentReferenceResponse, ConsentReferenceResponseHandler> {\n    name = ConsentReferenceResponseTypeName;\n\n    handle(cis: ClientPS, action: Message<ConsentReferenceResponse>): ClientPS {\n        return { ...cis, mem: { ...cis.mem, db: { \n            ...cis.mem.db,\n            consentRefByUser: updateCSRef(\n                cis.mem.db.consentRefByUser,\n                cis.mem.ui.user!,\n                action.message.purposeDeclarationId,\n                action.message.consentReference\n            )\n        } } };\n    }\n}\n\nexport const handleConsentRefernceResponse = addHandlerClass<ConsentReferenceResponse, ConsentReferenceResponseHandler>(ClientIS, ConsentReferenceResponseHandler);\n\ninterface ExecuteMessage extends Payload {\n    type: typeof ExecuteRequestHandler.name;\n    requestReference: string; // generated in UI because it should not be done here.\n    purposeId: string;\n    serviceAddress?: string; // only execute one request.\n    serviceName?: string;\n}\n\nclass ExecuteRequestHandler extends GenericMessageHandler<ClientState, ClientPS, ExecuteMessage, ExecuteRequestHandler> {\n    name = \"Client/UI/executeRequest\";\n\n    handle(cis: ClientPS, action: Message<ExecuteMessage>): ClientPS {\n        let req = action.message;\n\n        let userConsentRefs = cis.mem.db.consentRefByUser[cis.mem.ui.user!];\n        let consentReference = userConsentRefs === undefined ? undefined : userConsentRefs[req.purposeId];\n\n        let conf = cis.mem.config.find(c => c.purposeDeclarationId === req.purposeId);\n        if (conf === undefined) {\n            console.error(\"Unknown purpose? \", req);\n            return cis;\n        }\n\n        // send request for all services defined in configuration, or to those that match.\n        return (conf.services\n            .filter(service => ((req.serviceAddress === undefined || req.serviceAddress === service.serviceAddress)\n                    && (req.serviceName === undefined || req.serviceName === service.serviceName)))\n            .reduce((_cis, service) => {\n            let requestReference = hash(req.requestReference + service.serviceName + service.serviceAddress);\n            // eslint-disable-next-line\n            let cis = undefined;\n            \n            // replace or add response record for this particular purpose/serviceprovider/service\n            let newResponses = (_cis.mem.ui.response || []).filter(\n                r => !(r.purposeDeclarationId === req.purposeId \n                        && r.serviceAddress === service.serviceAddress \n                        && r.serviceName === service.serviceName)\n            ).concat({\n                requestReferenceId: requestReference,\n                purposeDeclarationId: req.purposeId,\n                serviceAddress: service.serviceAddress,\n                serviceName: service.serviceName,\n                data: null,\n            })\n\n            let __cis = { ..._cis, mem: { ..._cis.mem, ui: { \n                ..._cis.mem.ui,\n                 response: newResponses,\n            } } };\n\n            return this.send(__cis, message(action.arena, __cis, [service.serviceAddress], submitRequest({\n                clientId: address2org(__cis.name),\n                serviceName: service.serviceName,\n                subjectId: __cis.mem.ui.user,\n                consentReference: consentReference!,\n                requestReference: requestReference,\n            })()))\n        }, cis));\n    }\n}\n\nexport const executeRequest = addHandlerClass<ExecuteMessage, ExecuteRequestHandler>(ClientIS, ExecuteRequestHandler);\nexport function generateRequestReference() : string {\n    return hash(\"\" + ((Math.random() * 1000000) | 0));\n}\n\n\nclass ServiceResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ServiceResponse, ServiceResponseHandler> {\n    name = responseTypeName;\n\n    handle(cis: ClientPS, action: Message<ServiceResponse>): ClientPS {\n        return { ...cis, mem: { ...cis.mem, ui: {\n            ...cis.mem.ui,\n            response: (cis.mem.ui.response || []).map(\n                r => {\n                    if (r.requestReferenceId === action.message.asyncId) {\n                        return { ...r, data: action.message.records }\n                    } else {\n                        return r;\n                    }\n                }\n            )\n        }}}\n    }\n\n}\n\nexport const submitResponse = addHandlerClass<ServiceResponse, ServiceResponseHandler>(ClientIS, ServiceResponseHandler);\n\nclass ErrorResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ErrorPayload, ErrorResponseHandler> {\n    name = \"error\";\n\n    handle(cis: ClientPS, action: Message<ErrorPayload>): ClientPS {\n        switch (action.message.error) {\n            // assume the respone came for logged in user and for selected service\n            case \"consent_not_found\":\n                return updateDb<typeof cis.mem.db, ClientState>(cis, { \n                    consentRefByUser: updateCSRef(\n                        cis.mem.db.consentRefByUser,\n                        cis.mem.ui.user!,\n                        cis.mem.ui.service!,\n                        null\n                    )\n                });\n        }\n\n        console.log(\"Unknown error, ignoring: \", action);\n        return cis;\n    }\n}\n\naddHandlerClass<ErrorPayload, ErrorResponseHandler>(ClientIS, ErrorResponseHandler);\n\ninterface UpdateConsentReferencePayload extends Payload {\n    type: typeof UpdateConsentReferenceHandler.name;\n    purposeDeclarationId?: string;\n    consentReference?: string;\n}\n\nclass UpdateConsentReferenceHandler extends GenericMessageHandler<ClientState, ClientPS, UpdateConsentReferencePayload, UpdateConsentReferenceHandler> {\n    name = \"CS/UI/dumpConsentRefCache\";\n\n    handle(cis: ClientPS, action: Message<UpdateConsentReferencePayload>): ClientPS {\n        if (action.message.purposeDeclarationId !== undefined) {\n            return updateDb<typeof cis.mem.db, ClientState>(cis, { \n                consentRefByUser: updateCSRef(\n                    cis.mem.db.consentRefByUser,\n                    cis.mem.ui.user!,\n                    action.message.purposeDeclarationId,\n                    action.message.consentReference\n                )\n            });\n        }\n        return updateDb<typeof cis.mem.db, ClientState>(cis, { consentRefByUser: {} });\n    }\n}\n\nexport const updateConsentRefInCache = addHandlerClass<UpdateConsentReferencePayload, UpdateConsentReferenceHandler>(ClientIS, UpdateConsentReferenceHandler);\n\ninterface ValidateConsentRefMessage extends Payload {\n    consentServiceId: string;\n    consentReference: string;\n}\n\nclass ValidateConsentRefMessageHandler extends GenericMessageHandler<ClientState, ClientPS, ValidateConsentRefMessage, ValidateConsentRefMessageHandler> {\n    name = \"Client/UI/validateConsentRef\";\n\n    handle(cis: ClientPS, action: Message<ValidateConsentRefMessage>): ClientPS {\n        return this.send(\n            cis, \n            message(action.arena, cis, [action.message.consentServiceId || cis.mem.db.consentServiceId],\n                validateConsentReference({ \n                    partyId: cis.name,\n                    consentReference: action.message.consentReference\n                })()\n            )\n        );\n    }\n}\n\nexport const validateConsentRef = addHandlerClass<ValidateConsentRefMessage, ValidateConsentRefMessageHandler>(ClientIS, ValidateConsentRefMessageHandler);\n","import * as React from \"react\";\nimport { ProcessAndArena, Message, message } from \"../Base\";\nimport { ClientState } from \"./types\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { SimpleSend } from \"../../components/SendButton\";\nimport { loginMessage, selectServiceMessage, fetchConsentReference, executeRequest, generateRequestReference } from \"./messages\";\nimport { connect } from \"react-redux\";\nimport { __, fullname } from \"../../i18n\";\n\ninterface ClientViewProps extends ProcessAndArena<ClientState> {\n    t: any;\n    send: (props: ClientViewProps, values?: any) => Message<any>;\n}\n\n\nconst LOGIN: ClientViewState = \"login\";  // no authenticated user\nconst SELECT_SERVICE: ClientViewState = \"selectService\"; // user authenticated, service not selected\nconst WAIT_FOR_CONSENT_REF: ClientViewState = \"waitForConsent\"; //  no idea if user has consent\nconst CONSENT_NOT_FOUND: ClientViewState = \"consentNotFound\"; // prompt for consent\nconst SERVICE_V1: ClientViewState = \"serviceV1\";\n\ntype ClientViewState = \"login\" | \"selectService\" | \"waitForConsent\" | \"consentNotFound\" | \"serviceV1\";\n\ninterface State {\n    view: ClientViewState;\n    loading: boolean;\n}\n  \n  const Header = ({t, props} : {t: any; props: ClientViewProps}) => (\n  <div className=\"app-header\">\n    <SimpleSend arena={props.arena} owner={props.process} className=\"btn btn-success btn-health\" text={ t('logout') } message={ loginMessage() }/>\n    <div className=\"app-user-icon\">\n      <img alt=\"user icon\" src={require('./../../static/assets/images/user-icon.svg')} />\n    </div>\n    <p className=\"app-user\">{ t('hello').replace(\"USERNAME\", fullname(props.process.mem.ui.user!)) }</p>\n  </div>\n);\n\nfunction send(props: ClientViewProps, values?: any): Message<any> {\n    return message(props.arena, props.process, [props.process.name], values());\n}\n\nfunction currentView(m: ClientState): ClientViewState {\n    if (m.ui.user === undefined) {\n        return LOGIN;\n    } else if (m.ui.service === undefined) {\n        return SELECT_SERVICE;\n    } else if (m.db.consentRefByUser[m.ui.user] === undefined || \n            m.db.consentRefByUser[m.ui.user][m.ui.service] === undefined) {\n        return WAIT_FOR_CONSENT_REF;\n    } else if (m.db.consentRefByUser[m.ui.user][m.ui.service] === null) {\n        return CONSENT_NOT_FOUND;\n    } else {\n        return SERVICE_V1;\n    }\n}\n\nclass ClientView_ extends React.PureComponent<ClientViewProps, State> {\n\n  constructor(props: ClientViewProps) {\n    super(props);\n      this.state = { loading: false, view: currentView(props.process.mem) };\n      switch (this.state.view) {\n        case WAIT_FOR_CONSENT_REF:\n          this.sendMessagesFor(this.state.view);\n      }\n  }\n\n  componentDidMount() {\n    this.componentDidUpdate();    \n  }\n\n  componentDidUpdate() {\n    let actualView = currentView(this.props.process.mem);\n    if (actualView !== this.state.view) {\n      this.setState({ view: actualView });\n    }\n  }\n\n  sendMessagesFor = (view: ClientViewState) => {\n    const mem = this.props.process.mem;\n    switch (view) {\n        case WAIT_FOR_CONSENT_REF:\n            if (mem.ui.user !== undefined && mem.ui.service !== undefined && (\n                    mem.db.consentRefByUser[mem.ui.user] === undefined ||\n                    mem.db.consentRefByUser[mem.ui.user][mem.ui.service] === undefined ||\n                    mem.db.consentRefByUser[mem.ui.user][mem.ui.service] === null)\n            ) {\n                this.props.send(this.props, fetchConsentReference({ purposeDeclarationId: mem.ui.service }));\n            }\n            return;\n\n        case SERVICE_V1:\n            this.props.send(this.props, executeRequest({\n                requestReference: generateRequestReference(),\n                purposeId: mem.ui.service }));\n            return;\n    }\n  }\n\n  state = {\n    view: LOGIN,\n    loading: false\n  };\n\n  changeView = (view: ClientViewState, withMessages = true) => {\n    this.setState({ loading: true });\n    if (withMessages) {\n        this.sendMessagesFor(view);\n    }\n    setTimeout(() => {\n      this.setState({loading: false, view: view});\n    }, 600);\n  };\n\n  render() {\n    const cis = this.props.process;\n    const m = cis.mem;\n    const t = this.props.t;\n\n    const returnButton = (\n      <SimpleSend\n        arena={this.props.arena}\n        owner={this.props.process}\n        className=\"btn btn-light border\"\n        onClick={() => this.changeView(SELECT_SERVICE)}\n        message={selectServiceMessage()}\n        text={ t(\"return\") }\n      />\n    );\n\n    switch (this.state.loading) {\n      case true:\n      return (\n        <div className=\"d-flex align-items-center\">\n          <strong>Loading...</strong>\n          <div className=\"spinner-border ml-auto\" role=\"status\" aria-hidden=\"true\"></div>\n        </div>\n      );\n      default:\n        switch (this.state.view) {\n          case LOGIN:\n          return (\n            <div><form>\n                <h4>{ t(\"please_login\") }</h4>\n                <div>\n                  <div className=\"input-group\">\n                    <input className=\"form-control\" size={10} name=\"user\" defaultValue=\"47302200234\"/>\n                    <div className=\"input-group-append\">\n                      <SimpleSend\n                          arena={this.props.arena}\n                          owner={this.props.process}\n                          className=\"btn btn-light border\"\n                          onClick={() => this.changeView(SELECT_SERVICE)}\n                          message={loginMessage()}\n                          text={ t(\"login\") }\n                      />\n                    </div>\n                  </div>\n                </div>\n                <p className=\"mt-4 mb-0\">\n                    <img alt=\"illustration\" src={require('./../../static/assets/images/login.svg')} width=\"280\" />\n                </p>\n            </form></div>\n          );\n          case SELECT_SERVICE:\n          return (\n            <div>\n              <Header t={t} props={this.props} />\n          <h4>{ t(\"choose_service\") }</h4>\n              {\n                  this.props.process.mem.config.map(\n                      service => {\n                          return (\n                            <SimpleSend \n                                key={ service.purposeDeclarationId }\n                                className=\"btn btn-dark mt-2 mr-2\"\n                                arena={this.props.arena}\n                                owner={this.props.process}\n                                onClick={() => this.changeView(WAIT_FOR_CONSENT_REF)}\n                                message={selectServiceMessage({ service: service.purposeDeclarationId })}\n                                text={ t(\"service\", service.purposeDeclarationId, \"name\") }\n                             />                \n                          )\n                      }\n                  )\n              }\n            </div>\n          );\n          case WAIT_FOR_CONSENT_REF:\n              return (\n                  <div>\n                      <Header t={t} props={this.props} />\n                      <h4>{ t(\"checking_consent\") }</h4>\n                      <p className=\"text-left\">{ t(\"retry_if_timed_out\") }</p>\n                      <SimpleSend\n                            className=\"btn btn-dark\"\n                            arena={this.props.arena}\n                            owner={this.props.process}\n                            message={fetchConsentReference({ purposeDeclarationId: m.ui.service })}\n                            text={ t('retry-fetch') }\n                      />\n                  </div>\n              );\n          case CONSENT_NOT_FOUND:\n          return (\n            <div>\n              <Header t={t} props={this.props} />\n              <h4>{ t(\"service\", m.ui.service!, \"consent-header\") }</h4>\n              <p className=\"text-left\">\n                <small dangerouslySetInnerHTML={{__html: t(\"service\", m.ui.service!, \"consent-intro\")}} />\n              </p>\n              <p>\n                 <button className=\"btn btn-lg btn-primary\" onClick={ev => window.open(\"ui/csui/\", this.props.arena + \" - \" + m.db.consentServiceId) }>Annan nõusoleku</button>\n              </p>\n              <p>{ returnButton }</p>\n            </div>\n          );\n          case SERVICE_V1:\n              return (\n                  <div>\n                      <Header t={t} props={this.props} />\n                      <h4>{ t(\"consented_data\") }</h4>\n                      {\n                        (m.ui.response || []).filter(\n                            r => r.purposeDeclarationId === m.ui.service\n                        ).map(\n                            r => (\n                                <span className=\"card\" key={r.serviceAddress + \" \" + r.serviceName}>\n                                    <pre className=\"text-left\">\n                                        {r.serviceAddress}/{r.serviceName}: { JSON.stringify(r.data, undefined, \" \") }\n                                    </pre>\n                                </span>\n                            )\n                        )\n                      }\n                    <p>\n                      <SimpleSend\n                        owner={this.props.process}\n                        arena={this.props.arena}\n                        message={executeRequest({\n                          requestReference: generateRequestReference(),\n                          purposeId: m.ui.service\n                      })} text={ t('load-consented-data') } />\n                    </p>\n                    <p>{ returnButton }</p>\n                  </div>\n              )\n          default:\n          return <div>Unimplemented view: {this.state.view}</div>\n        }\n    }\n  }\n}\n\nconst ClientView = connect(null, { send })(ClientView_);\n\nconst EnduserUI : React.FC<ProcessAndArena<ClientState>> = ({process, arena}) => {\n\n    const t = (...k: string[]) => __({arena, process}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n\n    return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"lg\" bsPrefix=\"client-app modal\">\n          <Modal.Header>\n            <Modal.Title>{ t('title') }</Modal.Title>\n          </Modal.Header>\n          <Modal.Body>\n            <ClientView arena={arena} process={process} t={t}/>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"outline-dark\" onClick={handleClose}>{ t('close') }</Button>\n          </Modal.Footer>\n        </Modal>\n        <Button variant=\"success\" className=\"mr-2 btn-health\" onClick={handleShow}>{t('open-end-user-view')}</Button>\n        </>\n      )\n}\n  \n\nexport default EnduserUI;","import { ProcessAndArena } from \"../Base\";\nimport { ClientState, ClientPS, PurposeDeclarationTemplate, ClientConfig } from \"./types\";\nimport React from \"react\";\nimport { Modal, Button, Dropdown, ButtonProps } from \"react-bootstrap\";\nimport { SimpleSend } from \"../../components/SendButton\";\nimport { declarePurpose, executeRequest, fetchConsentReference, generateRequestReference, updateConsentRefInCache, validateConsentRef } from \"./messages\";\nimport EnduserUI from \"./EnduserUI\";\nimport { __, business } from \"../../i18n\";\nimport { address2org } from \"../../util\";\n\n\ninterface ClientViewProps extends ProcessAndArena<ClientState> {\n    process: ClientPS;\n}\n\ntype SDRef = {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n}\n\nfunction addSDRef(ev: any, opts: SDRef[], setOpts: React.Dispatch<React.SetStateAction<SDRef[]>> ) {\n    ev.preventDefault();\n    let f = ev.currentTarget.form;\n\n    let spId = f._spId.value;\n    let sdId = f._sdId.value;\n\n    if (!spId.match(\"^[!-~]+$\") || !sdId.match(\"^[!-~]+$\")) {\n        return;\n    }\n    \n    setOpts(old => old.concat({ serviceProviderId: spId, serviceDeclarationId: sdId }));\n    f._spId.value = f._sdId.value = \"\";\n}\n\nfunction prefillPurposeDeclaration(ev: any, decls: PurposeDeclarationTemplate[] | undefined, setOpts: React.Dispatch<React.SetStateAction<SDRef[]>> ) {\n    ev.preventDefault();\n  \n    let declId = ev.currentTarget.value;\n  \n    let form = ev.currentTarget.form;\n    let decl = decls!.find(d => d.purposeDeclarationId! === declId);\n    if (decl === undefined) {\n      return;\n    }\n  \n    form[\"name\"].value = decl.name;\n    form[\"purposeDeclarationId\"].value = decl.purposeDeclarationId;\n    form[\"description\"].value = decl.description;\n    if (decl.services !== undefined) {\n        setOpts(decl.services);\n    }\n  }\n  \n  function declarationPrefill(sp: ClientPS, setOpts: React.Dispatch<React.SetStateAction<SDRef[]>>) {\n    if (sp.mem.declTemplate === undefined || sp.mem.declTemplate.length === 0) {\n      return <></>;\n    }\n  \n    return (\n      <div className=\"form-group text-danger\">\n        <label htmlFor=\"prefilled\">Eeltäidetud deklaratsiooni kiirvalik</label>\n        <select \n            className=\"form-control\" \n            id=\"prefilled\" \n            onChange={ ev => prefillPurposeDeclaration(ev, sp.mem.declTemplate, setOpts) }\n            defaultValue=\"\">\n          <option key=\"none\" value=\"\">... vali eeltäidetud deklaratsioon ...</option>\n          {\n            sp.mem.declTemplate.map(dt => (\n              <option key={ dt.purposeDeclarationId } value={ dt.purposeDeclarationId }>{ dt.name! }</option>\n            ))\n          }\n        </select>\n      </div>\n    );\n  }\n  \n\nconst DeclarePurposePopup : React.FC<ClientViewProps> = ({process, arena}) => {\n\n  const t = (k: string) => __({arena, process}, k);\n  const [show, setShow] = React.useState(false);\n  const [sdrefs, setSDRefs] = React.useState([] as SDRef[]);\n  const handleClose = () => setShow(false);\n  const handleShow = () => setShow(true);\n    return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"xl\">\n        <Modal.Header closeButton>\n            <Modal.Title>Eesmärgideklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n            <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <small>\n                    { t('purpose-decl-intro') }\n                  </small>\n                </div>\n              </div>\n              <div className=\"row border-bottom mt-4 mb-2\">\n                <div className=\"col\">\n                  <h6>{t('declarer')} { business(address2org(process.name), \"name\") } ({ address2org(process.name) })</h6>\n                  <input name=\"clientId\" type=\"hidden\" value={ address2org(process.name) } />\n                </div>\n              </div>\n              <div className=\"row\">\n                <div className=\"col\">\n                  { declarationPrefill(process, setSDRefs) }\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dIdentifier\">Eesmärgideklaratsiooni identifikaator:</label>\n                    <input name=\"purposeDeclarationId\" type=\"text\" className=\"form-control\" id=\"dIdentifier\" />\n                    <small id=\"dIdentifierHelp\" className=\"form-text text-muted\">Klientrakenduse poolt määratud eesmärgideklaratsiooni identifikaator</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dName\">Eesmärgideklaratsiooni nimi:</label>\n                    <input name=\"name\" type=\"text\" className=\"form-control\" id=\"dName\" />\n                    <small id=\"dNameHelp\" className=\"form-text text-muted\">Eesmärgi lühike nimi kasutajale näitamiseks</small>\n                  </div>\n                </div>\n              </div>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dataUsage\">Andmete kasutamise eesmärk:</label>\n                    <textarea name=\"description\" className=\"form-control\" id=\"dataUsage\" rows={3} />\n                    <small id=\"dataUsageHelp\" className=\"form-text text-muted\">Andmesubjekti andmete töötlemise eesmärk. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"services\">Kasutatavad teenused:</label>\n                      <select name=\"services\"\n                          className=\"custom-select\"\n                          multiple\n                          id=\"services\"\n                          value={ sdrefs.map(s => JSON.stringify(s)) }\n                          onChange={ () => { /* nop. use X button and adding. */ } }\n                      >\n                          {\n                              sdrefs.map(sdref => (\n                                  <option \n                                      key={ JSON.stringify(sdref) }\n                                      value={ JSON.stringify(sdref) }\n                                  >\n                                          {sdref.serviceProviderId} / {sdref.serviceDeclarationId}\n                                  </option>\n                              ))\n                          }\n                    </select>\n                    <input name=\"_spId\" placeholder=\"teenusepakkuja id\" size={10}/>\n                    <input name=\"_sdId\" placeholder=\"teenuse deklaratsiooni id\" size={10}/>\n                    <button className=\"btn-sm\" onClick={ev => addSDRef(ev, sdrefs, setSDRefs)}>+</button>\n                    <button className=\"btn-sm\" onClick={ev => { ev.preventDefault(); setSDRefs([]); }} title={ t('clear') }>X</button>\n                  </div>\n                </div>\n              </div>\n            </Modal.Body>\n            <Modal.Footer>\n              <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n              <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text={ t('declare') } message={declarePurpose()}/>\n            </Modal.Footer>\n        </form>\n        </Modal>\n        <Button variant=\"dark\" onClick={handleShow}>\n            {t('declare')}\n        </Button>\n        </>\n    )\n}\n\n/*\nfunction countConsentRefs(cis: ClientPS): number {\n    let out : number = 0;\n    Object.keys(cis.mem.db.consentRefByUser).forEach(\n        k => { out += Object.keys(cis.mem.db.consentRefByUser[k]).filter(\n            pd => !!(cis.mem.db.consentRefByUser[k][pd])\n        ).length; }\n    );\n    return out;\n}\n*/\n\nfunction purposeView(t: any, purpose: ClientConfig, process: ClientPS, arena: any): React.ReactElement {\n    const consentRef = (process.mem.db.consentRefByUser[process.mem.ui.user!] || {})[purpose.purposeDeclarationId];\n    const consentRefDesc = (consentRef === undefined ? t('consent-ref-not-asked') : consentRef === null ? t('consent-ref-not-found') : consentRef);\n\n    const dropdownToggle = React.forwardRef<HTMLButtonElement, ButtonProps & { onClick?: any }>(({ children, onClick }, ref) => (\n      <button className=\"btn-link\" onClick={onClick} ref={ref}>{children}</button>\n    ));\n    \n  \n    const updateConsentRefDropdown = React.forwardRef<HTMLDivElement, any>(\n      ({ style, className }, ref) => {\n        return (\n          <div\n            ref={ref}\n            style={style}\n            className={className}\n          >\n            <div className=\"row no-gutters flex-nowrap\">\n              <form>\n                <div className=\"form-group\">\n                  <input type=\"text\" size={6} className=\"form-control\" name=\"consentReference\"/>\n                   <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1 dropdown-close\" \n                    owner={process} arena={arena} \n                    message={updateConsentRefInCache({\n                      purposeDeclarationId: purpose.purposeDeclarationId\n                    })} text=\"Set\"/>\n                </div>\n              </form>\n            </div>\n          </div>\n        );\n      },\n    );\n\n    return (\n        <span className=\"card small mt-2\" key={purpose.purposeDeclarationId}>\n            <div className=\"w-100 row no-gutters p-1 align-items-center\">\n                <div className=\"col-auto flex-fill\"> \n                        { t(\"service\", purpose.purposeDeclarationId, \"name\") }<br/>\n                        { t('consent-ref') }\n                          <Dropdown className=\"d-inline-block\">\n                            <Dropdown.Toggle as={dropdownToggle} id={`consentref-update-dropdown-${purpose.purposeDeclarationId}`}>{ consentRefDesc }</Dropdown.Toggle>\n                            <Dropdown.Menu as={updateConsentRefDropdown}/>\n                          </Dropdown>\n                </div>\n                <div className=\"col-auto\">\n                    <SimpleSend className=\"btn btn-sm btn-outline-secondary\" owner={process} arena={arena} message={executeRequest({\n                        requestReference: generateRequestReference(),\n                        purposeId: purpose.purposeDeclarationId\n                    })} text=\"GO\" title=\"Tee päring kõigile selle eesmärgi teenustele\"/>\n                    <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1\" owner={process} arena={arena} message={fetchConsentReference({\n                        purposeDeclarationId: purpose.purposeDeclarationId\n                    })} text={ t('fcr') }\n                        title=\"Küsi nõusolekuviide uuesti\"\n                    />\n                    { consentRef &&\n                        <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1\" owner={process} arena={arena} message={validateConsentRef({\n                            consentReference: consentRef\n                        })} text=\"vcr\"\n                            title=\"Valideeri nõusolekuviide nõusolekuteenuses\"\n                        />\n                    }\n                    { consentRef &&\n                        <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1\" owner={process} arena={arena} message={updateConsentRefInCache({\n                            purposeDeclarationId: purpose.purposeDeclarationId\n                        })} text=\"rcr\"\n                            title=\"Unusta see nõusolekuviide\"\n                        />\n                    }\n\n                </div>\n            </div>\n            { /*\n            \n            <table className=\"table\">\n                <tbody>\n                    { purpose.services.map(\n                        s => {\n                            const resp = findFrom((process.mem.ui.response || []), { \n                                purposeDeclarationId: purpose.purposeDeclarationId,\n                                serviceAddress: s.serviceAddress,\n                                serviceName: s.serviceName,\n                            });\n\n                            return (\n                                <tr>\n                                    <td>{ s.serviceAddress }<br/>{ s.serviceName }</td>\n                                    <td>{ resp && resp.requestReferenceId }</td>\n                                    <td>{ resp && \n                                        (resp.data === null \n                                            ? t('response-has-no-data') \n                                            : <>{ resp.data.length }{t('data-items-returned')}</>\n                                        )\n                                    }</td>\n                                    <td>\n                                        <SimpleSend \n                                            className=\"btn btn-sm\"\n                                            owner={process}\n                                            arena={arena}\n                                            message={executeRequest({\n                                                requestReference: generateRequestReference(),\n                                                purposeId: purpose.purposeDeclarationId,\n                                                serviceAddress: s.serviceAddress,\n                                                serviceName: s.serviceName,\n                                            })} text=\"GO\"\n                                            title=\"Ainult see päring\"\n                                        />\n                                    </td>\n                                </tr>\n                            )\n                        }\n                    )}\n                </tbody>\n            </table>\n\n                    */}\n        </span>\n    )\n}\n\nfunction hasUser(cis: ClientPS): boolean {\n    return cis.mem.ui.user !== undefined;\n}\n\nexport const ClientRenderer : React.FC<ClientViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({arena, process}, ...k);\n\n    /* \n    const serviceCount = Object.keys(process.mem.db.purpose).length;\n    const consentRefCount = countConsentRefs(process);\n    const responseCount = (process.mem.ui.response || []).filter(r => r.data !== null).length;\n    */\n\n    return (<div>\n        <p>{ hasUser(process) ? `${t('active-user')} : ${process.mem.ui.user}` : `${t('no-active-user')}.` }</p>\n        { /*\n        <p className=\"small\">\n            { serviceCount } { t('services-configured') }<br/> \n            { consentRefCount } { t('consent-refs-cached') }{ consentRefCount > 0 && <SimpleSend className=\"btn-link mt-2\" owner={process} arena={arena} message={dumpConsentRefCache()} text={ t('dump-consent-ref-cache') }/> }<br/>\n            { responseCount } { t('responses-cached') }{ responseCount > 0 && <SimpleSend className=\"btn-link mt-2\" owner={process} arena={arena} message={selectServiceMessage({ service: process.mem.ui.service })} text={ t('dump-response-cache') }/> }\n          \n        </p>\n         */ }\n        <div className=\"row mx-1\">\n            <EnduserUI arena={arena} process={process}/>\n            <DeclarePurposePopup arena={arena} process={process}/>\n        </div>\n        { hasUser(process) && process.mem.config.map(p => purposeView(t, p, process, arena)) } \n      </div>);\n}\n\n\n","import { ClientPS, ClientDefaultView, ClientIS, PurposeDeclarationTemplate, ClientConfig } from './types';\nimport { addRenderer } from '../Base';\nimport { ClientRenderer } from './views';\n\n// Client IS is a small information system that:\n// - has a set of purposes that need data from service providers\n// - is able to declare the purpose \n// - tracks consent refs by user and by purpose declaration id. \n// - has UI that allows a user to authenticate\n// - allows to attempt to use the service as authenticated user\n\n\nexport function createClient(name: string, consentService: string, config: ClientConfig[], decls?: PurposeDeclarationTemplate[]): ClientPS {\n    return {\n        type: ClientIS,\n        view: ClientDefaultView,\n        name: name,\n        title: name,\n        mem: {\n            ui: {},\n            db: {\n                consentServiceId: consentService,\n                consentRefByUser: {},\n                purpose: {}\n            },\n            declTemplate: decls,\n            config: config,\n        },\n        queue: []\n    }\n}\n\naddRenderer(ClientIS, ClientDefaultView, ClientRenderer);","import { ConsentServicePS, ConsentServiceDefaultView, ConsentService } from './types'\nimport { addUi, addRenderer } from '../Base';\nimport { ConsentServiceRenderer } from './views';\n\nexport function createConsentService(name: string): ConsentServicePS {\n    return {\n        type: ConsentService,\n        view: ConsentServiceDefaultView,\n        name: name,\n        title: name,\n        mem: {\n            ui: {\n                activePurposeDeclaration: {},\n            },\n            db: {\n                serviceDeclarations: [],\n                purposeDeclarations: [],\n                consents: [],\n                usageLog: [],\n            }\n        },\n        queue: [],\n    };\n}\n\naddRenderer(ConsentService, ConsentServiceDefaultView, ConsentServiceRenderer);\naddUi(ConsentService, './ui/csui/');\n","import { ConsentServicePS, ConsentServiceState } from './types';\nimport { ProcessAndArena } from '../Base';\nimport React from 'react';\nimport { UILink } from '../../components/Process';\nimport { __ } from '../../i18n';\n\nexport interface CSViewProps extends ProcessAndArena<ConsentServiceState> {\n    process: ConsentServicePS;\n}\n\nexport const ConsentServiceRenderer : React.FC<CSViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({process, arena}, ...k);\n\n    const now = (Date.now() / 1000) | 0;\n\n    return (<div>\n        <p>{ process.mem.ui.user !== undefined ? `${t('active-user')} : ${process.mem.ui.user}` : `${t('no-active-user')}.` }</p>\n        <p className=\"small\">\n            { process.mem.db.serviceDeclarations.length } { t('service-declarations')}, <br/>\n            { process.mem.db.purposeDeclarations.length } { t('purpose-declarations')}, <br/>\n            { process.mem.db.consents.filter(c => (!c.revoked && c.validFrom <= now && c.validUntil >= now)).length } { t('active-consents')}, <br/>\n            { process.mem.db.consents.length } { t('total-consents')}\n        </p>\n        <UILink process={process} arena={arena} button={true}> { t('open-end-user-view') }</UILink>\n      </div>);\n}\n\n","import React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\n\nimport { ProcessAndArena } from \"../Base\";\nimport { SimpleSend } from \"../../components/SendButton\";\n\nimport { ServiceProviderState, ServiceProviderPS, ServiceDeclarationTemplate } from \"./types\";\nimport { declareService, addData } from './messages';\nimport { __, business } from \"../../i18n\";\nimport { address2org } from \"../../util\";\n\nexport interface ServiceProviderViewProps extends ProcessAndArena<ServiceProviderState> {\n    process: ServiceProviderPS;\n}\n\nconst updateMaxDuration = (ev: any) => {\n  let f = ev.currentTarget.form!;\n  let v = f[\"consentMaxDurationSeconds\"].value = \n    (f[\"_mdValue\"].value - 0) * (f[\"_mdUnit\"].value) * 24 * 3600;\n  f[\"_mdValue\"].className = \"form-control\" + (v < 1 ? \" is-invalid\" : \"\");\n};\n\nfunction prefillServiceDeclaration(ev: any, decls?: ServiceDeclarationTemplate[]) {\n  ev.preventDefault();\n\n  let declId = ev.currentTarget.value;\n\n  let form = ev.currentTarget.form;\n  let decl = decls!.find(d => d.serviceDeclarationId! === declId);\n  if (decl === undefined) {\n    return;\n  }\n\n  form[\"name\"].value = decl.name;\n  form[\"serviceDeclarationId\"].value = decl.serviceDeclarationId;\n  form[\"technicalDescription\"].value = decl.technicalDescription;\n  form[\"description\"].value = decl.description;\n  form[\"needSignature\"].checked = decl.needSignature === true;\n  let md = decl.consentMaxDurationSeconds || (1 * 365 * 24 * 3600);\n  md = ((md / (24 * 3600)) | 0);\n  if (md > 365) {\n    form[\"_mdValue\"].value = ((md / 365) | 0);\n    form[\"_mdUnit\"].value = 365;\n  } else if (md > 30) {\n    form[\"_mdValue\"].value = ((md / 30) | 0);\n    form[\"_mdUnit\"].value = 30;\n  } else {\n    form[\"_mdValue\"].value = md;\n    form[\"_mdUnit\"].value = 1;\n  }\n\n  updateMaxDuration({ currentTarget: form[\"consentMaxDurationSeconds\"]});\n}\n\nfunction declarationPrefill(sp: ServiceProviderPS) {\n  if (sp.mem.declTemplate === undefined || sp.mem.declTemplate.length === 0) {\n    return <></>;\n  }\n\n  return (\n    <div className=\"form-group text-danger\">\n      <label htmlFor=\"prefilled\">Eeltäidetud deklaratsiooni kiirvalik</label>\n      <select className=\"form-control\" id=\"prefilled\" onChange={ ev => prefillServiceDeclaration(ev, sp.mem.declTemplate) } defaultValue=\"\">\n        <option key=\"none\" value=\"\">... vali eeltäidetud deklaratsioon ...</option>\n        {\n          sp.mem.declTemplate.map(dt => (\n            <option key={ dt.serviceDeclarationId } value={ dt.serviceDeclarationId }>{ dt.name! }</option>\n          ))\n        }\n      </select>\n    </div>\n  );\n}\n\nconst DeclareServicePopup : React.FC<ServiceProviderViewProps> = ({process, arena}) => {\n\n    const t = (...k: string[]) => __({process, arena}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n   \n      return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"xl\">\n        <Modal.Header closeButton>\n          <Modal.Title>Teenusedeklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <small>\n                    { t('service-decl-intro') }\n                  </small>\n                </div>\n              </div>\n\n              <div className=\"row border-bottom mt-4 mb-2\">\n                <div className=\"col\">\n                  <h6>{t('declarer')} { business(address2org(process.name), \"name\") } ({ address2org(process.name) })</h6>\n                  <input name=\"serviceProviderId\" type=\"hidden\" value={ address2org(process.name) } />\n                </div>\n              </div>\n\n              <div className=\"row\">\n                <div className=\"col\">\n                  { declarationPrefill(process) }\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdIdentifier\">Teenusedeklaratsiooni identifikaator:</label>\n                    <input name=\"serviceDeclarationId\" type=\"text\" className=\"form-control\" id=\"sdIdentifier\" />\n                    <small id=\"sdIdentifierHelp\" className=\"form-text text-muted\">Andmekogu poolt määratud teenusedeklaratsiooni masinloetav identifikaator.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdName\">Teenusedeklaratsiooni nimi:</label>\n                    <input name=\"name\" type=\"text\" className=\"form-control\" id=\"sdName\" />\n                    <small id=\"sdNameHelp\" className=\"form-text text-muted\">Teenusedeklaratsiooni identifikaator inimloetaval kujul. Soovitatavalt teenuse kood/nimi ja vajadusel alamteenuse identifikaator.</small>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdTechDescription\">Teenuse tehniline kirjeldus:</label>\n                    <textarea name=\"technicalDescription\" className=\"form-control\" id=\"sdTechDescription\" rows={3} />\n                    <small id=\"sdTechDescriptionHelp\" className=\"form-text text-muted\">Teenuse ja selle osutamise tehniline kirjeldus. Kasutamiseks klientsüsteemide haldajatele</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdDescription\">Teenuse andmekoosseisu kirjeldus:</label>\n                    <textarea name=\"description\" className=\"form-control\" id=\"sdDescription\" rows={3}/>\n                    <small id=\"sdDescriptionHelp\" className=\"form-text text-muted\">Teenuse inimloetav kirjeldus. Tagastatavad andmed, teenuse sisu jne. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <input type=\"hidden\" name=\"consentMaxDurationSeconds\" value={1 * 365 * 24 * 3600 }/>\n                    <label htmlFor=\"maxDuration\">Nõusoleku maksimaalne kehtivusaeg:</label>\n                    <div className=\"form-row\">\n                      <div className=\"form-group col-md\">\n                        <input type=\"number\" size={3} className=\"form-control\" id=\"maxDuration\" name=\"_mdValue\" onChange={updateMaxDuration} defaultValue={1}/>\n                      </div>\n                      <div className=\"form-group col-md\">\n                        <select name=\"_mdUnit\" className=\"form-control input-group-append\" onChange={updateMaxDuration}>\n                          <option value={ 365 }>{ t('year') }</option>\n                          <option value={  30 }>{ t('month') }</option>\n                          <option value={   1 }>{ t('day') }</option>\n                        </select>\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"form-group\">\n                    <div className=\"form-check\">\n                      <input name=\"needSignature\" className=\"form-check-input\" type=\"checkbox\" id=\"signature\" value=\"true|false\"/>\n                      <label className=\"form-check-label\" htmlFor=\"signature\">Vajab digiallkirja?</label>\n                      <small id=\"signatureHelp\" className=\"form-text text-muted\">Märgista see väli, kui andmesubjekt peab selle teenuse andmetele nõusoleku andmisel nõusoleku digitaalselt allkirjastama.</small>\n                    </div>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>{ t('close')}</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text={ t('declare') } message={ declareService() }/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"dark\" onClick={handleShow}>\n        {t('declare')}\n      </Button>\n\n         </>\n      )\n  }\n  \n\nexport const ServiceProviderRenderer : React.FC<ServiceProviderViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({process, arena}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n    const allValues : string[] = (() => {\n      let values = process.mem.services.map(s => s.returnedDatatypes).flat().concat(process.mem.db.map(r => r.type));\n      values.sort();\n      let out : string[] = [];\n      values.forEach((v) => { if (out.length === 0 || v !== out[out.length - 1]) out.push(v); });\n      return out;\n    })();\n    return (<div>\n        <p className=\"small\">\n          {/* process.mem.services.length } { t('services-defined') }<br/> //FIXME: Confusing for demo audience?*/ }\n          { process.mem.db.length } <button className=\"btn-link\" onClick={handleShow}>{ t('records-in-db') }</button>\n        </p>\n        <Modal show={show} onHide={handleClose} size=\"lg\">\n          <Modal.Header>\n            <Modal.Title>{ t('database') }: { t('title') }</Modal.Title>\n          </Modal.Header>\n          <Modal.Body>\n            <form>\n                <table className=\"table\">\n                    <thead>\n                        <tr>\n                            <th className=\"border-top-0\">id</th>\n                            <th className=\"border-top-0\">type</th>\n                            <th className=\"border-top-0\">subject</th>\n                            <th className=\"border-top-0\">data</th>\n                            <th className=\"border-top-0\"></th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                    { \n                        process.mem.db.map(r => (\n                            <tr key={ r.key }>\n                                <td>{ r.key }</td>\n                                <td>{ r.type }</td>\n                                <td>{ r.subject }</td>\n                                <td>{ JSON.stringify(r.data, undefined, \" \") }</td>\n                                <td>\n                                    <SimpleSend arena={arena} owner={process} text=\"-\" message={\n                                        addData({ key: r.key, datatype: undefined, subject: undefined, data: undefined })\n                                    }/>\n                                </td>\n                            </tr>\n                        ))\n                    }\n                    <tr key=\"add\">\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"key\" defaultValue={ (Math.random() * 10000) | 0 }/></td>\n                        <td><input className=\"form-control\" type=\"text\" size={8} name=\"datatype\" \n                            defaultValue={ allValues.length > 0 ? allValues[0] : \"\" } /></td>\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"subject\"/></td>\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"data\"/></td>\n                        <td><SimpleSend arena={arena} owner={process} text=\"+\" message={addData()} onClick={(ev) => {\n                            let f = ev.currentTarget.form;\n                            f.key.value = (Math.random() * 10000) | 0;\n                            f.datatype.value = \"\";\n                            f.subject.value = \"\";\n                            f.data.value = \"\";\n                        }} /></td>\n                    </tr>\n                    </tbody>\n                </table>\n            </form>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>{ t('close') }</Button>\n          </Modal.Footer>\n        </Modal>\n        <DeclareServicePopup arena={arena} process={process}/>\n      </div>);\n}\n\n","import { ServiceConfig, ServiceProviderPS, ServiceProviderDefaultView, ServiceProviderIS, SecretRecord, ServiceDeclarationTemplate } from \"./types\";\nimport { addRenderer } from \"../Base\";\nimport { ServiceProviderRenderer } from \"./views\";\n\n\nexport function createServiceProvider(name: string, title: string, config: ServiceConfig[], db?: SecretRecord[], decls?: ServiceDeclarationTemplate[]): ServiceProviderPS {\n    return {\n        type: ServiceProviderIS,\n        view: ServiceProviderDefaultView,\n        name: name,\n        title: title,\n        mem: {\n            db: db === undefined ? [] : db,\n            services: config,\n            inflight: [],\n            declTemplate: decls,\n        },\n        queue: []\n    };\n}\n\naddRenderer(ServiceProviderIS, ServiceProviderDefaultView, ServiceProviderRenderer);\n","import { createCounter } from \"./process/Counter\";\nimport { createTokenNode } from \"./process/TokenRing\";\nimport { ProcessState } from \"./process/Base\";\nimport { createArena } from \"./components/Arena\";\nimport { fromArray } from \"./byNameStore\";\nimport { TheatreState } from \"./components/Theatre\";\nimport { createClient } from \"./process/client/constructor\";\nimport { createConsentService } from \"./process/consentService/constructor\";\nimport { createServiceProvider } from \"./process/serviceProvider/constructor\";\nimport { SecretRecord } from \"./process/serviceProvider/types\";\nimport { LogRendererMap, consentRefApiLogRenderers, addLogRenderers } from \"./components/LogRows\";\n\n// initial configuration\n\ntype ConfigType = { \n    defaultArena: string;\n    arenas: { [name: string]: { processes: ProcessState<any>[]; logRenderers?: LogRendererMap }; }\n};\n\n\nconst CS1Address = \"EE/GOV/70009770/nt\";\n\nconst config : ConfigType = {\n    defaultArena: \"demo\",\n    // arenas: arena -> [process]\n    arenas: {\n        \"demo\": {\n            processes: [\n                createClient(\"EE/COM/10112345/healthstartup\", CS1Address, [ // client configuration\n                    { // vaktsineerimise meeldetuletused\n                        purposeDeclarationId: \"tervisepaevik_vaktsineerimised\",\n                        services: [\n                            {\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.282\",\n                            }\n                        ]\n                    },\n                    { // terviseandmete visualiseerimine\n                        purposeDeclarationId: \"tervisepaevik_visualiseerimine\",\n                        services: [\n                            { // diagnoosid\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.32\",\n                            },\n                            { // uuringud\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.35\",\n                            }\n                        ]\n                    }\n                ], [ // prefilled service declaration templates\n                    {\n                        purposeDeclarationId: \"tervisepaevik_visualiseerimine\",\n                        name: \"Terviseandmete visualiseerimine\",\n                        description: \"HealthStartup diagnooside ja uuringute tulemuste visualiseerimist pakkuv teenus.\\n\\n\" +\n                            \"Nõusoleku tagasivõtmisel kustutab HealthStartup kõik Sinu kohta saadud andmed.\",\n                        services: [\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_diagnoosid\" },\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_uuringud\" }\n                        ]\n                    },\n                    {\n                        purposeDeclarationId: \"tervisepaevik_vaktsineerimised\",\n                        name: \"Vaktsineerimiste meeldetuletused\",\n                        description: \"HealthStartup vaktsineerimiste meeldetuletusi ja immuniseerimisplaani pakkuv teenus.\\n\\n\" +\n                           \"Nõusoleku tagasivõtmisel kustutab HealthStartup kõik Sinu kohta saadud andmed.\",\n                        services: [\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_immuniseerimispass\" }\n                        ]\n                    }\n                ]),\n            \n                createServiceProvider(\"EE/GOV/70009770/digilugu\", \"Tervise Infosüsteem\", [ // services\n                    { // immuniseerimispassi teenus\n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.282\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_immuniseerimispass\" ],\n                        returnedDatatypes: [ \"immuniseerimine\" ]\n                    },\n                    { // uuringute päringu teenus\n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.35\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_uuringud\" ],\n                        returnedDatatypes: [ \"uuring\" ]\n                    },\n                    { // \n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.32\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_diagnoosid\" ],\n                        returnedDatatypes: [ \"diagnoos\" ],\n                    }\n                ], [ // secret data\n                    createData(\"01234567890\", \"diagnoos\", { diagnoos: \"A01\", arst: \"D03677\" }),\n                    createData(\"12345678901\", \"diagnoos\", { diagnoos: \"J01\", arst: \"D08031\"}),\n                    createData(\"47302200234\", \"diagnoos\", { diagnoos: \"J00\", arst: \"D05076\" }),\n                    createData(\"47302200234\", \"uuring\", { uuring: \"uuring 1\", arst: \"D12345\", vastus: \"korras.\" }),\n                    createData(\"47302200234\", \"immuniseerimine\", { \n                        haigus: \"A-gripp\", preparaat: \"Vaxigriptetra\", seeria:\"A2321-3232\", jrk: 3, uuesti: \"2020-10-22\"\n                    }),\n                ], [ // prefilled service declaration templates\n                    {\n                        serviceDeclarationId: \"hl7_uuringud\",\n                        name: \"Uuringute päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.35\",\n                        description: \"Andmekogule saadetakse päringu parameetrina Sinu isikukood.\\n\\n\" +\n                            \"Andmekogust Tervise Infosüsteem saadakse iga Sinu uuringu kohta järgmised andmed:\\n\" +\n                            \"  * Sinu andmed: nimi ja isikukood:\\n\" +\n                            \"  * Uuringu andmed:\\n\" +\n                            \"    * Uuringu tegemise aeg ja koht (raviasutus)\\n\" +\n                            \"    * Proovimaterjali tüüp\\n\" +\n                            \"    * Uuringu tüüp\\n\" +\n                            \"    * Uuringu vastus\\n\" +\n                            \"  * Uuringu teostanud tervishoiutöötaja andmed: nimi, kood ja tervishoiuasutuse andmed\",\n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    {\n                        serviceDeclarationId: \"hl7_diagnoosid\",\n                        name: \"Diagnooside päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.32\",\n                        description: \"Andmekogust Tervise Infosüsteem saadakse iga Sinu diagnoosi kohta järgmised andmed:\\n\" +\n                            \"  * Sinu andmed: nimi ja isikukood\\n\" +\n                            \"  * Haigusjuhtumi andmed: diagnoosi andmise aeg, diagnoos\\n\" +\n                            \"  * Diagnoosi andnud tervishoiutöötaja andmed: nimi, kood ja tervishoiuasutuse andmed\",\n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    {\n                        serviceDeclarationId: \"hl7_immuniseerimispass\",\n                        name: \"Immuniseerimispassi päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.282\",\n                        description: \"Andmekogust Tervise Infosüsteem saadakse iga Sinu immuniseerimise kohta järgmised andmed:\\n\" +\n                        \"  * Sinu andmed: nimi ja isikukood\\n\" +\n                        \"  * Immuniseerimise andmed:\\n\" +\n                        \"    * Haigus mille vastu immuniseeriti\\n\" +\n                        \"    * Immuniseerimise kuupäev\\n\" +\n                        \"    * Immuunpreparaadi nimi, partii number ja manustatud annus\\n\" +\n                        \"    * Mitmes annus\\n\" +\n                        \"    * Järgmine immuniseerimise varaseim kuupäev\\n\" +\n                        \"  * Immuniseerija andmed: nimi, kood ja tervishoiuasutuse andmed\", \n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    \n                ]),\n\n                createConsentService(\"EE/GOV/70009770/nt\"),\n            ],\n            logRenderers: {\n                ...consentRefApiLogRenderers\n            },\n        },\n\n\n        \"singleCounter\": { processes: [\n          createCounter(\"counter1\"),\n        ]},\n\n        \"tokenRing\": { processes: [\n          createTokenNode(\"sd.title\", \"a\", \"b\"),\n          createTokenNode(\"pd.title\", \"b\", \"c\"),\n          createTokenNode(\"ca.title\", \"c\", \"c\"),\n        ]}\n    }\n};\n\nexport function createData(subjectId: string, type: string, data: any): SecretRecord {\n    return {\n        key: \"\" + ((Math.random() * 10000) | 0),\n        type: type,\n        subject: subjectId,\n        data: data\n    };\n}\n\n\n\nexport function initialTheatre(): TheatreState {\n    return {\n        name: \"theatre\",\n        arenas: fromArray(Object.keys(config.arenas).map(a => createArena(a, config.arenas[a].processes))),\n        active: config.defaultArena,\n    }\n}\n\nObject.keys(config.arenas).forEach(arena => {\n    if (config.arenas[arena].logRenderers !== undefined) {\n        addLogRenderers(arena, config.arenas[arena].logRenderers!);\n    }\n})\n","import React from 'react';\nimport { connect } from 'react-redux';\n\nimport { ArenaState, Arena, reduceArena, ArenaActionType } from './Arena';\nimport { AppState } from '../store';\nimport { ByNameStore, reduceByName } from '../byNameStore';\nimport { initialTheatre } from '../config';\nimport { AnyAction } from 'redux';\n\ntype Arenas = ByNameStore<ArenaState>;\n\nexport interface TheatreState {\n    name: string;\n    arenas: Arenas;\n    active: string;\n}\n\nexport function selectArena(state: AppState, arena: string) {\n    return state.theatre.arenas.byName[arena];\n}\n\nconst SELECT_ARENA = \"Theatre/SELECT_ARENA\";\ninterface SelectArenaAction extends AnyAction {\n    type: typeof SELECT_ARENA;\n    arena: string;\n}\n\n// function selectArenaMessage(arena: string): SelectArenaAction {\n//     return { type: SELECT_ARENA, arena: arena };\n// }\n\nexport function reduceTheatre(state: TheatreState = initialTheatre(), action: any): TheatreState {\n    switch (action.type) {\n        case SELECT_ARENA:\n            return ({ ...state, active: action.arena });\n        default:\n            return ({ ...state, arenas: reduceByName(state.arenas, (a) => reduceArena(a, action as ArenaActionType)) });\n        }\n}\n\ninterface TheatreProps {\n    theatre: TheatreState;\n}\n\nclass _Theatre extends React.PureComponent<TheatreProps> {\n    // <ArenaSelector arenaNames={ this.props.theatre.arenas.allNames }/>\n    componentDidMount() {\n        require('../App.css');\n        require('../bootstrap.css');\n    }\n\n    render() {\n        return (\n            <div>\n                <Arena arena={ this.props.theatre.arenas.byName[this.props.theatre.active] }/>\n            </div>\n\n        )\n    }\n}\n\nexport const Theatre = connect(mapStateToProps)(_Theatre);\n\nfunction mapStateToProps(state: AppState) {\n    return { theatre: state.theatre }\n}\n\n\n// interface ArenaSelectorProps {\n//     arenaNames: string[];\n//     selectArenaMessage: (arena: string) => void; \n// }\n\n// class ArenaSelectorComponent extends React.PureComponent<ArenaSelectorProps> {\n//     render() {\n//         return (\n//             <select onChange={(ev) => this.props.selectArenaMessage(ev.currentTarget.value)}>\n//                 { this.props.arenaNames.map(n => (<option value={n} key={n}>{n}</option>))}\n//             </select>\n//         );\n//     }\n// }\n\n// const ArenaSelector = connect(undefined, { selectArenaMessage })(ArenaSelectorComponent);\n","import { BackendAPI } from \"../../../postMessage\";\nimport { ConsentServiceState, PurposeDeclaration, Consent, UsageRecord, PurposeDeclarationRef, findFrom, ServiceDeclarationRef, ServiceDeclaration } from \"../types\";\nimport React, { useContext } from \"react\";\nimport { loginMessage, giveConsentMessage, revokeConsentMessage, activatePurposeDeclarationMessage } from \"../ui\";\nimport { hash } from \"../../../util\";\nimport { fixRevoked } from \"../referenceAPI\";\n\nexport class ConsentServiceBackend extends BackendAPI<ConsentServiceState> {\n    login(ev:any, user?: string) {\n        console.log(\"login(\", user, \")\");\n        ev.preventDefault();\n        this.post(loginMessage({ user }));\n    }\n\n    giveConsentByPurpose(ev: any, services : ServiceDeclarationRef[], clientId: string, purposeDeclarationId: string) {\n        console.log(`giveConsent(${clientId}, ${purposeDeclarationId})`);\n        ev.preventDefault();\n        this.post(giveConsentMessage({\n            dataSubject: this.mem!.ui.user,\n            clientId: clientId,\n            purposeDeclarationId: purposeDeclarationId,\n            validFrom: (Date.now() / 1000) | 0,\n            validUntil: this.getValidUntil(services),\n            revoked: false,\n            // for technical reasons, we issue consentReference here. \n            // in real system it happens in (real) backend. \n            consentReference: hash(clientId + purposeDeclarationId + Date.now())\n        }))\n    }\n\n    revokeConsent(ev: any, consentReference: string) {\n        console.log(`revokeConsent(${consentReference})`);\n        ev.preventDefault();\n        this.post(revokeConsentMessage({ consentReference, revokeAt : Math.floor(Date.now()/1000) }))\n    }\n\n    // parameetrita/valid === undefined -> k]ik aktiivse kasutaja konsendid\n    // parameetriga -> ainult need, mis kas kehtivad v]i mitte\n    getConsents(valid?: boolean): Consent[] {\n        if (this.mem === undefined) {\n            return [];\n        }\n\n        let now = (Date.now() / 1000) | 0;\n        let user = this.mem.ui.user!;\n\n        return (this.mem.db.consents\n            .map(fixRevoked(now))\n            .filter(\n                c => (c.dataSubject === user \n                    && (valid === undefined \n                        || (valid === (c.validFrom <= now && c.validUntil >= now && !c.revoked)))) \n        ));\n    }\n\n    // need asjad kõlbavad consendi andmiseks FIXME seda vist pole enam vaja\n    getPDsWithoutValidConsent(): PurposeDeclaration[] {\n        if (this.mem === undefined) {\n            console.error(\"Not connected? No local state yet\");\n            return [];\n        }\n\n        let consents = this.getConsents(true);\n\n        return this.mem!.db.purposeDeclarations.filter(\n            pd => consents.find(c => (c.clientId === pd.clientId && c.purposeDeclarationId === pd.purposeDeclarationId)) === undefined\n        );\n    }\n\n    getUsageLogRecords(): UsageRecord[] {\n        if (this.mem === undefined) {\n            return [];\n        }\n\n        return this.mem.db.usageLog.filter(ur => ur.subjectId === this.mem!.ui.user);\n    }\n\n    activatePurposeDeclaration(ev: any, ref: PurposeDeclarationRef) {\n        ev.preventDefault();\n        if (this.mem === undefined) {\n            return;\n        }\n\n        this.post(activatePurposeDeclarationMessage(ref));\n    }\n\n    getActivePurposeDeclaration(): PurposeDeclaration | undefined {\n        if (this.mem === undefined || this.mem.ui.activePurposeDeclaration === undefined || this.mem.ui.activePurposeDeclaration[this.mem.ui.user!] === undefined) {\n            return undefined;\n        }\n\n        let candidate = findFrom(\n            this.mem.db.purposeDeclarations,\n            { ...this.mem.ui.activePurposeDeclaration[this.mem.ui.user!], callbackURL: undefined } as PurposeDeclarationRef\n        );\n\n        if (candidate === undefined || \n            findFrom(this.getConsents(true), { // if there is a valid consent for that candidate\n                clientId: candidate.clientId,\n                purposeDeclarationId: candidate.purposeDeclarationId\n            }) !== undefined) {\n\n            return undefined;\n        }\n        return {...candidate, validUntil: this.getValidUntil(this.mem.db.serviceDeclarations)};\n    }\n\n    getServiceDeclaration(ref: ServiceDeclarationRef): ServiceDeclaration | undefined {\n        if (this.mem === undefined) {\n            return undefined;\n        }\n\n        return findFrom(this.mem.db.serviceDeclarations, ref);\n    }\n\n    getPurposeDeclaration(ref: PurposeDeclarationRef): PurposeDeclaration | undefined {\n        if (this.mem === undefined) {\n            return undefined;\n        }\n\n        return findFrom(this.mem.db.purposeDeclarations, ref);\n    }\n\n    getValidUntil(services : ServiceDeclarationRef[]) {\n        const expiresIn = services.map( s => this.getServiceDeclaration(s)!.consentMaxDurationSeconds).sort()[0];\n        return Number(Math.floor(Date.now() / 1000)) + Number(expiresIn)\n    }\n}\n\nexport const CSBackend = React.createContext(undefined as (ConsentServiceBackend | undefined));\n\nexport class Backend {\n  use() {\n    const ctx = useContext(CSBackend);\n    return (ctx === undefined || ctx === null) ? ctx : new ConsentServiceBackend(ctx);\n  }\n}\n","import * as React from 'react';\n\n// <div className=\"footer-logo\">\n//   <img className=\"logo-brand\" alt=\"logo\" src={require('./../../static/assets/images/logo-est.png')} />\n// </div>\nconst Footer = () => {\n  return(\n    <footer>\n      <div className=\"footer-top\">\n\n        <div className=\"footer-contact\">\n          <div>\n            <div className=\"footer-contact-icon\">\n              <i className=\"icon-phone\"></i>\n            </div>\n          </div>\n          <div className=\"footer-contact-text\">\n            <table>\n              <tbody>\n                <tr>\n                  <th><a className=\"link-phone\" href=\"tel:+372-555-1\">555 1234</a></th>\n                  <th>Üldinfo</th>\n                </tr>\n                <tr>\n                  <td><a className=\"link-phone\" href=\"tel:+372-555-1234\">555 1234</a></td>\n                  <td>Teine osakond</td>\n                </tr>\n                <tr>\n                  <td><a className=\"link-phone\" href=\"tel:+372-555-1234\">555 1234</a></td>\n                  <td>Kolmas osakond</td>\n                </tr>\n              </tbody>\n            </table>\n            <a className=\"link-orange\" href=\"http://www.digilugu.ee/\" target=\"_blank\" rel=\"noopener noreferrer\">Kõik kontaktandmed</a>\n          </div>\n        </div>\n      </div>\n    </footer>\n  )\n}\n\nexport default Footer;","import * as React from 'react';\nimport { fullname } from '../../i18n';\n\nconst Header = ({backend}: any) => {\n  let backendUse = backend.use();\n  return(\n    <>\n    <nav className=\"navbar\">\n      <ul className=\"navbar-nav desktop-nav\">\n        <li className=\"nav-item with-logo\">\n          <img className=\"logo-brand\" alt=\"logo\" width=\"170\" src={require('./../../static/assets/images/logo-est.png')} />\n        </li>\n        {backendUse && backendUse.mem.ui.user &&\n          <li className=\"nav-item with-title\">\n            <p className=\"nav-item-title\">Kasutaja</p>\n            <p>{ fullname(backendUse.mem.ui.user) }</p>\n          </li>\n        }\n        {backendUse && backendUse.mem.ui.user &&\n          <li className=\"nav-item nav-logout\">\n            <button className=\"btn btn-logout\" onClick={(ev) => backendUse.login(ev)}>Väljun</button>\n          </li>\n        }\n      </ul>\n    </nav>\n    </>\n  )\n}\n\nexport default Header;","import React from 'react';\nimport Footer from './footer';\nimport Header from './header';\n\nconst VeeraLayout = ({children, backend}: any) => {\n  let backendUse = backend.use();\n  return (\n    <div className={\"wrapper \" + (backendUse && backendUse.mem.ui.user ? 'push' : '')}>\n      { backendUse && backendUse.mem.ui.user &&\n        <Header backend={backend} />\n      }\n      <div className=\"content-wrapper\">\n      <div className=\"workarea\">\n        {children}\n      </div>\n      </div>\n      <Footer />\n    </div>\n  );\n}\nexport default VeeraLayout;","import React from 'react';\nimport PropTypes from 'prop-types';\n\ninterface Props {\n  activeTab: string;\n  label: string;\n  onClick: (tab: string) => void;\n}\n\nexport class Tab extends React.Component<Props, {}> {\n  static propTypes = {\n    activeTab: PropTypes.string.isRequired,\n    label: PropTypes.string.isRequired,\n    onClick: PropTypes.func.isRequired,\n  };\n\n  onClick = () => {\n    const { label, onClick } = this.props;\n    onClick(label);\n  }\n\n  render() {\n    const {\n      onClick,\n      props: {\n        activeTab,\n        label,\n      },\n    } = this;\n\n    let className = 'sidebar-item';\n\n    if (activeTab === label) {\n      className += ' active';\n    }\n\n    return (\n      <li\n        className={className}\n        onClick={onClick}\n        style={{cursor: 'pointer'}}\n      >\n        {label}\n      </li>\n    );\n  }\n}\n\nexport default Tab;","import React from 'react';\nimport PropTypes from 'prop-types';\nimport Tab from './Tab';\n\ninterface Props {\n  children: React.ReactElement<any>[];\n}\n\ninterface State {\n  activeTab: string;\n}\n\ndeclare module 'react' {\n  interface HTMLAttributes<T> extends AriaAttributes, DOMAttributes<T> {\n    // extends React's HTMLAttributes\n    label?: string;\n  }\n}\n\nclass Tabs extends React.Component<Props, State> {\n  static propTypes = {\n    children: PropTypes.instanceOf(Array).isRequired,\n  }\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      activeTab: this.props.children[0].props.label,\n    };\n  }\n\n  onClickTabItem = (tab: string) => {\n    this.setState({ activeTab: tab });\n  }\n\n  render() {\n    const {\n      onClickTabItem,\n      props: {\n        children,\n      },\n      state: {\n        activeTab,\n      }\n    } = this;\n\n    return (\n      <div>\n        <div id=\"sidebar\">\n          <ol>\n            {children.filter(c => c.props.label !== undefined).map((child) => {\n              const { label } = child.props;\n\n              return (\n                <Tab\n                  activeTab={activeTab}\n                  key={label}\n                  label={label}\n                  onClick={onClickTabItem}\n                />\n              );\n            })}\n          </ol>\n        </div>\n        <div className=\"section\">\n          {children.map((child) => {\n            if (child.props.label !== activeTab) return undefined;\n            return child.props.children;\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default Tabs;","import { ConsentServiceBackend } from \"./backendAPI\";\nimport { Consent } from \"../types\";\nimport React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { formatTimestamp } from \"./CSEnduserUI\";\nimport { isConsentActive } from \"./MyConsents\";\nimport { business } from \"../../../i18n\";\nimport { renderText } from \"../../../util\";\n\nexport const ConsentModal: React.FC<{backend: ConsentServiceBackend, consent: Consent, buttonText : string}> = ({backend, consent, buttonText}) => {\n\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n\n    const handleRevoke = (ev:any) => {\n      setShow(false);\n      backend.revokeConsent(ev, consent.consentReference);\n    }\n\n    if (backend.mem === undefined) {\n        return null;\n      }\n      const dec = backend.mem.db.purposeDeclarations.find(p => p.purposeDeclarationId === consent.purposeDeclarationId);\n      if (dec === undefined) {\n        return null;\n      }\n\n      const rowView = (name: string, value: any, last?: boolean) => {\n        return (\n          <div className=\"row\" key={name}>\n            <div className=\"col-md\">\n              <div className= { last ? \"d-flex align-items-end\" : \"d-flex align-items-baseline\" }>\n                <div><h4> { name }</h4></div>\n                <div>{ value }</div>\n              </div>\n              </div>\n          </div>\n        )\n      }\n\n    const Body = () => {\n      let services = dec.services.map(sdref => {\n        const sd = backend.getServiceDeclaration(sdref);\n        if (sd === undefined) {\n          return <></>;\n        }\n        return (\n          <>\n            <h4>{sd.name}</h4>\n            { renderText(sd.description) }\n          </>\n        )\n      })\n      return (\n        <div className=\"tab-info\">\n          { rowView('Nõusoleku saaja:', `${business(dec.clientId, \"name\")} (${business(dec.clientId, \"ntr\")})`) }\n          { rowView('Rakendus:', `${ business(dec.clientId, \"appname\") }` ) }\n          { rowView('Nõusolek antud:', formatTimestamp(consent.validFrom)) }\n          { isConsentActive(consent)\n              ? rowView('Nõusolek kehtib kuni:', formatTimestamp(consent.validUntil))\n              : rowView('Nõusolek tühistatud:', formatTimestamp(consent.validUntil)) }\n          { rowView('Eesmärk:', renderText(dec.description), true) }\n          { rowView(`Nõusoleku alusel saab ${business(dec.clientId, \"name\")} Sinu kohta järgmised andmed:`, services, true)}\n        </div>\n      )\n    }\n\n    return (\n    <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header>\n          <Modal.Title>Detailid</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <Body />\n        </Modal.Body>\n        <Modal.Footer>\n          { isConsentActive(consent) &&\n          <Button variant=\"primary\" onClick={(ev:any) => handleRevoke(ev)}>\n            Võtan nõusoleku tagasi\n          </Button>\n          }\n          <Button variant=\"secondary\" onClick={handleClose}>\n            Sule\n          </Button>\n        </Modal.Footer>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        { buttonText }\n      </Button>\n    </>\n    )\n};","import { ConsentServiceBackend } from './backendAPI';\nimport React from 'react';\nimport { Consent } from '../types';\nimport { formatTimestamp } from './CSEnduserUI';\nimport { ConsentModal } from './ConsentModal';\nimport { business } from '../../../i18n';\n\nexport function isConsentActive(consent : Consent) {\n  return !consent.revoked && consent.validUntil > Date.now()/1000;\n}\n\nfunction consentDescription(c : Consent) {\n  return (\n    `${business(c.clientId, \"name\")}; ${business(c.clientId, \"appname\")}; Nõusolek antud ${formatTimestamp(c.validFrom)}` +\n    ` – ${ c.revoked ? \"nõusolek tühistatud\" : \"kehtib kuni\" } ${formatTimestamp(c.validUntil)}`\n  );\n}\n\nexport const MyConsents = (backend :  ConsentServiceBackend) => {\n\n  const Table = (consents : Consent[], header : JSX.Element) => {\n    return (\n      <>\n        <h4>{ header }</h4>\n        <table className=\"table align-middle\">\n          <tbody>\n            { consents.map( c => (\n              <tr key={c.clientId}>\n                <td>{ consentDescription(c) }</td>\n                <td><ConsentModal backend={backend} consent={c} buttonText=\"Vaata lähemalt\"/></td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </>\n    )\n  }\n\n  const Body = (backend : ConsentServiceBackend) => {\n\n    if (backend.getConsents().length === 0) {\n      return (\n        <p>Nõusolekuid ei leitud.</p>\n      )\n    }\n\n    const header = (title: string, length: number) => (\n      <h4>\n        <span>{title}</span>\n        {length === 0 &&\n          <span className=\"badge badge-default ml-2\">\n            <span className=\"badge-text\">Puuduvad</span>\n          </span>\n        }\n      </h4>\n    )\n\n    return (\n      <>\n        { Table( backend.getConsents(true),  header(\"Kehtivad nõusolekud:\", backend.getConsents(true).length)) }\n        { Table( backend.getConsents(false), header(\"Kehtetud nõusolekud:\", backend.getConsents(false).length)) }\n      </>\n    )\n  }\n\n  return (\n    <div label = \"Minu nõusolekud\"> { Body(backend) } </div>\n  )\n}\n","import { ConsentServiceBackend } from './backendAPI';\nimport { UsageRecord } from '../types';\nimport React from 'react';\nimport { formatTimestamp } from './CSEnduserUI';\nimport { ConsentModal } from './ConsentModal';\nimport { business } from '../../../i18n';\n\nfunction usageRecordDescription(u: UsageRecord) {\n  if (u.result === 'OK') {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' sai Sinu andmed nõusoleku alusel';\n  } else if (u.consentReference) {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' küsis, kuid ei saanud Sinu andmeid tühistatud nõusoleku alusel';\n  } else {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' küsis, kuid ei saanud Sinu andmeid nõusoleku puudumise tõttu';\n  }\n} \n\nexport const ConsentHistory = (backend : ConsentServiceBackend) => {\n\n  const Modal = (backend : ConsentServiceBackend, consentReference : string) => {\n    if (!backend.mem) {\n      return;\n    }\n    const con = backend.mem.db.consents.find(c => c.consentReference === consentReference);\n    if (!con) {\n      return;\n    }\n    return (<td><ConsentModal backend={backend} consent={con} buttonText=\"Vaata nõusolekut\"/></td>)\n  }\n\n  const Body = (backend : ConsentServiceBackend) => {\n    if (backend.getUsageLogRecords().length === 0) {\n      return (\n        <p>Nõusolekute kasutamise sündmusi ei leitud.</p>\n      )\n    }\n    return (\n      <>\n        <h4>Ajalugu:</h4>\n        <table className=\"table align-middle\">\n          <tbody>\n          {\n            backend.getUsageLogRecords().map(\n              u => (\n                <tr key={u.clientId}>\n                  <td>{ usageRecordDescription(u) }</td>\n                  { u.consentReference ? Modal(backend, u.consentReference) : (<></>) }\n                </tr>\n              )\n            )\n          }\n          </tbody>\n        </table>\n      </>\n    )\n  } \n\n  return (\n    <div label=\"Nõusolekute kasutamise ajalugu\">\n      { Body(backend) }\n    </div>\n  );\n};\n","import React from 'react';\nimport { BackendStateUpdater } from '../../../postMessage';\nimport { ConsentServiceState, PurposeDeclaration } from '../types';\nimport { ConsentServiceBackend, Backend, CSBackend } from './backendAPI';\nimport VeeraLayout from './../../../components/veera/layout';\nimport Tabs from './../../../components/tabs/Tabs';\nimport { MyConsents } from './MyConsents';\nimport { ConsentHistory } from './ConsentHistory';\nimport { business } from '../../../i18n';\nimport { renderText } from '../../../util';\nimport { Modal, Button } from \"react-bootstrap\";\n\n\nfunction LoginScreen() {\n  return (\n    <div className=\"section\">\n      <h4>Nõusoleku andmiseks sisene Tervise- ja Heaolu Infosüsteemide Keskuse nõusolekute andmise keskkonda:</h4>\n      <p className=\"mt-3\"><a href=\"../ria/\" className=\"btn btn-primary\">Sisene</a></p>\n    </div>\n  );\n}\n\ninterface APDProps {\n  backend: ConsentServiceBackend;\n  activeDecl?: PurposeDeclaration;\n  tabRef: React.RefObject<Tabs>;\n  label: string;\n}\n\ninterface State {\n  signPopup: boolean;\n  returnPopup: boolean;\n  savedClientId?: string;  \n}\n\nclass ActivePurposeDeclaration extends React.PureComponent<APDProps, State> {\n  state : State = {\n    signPopup: false,\n    returnPopup: false,\n  };\n\n  constructor(props: APDProps) {\n    super(props);\n    this.showConsentTab = this.showConsentTab.bind(this);\n  }\n\n  showSignPopup(show: boolean) {\n    this.setState(s => ({ ...s, signPopup: show }));\n  }\n\n  showReturnPopup(show = true, clientId?: string) {\n    this.setState(s => ({ ...s, returnPopup: show, savedClientId: clientId }))\n  }\n\n  toggleSignPopup() {\n    this.setState(s => ({ ...s, signPopup: !s.signPopup }))\n  }\n\n  showConsentTab(ev: any) {\n    ev.preventDefault();\n    if (this.props.tabRef.current) this.props.tabRef.current.onClickTabItem(\"Minu nõusolekud\");\n  };\n\n  Popover() {\n    return (\n      <>\n        <Modal show={this.state.signPopup} onHide={() => this.toggleSignPopup()}>\n          <Modal.Body>\n            <h4>Nõusoleku andmiseks allkirjasta nõusolek digitaalselt</h4>\n          </Modal.Body>\n          <Modal.Footer>\n            <button className=\"btn btn-primary\" onClick={(ev) => {\n              this.props.backend.giveConsentByPurpose(\n                ev,\n                this.props.activeDecl!.services,\n                this.props.activeDecl!.clientId,\n                this.props.activeDecl!.purposeDeclarationId\n              );\n              this.toggleSignPopup();\n              this.showReturnPopup(true, this.props.activeDecl!.clientId);\n            }}>Allkirjasta</button>\n            <Button variant=\"secondary\" onClick={(ev:any) => this.toggleSignPopup()}>\n              Tagasi\n            </Button>\n          </Modal.Footer>\n        </Modal>\n        <Button variant=\"primary\" className=\"mr-2\" onClick={(ev:any) => this.toggleSignPopup()}>\n          Anna nõusolek\n        </Button>\n        <Button variant=\"secondary\" onClick={(ev:any) => window.close()}>\n          Ei anna nõusolekut\n        </Button>\n      </>\n    );\n  }\n\n  ReturnScreen() {\n    return (\n    <div>\n      <h4>Nõusolek { business(this.state.savedClientId!, \"name\") }-le on antud!</h4>\n      <p>Kõiki oma antud nõusolekuid näed ja saad hallata siit <a href=\"../../ui/csui\" onClick={this.showConsentTab}>Minu nõusolekud</a></p>\n      <button className=\"btn btn-primary\" onClick={() => {\n          window.close();\n          this.showReturnPopup(false);\n        }}>Tagasi teenusesse</button>\n    </div>\n    );\n  }\n\n  render() {\n\n    const activeDecl = this.props.activeDecl;\n\n    if (activeDecl === undefined) {\n      if (this.state.returnPopup) {\n        return this.ReturnScreen();\n      } else {\n        return (<div>Avatud taotlust pole.</div>);\n      }\n    }\n\n    return (\n        <div className=\"tab-info\">\n          <h4 className=\"mb-4 title\">{ business(activeDecl.clientId, \"name\") } ({ business(activeDecl.clientId, \"ntr\") }) küsib nõusolekute järgmistel tingimustel:</h4>\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-baseline\">\n                  <div><h4>Kirjeldus:</h4></div>\n                  <div>\n                    { renderText(activeDecl.description) }\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-end\">\n                  <div><h4>Kehtivus:</h4></div>\n                  <div>{activeDecl.validUntil && `Kehtib kuni: ${ formatTimestamp(activeDecl.validUntil)}`}</div>\n                </div>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-end\">\n                  <div><h4>Nõusoleku alusel saab { business(activeDecl.clientId, \"name\") } Sinu kohta järgmised andmed:</h4></div>\n                  <div>\n                    {\n                      activeDecl.services.map(sdref => {\n                        const sd = this.props.backend.getServiceDeclaration(sdref);\n                        if (sd === undefined) {\n                          return <></>;\n                        }\n                        return (\n                          <>\n                            <h4>{sd.name}</h4>\n                            { renderText(sd.description) }\n                          </>\n                        )\n                      })\n                    }\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col-md mt-4 mb-2 text-muted\">\n                Antud nõusoleku saad igal ajal tühistada oma nõusolekute vaatest <a href=\"../../ui/csui\" onClick={this.showConsentTab}>Minu nõusolekud</a>\n              </div>\n            </div>\n            <p className=\"mt-4\">\n              { this.Popover() }\n            </p>\n          </div>\n    );\n  }\n};\n\nconst MainView = ({backend, tabRef}: any) => {\n\n  let backendUse = backend.use();\n\n  if (backendUse === null || backendUse === undefined) {\n    return (\n      <>\n      <div className=\"section\">Wait, or reinit the client UI from the arena window... '{window.name}'</div>\n      </>\n    );\n  }\n\n  if (backendUse.mem!.ui.user === undefined) {\n    return LoginScreen();\n  }\n\n  const activeDecl = backendUse.getActivePurposeDeclaration();\n\n  return (\n    <Tabs ref={tabRef}>\n      <div label=\"Avatud taotlused\">\n        <ActivePurposeDeclaration label=\"Avatud taotlused\" backend={backendUse} activeDecl={activeDecl} tabRef={tabRef}/>\n      </div>\n      { MyConsents(backendUse) }\n      { ConsentHistory(backendUse) }\n    </Tabs>\n  )\n}\n\n\n\nexport class CSEnduserUI extends React.PureComponent<{}, ConsentServiceBackend> {\n  backendLink: BackendStateUpdater<ConsentServiceState, ConsentServiceBackend>;\n  backend: Backend;\n  ref: React.RefObject<any>;\n\n  constructor(props: any, context?: any) {\n    super(props, context);\n    this.backendLink = new BackendStateUpdater(csb => { this.setState(csb as ConsentServiceBackend); }, ConsentServiceBackend);\n    this.backend = new Backend();\n    this.ref = React.createRef();\n  }\n\n  componentDidMount() {\n    if (process.env.NODE_ENV === \"development\") {\n      require('../../../static/css/mta_visuaal.css');\n    }\n    document.body.classList.add('temp');\n    this.backendLink.resetState();\n  }\n\n  render() {\n    return (\n      <CSBackend.Provider value={this.state}>\n        <VeeraLayout backend={this.backend}>\n          <MainView backend={this.backend} tabRef={this.ref} />\n        </VeeraLayout>\n      </CSBackend.Provider>\n    );\n  }\n}\n\nexport function formatTimestamp(timestamp : number, withTime? : boolean) {\n  if (withTime) {\n    return Intl.DateTimeFormat(\n      'et',\n      {\n        year : 'numeric',\n        month : 'numeric',\n        day : 'numeric',\n        hour : 'numeric',\n        minute : 'numeric',\n        second : 'numeric'\n      }\n    ).format(new Date(timestamp*1000));\n  }\n  return Intl.DateTimeFormat('et').format(new Date(timestamp*1000));\n}\n","import React from 'react';\nimport { BackendStateUpdater } from '../../../postMessage';\nimport { ConsentServiceState } from '../types';\nimport { ConsentServiceBackend, Backend, CSBackend } from './backendAPI';\n\n\nexport class Ria extends React.PureComponent<{}, ConsentServiceBackend> {\n  backendLink: BackendStateUpdater<ConsentServiceState, ConsentServiceBackend>;\n  backend: Backend;\n\n  constructor(props: any, context?: any) {\n    super(props, context);\n    this.backendLink = new BackendStateUpdater(csb => { this.setState(csb as ConsentServiceBackend); }, ConsentServiceBackend);\n    this.backend = new Backend();\n  }\n\n  componentDidMount() {\n    if (process.env.NODE_ENV === \"development\") {\n      require('../../../static/assets/tara/main.css');\n    }\n    this.backendLink.resetState();\n  }\n\n  render() {\n    return (\n      <CSBackend.Provider value={this.state}>\n        <MainView backend={this.backend} />\n      </CSBackend.Provider>\n    )\n  }\n\n}\n\nconst MainView = ({backend}: any) => {\n  let backendUse = backend.use();\n  if (!backendUse) return (<p>Backend failed, close and reopen window.</p>)\n  let click = (ev: React.MouseEvent<HTMLButtonElement>) => {\n    ev.preventDefault();\n    backendUse.login(ev, (ev.currentTarget.form!.elements[0] as any).value)\n    window.location.href = \"../csui/\";\n  }\n  return(\n    <div className=\"c-layout\">\n      <div className=\"c-layout--full\">\n        <div className=\"c-header-bar\">\n          <div className=\"container\">\n            <div className=\"d-flex justify-content-between align-items-center\">\n              <header role=\"banner\">\n                <h1 aria-label=\"Riigi autentimisteenus\" aria-hidden=\"true\"></h1>\n                <p aria-label=\"Turvaline autentimine asutuste e-teenustes\">Turvaline autentimine asutuste e-teenustes</p>\n              </header>\n            </div>\n          </div>\n        </div>\n        <div className=\"c-header\">\n          <div className=\"container\">\n            <div className=\"c-header__logo\">\n              <div className=\"c-header__logo-link\">\n              <img src={require('./../../../static/assets/tara/tara-logo-et.png')} aria-hidden=\"true\" alt=\"\" /></div>\n            </div>\n          </div>\n        </div>\n        <div className=\"container\">\n          <div className=\"c-tab-login\">\n            <main role=\"main\" className=\"c-tab-login__main\">\n              <div className=\"c-tab-login__content is-active\" data-tab=\"mobile-id\" aria-hidden=\"false\">\n                <div className=\"c-tab-login__content-wrap\">\n                  <div className=\"c-tab-login__content-icon\">\n                    <svg role=\"img\" aria-label=\"\" className=\"icon icon-mobile-id\"><use href=\"#icon-mobile-id\"></use></svg>\n                  </div>\n                <div className=\"c-tab-login__content-text\">\n                  <div role=\"heading\">\n                    <h2>Mobiil-ID</h2>\n                  </div>\n                  <p>Sisselogimiseks vajate kehtivat Mobiil-ID lepingut. Sisenemiseks Mobiil-ID-ga sisestage oma isikukood ja telefoninumber. Seejärel saadetakse Teie mobiiltelefonile kontrollsõnum.</p>\n                  <form>\n                    <table>\n                      <tbody>\n                        <tr>\n                          <td className=\"col-label\">\n                            <label htmlFor=\"mid-personal-code\" className=\"form-label\">Isikukood</label>\n                          </td>\n                          <td>\n                            <div className=\"input-group\">\n                              <div className=\"input-group-prepend\">\n                                <span className=\"input-group-text\">EE</span>\n                              </div>\n                              <input type=\"text\" id=\"mid-personal-code\" className=\"form-control\" name=\"principalCode\" defaultValue=\"47302200234\" />\n                            </div>\n                          </td>\n                          </tr>\n                          <tr>\n                            <td className=\"col-label\">\n                              <label htmlFor=\"mid-phone-number\" className=\"form-label\">Telefoninumber</label>\n                            </td>\n                            <td>\n                              <div className=\"input-group\">\n                                <div className=\"input-group-prepend\">\n                                  <span className=\"input-group-text\">+372</span>\n                                </div>\n                                <input type=\"tel\" id=\"mid-phone-number\" className=\"form-control\" name=\"mobileNumber\" defaultValue=\"53883333\" /></div>\n                              </td>\n                            </tr>\n                            <tr>\n                              <td></td>\n                              <td>\n                                <button className=\"c-btn c-btn--primary\" onClick={(ev) => click(ev)}>Jätkan</button>\n                              </td>\n                            </tr>\n                          </tbody>\n                        </table>\n                      </form>\n                    </div>\n                  </div>\n                  <div className=\"c-tab-login__footer\">\n                    <p><a href=\"https://tim.www.eesti.ee/tim/cancel-auth\">Tagasi teenusepakkuja juurde</a></p>\n                    <p>\n                      <a href=\"https://www.id.ee/?id=35803&amp;group_id=1\" target=\"_blank\" rel=\"noopener noreferrer\">Abi id.ee lehelt</a>\n                    </p>\n                  </div>\n                </div>\n              </main>\n            </div>\n          </div>\n          <p className=\"link-back-mobile\">\n            <a href=\"https://tim.www.eesti.ee/tim/cancel-auth\">Tagasi teenusepakkuja juurde</a>\n          </p>\n          <svg aria-hidden=\"true\" className=\"c-inline-svg__hidden\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\">\n            <defs>\n            <symbol id=\"icon-mobile-id\" viewBox=\"0 0 20 32\">\n            <title>mobile-id</title>\n            <path d=\"M7.218 28.027h5.476v1.12h-5.476zM15.876 31.68h-12.089c-0 0-0 0-0 0-1.8 0-3.261-1.454-3.271-3.252v-24.854c0.005-1.803 1.468-3.262 3.271-3.262 0 0 0 0 0 0h12.089c0 0 0 0 0 0 1.803 0 3.266 1.459 3.271 3.262v24.845c-0.005 1.803-1.468 3.262-3.271 3.262 0 0 0 0 0 0v0zM3.787 1.422c0 0 0 0-0 0-1.19 0-2.155 0.962-2.16 2.151v22.045h16.409v-22.044c0 0 0 0 0-0 0-1.188-0.963-2.151-2.151-2.151-0.003 0-0.006 0-0.009 0h0zM1.627 28.418c0.005 1.189 0.97 2.151 2.16 2.151 0 0 0 0 0 0h12.089c0 0 0 0 0 0 1.19 0 2.155-0.962 2.16-2.151v-1.689h-16.409zM12.382 8.951c-0.721-0.218-1.55-0.343-2.408-0.343-0.544 0-1.076 0.050-1.592 0.147l0.053-0.008c-0.018 0.004-0.039 0.006-0.060 0.006-0.154 0-0.282-0.108-0.313-0.252l-0-0.002c-0.009-0.089 0-0.169 0.053-0.231 0.047-0.068 0.119-0.117 0.202-0.133l0.002-0c0.494-0.094 1.063-0.147 1.644-0.147 0.922 0 1.813 0.135 2.653 0.386l-0.065-0.017c0.132 0.040 0.226 0.16 0.226 0.302 0 0.174-0.141 0.315-0.315 0.315-0.032 0-0.062-0.005-0.091-0.013l0.002 0.001zM14.187 11.396c-0 0-0.001 0-0.001 0-0.066 0-0.127-0.020-0.178-0.054l0.001 0.001c-1.129-0.791-2.531-1.263-4.043-1.263-1.375 0-2.659 0.391-3.747 1.067l0.030-0.017c-0.049 0.032-0.109 0.051-0.174 0.051-0.113 0-0.213-0.059-0.27-0.148l-0.001-0.001c-0.033-0.049-0.053-0.108-0.053-0.173 0-0.116 0.064-0.217 0.158-0.271l0.002-0.001c1.151-0.716 2.547-1.141 4.043-1.141 1.65 0 3.18 0.517 4.435 1.397l-0.025-0.016c0.142 0.089 0.178 0.293 0.089 0.436-0.059 0.081-0.153 0.133-0.26 0.133-0.002 0-0.005-0-0.007-0h0zM5.236 13.92c-0.176-0.001-0.318-0.144-0.318-0.32 0-0.070 0.023-0.135 0.061-0.188l-0.001 0.001c1.147-1.527 2.954-2.505 4.99-2.505 1.961 0 3.709 0.907 4.85 2.324l0.009 0.012c0.107 0.142 0.089 0.338-0.053 0.444-0.053 0.041-0.121 0.066-0.195 0.066-0.101 0-0.19-0.046-0.249-0.119l-0-0.001c-1.035-1.279-2.604-2.090-4.364-2.090-1.826 0-3.448 0.874-4.471 2.227l-0.010 0.014c-0.057 0.078-0.146 0.13-0.248 0.133l-0.001 0zM5.556 17.138c-0.003 0-0.006 0-0.009 0-0.172 0-0.311-0.139-0.311-0.311 0-0 0-0 0-0v0-0.018c0.161-2.486 2.216-4.441 4.728-4.441 2.137 0 3.943 1.415 4.534 3.358l0.009 0.034c0.004 0.018 0.006 0.039 0.006 0.061 0 0.177-0.143 0.32-0.32 0.32-0.128 0-0.238-0.075-0.289-0.183l-0.001-0.002v-0.018c-0.511-1.722-2.079-2.956-3.936-2.956-2.181 0-3.963 1.703-4.091 3.852l-0.001 0.011c-0.010 0.164-0.145 0.293-0.311 0.293-0.003 0-0.007-0-0.010-0h0zM7.004 19.387c-0.176-0-0.319-0.144-0.319-0.32 0-0.025 0.003-0.050 0.008-0.073l-0 0.002c0.082-0.236 0.129-0.507 0.129-0.79 0-0.116-0.008-0.231-0.023-0.343l0.001 0.013c-0.085-0.277-0.134-0.596-0.134-0.926 0-1.802 1.461-3.262 3.262-3.262 1.579 0 2.896 1.122 3.197 2.612l0.004 0.021c0.142 0.587 0.213 1.182 0.204 1.778 0 0.178-0.142 0.32-0.32 0.32-0.17-0.005-0.306-0.141-0.311-0.311v-0c0-0.551-0.062-1.102-0.178-1.636-0.291-1.16-1.325-2.005-2.556-2.005-1.453 0-2.631 1.178-2.631 2.631 0 0.222 0.028 0.439 0.080 0.645l-0.004-0.018c0.080 0.329 0.044 0.809-0.107 1.422-0.036 0.137-0.157 0.236-0.302 0.24h-0zM8.311 20.151l-0.089-0.009c-0.128-0.041-0.219-0.158-0.219-0.297 0-0.034 0.005-0.066 0.015-0.096l-0.001 0.002c0.169-0.456 0.266-0.982 0.266-1.531 0-0.244-0.019-0.483-0.056-0.717l0.003 0.026c-0.059-0.17-0.093-0.367-0.093-0.571 0-0.992 0.804-1.796 1.796-1.796 0.892 0 1.632 0.65 1.772 1.503l0.001 0.010c0.213 0.836 0.222 1.804 0.027 2.88-0.001 0.176-0.144 0.319-0.32 0.319s-0.32-0.143-0.32-0.32c0-0.038 0.007-0.074 0.018-0.107l-0.001 0.002c0.178-0.987 0.169-1.867-0.018-2.631-0.128-0.51-0.583-0.882-1.124-0.882-0.639 0-1.158 0.518-1.158 1.158 0 0.098 0.012 0.193 0.035 0.284l-0.002-0.008c0.16 0.64 0.089 1.502-0.222 2.56-0.043 0.13-0.163 0.222-0.305 0.222-0.002 0-0.005-0-0.007-0h0zM9.804 20.329c-0.172-0.005-0.31-0.147-0.31-0.32 0-0.025 0.003-0.050 0.008-0.073l-0 0.002c0.159-0.552 0.256-1.187 0.267-1.843l0-0.006c0-0.311-0.036-0.622-0.107-0.916-0.001-0.008-0.001-0.017-0.001-0.026 0-0.177 0.143-0.32 0.32-0.32 0.131 0 0.244 0.079 0.294 0.192l0.001 0.002c0.089 0.356 0.124 0.711 0.116 1.067-0.010 0.716-0.113 1.403-0.298 2.056l0.014-0.056c-0.036 0.137-0.157 0.236-0.302 0.24h-0z\"></path>\n          </symbol>\n          </defs>\n        </svg>\n      </div>\n    </div>\n  )\n}","import React, { Suspense } from 'react';\nimport './App.css';\nimport { BrowserRouter as Router, Switch, Route } from \"react-router-dom\";\nimport { Theatre } from './components/Theatre';\nimport { useTranslation } from 'react-i18next';\nimport { CSEnduserUI } from './process/consentService/altUI/CSEnduserUI';\nimport { Ria } from './process/consentService/altUI/ria';\n\nconst Page = () => {\n  const { i18n } = useTranslation();\n\n  const changeLanguage = (lng: string) => {\n    i18n.changeLanguage(lng);\n  };\n\n  return (\n    <div className=\"App\">\n        <Router basename=\".\">\n          <Switch>\n            <Route path=\"(.*)/ui/ria\">\n              <Ria/>\n            </Route>\n            <Route path=\"(.*)/ui/csui\">\n              <CSEnduserUI/>\n            </Route>\n            <Route path=\"/\">\n              <nav className=\"navbar navbar-light bg-light mb-4\">\n                <span className=\"navbar-brand\">\n                  <img alt=\"logo\" src={require('./logo.svg')} width=\"40\" />\n                </span>\n                <div className=\"language\">\n                  <a href=\"#!\"\n                    onClick={(e) => {e.preventDefault(); changeLanguage('et')}}\n                    className={ i18n.language === 'et' ? 'active': '' }>et</a>\n                  <a href=\"#!\"\n                    onClick={(e) => {e.preventDefault(); changeLanguage('en')}}\n                    className={ i18n.language === 'en' || i18n.language === 'en-US' ? 'active': '' }>en</a>\n                </div>\n              </nav>\n              <div className=\"container-fluid\">\n                <Theatre/>\n              </div>\n            </Route>\n          </Switch>\n        </Router>\n    </div>\n  );\n}\n\n// loading component for suspense fallback\nconst Loader = () => (\n  <div className=\"App\">\n    <div>loading...</div>\n  </div>\n);\n\nconst App: React.FC = () => {\n  return (\n    <Suspense fallback={<Loader />}>\n      <Page />\n    </Suspense>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import { createStore, combineReducers, applyMiddleware } from \"redux\";\nimport thunkMiddleware from \"redux-thunk\";\nimport { composeWithDevTools } from \"redux-devtools-extension\";\n\nimport { queueListener } from \"./components/Arena\";\nimport { reduceTheatre } from \"./components/Theatre\";\nimport { registerGlobalListener } from \"./postMessage\";\n\nconst rootReducer = combineReducers({\n\ttheatre: reduceTheatre,\n});\n\n\nexport type AppState = ReturnType<typeof rootReducer>;\n\nexport default function configureStore() {\n\t  const middlewares = [thunkMiddleware];\n\t  const middleWareEnhancer = applyMiddleware(...middlewares);\n\n\t  const store = createStore(\n\t\t      rootReducer,\n\t\t      composeWithDevTools(middleWareEnhancer)\n\t  );\n\n\tstore.subscribe(() => queueListener(store));\n\n\tregisterGlobalListener(store);\n\n\treturn store;\n}\n\n\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport { Provider } from \"react-redux\";\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\nimport configureStore from './store';\nimport './i18n';\n\nconst store = configureStore();\n\nReactDOM.render(<Provider store={store}><App /></Provider>, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","module.exports = __webpack_public_path__ + \"static/media/user-icon.bdeaa261.svg\";","module.exports = __webpack_public_path__ + \"static/media/login.9f370677.svg\";"],"sourceRoot":""}