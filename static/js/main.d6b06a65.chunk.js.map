{"version":3,"sources":["static/assets/images/logo-est.png","static/assets/tara/tara-logo-et.png","static/assets/images/arena-logo.png","process/Base.tsx","postMessage.tsx","i18n.ts","components/LogRows.tsx","components/MessageLog.tsx","components/Process.tsx","byNameStore.tsx","components/Arena.tsx","components/SendButton.tsx","process/Counter.tsx","components/Popup.tsx","components/Client.tsx","process/TokenRing.tsx","process/client/types.tsx","process/consentService/types.tsx","util.tsx","process/consentService/declarationAPI.tsx","process/consentService/ui.tsx","process/consentService/referenceAPI.tsx","process/serviceProvider/types.tsx","process/consentService/validationAPI.tsx","process/consentService/reportingAPI.tsx","process/serviceProvider/messages.tsx","process/client/messages.tsx","process/client/EnduserUI.tsx","process/client/views.tsx","process/client/constructor.tsx","process/consentService/constructor.tsx","process/consentService/views.tsx","process/serviceProvider/views.tsx","process/serviceProvider/constructor.tsx","config.tsx","components/Theatre.tsx","process/consentService/altUI/backendAPI.tsx","components/veera/footer.tsx","components/veera/header.tsx","components/veera/layout.tsx","components/tabs/Tab.tsx","components/tabs/Tabs.tsx","process/consentService/altUI/ConsentModal.tsx","process/consentService/altUI/MyConsents.tsx","process/consentService/altUI/ConsentHistory.tsx","process/consentService/altUI/CSEnduserUI.tsx","process/consentService/altUI/ria.tsx","App.tsx","serviceWorker.ts","store.tsx","index.tsx","static/assets/images/user-icon.svg","static/assets/images/login.svg"],"names":["module","exports","MESSAGE","handlers","addHandlerClass","impl","c","handler","type","undefined","addHandler","name","p","a","handle","obj","values","createMessage","message","arena","sender","receivers","length","GenericMessageHandler","this","process","action","mem","updateMem","queue","concat","payload","send","error","extra","withResponse","response","uiMap","addUi","url","defaultRender","JSON","stringify","renderers","addRenderer","view","renderer","updateDb","newdb","db","STATE_UPDATE","INITIALIZED","StateUpdateMessage","statusUpdateChannel","StateUpdater","store","ui","_cachedState","_storeUnsubscriber","_messageListener","_channel","URL","window","location","href","open","Math","random","subscribe","stateChanged","processMessage","addEventListener","removeEventListener","state","ps","theatre","arenas","byName","selectProcess","getState","postMessage","origin","e","console","unregisterListeners","msg","data","dispatch","registeredUpdaters","BackendStateUpdater","setter","caster","log","ev","receiveNewState","newState","withUpdater","target","opener","channelId","Object","assign","setState","BackendAPI","updater","m","split","i18n","use","Backend","LanguageDetector","initReactI18next","init","fallbackLng","debug","backend","loadPath","pathname","includes","interpolation","escapeValue","__","props","labels","suffix","join","proc","t","map","pref","styleNameFor","fullname","id","prop","replace","person","business","formatProcess","className","formatLogtime","epochSeconds","Date","toLocaleString","formatHeader","owner","showPopup","onClick","now","names","r","i","formatBody","max","key","value","substring","defaultRenderer","LogRow","findLogRenderer","addLogRenderers","keys","forEach","addLogRenderer","LogView","ref","React","filterFn","showSelf","scollToBottom","scroll","setTimeout","current","scrollHeight","index","_this","show","onHide","closePopup","size","Body","Footer","Button","variant","logLines","rows","filter","slice","maxRows","popup","line","formatLogLine","MessageLog","connect","ownProps","selectArena","LogButton","Header","Title","ModalFooter","children","render","findRenderer","ProcessUI","visible","setVisible","UILink","button","useStore","launch","push","registerListeners","launchUI","el","addByName","old","allNames","n","reduceByName","reducer","k","fromArray","reduce","MESSAGE_DELAY","createProcess","reduceProcesses","CREATE_PROCESS","FLUSH_QUEUE","reduceArena","reduceMessage","fixNowAndRandom","queueListener","queued","flat","d","getQueued","delayedSender","shift","Arena","useTranslation","processes","role","parseOrRaw","s","startsWith","parse","f","Array","from","elements","u","out","options","selected","checked","o","Send","preventDefault","messageToAction","currentTarget","form","handleClick","title","text","SimpleSend","Counter","CounterDefaultView","IncrementMessageHandler","DecrementMessageHandler","incrementMessage","decrementMessage","Popup","LOGIN","alt","src","require","ClientView","loading","changeView","aria-hidden","width","TokenNode","WithToken","WithoutToken","createTokenNode","next","token","initPassMessage","node","tokenMessage","updateNextMessage","SetTargetPopup","setShow","handleClose","handleShow","closeButton","htmlFor","readOnly","multiple","defaultValue","bsPrefix","Client","ClientIS","ClientDefaultView","ConsentService","ConsentServiceDefaultView","findFrom","items","example","find","hash","input","createHash","update","digest","address2org","address","match","renderText","stack","last","indent","l","prefix","pop","ul","addServiceDeclaration","cs","sd","serviceDeclarations","decl","serviceProviderId","serviceDeclarationId","withErrorResponse","withOkResponse","addPurposeDeclaration","pd","purposeDeclarations","clientId","purposeDeclarationId","services","sdRef","loginMessage","user","giveConsentMessage","con","consents","newConsent","dataSubject","revoked","updatedCS","addConsent","activeUser","activePurposeDeclaration","updatedCS2","setActivePD","callbackURL","fetchConsentReference","revokeConsentMessage","consentReference","validUntil","revokeAt","revokeIfReferenceEquals","revokeConsent","updateAPDforUser","refs","activatePurposeDeclarationMessage","ConsentReferenceResponseTypeName","fixRevoked","getConsentReference","req","_cs","consent","subjectId","ServiceProviderIS","ServiceProviderDefaultView","requestTypeName","responseTypeName","ValidationResponseTypeName","NotValidResponse","asyncId","valid","validateConsentReference","notValid","validFrom","purposeDeclaration","consentExpiration","toISOString","dataSubjectId","reportServiceUse","usageLog","addUsageRecord","addData","spis","datatype","rec","dbrec","subject","declareService","consentService","requestId","service","requestReference","serviceName","submitRequest","_send","report","result","serviceDeclarationIds","requiredServiceDeclarationIds","usageTime","reqState","validationRequestId","clientAddress","withInfligh","inflight","partyId","ifr","resp","removeInflight","usageReport","submitResponse","records","x","returnedDatatypes","selectServiceMessage","cachedConsentRefs","consentRefByUser","cachedConsentRef","consentServiceId","declarePurpose","cis","updateCSRef","csByUser","executeRequest","userConsentRefs","purposeId","conf","config","serviceAddress","_cis","newResponses","requestReferenceId","__cis","generateRequestReference","updateConsentRefInCache","validateConsentRef","SELECT_SERVICE","WAIT_FOR_CONSENT_REF","CONSENT_NOT_FOUND","SERVICE_V1","currentView","ClientView_","sendMessagesFor","withMessages","componentDidUpdate","actualView","returnButton","dangerouslySetInnerHTML","__html","EnduserUI","DeclarePurposePopup","sp","setOpts","useState","sdrefs","setSDRefs","declTemplate","onChange","decls","declId","description","prefillPurposeDeclaration","dt","sdref","placeholder","opts","spId","_spId","sdId","_sdId","addSDRef","hasUser","purpose","consentRef","consentRefDesc","dropdownToggle","forwardRef","updateConsentRefDropdown","style","Dropdown","Toggle","as","Menu","purposeView","updateMaxDuration","v","declarationPrefill","technicalDescription","needSignature","md","consentMaxDurationSeconds","prefillServiceDeclaration","DeclareServicePopup","allValues","sort","alert","CS1Address","defaultArena","createServiceProvider","createData","diagnoos","arst","createConsentService","logRenderers","createCounter","initialTheatre","createArena","active","SELECT_ARENA","_Theatre","PureComponent","Theatre","ConsentServiceBackend","post","getValidUntil","floor","getConsents","ur","candidate","expiresIn","getServiceDeclaration","Number","CSBackend","createContext","ctx","useContext","rel","backendUse","login","VeeraLayout","Tab","label","activeTab","cursor","Component","Tabs","onClickTabItem","tab","child","ConsentModal","buttonText","dec","rowView","formatTimestamp","isConsentActive","handleRevoke","MyConsents","Table","header","getPurposeDeclaration","consentDescription","ConsentHistory","getUsageLogRecords","usageRecordDescription","Modal","ActivePurposeDeclaration","signPopup","returnPopup","showConsentTab","bind","savedClientId","tabRef","toggleSignPopup","giveConsentByPurpose","activeDecl","showReturnPopup","close","ReturnScreen","Popover","MainView","getActivePurposeDeclaration","CSEnduserUI","context","backendLink","csb","createRef","document","body","classList","add","resetState","Provider","timestamp","withTime","Intl","DateTimeFormat","year","month","day","hour","minute","second","format","Ria","aria-label","data-tab","click","version","xmlns","viewBox","Page","changeLanguage","lng","basename","path","language","Loader","App","fallback","Boolean","hostname","rootReducer","combineReducers","middlewares","thunkMiddleware","middleWareEnhancer","applyMiddleware","createStore","composeWithDevTools","su","source","registerGlobalListener","configureStore","ReactDOM","getElementById","navigator","serviceWorker","ready","then","registration","unregister"],"mappings":"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","file":"static/js/main.d6b06a65.chunk.js","sourcesContent":["module.exports = __webpack_public_path__ + \"static/media/logo-est.bca08fff.png\";","module.exports = __webpack_public_path__ + \"static/media/tara-logo-et.5947b56d.png\";","module.exports = __webpack_public_path__ + \"static/media/arena-logo.03f46566.png\";","import { AnyAction } from 'redux';\n\nexport type InstanceName = string;\nexport type ProcessImplName = string;\nexport type ViewName = string;\n\n// state\n\nexport interface ProcessState<S> {\n\tname: string; // instantsi nimi\n\ttitle: string;\n\ttype: ProcessImplName; // implementatsiooni nimi?\n\tview: ViewName; // \"olek\", tegelikult defineerib vaate\n\tmem: S; // sisuline olek\n\tqueue: Message<any>[]; // outbound queue, reduceritest kasutamiseks?\n}\n\n// sõnumi-action\n\nexport const MESSAGE = \"Process/SEND_MESSAGE\";\n\nexport interface Message<PL extends Payload> extends AnyAction {\n\ttype: typeof MESSAGE;\n\tarena: string;\n\tsender: string;\n\treceivers: string[];\n\tmessage: PL;\n\tnow?: number;\n\trandom?: string;\n}\n\nexport interface Payload {\n\ttype: string;\n}\n\nexport interface ErrorPayload extends Payload {\n\ttype: \"error\";\n\terror: string;\n}\n\nexport interface OKPayload extends Payload {\n\ttype: \"ack\"\n\tresponse: \"OK\";\n}\n\nexport type MessageHandler<S, M extends Payload> = (process: ProcessState<S>, action: Message<M>) => ProcessState<S>;\n\nconst handlers : { [impl: string] : { [type: string]: MessageHandler<any, any> } } = {};\n\nexport function addHandler<P extends Payload>(impl: ProcessImplName, type: string, handler: MessageHandler<any, P>) {\n\tif (handlers[impl] === undefined) {\n\t\thandlers[impl] = {};\n\t}\n\n\thandlers[impl][type] = handler;\n}\n\nexport function addHandlerClass<P extends Payload, T extends GenericMessageHandler<any, ProcessState<any>, P, T>>(impl: ProcessImplName, c: { new(): T }) {\n\tlet handler = new c();\n\taddHandler<P>(impl, handler.name, (p, a) => handler.handle(p, a));\n\treturn (obj?: Partial<P>) => ( (values?: Partial<P>) => handler.createMessage({...(values === undefined ? {} : values), ...(obj === undefined ? {} : obj)}) );\n}\n\nexport function reduceMessage<T>(process: ProcessState<T>, action: Message<Payload>): ProcessState<T> {\n\t//\tconsole.log(`reduceMessage ${JSON.stringify(process)}, ${JSON.stringify(action)}`);\n\tif (action.type !== MESSAGE || !action.receivers.includes(process.name)) {\n\t\treturn process;\n\t}\n\n\tif (handlers[process.type] === undefined) {\n\t\tconsole.error(`No handler for ${process.name} (${process.type})`);\n\t\treturn process;\n\t}\n\n\tif (handlers[process.type][action.message.type] === undefined) {\n\t\tconsole.error(`No handler for ${process.name} (${process.type}) for message ${action.message.type} (${JSON.stringify(action.message)})`);\n\t\treturn process;\n\t}\n\n\treturn handlers[process.type][action.message.type](process, action);\n}\n\nexport function message<M extends Payload>(arena: string, sender: ProcessState<any>, receivers: string[], message: M): Message<M> {\n\treturn { \n\t\ttype: MESSAGE,\n\t\tarena: arena,\n\t\tsender: sender.name, \n\t\treceivers: receivers.length === 0 ? [sender.name] : receivers,\n\t\tmessage: message\n\t};\n}\n\nexport abstract class GenericMessageHandler<S, PS extends ProcessState<S>, M extends Payload, GMH extends GenericMessageHandler<S, PS, M, GMH>> {\n\tabstract name: string;\n\n\tcreateMessage(obj: any): (M & { type: GMH[\"name\"] }) { return { ...obj, type: this.name }; };\n\thandle(process: PS, action: Message<M>): PS { return { ...process, mem: this.updateMem(process.mem, action) }; };\n\tupdateMem(mem: S, action: Message<M>): S { return mem; };\n\n\tsend<NM extends Payload>(process: PS, message: Message<NM>): PS {\n\t\treturn { ...process, queue: process.queue.concat(message) };\n\t}\n\n\twithResponse<NM extends Payload>(process: PS, action: Message<M>, payload: NM): PS {\n\t\treturn this.send(process, message<NM>(action.arena, process, [action.sender], payload));\n\t}\n\n\twithErrorResponse(process: PS, action: Message<M>, error: string, extra?: any) {\n\t\treturn this.withResponse<ErrorPayload>(process, action, { type: \"error\", error: error, ...extra });\n\t}\n\n\twithOkResponse(process: PS, action: Message<M>) {\n\t\treturn this.withResponse<OKPayload>(process, action, { type: \"ack\", response: \"OK\"});\n\t}\n\t\n}\n\n\n// UId\nexport const uiMap : { [type: string /* ProcessImplName */]: string /* URL */ } = {};\n\nexport function addUi(impl: ProcessImplName, url: string) {\n\tuiMap[impl] = url;\n}\n\n// renderdus\n\nexport interface ProcessAndArena<S> {\n\tprocess: ProcessState<S>;\n\tarena: string;\n}\n\nexport type ProcessRenderer<S> = React.FC<ProcessAndArena<S>> | ((props: ProcessAndArena<S>) => string);\n\nconst defaultRender: ProcessRenderer<any> = ({process} : ProcessAndArena<any>) => JSON.stringify(process.mem);\n\nconst renderers : { [impl: string /* ProcessImplName */]: { [view: string /* ViewName */]: ProcessRenderer<any> } } = {};\n\nexport function addRenderer(impl: ProcessImplName, view: ViewName, renderer: ProcessRenderer<any>) {\n\tif (renderers[impl] === undefined) {\n\t\trenderers[impl] = {};\n\t}\n\n\trenderers[impl][view] = renderer;\n}\n\nexport function findRenderer<S>(process: ProcessState<S>): ProcessRenderer<S> {\n\tif (renderers[process.type] === undefined) {\n\t\tconsole.error(`No renderer for ${process.type}`);\n\t\treturn defaultRender;\n\t}\n\n\tif (renderers[process.type][process.view] === undefined) {\n\t\tconsole.error(`No renderer for ${process.type} and view ${process.view}`);\n\t\treturn defaultRender;\n\t}\n\n\treturn renderers[process.type][process.view];\n}\n\nexport function updateMem<S>(process: ProcessState<S>, mem: Partial<S>): ProcessState<S> {\n\treturn { ...process, mem: { ...process.mem, ...mem }};\n}\n\nexport function updateDb<T, S extends ({ db: T; })>(process: ProcessState<S>, newdb: Partial<T>): ProcessState<S> {\n\treturn updateMem<S>(process, { db: { ...process.mem.db, ...newdb} } as Partial<S>);\n}","import { Store } from 'redux';\nimport { InstanceName, ViewName, MESSAGE, Message, Payload } from './process/Base';\nimport { AppState } from './store';\n\nexport const STATE_UPDATE = \"STATE_UPDATE\";\nexport const INITIALIZED = \"INITIALIZED\";\n\ntype MessagingTarget = Window | ServiceWorker | null;\n\nexport class StateUpdateMessage<P> {\n    type!: typeof STATE_UPDATE;\n    view!: ViewName;\n    mem?: P;\n    statusUpdateChannel?: number;\n}\n\nfunction selectProcess(state: AppState, arena: string, process: InstanceName): StateUpdateMessage<any> {\n    let ps = state.theatre.arenas.byName[arena].process.byName[process];\n    if (ps === undefined) {\n        // no such process?\n        return { type: STATE_UPDATE, view: \"\" };\n    }\n    return { type: STATE_UPDATE, view: ps.view, mem: ps.mem}\n}\n\nclass StateUpdater {\n    arena: string;\n    process: InstanceName;\n    store: Store;\n    url: URL;\n    ui: MessagingTarget;\n\n    _cachedState: any;\n    _storeUnsubscriber: any = null;\n    _messageListener: ((message: MessageEvent) => any) | null = null;\n    _channel: number;\n\n    constructor(arena: string, process: InstanceName, store: Store, url: string, ui?: MessagingTarget) {\n        this.arena = arena;\n        this.process = process;\n        this.store = store;\n        this.url = new URL(url, window.location.href);\n        if (ui === undefined) {\n            this.ui = window.open(url, `${arena} - ${process}`);\n        } else {\n            this.ui = ui;\n        }\n        this._channel = Math.random();\n    }\n\n    registerListeners() {\n        this._storeUnsubscriber = this.store.subscribe(() => { this.stateChanged(); })\n        this._messageListener = (message) => { this.processMessage(message); };\n        window.addEventListener(\"message\", this._messageListener);\n        return this;\n    }\n\n    unregisterListeners() {\n        this._storeUnsubscriber();\n        this._storeUnsubscriber = null;\n\n        if (this._messageListener !== null) {\n            window.removeEventListener(\"message\", this._messageListener);\n            this._messageListener = null;\n        }\n\n        return this;\n    }\n\n    stateChanged() {\n        let state = selectProcess(this.store.getState(), this.arena, this.process);\n        if (state !== this._cachedState) {\n            // postMessage originiga, mis ei ole \"*\" ei tööta ffga?\n            // https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage#Example lõpp\n            try { \n            this.ui!.postMessage({...state, statusUpdateChannel: this._channel}, this.url.origin);\n            } catch (e) {\n                console.error(\"Error posting message, stopping\", e);\n                this.unregisterListeners();\n            }\n            this._cachedState = state;\n        }\n        return this;\n    }\n\n    processMessage(msg: MessageEvent): void {\n        switch (msg.data.type) {\n            case INITIALIZED:\n                this._cachedState = undefined; // force state update\n                this.stateChanged();\n                return;\n\n            default:\n                if (msg.data.statusUpdateChannel !== this._channel) {\n                    // not for us. \n                    return;\n                }\n\n                // only messages to self.\n                this.store.dispatch({ \n                    type: MESSAGE, \n                    arena: this.arena,\n                    sender: this.process,\n                    receivers: [this.process],\n                    message: { ...msg.data, statusUpdateChannel: undefined },\n                } as Message<Payload>);\n        }\n    }\n}\n\nconst registeredUpdaters : StateUpdater[] = [];\n\nexport function registerGlobalListener(store: Store) {\n    window.addEventListener(\"message\", ev => {\n        if (ev.data.type === INITIALIZED) {\n            let [arena, process] = ev.data.target.split(' - ');\n            let url = ev.data.url;\n            if (registeredUpdaters.find(su => su.arena === arena && su.process === process && su.ui === ev.source) === undefined) {\n                console.log(\"Unregistered childwindow, registering: \", ev.data);\n                registeredUpdaters.push(\n                    new StateUpdater(arena, process, store, url, ev.source as Window)\n                    .registerListeners()\n                    .stateChanged()\n                );\n                ev.preventDefault();\n            }\n        }\n    });\n}\n\nexport function launchUI(arena: string, process: InstanceName, url: string, store: Store) {\n    registeredUpdaters.push(new StateUpdater(arena, process, store, url).registerListeners());\n}\n\n\nexport class BackendStateUpdater<S, C extends BackendAPI<S>> {\n    state!: StateUpdateMessage<S>;\n\n    setter: (newState: BackendAPI<S>) => void;\n    caster: { new(s: StateUpdateMessage<S>): C };\n\n    constructor(setter: (newState: BackendAPI<S>) => void, caster: { new(s: StateUpdateMessage<S>): C }) {\n        this.setter = setter;\n        this.caster = caster;\n        console.log(\"setting listener\");\n        window.addEventListener(\"message\", (ev) => { this.receiveNewState(ev); });\n    }\n\n    setState(newState: StateUpdateMessage<S>) {\n        console.log(\"updating state:\", newState);\n        this.state = newState;\n        this.setter(new this.caster(newState).withUpdater(this));\n    }\n\n    resetState() {\n        this.postMessage(INITIALIZED, { target: window.name, url: window.location.href });\n    }\n\n    postMessage(type: string, message?: any) {\n        if (window.opener === null) {\n            this.setState({ type: STATE_UPDATE, view: \"\", mem: { \"error\": \"NO OPENER WINDOW\", ui: {} }} as any);\n            return;          \n        }\n\n        const channelId = this.state !== undefined ? { statusUpdateChannel: this.state.statusUpdateChannel } : {};\n\n        let msg = Object.assign({}, (message === undefined ? {} : message), { type }, channelId);\n        console.log(\"posting message:\", msg);\n        window.opener.postMessage(msg);\n    }\n\n    receiveNewState(ev: MessageEvent) {\n        if (ev.data.type === STATE_UPDATE) {\n            this.setState(ev.data);\n        }\n    }\n}\n\nexport class BackendAPI<S> extends StateUpdateMessage<S> {\n    updater!: BackendStateUpdater<S, BackendAPI<S>>;\n\n    constructor(msg?: StateUpdateMessage<S>) {\n        super();\n        Object.assign(this, msg);\n    }\n\n    withUpdater(updater: BackendStateUpdater<S, BackendAPI<S>>) {\n        this.updater = updater;\n        return this;\n    }\n\n    post(msg: () => Payload) {\n        let m = msg();\n        this.updater.postMessage(m.type, m);\n    }  \n\n\n    arena(): string {\n        return window.name.split(\" - \")[0];\n    }\n}\n","import i18n from 'i18next';\nimport Backend from 'i18next-xhr-backend';\nimport LanguageDetector from 'i18next-browser-languagedetector';\nimport { initReactI18next } from 'react-i18next';\nimport { ProcessAndArena, ProcessState } from './process/Base';\n\ni18n\n  // load translation using xhr -> see /public/locales\n  // learn more: https://github.com/i18next/i18next-xhr-backend\n  .use(Backend)\n  // detect user language\n  // learn more: https://github.com/i18next/i18next-browser-languageDetector\n  .use(LanguageDetector)\n  // pass the i18n instance to react-i18next.\n  .use(initReactI18next)\n  // init i18next\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    fallbackLng: 'et',\n    debug: process.env.NODE_ENV !== \"production\",\n    backend: {\n      loadPath: (window.location.pathname.includes(\"/ui/\") ? \"../../\" : \"\") + 'locales/{{lng}}/{{ns}}.json'\n    },\n    \n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n  });\n\nexport default i18n;\n\nexport function _(...labels: string[]): string {\n  return i18n.t(labels.join(\".\"));\n}\n\nexport function __(props: ProcessAndArena<any>, ...labels: string[]): string {\n  const suffix = labels.join(\".\");\n  const arena = props.arena;\n  const proc = props.process.name;\n  const impl = props.process.type;\n  return i18n.t([\n    [ arena, proc ],\n    [ arena, impl ],\n    [ impl ],\n    []\n  ].map(pref => pref.concat(suffix).join(\".\")));\n}\n\nexport function styleNameFor(arena: string, name: string, type?: string): string {\n  return __({ arena: arena, process: { name: name, type: type! } as ProcessState<any> }, \"stylename\");\n}\n\nexport function person(id: string, prop: string): string {\n  return i18n.t([`person.${id}.${prop}`, `person.default.${prop}`]).replace(\"ISIKUKOOD\", id);\n}\n\nexport function fullname(id: string): string {\n  return person(id, \"name\");\n}\n\nexport function business(id: string, prop: string): string {\n  return i18n.t(`business.${id}.${prop}`);\n}\n","import { Message, ProcessState, Payload } from \"../process/Base\";\nimport React from \"react\";\nimport { styleNameFor } from \"../i18n\";\n\n\nexport function receivers(receivers: string[]) {\n    return receivers.length === 1 ? receivers[0] : `(${receivers.join(\", \")})`;\n}\n\nfunction formatProcess(arena: string, name: string) {\n    return (<span className={`msg-${ styleNameFor(arena, name) }`}>\n        { name }\n    </span>)\n}\n\nfunction formatProcessList(arena: string, names: string[]) {\n    if (names.length === 1) {\n        return formatProcess(arena, names[0]);\n    } else {\n        return (<>({ names.map(\n            (r, i) => (\n                <>{ i === 0 ? \", \" : undefined }{ formatProcess(arena, r) }</>\n            )\n        ) })</>)\n    }\n}\n\nexport function formatLogtime(epochSeconds: number): string {\n    // locale. Swedes got it right. As did Lithuanians and few other countries. YYYY-MM-DD dates.\n    return new Date(epochSeconds * 1000).toLocaleString(\"se\");\n}\n\nfunction formatHeader(msg: Message<Payload>, owner: ProcessState<any> | undefined, showPopup: ShowPopup) {\n\treturn (<>\n            <span onClick={ ev => showPopup(msg) }>\n                <span className=\"link-underline\">{ formatLogtime(msg.now!) }</span>\n                &nbsp;\n            </span>\n                { formatProcess(msg.arena, msg.sender) }\n                <span> » </span>\n                { formatProcessList(msg.arena, msg.receivers) }\n            </>\n        );\n}\n\nfunction cutJson(max: number) {\n    return (key: string, value: any) => (\n        typeof value !== \"string\" \n            ? value \n            : (value.length > max ? value.substring(0, max) + \"...\" : value)\n        );\n}\n\nfunction formatBody<M extends Payload>(msg: M) {\n\treturn `${msg.type}: ${JSON.stringify({ ...msg, type: undefined, statusUpdateChannel: undefined }, cutJson(40), \"  \")}`;\n}\n\nfunction defaultRenderer(msg: Message<any>, owner: ProcessState<any> | undefined, showPopup: ShowPopup) {\n    return (<>{formatHeader(msg, owner, showPopup)}:<br/>{formatBody(msg.message)}</>);\n}\n\ntype ShowPopup = (m: Message<any>) => void;\n\nexport function LogRow(arena: string, i: number, msg: Message<any>, owner: (ProcessState<any> | undefined), showPopup: ShowPopup) {\n    return (<span>{ findLogRenderer(msg)(msg, owner, showPopup) }</span>);\n}\n\nexport type LogRenderer = (msg: Message<any>, owner: ProcessState<any> | undefined, showPopup: ShowPopup ) => any;\nconst renderers : { [arena: string]: { [type: string]: LogRenderer } } = {};\n\nfunction findLogRenderer(msg: Message<any>): LogRenderer {\n    if (renderers[msg.arena] === undefined) {\n        return defaultRenderer;\n    }\n\n    if (renderers[msg.arena][msg.message.type] === undefined) {\n        return defaultRenderer;\n    }\n\n    return renderers[msg.arena][msg.message.type];\n}\n\nexport function addLogRenderer(arena: string, type: string, renderer: LogRenderer) {\n    if (renderers[arena] === undefined) {\n        renderers[arena] = {};\n    }\n\n    renderers[arena][type] = renderer;\n}\n\nexport type LogRendererMap = { [type: string]: LogRenderer };\n\nexport function addLogRenderers(arena: string, r: LogRendererMap) {\n    Object.keys(r).forEach(type => addLogRenderer(arena, type, r[type]))\n}\n\n////////////////////////\n\nexport const consentRefApiLogRenderers : LogRendererMap = {\n    // \"CS/getConsentReference\": (a, m) => `Rakendus ${m.sender} kysib nousolekuteenuselt ${receivers(m.receivers)} nqusolekuviidet isiku ${m.message.subjectId} ja eesmargideklaratsiooni ${m.message.purposeDeclarationId} kohta.`\n}\n","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { ProcessState, Message, Payload } from '../process/Base';\nimport { AppState } from '../store';\nimport { selectArena } from './Theatre';\nimport { LogRow, receivers, formatLogtime } from './LogRows';\nimport { Modal, Button, ModalFooter } from 'react-bootstrap';\nimport { __ } from '../i18n';\n\ninterface LogProps {\n  arena: string;\n  owner?: ProcessState<any>;\n  showSelf?: boolean;\n  maxRows?: number;\n  rows?: Message<any>[];\n  t?: any;\n  className?: string;\n  scroll?: boolean;\n}\n\n\nclass LogView extends React.Component<LogProps> {\n\n  ref: React.RefObject<any> = React.createRef();\n\n  state = {\n    msg: undefined as (Message<any> | undefined)\n  }\n\n  closePopup() {\n    this.setState({ msg: undefined });\n  }\n\n  showPopup(msg: Message<any>) {\n    this.setState({ msg });\n  }\n\n  componentDidUpdate() {\n    this.scollToBottom();\n  }\n\n  componentDidMount() {\n    if (this.props.scroll) {\n      setTimeout(() => {\n        this.scollToBottom();\n      })\n    }\n  }\n\n  scollToBottom() {\n    if (this.ref.current) this.ref.current.scroll(0, this.ref.current.scrollHeight);\n  }\n\n  filterFn : (msg: Message<Payload>) => boolean = (msg) => {\n    if (msg.receivers.length === 1 && msg.receivers.includes(msg.sender) && !this.props.showSelf) {\n      return false;\n    }\n\n    if (this.props.owner !== undefined && !(msg.sender === this.props.owner.name || msg.receivers.includes(this.props.owner.name))) {\n      return false;\n    }\n\n    return true;\n  }\n\n  formatLogLine(msg: Message<Payload>, index: number, owner?: ProcessState<any>) {\n    const _this = this;\n    return (<li className=\"log-item\" key={index}>\n      { LogRow(this.props.arena, index, msg, owner, msg => { _this.showPopup(msg) }) }\n    </li>);\n  }\n\n  popup() { \n    const msg = this.state.msg;\n    const _this = this;\n    const t = this.props.t || ((a: string) => a);\n\n    return (\n      <Modal show={msg !== undefined} onHide={() => _this.closePopup()} size=\"lg\">\n        <Modal.Body>\n        { msg === undefined ? \"No message?\" : (\n        <div>\n          <div className=\"log-details\">\n            <div className=\"row\">\n              <div className=\"col\">\n                <h4>Saatja:</h4>\n                <p>{ msg!.sender }</p>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col\">\n                <h4>Saaja:</h4>\n                <p>{ receivers(msg!.receivers) }</p>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col\">\n                <h4>Tüüp:</h4>\n                <p>{ msg!.message.type }</p>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col\">\n                <h4>Aeg:</h4>\n                <p>{ formatLogtime(msg.now!) }</p>\n              </div>\n            </div>\n          </div>\n          <div className=\"row\">\n            <div className=\"col\">\n              <pre className=\"text-left\">\n                { JSON.stringify({\n                  ...msg,\n                  type: undefined,\n                  statusUpdateChannel: undefined,\n                  arena: undefined,\n                  now: undefined,\n                  random: undefined,\n                }, undefined, \"  \") }\n              </pre>\n            </div>\n          </div>\n        </div>\n        ) }\n        </Modal.Body>\n        <Modal.Footer>\n        <Button variant=\"secondary\" onClick={(ev: any) => _this.closePopup()}>{ t('close') }</Button>\n        </Modal.Footer>\n      </Modal>\n      );\n  }\n\n  render() {\n    const logLines = (this.props.rows!\n      .filter(this.filterFn)\n      .slice(-(this.props.maxRows || 4)));\n\n    if (logLines.length === 0) {\n      return <span className=\"no-msg-log\">{ __({arena: this.props.arena, process: (this.props.owner || {}) as ProcessState<any> }, \"no-log-lines\") }</span>;\n    }\n\n    return (\n      <>\n      { this.popup() }\n      <samp className=\"msg-log\" ref={this.ref}>\n        <ul className=\"log-view\">\n          { logLines.map((line, index) => this.formatLogLine(line, index, this.props.owner)) }\n        </ul>\n      </samp>\n      </>\n      );\n  }\n}\n\nfunction mapStateToProps(state: AppState, ownProps: LogProps) {\n  return { rows: selectArena(state, ownProps.arena).log };\n}\n\nexport const MessageLog = connect(mapStateToProps)(LogView);\n\n\nexport class LogButton extends React.PureComponent<LogProps, { show: boolean }> {\n  state = { show: false };\n\n  render() {\n    const t = this.props.t;\n    return (<>\n      <Modal show={this.state.show} onHide={() => this.setState({ show: false })} size=\"lg\">\n        <Modal.Header>\n          <Modal.Title>{ __({ arena: this.props.arena, process: this.props.owner! }, \"log\") }: { \n            this.props.owner !== undefined ? __({arena: this.props.arena, process: this.props.owner}, \"title\") : <></> }</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <div className=\"msg-log-popup\">\n            <MessageLog {...this.props} scroll={true} />\n          </div>\n        </Modal.Body>\n        <ModalFooter>\n          <Button variant=\"secondary\" onClick={(ev: any) => this.setState({ show: false })}>{ t('close') }</Button>\n        </ModalFooter>\n      </Modal>\n      <Button className={this.props.className} onClick={(ev: any) => this.setState({ show: true }) }>{ this.props.children }</Button>\n    </>)\n  }\n}","import * as React from 'react';\n\nimport { ProcessState, ProcessRenderer, findRenderer, uiMap } from '../process/Base';\nimport { useStore } from 'react-redux';\nimport { launchUI } from '../postMessage';\nimport { __ } from '../i18n';\nimport { LogButton } from './MessageLog';\nimport { Modal, ModalFooter, Button } from 'react-bootstrap';\n\nfunction render<S>({process, arena}: ProcessUIProps<S>): ReturnType<ProcessRenderer<S>> {\n\treturn (findRenderer(process))({process, arena});\n}\n\n// Protsessi-kasti komponent. \n\nexport interface ProcessUIProps<S> {\n\tprocess: ProcessState<S>;\n\tarena: string; // current arena.\n\tchildren?: any;\n\tbutton?: boolean;\n}\n\n\n\nexport function ProcessUI({process, arena}: ProcessUIProps<any>) {\n\tconst t = (...keys: string[]) => __({arena, process}, ...keys);\n\tconst [ visible, setVisible ] = React.useState(false);\n\treturn (\n\t\t<div className=\"col\">\n\t\t\t<div className={`card process style-${ t('stylename') }`} id={`proc-${process.name}`}>\n\t\t\t  <div className=\"card-header\">\n\t\t\t  <Modal show={visible} onHide={() => setVisible(false) } size=\"lg\">\n\t\t  \t\t<Modal.Header>\n\t\t\t\t  <Modal.Title>{ t(\"internal-state\") }: { t('title') }</Modal.Title>\n\t\t\t  \t</Modal.Header>\n\t\t\t\t<Modal.Body>\n\t\t\t\t  <div className=\"msg-log-popup\">\n\t\t\t\t\t<pre className=\"msg-log\">{ JSON.stringify(process, undefined, \"  \") }</pre>\n\t\t\t\t  </div>\n\t\t  \t\t</Modal.Body>\n\t\t  \t\t<ModalFooter>\n\t\t\t\t  <Button variant=\"secondary\" onClick={() => setVisible(false)}>{ t('close') }</Button>\n\t\t  \t\t</ModalFooter>\n\t\t      </Modal>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"process-name\"\n\t\t\t\t\t\tonClick={() => setVisible(true)}>\n\t\t\t\t\t\t\t{ t(\"title\") }\n\t\t\t\t\t</span>\n\t\t\t\t\t<LogButton arena={arena} owner={process} showSelf={true} maxRows={100} t={t} className=\"btn-log btn-light btn-sm\">log</LogButton>\n\t\t\t  </div>\n\t\t\t  <div className=\"card-body\">\n\t\t\t\t\t<span className=\"process-state\">{ render({process, arena}) }</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n}\n\nexport function UILink({arena, process, children, button }: ProcessUIProps<any>) {\n\tconst store = useStore();\n\tfunction launch() {\n\t\tlaunchUI(arena, process.name, uiMap[process.type], store);\n\t}\n\n\tconst el = button === true ? 'button' : 'div'\n\n\tif (uiMap[process.type] === undefined) {\n\t\treturn <></>;\n\t} else {\n\t\treturn React.createElement(el, {\n\t\t\tclassName: button !==  true ? \"process-uilink\" : \"btn btn-primary\",\n\t\t\tonClick: () => launch()\n\t\t}, children === undefined ? \"\\u2398\" : children);\n\t}\n}\n\n","\ntype NamedObject = { name: string };\n\nexport interface ByNameStore<T extends NamedObject> {\n\tbyName: { [k: string]: T },\n\tallNames: string[];\n}\n\nexport function addByName<T extends NamedObject>(old: ByNameStore<T> = emptyStore(), init: T): ByNameStore<T> {\n\treturn {\n\t\tbyName: { ...old.byName, [init.name]: init },\n\t\tallNames: old.allNames.filter(n => n !== init.name).concat(init.name),\n\t}\n}\n\nexport function reduceByName<T extends NamedObject>(old: ByNameStore<T> = emptyStore(), reducer: (i: T) => T): ByNameStore<T> {\n\treturn {\n\t\t...old,\n\t\tbyName: Object.assign({}, ...old.allNames.map((k) => ({[k]: reducer(old.byName[k])})))\n\t}\n}\n\nexport function emptyStore<T extends NamedObject>(): ByNameStore<T> {\n    return { byName: {}, allNames: [] };\n}\n\nexport function fromArray<T extends NamedObject>(a: T[]): ByNameStore<T> {\n\treturn a.reduce(addByName, emptyStore());\n}","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { Store } from 'redux';\n\nimport { ProcessState, MESSAGE, Message, reduceMessage, Payload } from '../process/Base';\n\nimport { ProcessUI } from './Process';\nimport { MessageLog } from './MessageLog';\n\nimport { ByNameStore, addByName, reduceByName, fromArray } from '../byNameStore';\nimport { AppState } from '../store';\nimport { selectArena } from './Theatre';\nimport { useTranslation } from 'react-i18next';\n\n// Arena -- ports protsesse, mis omavahel sõnumeid vahetavad. \n// arenal on nimi?\n\nconst MESSAGE_DELAY = 300; // ms\n\n\ntype ProcessStore = ByNameStore<ProcessState<any>>;\nconst createProcess: (old : ProcessStore, init: ProcessState<any>) => ProcessStore = addByName;\nconst reduceProcesses: (old: ProcessStore, reducer: (p: ProcessState<any>) => ProcessState<any>) => ProcessStore = reduceByName;\n\nexport interface ArenaState {\n  name: string;\n  process: ProcessStore;\n  log: Message<any>[];\n}\n\nexport function createArena(name: string, ps: ProcessState<any>[]): ArenaState {\n  return { name: name, process: fromArray(ps), log: [] };\n}\n\nexport const CREATE_PROCESS = \"Arena/CREATE_PROCESS\"; \n\nexport interface CreateProcess {\n  type: typeof CREATE_PROCESS;\n  arena: string; \n  process: ProcessState<any>;\n}\n\nexport const FLUSH_QUEUE = \"Arena/FLUSH_QUEUE\";\nexport interface FlushQueue {\n  type: typeof FLUSH_QUEUE;\n  arena: string;\n}\n\nexport type ArenaActionType = CreateProcess | FlushQueue | Message<any>;\n\n\nexport function reduceArena(state: ArenaState, action: ArenaActionType): ArenaState {\n  if (action.arena !== state.name) {\n    return state;\n  }\n\n  switch (action.type) {\n    case CREATE_PROCESS:\n      return { ...state, process: createProcess(state.process, action.process) };\n    case FLUSH_QUEUE:\n      return { ...state, process: reduceProcesses(state.process, (p) => ({ ...p, queue: [] })) };\n    case MESSAGE:\n      return { ...state, process: reduceProcesses(state.process, (p) => reduceMessage(p, action)), log: state.log.concat([action])  };\n    default:\n      return state;\n  }\n}\n\nfunction getQueuedForArena(p: ProcessStore): Message<any>[] {\n  return p.allNames.map((n) => p.byName[n].queue).flat(1).filter((d) => d !== undefined);\n}\n\nfunction getQueued(arenas: ByNameStore<ArenaState>): Message<any>[] {\n  return arenas.allNames.map(n => getQueuedForArena(arenas.byName[n].process)).flat(1);\n}\n\nexport function fixNowAndRandom<P extends Payload>(m: Message<P>): Message<P> {\n  return { ...m, now: (Date.now() / 1000) | 0, random: \"\" + Math.random() };\n}\n\nexport function queueListener(store: Store) {\n  let queued = getQueued(store.getState().theatre.arenas);\n\n  if (queued.length === 0) {\n    return;\n  }\n\n  let arenas = Object.keys(Object.assign({}, ...queued.map((m) => ({ [m.arena]: 1 }))))\n\n  arenas.forEach((a) => store.dispatch({ type: FLUSH_QUEUE, arena: a } as FlushQueue ));\n\n  // queued.forEach((m) => store.dispatch(m));\n\n  const delayedSender = (store: Store, queue: Message<any>[]) => {\n    if (queue.length > 0) {\n      store.dispatch(fixNowAndRandom(queue.shift()!))\n      window.setTimeout(() => { delayedSender(store, queue); }, MESSAGE_DELAY);\n    }\n  };\n  \n  window.setTimeout(() => { delayedSender(store, queued); }, MESSAGE_DELAY);\n}\n\ninterface ArenaProps {\n  arena: ArenaState;\n}\n\nfunction ArenaElement({ arena }: ArenaProps) {\n  const { t } = useTranslation();\n  const processes = arena.process.allNames.map((p) => <ProcessUI process={arena.process.byName[p]} arena={arena.name} key={p} />);\n  return (\n    <div>\n      <div className=\"row align-self-stretch\">{ processes }</div>\n      <div className=\"card w-100 mt-4 mb-2\">\n        <div className=\"card-body\">\n          <h5 className=\"card-title\">{t('msg-log.title')}</h5>\n          {arena.log.length === 0 &&\n            <div className=\"d-flex align-items-center\">\n              <div className=\"spinner-grow spinner-grow-sm\" role=\"status\"></div>\n              <p className=\"card-text ml-1\">{t('msg-log.empty')}</p>\n            </div>\n          }\n          <MessageLog arena={arena.name} showSelf={false} maxRows={1000}/>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction mapStateToProps(state: AppState, props: ArenaProps) {\n  return { log: selectArena(state, props.arena.name).log };\n}\n\nexport const Arena = connect(mapStateToProps)(ArenaElement);\n\n\n","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { ProcessState, Payload, message, Message } from '../process/Base';\nimport { fixNowAndRandom } from './Arena';\n\ninterface SendProps<S, M extends Payload> {\n\tarena: string;\n\towner: ProcessState<S>;\n\ttarget?: string | string[];\n\tclassName?: string;\n\tmessage: (values?: any) => M;\n\ttext: string;\n\tmessageToAction: (props: SendProps<S, M>, values?: any) => Message<M>;\n\tonClick?: (ev?: any) => void;\n\ttitle?: string;\n}\n\nfunction fixTarget(owner: ProcessState<any>, target?: string | string[]): string[] {\n\tif (target !== undefined && typeof target === 'string') {\n\t\treturn [target];\n\t}\n\n\tif (target === undefined || target.length === 0) {\n\t\treturn [owner.name];\n\t}\n\n\treturn target;\n}\n\nfunction messageToAction<S, M extends Payload>(props: SendProps<S, M>, values: Partial<M>): Message<M> {\n\treturn fixNowAndRandom<M>(message(\n\t\tprops.arena,\n\t\tprops.owner,\n\t\tfixTarget(props.owner, props.target),\n\t\tprops.message(values)\n\t));\n}\n\nfunction parseOrRaw(s: any): any {\n\tif (typeof s === \"string\" && s.startsWith(\"{\")) {\n\t\treturn JSON.parse(s);\n\t}\n\n\treturn s;\n}\n\nfunction values(f: HTMLFormElement): any {\n\n\tif (f === undefined || f === null) {\n\t\treturn {};\n\t}\n\n\treturn Array.from(f.elements)\n\t\t\t.map((u, i) => f.elements[i] as any as { \n\t\t\t\tname: string;\n\t\t\t\tvalue: any;\n\t\t\t\ttype: string;\n\t\t\t\toptions?: HTMLOptionsCollection;\n\t\t\t\tchecked?: boolean;\n\t\t\t})\n\t\t\t.filter(e => (e.name !== undefined && e.name !== null && e.name !== \"\" && !e.name.startsWith(\"_\")))\n\t\t\t.map(e => {\n\t\t\t\tif (e.type === \"select-multiple\") {\n\t\t\t\t\tlet out: any[] = [];\n\t\t\t\t\tlet i: number;\n\t\t\t\t\tfor (i = 0; i < e.options!.length; i++) {\n\t\t\t\t\t\tif (e.options![i].selected) {\n\t\t\t\t\t\t\tout.push(parseOrRaw(e.options![i].value));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn { [e.name]: out };\n\t\t\t\t}\n\n\t\t\t\tif (e.type === \"checkbox\") {\n\t\t\t\t\tlet values: (string | undefined)[] = e.value.split(\"|\", 2);\n\t\t\t\t\tif (values.length === 1) {\n\t\t\t\t\t\tvalues.push(undefined);\n\t\t\t\t\t}\n\t\t\t\t\treturn { [e.name]: parseOrRaw(values[e.checked ? 0 : 1]) }\n\t\t\t\t}\n\t\t\t\treturn { [e.name]: parseOrRaw(e.value) }\n\t\t\t})\n\t\t\t.reduce((o, c) => ({ ...o, ...c }), {});\n}\n\nclass Send<S, M extends Payload> extends React.Component<SendProps<S, M>> {\n\n\thandleClick(ev: any) {\n\t\tev.preventDefault();\n\t\tthis.props.messageToAction(this.props, values(ev.currentTarget.form));\n\t\tif(this.props.onClick) this.props.onClick(ev);\n\t};\n\n\trender() {\n\t\treturn <button \n\t\t\tclassName={ this.props.className === undefined ? \"btn btn-primary\" : this.props.className } \n\t\t\tonClick={(ev) => this.handleClick(ev)}\n\t\t\ttitle={this.props.title}\n\t\t>{this.props.text}</button>\n\t}\n}\n\nexport const SimpleSend = connect(null, { messageToAction })(Send);\n\n","import { ProcessImplName, ViewName, ProcessState, Payload, GenericMessageHandler, Message, addHandlerClass, ProcessAndArena, addRenderer } from './Base';\nimport * as React from 'react';\nimport { SimpleSend } from '../components/SendButton';\nimport { MessageLog } from '../components/MessageLog';\n\nconst Counter : ProcessImplName = \"Counter\";\n\nconst CounterDefaultView : ViewName = \"_\";\n\n// \"rakenduse olek\"\nexport interface CounterState extends ProcessState<number> {\n\ttype: typeof Counter;\n\tview: typeof CounterDefaultView;\n}\n\n// \"bootloader\", tekitab rakenduse algoleku\nexport function createCounter(name: string) {\n\treturn {\n\t\tname: name,\n\t\ttype: Counter,\n\t\tview: CounterDefaultView,\n\t\tmem: 0,\n\t} as CounterState;\n}\n\nclass IncrementMessageHandler extends GenericMessageHandler<number, CounterState, Payload, IncrementMessageHandler> {\n\tname = \"Counter/INC\";\n\tupdateMem(mem: number, action: Message<Payload>) { return mem + 1; }\n}\n\n\nclass DecrementMessageHandler extends GenericMessageHandler<number, CounterState, Payload, DecrementMessageHandler> {\n\tname = \"Counter/DEC\";\n\tupdateMem(mem: number, action: Message<Payload>) { return mem - 1; }\n}\n\nconst incrementMessage = addHandlerClass(Counter, IncrementMessageHandler);\nconst decrementMessage = addHandlerClass(Counter, DecrementMessageHandler);\n\n\ninterface DefaultViewProps extends ProcessAndArena<number> {\n\tprocess: CounterState;\n\tarena: string;\n}\n\nconst counterRenderer : React.FC<DefaultViewProps> = ({process, arena}) => {\n\treturn (\n\t<div>\n\t\t<span className=\"process-state\">{ process.mem }</span>\n\t\t<span className=\"process-state\">\n\t\t\t<SimpleSend arena={arena} owner={process} text=\"+\" message={incrementMessage()}/>\n\t\t\t<SimpleSend arena={arena} owner={process} text=\"-\" message={decrementMessage()}/>\n\t\t</span>\n\t\t<span className=\"process-state\">\n\t\t\t<MessageLog arena={arena} owner={process} showSelf={true} maxRows={4}/>\n\t\t</span>\n\t</div>\n\t);\n};\n\n\naddRenderer(Counter, CounterDefaultView, counterRenderer);\n","import * as React from 'react';\n\ninterface PopupProps {\n    text: any;\n    open?: boolean; // initial state\n}\n\nexport class Popup extends React.Component<PopupProps, { open: boolean }> {\n    state = { open: false };\n\n    render() {\n        return (\n            <div>\n                <div className={ this.state.open ? \"popup-visible\" : \"popup-hidden\" }>\n                    <div className=\"popup-content\">\n                        <div className=\"popup-close\" onClick={() => this.setState({open: false})}></div>\n                        {this.props.children}\n                    </div>\n                </div>\n                <button className=\"btn btn-primary\" onClick={() => this.setState({open: true})}>{this.props.text}</button>\n            </div>\n        );\n    }\n}","import * as React from \"react\";\n\ninterface Props {}\n\ninterface State {\n  view: string;\n  loading: boolean;\n}\n\nconst LOGIN = \"login\";\nconst SELECT_SERVICE = \"selectService\";\nconst SERVICE_V1 = \"serviceV1\";\n\nconst Header = () => (\n  <div className=\"app-header\">\n    <div className=\"app-user-icon\">\n      <img alt=\"user icon\" src={require('./../static/assets/images/user-icon.svg')} />\n    </div>\n    <p className=\"app-user\">TERE MARI-LIIS MÄNNIK</p>\n  </div>\n);\n\nclass ClientView extends React.PureComponent<Props, State> {\n\n  state = {\n    view: LOGIN,\n    loading: false\n  };\n\n  changeView = (view: string) => {\n    this.setState({ loading: true });\n    setTimeout(() => {\n      this.setState({loading: false});\n      this.setState({view: view});\n    }, 1000);\n  };\n\n  render() {\n    switch (this.state.loading) {\n      case true:\n      return (\n        <div className=\"d-flex align-items-center\">\n          <strong>Loading...</strong>\n          <div className=\"spinner-border ml-auto\" role=\"status\" aria-hidden=\"true\"></div>\n        </div>\n      );\n      default:\n        switch (this.state.view) {\n          case LOGIN:\n          return (\n            <div>\n              <h4>Tere! Teenuse kasutamiseks logi palun sisse.</h4>\n              <button className=\"btn btn-light border\" onClick={() => this.changeView(SELECT_SERVICE)}>Logi sisse kasutajana Mari-Liis Männik 47302200234</button>\n              <p className=\"mt-4\">\n                <img alt=\"illustration\" src={require('./../static/assets/images/login.svg')} width=\"280\" />\n              </p>\n            </div>\n          );\n          case SELECT_SERVICE:\n          return (\n            <div>\n              <Header />\n              <h4>Vali teenus mida soovid kasutada:</h4>\n              <button className=\"btn btn-dark\" onClick={() => this.changeView(SERVICE_V1)}>Vaktsineerimiste meeldetuletused</button>\n            </div>\n          );\n          case SERVICE_V1:\n          return (\n            <div>\n              <Header />\n              <h4>Teenuse tekst TODO</h4>\n              <p className=\"text-left\">\n                <small>Enne nõusoleku andmist veendu, et oled tutvunud meie privaatsuspoliitika ja kasutustingimustega, mis on leiavad <a href=\"JavaScript:void(0);\">siin</a>. Nõusoleku andmiseks suuname Sind e-Tervise nõusolekute keskkonda, mida haldab Tervise- ja Heaolu Infosüsteemide Keskus.</small>\n              </p>\n              <button className=\"btn btn-lg btn-primary\">Annan nõusoleku</button>\n            </div>\n          );\n          default:\n          return(null)\n        }\n    }\n  }\n}\n\nexport default ClientView;","import * as React from 'react';\nimport { ProcessAndArena, ProcessImplName, ViewName, ProcessState, GenericMessageHandler, Payload, Message, message, addHandlerClass, addRenderer, addUi } from './Base';\nimport { SimpleSend } from '../components/SendButton';\nimport { MessageLog } from '../components/MessageLog';\nimport { Popup } from '../components/Popup';\nimport { Modal, Button } from 'react-bootstrap';\nimport { useTranslation } from 'react-i18next';\nimport ClientView from './../components/Client';\n\nconst TokenNode : ProcessImplName = \"TokenNode\";\n\nconst WithToken : ViewName = \"with\";\nconst WithoutToken : ViewName = \"without\";\n\ninterface NodeState {\n  token?: string; // token I have or undefined\n  next: string; // next station.\n}\n\ninterface NodePS extends ProcessState<NodeState> {\n  type: typeof TokenNode;\n  view: typeof WithToken | typeof WithoutToken;\n  title: string;\n}\n\nexport function createTokenNode(title: string, name: string, next: string, token?: string): NodePS {\n  return {\n    title: title,\n    name: name,\n    type: TokenNode,\n    view: token === undefined ? WithoutToken : WithToken,\n    mem: {\n      token: token,\n      next: next\n    },\n    queue: [],\n  };\n}\n\nclass InitPassHandler extends GenericMessageHandler<NodeState, NodePS, Payload, InitPassHandler> {\n  name = \"TokenNode/InitPass\";\n  handle(node: NodePS, action: Message<Payload>) {\n    if (node.view !== WithToken) {\n      console.error(`Invalid message, order to pass while I have no token? ${JSON.stringify(node)}`);\n      return node;\n    }\n\n    \n    return {\n      ...node,\n      queue: node.queue.concat(message(action.arena, node, [node.mem.next], tokenMessage({token: node.mem.token})())),\n      mem: { ...node.mem, token: undefined },\n      view: WithoutToken,\n    };\n  }\n}\n\nconst initPassMessage = addHandlerClass(TokenNode, InitPassHandler);\n\n\n// selle sõnumiga saadetakse reaalselt tokeneid.\ninterface TokenMessage extends Payload {\n  token: string;\n}\n\nclass PostTokenHandler extends GenericMessageHandler<NodeState, NodePS, TokenMessage, PostTokenHandler> {\n  name = \"TokenNode/PostToken\";\n  // sissetulev token\n  handle(node: NodePS, action: Message<TokenMessage>) {\n    if (node.view === WithToken) {\n      console.log(`${action.sender} sent token '${action.message.token}' to ${node.name}. We already have a token (${node.mem.token}). Will send the token back`);\n      // send it back.\n      return {\n        ...node,\n        queue: node.queue.concat(message(action.arena, node, [action.sender], action.message)),\n      };\n    } else {\n      // tokenit polnud, jätame meelde.\n      return {\n        ...node,\n        mem: { ...node.mem, token: action.message.token },\n        view: WithToken,\n      };\n\n    }\n  }\n}\n\nconst tokenMessage = addHandlerClass<TokenMessage, PostTokenHandler>(TokenNode, PostTokenHandler);\n\n\ninterface TargetPayload extends Payload {\n  target: string;\n}\n\nclass UpdateTargetHandler extends GenericMessageHandler<NodeState, NodePS, Payload, InitPassHandler> {\n  name = \"TokenNode/UpdateTarget\";\n  updateMem(mem: NodeState, action: Message<TargetPayload>) {\n    return { ...mem, next: action.message.target };\n  }\n}\n\nconst updateNextMessage = addHandlerClass(TokenNode, UpdateTargetHandler);\n\n\n////\n\ninterface NodeViewProps extends ProcessAndArena<NodeState> {\n  process: NodePS,\n}\n\nconst SetTargetPopup : React.FC<NodeViewProps> = ({process, arena}) => {\n\n  const { t } = useTranslation();\n  const [show, setShow] = React.useState(false);\n  const handleClose = () => setShow(false);\n  const handleShow = () => setShow(true);\n\n  switch(process.name) {\n    case \"a\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Teenusedeklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"baseName\">Andmekogu nimi:</label>\n                    <input name=\"baseName\" type=\"text\" className=\"form-control\" id=\"baseName\" value=\"test\" readOnly />\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"xtee\">Andmekogu X-tee:</label>\n                    <input name=\"xtee\" type=\"text\" className=\"form-control\" id=\"xtee\" value=\"123\" readOnly />\n                    <small id=\"xteeHelp\" className=\"form-text text-muted\">(alamsüsteemi) identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdName\">Teenusedeklaratsiooni nimi:</label>\n                    <input name=\"sdName\" type=\"text\" className=\"form-control\" id=\"sdName\" />\n                    <small id=\"sdNameHelp\" className=\"form-text text-muted\">Teenusedeklaratsiooni identifikaator inimloetaval kujul. Soovitatavalt teenuse kood/nimi ja vajadusel alamteenuse identifikaator.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdIdentifier\">Teenusedeklaratsiooni identifikaator:</label>\n                    <input name=\"sdIdentifier\" type=\"text\" className=\"form-control\" id=\"sdIdentifier\" />\n                    <small id=\"sdIdentifierHelp\" className=\"form-text text-muted\">Andmekogu poolt määratud teenusedeklaratsiooni masinloetav identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdDescription\">Teenuse andmekoosseisu kirjeldus:</label>\n                    <input name=\"sdDescription\" type=\"text\" className=\"form-control\" id=\"sdDescription\" />\n                    <small id=\"sdDescriptionHelp\" className=\"form-text text-muted\">Teenuse poolt tagastatava andmekoosseisu inimloetav kirjeldus. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <div className=\"form-check\">\n                      <input name=\"signature\" className=\"form-check-input\" type=\"checkbox\" id=\"signature\" />\n                      <label className=\"form-check-label\" htmlFor=\"signature\">Vajab digiallkirja?</label>\n                      <small id=\"signatureHelp\" className=\"form-text text-muted\">Märgista see väli, kui andmesubjekt peab selle teenuse andmetele nõusoleku andmisel nõusoleku digitaalselt allkirjastama.</small>\n                    </div>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text=\"Update\" message={updateNextMessage()}/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('register')}\n      </Button>\n      </>\n    )\n    case \"b\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Eesmärgideklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"applicationName\">Klientrakenduse nimi:</label>\n                    <input name=\"applicationName\" type=\"text\" className=\"form-control\" id=\"applicationName\" value=\"test\" readOnly />\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"applicationXtee\">Klientrakenduse X-tee:</label>\n                    <input name=\"applicationXtee\" type=\"text\" className=\"form-control\" id=\"applicationXtee\" value=\"123\" readOnly />\n                    <small id=\"applicationXteeHelp\" className=\"form-text text-muted\">(alamsüsteemi) identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dIdentifier\">Deklaratsiooni identifikaator:</label>\n                    <input name=\"dIdentifier\" type=\"text\" className=\"form-control\" id=\"dIdentifier\" />\n                    <small id=\"dIdentifierHelp\" className=\"form-text text-muted\">Klientrakenduse poolt määratud eesmärgideklaratsiooni identifikaator</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dataUsage\">Andmete kasutamise eesmärk:</label>\n                    <input name=\"dataUsage\" type=\"text\" className=\"form-control\" id=\"dataUsage\" />\n                    <small id=\"dataUsageHelp\" className=\"form-text text-muted\">Andmesubjekti andmete töötlemise eesmärk. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"services\">Kasutatavad teenused:</label>\n                    <select name=\"services\" className=\"custom-select\" multiple defaultValue={['1']} id=\"services\">\n                      <option value=\"1\">One</option>\n                      <option value=\"2\">Two</option>\n                      <option value=\"3\">Three</option>\n                    </select>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text=\"Update\" message={updateNextMessage()}/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('register')}\n      </Button>\n      </>\n    )\n    case \"c\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\" bsPrefix=\"client-app modal\">\n        <Modal.Header>\n          <Modal.Title>HealthStartup</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <ClientView />\n        </Modal.Body>\n        <Modal.Footer>\n          <Button variant=\"outline-dark\" onClick={handleClose}>Close</Button>\n        </Modal.Footer>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('continue')}\n      </Button>\n      </>\n    )\n    default:\n    return (\n      <Popup text=\"Set target\">\n        <form>\n          <input name=\"target\" size={20}/>\n          <SimpleSend arena={arena} owner={process} text=\"Update target\" message={updateNextMessage()}/>\n        </form>\n      </Popup>\n    )\n  }\n};\n\nconst tokenlessRenderer : React.FC<NodeViewProps> = ({process, arena}) => {\n  return (\n    <div>\n      {/*\n      <span className=\"process-state\">next: {process.mem.next}</span>\n      */}\n      <SetTargetPopup arena={arena} process={process}/>\n      <span className=\"process-state\">\n        <MessageLog arena={arena} owner={process} showSelf={true} maxRows={2}/>\n      </span>\n    </div>\n  )\n};\n\nconst tokenfulRenderer : React.FC<NodeViewProps> = ({process, arena}) => {\n  return (<div>\n    <span className=\"process-state\">{process.mem.token}</span>\n    <span className=\"process-state\">next: {process.mem.next}</span>\n    <span className=\"process-state d-none\"><SimpleSend arena={arena} owner={process} text=\"Pass the token\" message={initPassMessage()}/></span>\n    <SetTargetPopup arena={arena} process={process}/>\n    <span className=\"process-state\">\n      <MessageLog arena={arena} owner={process} showSelf={true} maxRows={4}/>\n    </span>\n  </div>);\n}\n\naddRenderer(TokenNode, WithToken, tokenfulRenderer);\naddRenderer(TokenNode, WithoutToken, tokenlessRenderer);\n\naddUi(TokenNode, \"/ui/dummy\");","import { ProcessImplName, ViewName, ProcessState } from \"../Base\";\nimport { PurposeDeclaration } from \"../consentService/types\";\n\n\nexport const ClientIS : ProcessImplName = \"ClientIS\";\nexport const ClientDefaultView : ViewName = \"loginView\";\n\nexport type PurposeDeclarationTemplate = Partial<PurposeDeclaration> & { purposeDeclarationId: string; }\n\n// the Client \"implements\" requests as defined in config\nexport interface ClientConfig {\n    // purpose declaration\n    purposeDeclarationId: string;\n    services: { // services it needs\n        serviceAddress: string;\n        serviceName: string;\n    }[];\n}\nexport interface ClientState {\n    ui: {\n        user?: string; // authenticated data subject id or null\n        service?: string;\n        response?: {\n            // used to match async messag\n            requestReferenceId: string;\n            purposeDeclarationId: string;\n            serviceAddress: string;\n            serviceName: string;\n            data: any;\n        }[];\n    };\n\n    db: {\n        consentServiceId: string; // should be per purpose\n        consentRefByUser: { [key: string]: { [key: string]: string | null; } }; // userid -> purposedeclarationid -> consentref\n        purpose: { // purposedeclarationid -> servicedesc[]\n            [key: string]: { \n                serviceAddress: string; // the actual communication address\n                serviceId: string;      // actual \"service\"\n            }[];\n         } \n    };\n\n    declTemplate?: PurposeDeclarationTemplate[];\n\n    config: ClientConfig[];\n}\n\nexport interface ClientPS extends ProcessState<ClientState> {\n    type: typeof ClientIS;\n    view: typeof ClientDefaultView;\n}\n","import { ViewName, ProcessImplName, ProcessState } from '../Base';\n\nexport const ConsentService : ProcessImplName = \"ConsentService\";\nexport const ConsentServiceDefaultView : ViewName = \"loginView\";\n\n\nexport interface ConsentServicePS extends ProcessState<ConsentServiceState> {\n    type: typeof ConsentService;\n    view: typeof ConsentServiceDefaultView;\n}\n\nexport interface ServiceDeclaration {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n    name: string;\n    description: string;\n    technicalDescription: string;\n    consentMaxDurationSeconds: number; // integer\n    needSignature: boolean;\n    validUntil?: number; // timestamp as seconds from unix epoch?\n    maxCacheSeconds?: number;\n}\n\nexport interface ServiceDeclarationRef {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n}\n\nexport interface PurposeDeclaration {\n    clientId: string;\n    purposeDeclarationId: string;\n    name: string;\n    description: string;\n    services: ServiceDeclarationRef[];\n    validUntil?: number; // seconds from unix epoch\n    options: any;\n}\n\nexport interface Consent {\n    dataSubject: string;\n    clientId: string;\n    purposeDeclarationId: string;\n    validFrom: number;\n    validUntil: number;\n    revoked: boolean;\n    consentReference: string; // used only in protocol\n}\n\nexport interface UsageRecord {\n    usageTime: number; // seconds from unix epoch\n    serviceProviderId: string;\n    requestReference: string;\n    consentReference?: string;\n    subjectId: string;\n    clientId: string;\n    serviceDeclarationIds: string[];\n    result: \"OK\" | \"ACCESS_DENIED\" | \"OTHER_FAIL\";\n}\n\nexport interface PurposeDeclarationRef {\n    clientId: string;\n    purposeDeclarationId: string;\n}\n\nexport interface ActivePurposeDeclarationRef extends PurposeDeclarationRef {\n    callbackURL?: string;\n}\n\nexport interface ConsentServiceState {\n    ui: {\n        user?: string;\n        activePurposeDeclaration: {\n            [userid: string]: ActivePurposeDeclarationRef;\n        };\n    }\n\n    db: {\n        serviceDeclarations: ServiceDeclaration[];\n        purposeDeclarations: PurposeDeclaration[];\n        consents: Consent[];\n        usageLog: UsageRecord[];\n    }\n}\n\nexport function findFrom<T extends U, U extends any>(items: T[], example: U): T | undefined {\n    return items.find(\n        i => { \n            return Object.keys(example).filter(\n                k => (i as T)[k] !== (example as U)[k]\n            ).length === 0\n        }\n    );\n}\n\n\n","import { createHash } from \"crypto\";\nimport React from \"react\";\n\n\nexport function hash(input: string): string {\n    return createHash(\"sha256\").update(input).digest(\"hex\").substring(0, 6);\n}\n\n// converts transport address to organization id\nexport function address2org(address: string): string {\n    let m = address.match(\"^([^/]+/[^/]+/[^/]+)(/.*)?$\");\n    if (m === null) {\n        // not an X-Road member id or more specific address?\n        return address;\n    }\n    \n    return m[1];\n}\n\nexport function renderText(t: string) {\n    type OutElement = { text: string; indent: number; children: OutElement[] };\n    let stack: OutElement[] = [];\n\n    function last(a: OutElement[]): OutElement {\n        return a[a.length - 1];\n    }\n\n    stack.push({ text: \"\", indent: -1, children: [] });\n\n    t.split(\"\\n\").forEach(l => {\n        let pref = l.match(\"^((  )+\\\\* )(.*)$\");\n        if (pref === null) {\n            pref = [\"\", \"\", \"\", l];\n        }\n\n        let prefix = pref[1];\n        let text = pref[3];\n\n        while (prefix.length <= last(stack).indent) {\n            // the same level -> back up, so it will be actually a new level?\n            stack.pop();\n        }\n\n        if (prefix.length > last(stack).indent) {\n            // new level\n            last(stack).children.push({ text: text, indent: prefix.length, children: [] })\n            stack.push(last(last(stack).children));\n        }\n    });\n\n    function ul(children: OutElement[]) {\n        if (children.length === 0) {\n            return <></>;\n        }\n\n        return (\n            <ul className=\"desc-markup\">{ \n                children.map(c => <li className=\"desc-markup\">{ c.text }{ ul(c.children) }</li>)\n            }</ul>\n        );\n    }\n\n    return stack[0].children.map(c => <><p className=\"desc-markup\">{ c.text }</p>{ ul(c.children) }</>);\n}","import { ServiceDeclaration, ConsentServiceState, findFrom, PurposeDeclaration, ConsentService, ConsentServicePS } from './types'\nimport { GenericMessageHandler, Message, addHandlerClass, updateDb } from '../Base';\nimport { address2org } from '../../util';\n\n// {Service,Purpose}Declaration API messages and their processing\n\ninterface ServiceDeclarationMessage extends ServiceDeclaration {\n    type: typeof AddServiceDeclarationMessage.name;\n}\n\nclass AddServiceDeclarationMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ServiceDeclarationMessage, AddServiceDeclarationMessage> {\n    name = \"CS/addServiceDeclaration\"; \n\n    addServiceDeclaration(cs: ConsentServicePS, sd: ServiceDeclaration): ConsentServicePS {\n        return updateDb(cs, { serviceDeclarations: cs.mem.db.serviceDeclarations.concat(sd) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<ServiceDeclarationMessage>) {\n        console.log(`addServiceDeclaration: ${JSON.stringify(msg)}`);\n\n        let decl = msg.message;\n\n        if (findFrom(\n            cs.mem.db.serviceDeclarations,\n            { serviceProviderId: decl.serviceProviderId, serviceDeclarationId: decl.serviceDeclarationId }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"duplicate_declaration\");\n        }\n\n        if (decl.serviceProviderId !== address2org(msg.sender)) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", {\n                 msg: \"serviceProvcderId in declaration and message do not match\"\n            });\n        }\n\n        if (decl.serviceDeclarationId === undefined || !decl.serviceDeclarationId.match(\"^[!-~]+$\")) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid service declaration id\"});\n        }\n\n        return this.withOkResponse(this.addServiceDeclaration(cs, { ...msg.message, type: undefined } as ServiceDeclaration), msg);\n    }\n}\n\nexport const addServiceDeclaration = addHandlerClass(ConsentService, AddServiceDeclarationMessage);\n\ninterface PurposeDeclarationMessage extends PurposeDeclaration {\n    type: typeof AddPurposeDeclarationMessage.name;\n}\n\nclass AddPurposeDeclarationMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, PurposeDeclarationMessage, AddPurposeDeclarationMessage> {\n    name = \"CS/addPurposeDeclaration\"; \n\n    addPurposeDeclaration(cs: ConsentServicePS, pd: PurposeDeclaration): ConsentServicePS {\n        return updateDb(cs, { purposeDeclarations: cs.mem.db.purposeDeclarations.concat(pd) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<PurposeDeclarationMessage>) {\n        console.log(`addPurposeDeclaration: ${JSON.stringify(msg)}`);\n\n        let decl = msg.message;\n\n        if (findFrom(\n            cs.mem.db.purposeDeclarations,\n            { clientId: decl.clientId, purposeDeclarationId: decl.purposeDeclarationId }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"duplicate_declaration\");\n        }\n\n        if (decl.clientId !== address2org(msg.sender)) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"clientId in declaration and message do not match\"});\n        }\n\n        if (decl.purposeDeclarationId === undefined || !decl.purposeDeclarationId.match(\"^[!-~]+$\")) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid purpose declaration id\"});\n        }\n\n        if (decl.services.length === 0 || decl.services.find(sdRef => {\n            // true if sdRerf does not match with any of existing servicedeclarations\n            return findFrom(cs.mem.db.serviceDeclarations, sdRef) === undefined;\n        }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid or missing SD reference(s)\"});\n        }\n\n        return this.withOkResponse(this.addPurposeDeclaration(cs, { ...msg.message, type: undefined } as PurposeDeclaration), msg);\n    }\n}\n\nexport const addPurposeDeclaration = addHandlerClass(ConsentService, AddPurposeDeclarationMessage);\n","import { Payload, GenericMessageHandler, Message, addHandlerClass, message, updateDb } from '../Base';\nimport { ConsentServiceState, ConsentServicePS, ConsentService, findFrom, Consent, PurposeDeclarationRef, ActivePurposeDeclarationRef } from './types';\nimport { fetchConsentReference } from '../client/messages';\n\n// messages that the ConsentService UI can send \n\nexport interface LoginMessage extends Payload {\n    type: typeof LoginMessageHandler.name;\n    user?: string;\n}\n\nclass LoginMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, LoginMessage, LoginMessageHandler> {\n    name = \"CS/UI/login\";\n\n    handle(cs: ConsentServicePS, action: Message<LoginMessage>): ConsentServicePS {\n        console.log(\"login message: \", action); \n        return { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, user: action.message.user } } };\n    }\n}\n\nexport const loginMessage = addHandlerClass<LoginMessage, LoginMessageHandler>(ConsentService, LoginMessageHandler);\n\ninterface ConsentMessage extends Consent, Payload {\n    type: typeof GiveConsentMessageHandler.name;\n}\n\nclass GiveConsentMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ConsentMessage, GiveConsentMessageHandler> {\n    name: string = \"CS/UI/giveConsent\";\n\n    addConsent(cs: ConsentServicePS, con: Consent): ConsentServicePS {\n        return updateDb<typeof cs.mem.db, ConsentServiceState>(cs, { consents: cs.mem.db.consents.concat(con) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<ConsentMessage>): ConsentServicePS {\n        let newConsent = msg.message;\n        if (findFrom(cs.mem.db.purposeDeclarations, { \n            clientId: newConsent.clientId,\n             purposeDeclarationId: newConsent.purposeDeclarationId\n        }) === undefined) {\n            console.error(\"Attempt to add consent for unknown purpose declaration: \", newConsent);\n            return cs;\n        }\n\n        if (findFrom(cs.mem.db.consents, {\n            clientId: msg.message.clientId,\n            purposeDeclarationId: msg.message.purposeDeclarationId,\n            dataSubject: msg.message.dataSubject,\n            revoked: false\n        }) !== undefined) {\n            console.error(\"Attempt to add duplicate consent?\");\n            return cs;\n        }\n\n        console.log(\"Adding consent: \", msg.message);\n\n        let updatedCS = this.addConsent(cs, { ...msg.message, type: undefined } as Consent);\n\n        let activeUser = cs.mem.ui.user;\n        if (activeUser === undefined || cs.mem.ui.activePurposeDeclaration[activeUser] === undefined) {\n            // no user, no active pd --> no callback\n            return updatedCS;\n        }\n\n        let decl = cs.mem.ui.activePurposeDeclaration[activeUser];\n\n        // forget that we had pd selected.\n        let updatedCS2 = setActivePD(updatedCS, activeUser, undefined);\n\n        if (decl.clientId !== msg.message.clientId || decl.purposeDeclarationId !== msg.message.purposeDeclarationId \n                || decl.callbackURL === undefined) {\n            return updatedCS2;\n        }\n\n        // if the client application asked for callback, we send it a message about the \n        // consent being signed. reusing UI message from client implementation.\n        return this.send(updatedCS2, message(msg.arena, updatedCS, [decl.callbackURL],\n            fetchConsentReference({ purposeDeclarationId: decl.purposeDeclarationId })()\n        ));\n\n    }\n}\n\nexport const giveConsentMessage = addHandlerClass<ConsentMessage, GiveConsentMessageHandler>(ConsentService, GiveConsentMessageHandler);\n\n\ninterface RevokeConsentMessage extends Payload {\n    type: typeof RevokeConsentMessageHandler.name;\n    consentReference: string;\n    revokeAt: number;\n}\n\nclass RevokeConsentMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, RevokeConsentMessage, RevokeConsentMessageHandler> {\n    name: string = \"CS/UI/revokeConsent\";\n\n    revokeIfReferenceEquals(con: Consent, ref: RevokeConsentMessage) : Consent {\n        if (con.consentReference === ref.consentReference) {\n            return { ...con, revoked: true, validUntil: ref.revokeAt};\n        } \n\n        return con;\n    }\n\n    revokeConsent(cs: ConsentServicePS, ref: RevokeConsentMessage): ConsentServicePS {\n        return updateDb(cs, { consents: cs.mem.db.consents.map(a => this.revokeIfReferenceEquals(a, ref))});\n    }\n    \n    handle(cs: ConsentServicePS, msg: Message<RevokeConsentMessage>): ConsentServicePS {\n        return this.revokeConsent(cs, msg.message);\n    }\n}\n\nexport const revokeConsentMessage = addHandlerClass<RevokeConsentMessage, RevokeConsentMessageHandler>(ConsentService, RevokeConsentMessageHandler);\n\nfunction updateAPDforUser<R extends { [ user: string]: ActivePurposeDeclarationRef }>(refs: R, user: string, ref?: ActivePurposeDeclarationRef): R {\n    return { ...refs, [user]: ref };\n}\n\nexport function setActivePD(cs: ConsentServicePS, user: string, ref?: ActivePurposeDeclarationRef): ConsentServicePS {\n    return { ...cs, mem: { ...cs.mem, ui: { \n        ...cs.mem.ui,\n         activePurposeDeclaration: updateAPDforUser(cs.mem.ui.activePurposeDeclaration, user, ref)\n    }}}\n}\n\ninterface ActivatePurposeDeclaration extends Payload, PurposeDeclarationRef {\n    type: typeof ActivatePurposeDeclarationHandler.name;\n    user?: string;\n}\n\nclass ActivatePurposeDeclarationHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ActivatePurposeDeclaration, ActivatePurposeDeclarationHandler> {\n    name = \"CS/UI/activatePurposeDeclaration\";\n\n    handle(cs: ConsentServicePS, action: Message<ActivatePurposeDeclaration>): ConsentServicePS {\n        return setActivePD(\n            cs,\n            action.message.user === undefined ? cs.mem.ui.user! : action.message.user,\n            {\n                clientId: action.message.clientId,\n                purposeDeclarationId: action.message.purposeDeclarationId,\n            }\n        );\n    }\n}\n\nexport const activatePurposeDeclarationMessage = addHandlerClass<ActivatePurposeDeclaration, ActivatePurposeDeclarationHandler>(ConsentService, ActivatePurposeDeclarationHandler);\n","import { GenericMessageHandler, Message, Payload, addHandlerClass, updateDb } from \"../Base\";\nimport { ConsentServiceState, ConsentServicePS, findFrom, ConsentService, Consent } from \"./types\";\nimport { setActivePD } from \"./ui\";\n\ninterface ConsentReferenceRequest extends Payload {\n    type: typeof GetConsentReferenceMessage.name;\n    clientId: string;\n    purposeDeclarationId: string;\n    subjectId: string;\n    callbackURL?: string;\n    code?: string;\n}\n\nexport const  ConsentReferenceResponseTypeName = \"CS/getConsentReference/response\";\nexport interface ConsentReferenceResponse extends Payload {\n    type: typeof ConsentReferenceResponseTypeName;\n    clientId: string; \n    purposeDeclarationId: string;\n    consentReference: string;\n}\n\nexport function fixRevoked(now: number): ((c: Consent) => Consent) {\n    return (c => ((!c.revoked && c.validUntil < now) ? { ...c, revoked: true } : c));\n}\n\nclass GetConsentReferenceMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ConsentReferenceRequest, GetConsentReferenceMessage> {\n    name: string = \"CS/getConsentReference\";\n\n    handle (cs: ConsentServicePS, msg: Message<ConsentReferenceRequest>): ConsentServicePS {\n\n        let req = msg.message;\n\n        // mark expired consents as revoked, as optimization\n        let _cs : ConsentServicePS = updateDb<typeof cs.mem.db, ConsentServiceState>(\n            cs, { consents: cs.mem.db.consents.map(fixRevoked(msg.now!)) }\n        );\n\n        const consent = findFrom(\n            _cs.mem.db.consents,\n            {\n                purposeDeclarationId: req.purposeDeclarationId,\n                dataSubject: req.subjectId,\n                revoked: false,\n            }\n        );\n\n        if (consent === undefined) {\n            return this.withErrorResponse(\n                setActivePD(_cs, req.subjectId, {\n                    clientId: req.clientId,\n                    purposeDeclarationId: req.purposeDeclarationId,\n                    callbackURL: req.callbackURL\n                }),\n                msg,\n                \"consent_not_found\"\n            );\n        }\n\n        return this.withResponse<ConsentReferenceResponse>(\n            _cs,\n            msg,\n            {\n                type: ConsentReferenceResponseTypeName,\n                clientId: msg.message.clientId,\n                purposeDeclarationId: msg.message.purposeDeclarationId,\n                consentReference: consent.consentReference\n            })\n    }\n}\n\nexport const getConsentReference = addHandlerClass<ConsentReferenceRequest, GetConsentReferenceMessage>(ConsentService, GetConsentReferenceMessage);\n\n","import { ProcessImplName, ViewName, ProcessState, Payload } from \"../Base\";\nimport { ServiceDeclaration } from \"../consentService/types\";\n\n\nexport const ServiceProviderIS : ProcessImplName = \"ServiceProviderIS\";\nexport const ServiceProviderDefaultView : ViewName = \"defaultView\";\n\nexport interface ServiceProviderPS extends ProcessState<ServiceProviderState> {\n    type: typeof ServiceProviderIS;\n    view: typeof ServiceProviderDefaultView;\n}\n\n\nexport interface SecretRecord {\n    key: string;\n    type: string;\n    subject: string;\n    data: any;\n} \n\nexport interface ServiceConfig {\n    consentService: string;\n    serviceName: string;\n    requiredServiceDeclarationIds: string[];\n    returnedDatatypes: string[];\n}\n\nexport const requestTypeName = \"SP/request\";\n\nexport interface ServiceRequest extends Payload {\n    type: typeof requestTypeName;\n    clientId: string;\n    serviceName: string;\n    subjectId: string;\n    consentReference?: string;\n    requestReference: string;\n}\n\nexport const responseTypeName = \"SP/request/response\";\n\nexport interface ServiceResponse extends Payload {\n    asyncId: string; // response correlation id\n    records : SecretRecord[];\n}\n\nexport interface RequestState extends ServiceRequest {\n    validationRequestId: string; // internal, to match response\n    validationResponse?: any;\n    clientAddress: string;\n}\n\nexport type ServiceDeclarationTemplate = Partial<ServiceDeclaration> & { serviceDeclarationId: string };\n\nexport interface ServiceProviderState { \n    db: SecretRecord[];\n    services: ServiceConfig[];\n    inflight: RequestState[]; // requests received but not properly responded\n    declTemplate?: ServiceDeclarationTemplate[];\n}\n","import { GenericMessageHandler, Payload, Message, addHandlerClass } from \"../Base\";\nimport { ConsentServicePS, ConsentServiceState, ConsentService } from \"./types\";\nimport { address2org } from \"../../util\";\n\n\nexport interface ValidationRequest extends Payload {\n    type: typeof ValidationRequestHandler.name;\n    asyncId: string; // internal identifier to help SP to match answer to a request\n    partyId: string;\n    consentReference: string;\n    requestReference: string;\n}\n\nexport const ValidationResponseTypeName = \"CS/validateConsentReference/response\";\nexport interface ValidationResponse extends Payload {\n    type: typeof ValidationResponseTypeName;\n    asyncId: string; // internal identifier. same as in the request\n    valid: boolean;\n    consentReference?: string;\n    consentExpiration?: string; // timestamp\n    validationExpiration?: string;\n    dataSubjectId?: string;\n    clientId?: string;\n    purposeDeclarationId?: string;\n    serviceDeclarationId?: string[];\n}\n\nconst NotValidResponse : ValidationResponse = {\n    type: ValidationResponseTypeName,\n    asyncId: \"\",\n    valid: false,\n}\n\nclass ValidationRequestHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ValidationRequest, ValidationRequestHandler> {\n    name = \"CS/validateConsentReference\";\n\n    notValid(cs: ConsentServicePS, action: Message<ValidationRequest>): ConsentServicePS {\n        return this.withResponse<ValidationResponse>(cs, action, { ...NotValidResponse, asyncId: action.message.asyncId });\n    }\n\n    handle(cs: ConsentServicePS, action: Message<ValidationRequest>): ConsentServicePS {\n        let consent = cs.mem.db.consents.find(c => c.consentReference === action.message.consentReference);\n\n        if (consent === undefined) {\n            console.log(\"No such consent found: \", action.message.consentReference);\n            return this.notValid(cs, action);\n        }\n\n        let now = action.now!;\n\n        if (consent.revoked || now < consent.validFrom || now > consent.validUntil) {\n            console.log(`Consent ${consent} is not valid`);\n            return this.notValid(cs, action);\n        }\n\n        let sender = address2org(action.sender);\n\n        // find services that the sender of the request is allowed to provide under the consent in question\n        let purposeDeclaration = cs.mem.db.purposeDeclarations.find(\n            pd => (pd.clientId === consent!.clientId && pd.purposeDeclarationId === consent!.purposeDeclarationId)\n        );\n\n        if (purposeDeclaration === undefined) {\n            console.error(\"Cannot find purposeDeclaration that matches to an existing consent?\");\n            return this.notValid(cs, action);\n        }\n\n        // services that the asking party is allowed to provide with this consent\n        let services = (purposeDeclaration.services\n            .filter(s => s.serviceProviderId === sender)\n            .map(s => s.serviceDeclarationId)\n        );\n\n        if (sender === consent.clientId) {\n            let response: ValidationResponse = {\n                type: ValidationResponseTypeName,\n                asyncId: action.message.asyncId,\n                valid: true,\n                consentReference: action.message.consentReference,\n                consentExpiration: new Date(consent.validUntil * 1000).toISOString(),\n                dataSubjectId: consent.dataSubject,\n                clientId: consent.clientId,\n                purposeDeclarationId: consent.purposeDeclarationId,\n                // this is not empty if the client and service provider are the same\n                // (data repurposing using the consent)\n                serviceDeclarationId: services,\n            }\n            return this.withResponse(cs, action, response);\n        }\n\n        // it was not the party that declared the purpose. if it is party whose service declaration was\n        // referenced from the purpose declaration, then it still might get the answer\n        if (services.length > 0) {\n            let response: ValidationResponse = {\n                type: ValidationResponseTypeName,\n                asyncId: action.message.asyncId,\n                valid: true,\n                consentReference: action.message.consentReference,\n                consentExpiration: new Date(consent.validUntil * 1000).toISOString(),\n                dataSubjectId: consent.dataSubject,\n                clientId: consent.clientId,\n                serviceDeclarationId: services,\n            }\n            return this.withResponse(cs, action, response);\n        }\n\n        // not the client, not the service provider => not authorized to get anything.\n        return this.notValid(cs, action);\n    }\n}\n\nexport const validateConsentReference = addHandlerClass<ValidationRequest, ValidationRequestHandler>(ConsentService, ValidationRequestHandler);\n\n","import { UsageRecord, ConsentServiceState, ConsentServicePS, ConsentService } from \"./types\";\nimport { GenericMessageHandler, Message, addHandlerClass, Payload, updateDb } from \"../Base\";\n\ninterface ServiceUseMessage extends UsageRecord, Payload {\n    type: typeof ReportServiceUseMessage.name;\n}\n\nclass ReportServiceUseMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ServiceUseMessage, ReportServiceUseMessage> {\n    name: string = \"CS/reportServiceUsage\";\n\n    addUsageRecord(cs: ConsentServicePS, sd: UsageRecord) {\n        return updateDb(cs, { usageLog : cs.mem.db.usageLog.concat(sd)});\n    }\n\n    handle (cs: ConsentServicePS, msg: Message<ServiceUseMessage>) {\n        return this.withOkResponse(this.addUsageRecord(cs, {...msg.message, type: undefined } as UsageRecord), msg);\n    }\n}\n\nexport const reportServiceUse = addHandlerClass<ServiceUseMessage, ReportServiceUseMessage>(ConsentService, ReportServiceUseMessage);\n\n","import { GenericMessageHandler, Payload, Message, message, addHandlerClass, ErrorPayload } from \"../Base\";\nimport { ServiceProviderState, ServiceProviderPS, ServiceProviderIS, SecretRecord, ServiceRequest, requestTypeName, RequestState, ServiceConfig } from \"./types\";\nimport { addServiceDeclaration } from \"../consentService/declarationAPI\";\nimport { validateConsentReference, ValidationResponse, ValidationResponseTypeName } from \"../consentService/validationAPI\";\nimport { reportServiceUse } from \"../consentService/reportingAPI\";\nimport { submitResponse } from \"../client/messages\";\nimport { hash, address2org } from \"../../util\";\nimport { UsageRecord } from \"../consentService/types\";\n\ninterface DataPayload extends Payload {\n    type: typeof DataEntryHandler.name;\n    key: string;\n    datatype?: string;\n    subject?: string;\n    data?: any;\n}\n\nclass DataEntryHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, DataPayload, DataEntryHandler> {\n    name = \"ServiceProvider/UI/addData\";\n\n    handle (spis: ServiceProviderPS, action: Message<DataPayload>): ServiceProviderPS {\n        if (action.message.datatype === undefined || action.message.datatype === \"\") {\n            return { ...spis, mem: { ...spis.mem, db: spis.mem.db.filter(r => (r.key !== action.message.key)) } };\n        }\n\n        let rec = action.message;\n        let dbrec : SecretRecord = { key: rec.key, type: rec.datatype!, subject: rec.subject!, data: rec.data! };\n\n        return { ...spis, mem: { ...spis.mem, db: spis.mem.db.concat(dbrec) } }\n    }\n}\n\nexport const addData = addHandlerClass<DataPayload, DataEntryHandler>(ServiceProviderIS, DataEntryHandler);\n\nclass SendDeclarationHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, Payload, SendDeclarationHandler> {\n    name = \"ServiceProvider/UI/declareService\";\n\n    handle(spis: ServiceProviderPS, action: Message<Payload>): ServiceProviderPS {\n        // FIXME: korrektne CS väärtus\n        return this.send(spis, message(action.arena, spis, [ spis.mem.services[0].consentService ], addServiceDeclaration()(action.message)))\n    }\n}\n\nexport const declareService = addHandlerClass(ServiceProviderIS, SendDeclarationHandler);\n\nfunction requestId(req: ServiceRequest, service: ServiceConfig): string {\n    let input = req.clientId + req.consentReference + req.requestReference + \n             req.serviceName + req.subjectId + service.consentService;\n    \n    return hash(input);\n}\n\nclass ProtectedRequestHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, ServiceRequest, ProtectedRequestHandler> {\n    name = requestTypeName;\n    handle(spis: ServiceProviderPS, action: Message<ServiceRequest>): ServiceProviderPS {\n\n        function _send<P extends Payload>(receivers: string[], m: P): Message<P> {\n            return message(action.arena, spis, receivers, m);     \n        }\n\n        let req : ServiceRequest = action.message;\n        // validate request (find service record from config)\n        let service = spis.mem.services.find(s => s.serviceName === req.serviceName);\n        if (service === undefined) {\n            // no reporting -- \"the request did not reach the relevant endpoint\"\n            return this.withErrorResponse(spis, action, \"invalid_request\");\n        }\n\n        if (req.clientId !== address2org(action.sender)) {\n            // FIXME: here we COULD report something?\n            return this.withErrorResponse(spis, action, \"invalid_request\");\n        }\n\n        if(!req.consentReference) {\n            const report : UsageRecord = { \n                result: \"ACCESS_DENIED\", \n                clientId : req.clientId,\n                subjectId: req.subjectId,\n                serviceDeclarationIds: service.requiredServiceDeclarationIds, \n                requestReference: req.requestReference,\n                serviceProviderId: address2org(spis.name),\n                usageTime : action.now!,\n            }\n            return this.send(\n                this.send(\n                    spis,\n                    _send([service.consentService],reportServiceUse()(report))\n                ),\n                _send<ErrorPayload>([action.sender], {type : \"error\", error : \"ACCESS_DENIED\"})\n            )\n        }\n\n        // store inflight query\n        // spis.mem.inflight += [inflight]\n        let reqState : RequestState = { \n            ...req,\n             validationRequestId: requestId(req, service),\n             clientAddress: action.sender,\n        }\n        let withInfligh : ServiceProviderPS = {\n            ...spis, mem: { ...spis.mem, inflight: spis.mem.inflight.concat(reqState) }\n        };\n\n        // send consent reference validation request\n        return this.send(\n            withInfligh, \n            message(\n                action.arena,\n                 withInfligh,\n                  [ service.consentService ],\n                  validateConsentReference()({\n                      asyncId: reqState.validationRequestId,\n                      partyId: spis.name,\n                      consentReference: req.consentReference,\n                      requestReference: req.requestReference,\n                  })\n            )\n        );\n    }\n}\n\nexport const submitRequest = addHandlerClass<ServiceRequest, ProtectedRequestHandler>(ServiceProviderIS, ProtectedRequestHandler);\n\n\nclass ValidationResponseHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, ValidationResponse, ValidationResponseHandler> {\n    name = ValidationResponseTypeName;\n\n    handle(spis: ServiceProviderPS, action: Message<ValidationResponse>): ServiceProviderPS {\n\n        function _send<P extends Payload>(receivers: string[], m: P): Message<P> {\n            return message(action.arena, spis, receivers, m);     \n        }\n        \n        const reqState = spis.mem.inflight.find(ifr => ifr.validationRequestId === action.message.asyncId);\n        const resp = action.message;\n\n        function removeInflight(spis: ServiceProviderPS): ServiceProviderPS {\n            return { ...spis, mem: { ...spis.mem, inflight: spis.mem.inflight.filter(\n                ifr => (reqState === undefined || ifr.requestReference !== reqState.requestReference)\n            ) }};\n        }\n\n\n        if (reqState === undefined) {\n            console.error(\"Failed to find original inflight request, ignoring the response.\");\n            return spis;\n        }\n\n        const service = spis.mem.services.find(s => s.serviceName === reqState.serviceName);\n        if (service === undefined) {\n            console.error(\"Failed to find the service specified in the original inflight request, ignoring the response.\");\n            return removeInflight(spis);\n        }\n\n        const usageReport : UsageRecord = { \n            result: \"OK\", // will be overwritten\n            clientId : reqState.clientId,\n            subjectId: reqState.subjectId,\n            serviceDeclarationIds: service.requiredServiceDeclarationIds, \n            consentReference: reqState.consentReference,\n            requestReference: reqState.requestReference,\n            serviceProviderId: address2org(spis.name),\n            usageTime : action.now!,\n        }\n\n        if (!resp.valid \n                || resp.clientId !== reqState.clientId \n                || resp.consentReference !== reqState.consentReference \n                || resp.dataSubjectId !== reqState.subjectId\n                || resp.serviceDeclarationId === undefined\n                // (there is a required serviceDeclarationId that is not on the consent)\n                || service.requiredServiceDeclarationIds\n                        .find(sd => !resp.serviceDeclarationId!.includes(sd))\n                ) {     \n            return this.send(\n                this.send(\n                    removeInflight(spis),\n                    _send([service.consentService], reportServiceUse()({...usageReport, result : \"ACCESS_DENIED\"}))\n                ),\n                _send<ErrorPayload>([reqState.clientAddress], {type : \"error\", error : \"ACCESS_DENIED\"})\n            )\n        };\n    \n        return this.send(\n            this.send(\n                removeInflight(spis),\n                _send([service.consentService], reportServiceUse()({...usageReport, result : \"OK\"}))\n            ),\n            _send(\n                [reqState.clientAddress],\n                submitResponse()({\n                    records : spis.mem.db\n                        .filter(x => x.subject === reqState.subjectId)\n                        .filter(x => service.returnedDatatypes.includes(x.type)),\n                    asyncId : reqState.requestReference    \n                })\n            )\n        );\n    }\n}\n\nexport const validationResponse = addHandlerClass<ValidationResponse, ValidationResponseHandler>(ServiceProviderIS, ValidationResponseHandler);\n","import { addHandlerClass, Payload, GenericMessageHandler, Message, message, ErrorPayload, updateDb } from \"../Base\";\nimport { ClientIS, ClientState, ClientPS } from \"./types\";\n\nimport { addPurposeDeclaration } from \"../consentService/declarationAPI\";\nimport { getConsentReference, ConsentReferenceResponse, ConsentReferenceResponseTypeName } from \"../consentService/referenceAPI\";\n\nimport { submitRequest } from \"../serviceProvider/messages\";\nimport { ServiceResponse, responseTypeName } from \"../serviceProvider/types\";\n\nimport { hash, address2org } from \"../../util\";\nimport { validateConsentReference } from \"../consentService/validationAPI\";\n\n\ninterface LoginMessage extends Payload {\n    type: typeof LoginMessageHandler.name;\n    user?: string;\n}\n\nclass LoginMessageHandler extends GenericMessageHandler<ClientState, ClientPS, LoginMessage, LoginMessageHandler> {\n    name = \"Client/UI/login\";\n\n    handle(cs: ClientPS, action: Message<LoginMessage>): ClientPS {\n        // reset cached responses when logging in.\n        return { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, user: action.message.user, service: undefined, response: [] } } };\n    }\n}\n\nexport const loginMessage = addHandlerClass<LoginMessage, LoginMessageHandler>(ClientIS, LoginMessageHandler);\n\ninterface SelectServiceMessage extends Payload {\n    type: typeof SelectServiceMessageHandler.name;\n    service?: string;\n}\n\nclass SelectServiceMessageHandler extends GenericMessageHandler<ClientState, ClientPS, SelectServiceMessage, SelectServiceMessageHandler> {\n    name = \"Client/UI/selectService\";\n\n    handle(cs: ClientPS, action: Message<SelectServiceMessage>): ClientPS {\n        let _cs = { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, service: action.message.service, response: [] } } };\n\n        if (_cs.mem.ui.service !== undefined) {\n            // if cached consentref is missing (not asked or known to not exist), ask automatically for new\n            let cachedConsentRefs = _cs.mem.db.consentRefByUser[_cs.mem.ui.user!];\n            let cachedConsentRef = cachedConsentRefs === undefined ? undefined : cachedConsentRefs[_cs.mem.ui.service!];\n            if (cachedConsentRef === undefined || cachedConsentRef === null) {\n                return this.send(_cs, message(action.arena, cs, [cs.mem.db.consentServiceId], \n                    getConsentReference({ \n                        clientId: address2org(cs.name),\n                        subjectId: cs.mem.ui.user,\n                        purposeDeclarationId: action.message.service,\n                        callbackURL: cs.name, // actual address for callback message\n                    })()\n                ));\n            }\n        }\n\n        return _cs;\n    }\n}\n\nexport const selectServiceMessage = addHandlerClass<SelectServiceMessage, SelectServiceMessageHandler>(ClientIS, SelectServiceMessageHandler);\n\n\n\nclass SendDeclarationHandler extends GenericMessageHandler<ClientState, ClientPS, Payload, SendDeclarationHandler> {\n    name = \"Client/UI/declarePurpose\";\n\n    handle(cis: ClientPS, action: Message<Payload>): ClientPS {\n        return this.send(cis, message(action.arena, cis, [ cis.mem.db.consentServiceId ], addPurposeDeclaration()(action.message)))\n    }\n}\n\nexport const declarePurpose = addHandlerClass(ClientIS, SendDeclarationHandler);\n\ninterface FetchConsentReferencePayload extends Payload {\n    type: typeof FetchConsentReferenceHandler.name;\n    purposeDeclarationId: string;\n}\n\nclass FetchConsentReferenceHandler extends GenericMessageHandler<ClientState, ClientPS, FetchConsentReferencePayload, FetchConsentReferenceHandler> {\n    name = \"Client/UI/fetchConsentReference\";\n\n    handle(cis: ClientPS, action: Message<FetchConsentReferencePayload>): ClientPS {\n        return this.send(\n            updateDb<typeof cis.mem.db, ClientState>({\n                ...cis,\n                mem: {\n                    ...cis.mem,\n                    ui: {\n                        ...cis.mem.ui,\n                        service: action.message.purposeDeclarationId\n                    }\n                }\n            }, { \n                consentRefByUser: updateCSRef(\n                    cis.mem.db.consentRefByUser,\n                    cis.mem.ui.user!,\n                    action.message.purposeDeclarationId,\n                    undefined\n                )\n             }), \n            message(action.arena, cis, [cis.mem.db.consentServiceId], getConsentReference({\n                clientId: address2org(cis.name),\n                purposeDeclarationId: action.message.purposeDeclarationId,\n                subjectId: cis.mem.ui.user,\n                callbackURL: cis.name, // actual address for callback message\n            })()\n        ))\n    }\n}\n\nexport const fetchConsentReference = addHandlerClass<FetchConsentReferencePayload, FetchConsentReferenceHandler>(ClientIS, FetchConsentReferenceHandler);\n\nfunction updateCSRef<T extends { [k: string]: any }>(csByUser: T, user: string, purposeDeclarationId: string, consentReference?: string | null): T {\n    return {\n        ...csByUser,\n        [user]: { ...csByUser[user], [purposeDeclarationId]: consentReference }\n    };\n}\n\nclass ConsentReferenceResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ConsentReferenceResponse, ConsentReferenceResponseHandler> {\n    name = ConsentReferenceResponseTypeName;\n\n    handle(cis: ClientPS, action: Message<ConsentReferenceResponse>): ClientPS {\n        return { ...cis, mem: { ...cis.mem, db: { \n            ...cis.mem.db,\n            consentRefByUser: updateCSRef(\n                cis.mem.db.consentRefByUser,\n                cis.mem.ui.user!,\n                action.message.purposeDeclarationId,\n                action.message.consentReference\n            )\n        } } };\n    }\n}\n\nexport const handleConsentRefernceResponse = addHandlerClass<ConsentReferenceResponse, ConsentReferenceResponseHandler>(ClientIS, ConsentReferenceResponseHandler);\n\ninterface ExecuteMessage extends Payload {\n    type: typeof ExecuteRequestHandler.name;\n    requestReference: string; // generated in UI because it should not be done here.\n    purposeId: string;\n    serviceAddress?: string; // only execute one request.\n    serviceName?: string;\n}\n\nclass ExecuteRequestHandler extends GenericMessageHandler<ClientState, ClientPS, ExecuteMessage, ExecuteRequestHandler> {\n    name = \"Client/UI/executeRequest\";\n\n    handle(cis: ClientPS, action: Message<ExecuteMessage>): ClientPS {\n        let req = action.message;\n\n        let userConsentRefs = cis.mem.db.consentRefByUser[cis.mem.ui.user!];\n        let consentReference = userConsentRefs === undefined ? undefined : userConsentRefs[req.purposeId];\n\n        let conf = cis.mem.config.find(c => c.purposeDeclarationId === req.purposeId);\n        if (conf === undefined) {\n            console.error(\"Unknown purpose? \", req);\n            return cis;\n        }\n\n        // send request for all services defined in configuration, or to those that match.\n        return (conf.services\n            .filter(service => ((req.serviceAddress === undefined || req.serviceAddress === service.serviceAddress)\n                    && (req.serviceName === undefined || req.serviceName === service.serviceName)))\n            .reduce((_cis, service) => {\n            let requestReference = hash(req.requestReference + service.serviceName + service.serviceAddress);\n            // eslint-disable-next-line\n            let cis = undefined;\n            \n            // replace or add response record for this particular purpose/serviceprovider/service\n            let newResponses = (_cis.mem.ui.response || []).filter(\n                r => !(r.purposeDeclarationId === req.purposeId \n                        && r.serviceAddress === service.serviceAddress \n                        && r.serviceName === service.serviceName)\n            ).concat({\n                requestReferenceId: requestReference,\n                purposeDeclarationId: req.purposeId,\n                serviceAddress: service.serviceAddress,\n                serviceName: service.serviceName,\n                data: null,\n            })\n\n            let __cis = { ..._cis, mem: { ..._cis.mem, ui: { \n                ..._cis.mem.ui,\n                 response: newResponses,\n            } } };\n\n            return this.send(__cis, message(action.arena, __cis, [service.serviceAddress], submitRequest({\n                clientId: address2org(__cis.name),\n                serviceName: service.serviceName,\n                subjectId: __cis.mem.ui.user,\n                consentReference: consentReference!,\n                requestReference: requestReference,\n            })()))\n        }, cis));\n    }\n}\n\nexport const executeRequest = addHandlerClass<ExecuteMessage, ExecuteRequestHandler>(ClientIS, ExecuteRequestHandler);\nexport function generateRequestReference() : string {\n    return hash(\"\" + ((Math.random() * 1000000) | 0));\n}\n\n\nclass ServiceResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ServiceResponse, ServiceResponseHandler> {\n    name = responseTypeName;\n\n    handle(cis: ClientPS, action: Message<ServiceResponse>): ClientPS {\n        return { ...cis, mem: { ...cis.mem, ui: {\n            ...cis.mem.ui,\n            response: (cis.mem.ui.response || []).map(\n                r => {\n                    if (r.requestReferenceId === action.message.asyncId) {\n                        return { ...r, data: action.message.records }\n                    } else {\n                        return r;\n                    }\n                }\n            )\n        }}}\n    }\n\n}\n\nexport const submitResponse = addHandlerClass<ServiceResponse, ServiceResponseHandler>(ClientIS, ServiceResponseHandler);\n\nclass ErrorResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ErrorPayload, ErrorResponseHandler> {\n    name = \"error\";\n\n    handle(cis: ClientPS, action: Message<ErrorPayload>): ClientPS {\n        switch (action.message.error) {\n            // assume the respone came for logged in user and for selected service\n            case \"consent_not_found\":\n                return updateDb<typeof cis.mem.db, ClientState>(cis, { \n                    consentRefByUser: updateCSRef(\n                        cis.mem.db.consentRefByUser,\n                        cis.mem.ui.user!,\n                        cis.mem.ui.service!,\n                        null\n                    )\n                });\n        }\n\n        console.log(\"Unknown error, ignoring: \", action);\n        return cis;\n    }\n}\n\naddHandlerClass<ErrorPayload, ErrorResponseHandler>(ClientIS, ErrorResponseHandler);\n\ninterface UpdateConsentReferencePayload extends Payload {\n    type: typeof UpdateConsentReferenceHandler.name;\n    purposeDeclarationId?: string;\n    consentReference?: string;\n}\n\nclass UpdateConsentReferenceHandler extends GenericMessageHandler<ClientState, ClientPS, UpdateConsentReferencePayload, UpdateConsentReferenceHandler> {\n    name = \"CS/UI/dumpConsentRefCache\";\n\n    handle(cis: ClientPS, action: Message<UpdateConsentReferencePayload>): ClientPS {\n        if (action.message.purposeDeclarationId !== undefined) {\n            return updateDb<typeof cis.mem.db, ClientState>(cis, { \n                consentRefByUser: updateCSRef(\n                    cis.mem.db.consentRefByUser,\n                    cis.mem.ui.user!,\n                    action.message.purposeDeclarationId,\n                    action.message.consentReference\n                )\n            });\n        }\n        return updateDb<typeof cis.mem.db, ClientState>(cis, { consentRefByUser: {} });\n    }\n}\n\nexport const updateConsentRefInCache = addHandlerClass<UpdateConsentReferencePayload, UpdateConsentReferenceHandler>(ClientIS, UpdateConsentReferenceHandler);\n\ninterface ValidateConsentRefMessage extends Payload {\n    consentServiceId: string;\n    consentReference: string;\n}\n\nclass ValidateConsentRefMessageHandler extends GenericMessageHandler<ClientState, ClientPS, ValidateConsentRefMessage, ValidateConsentRefMessageHandler> {\n    name = \"Client/UI/validateConsentRef\";\n\n    handle(cis: ClientPS, action: Message<ValidateConsentRefMessage>): ClientPS {\n        return this.send(\n            cis, \n            message(action.arena, cis, [action.message.consentServiceId || cis.mem.db.consentServiceId],\n                validateConsentReference({ \n                    partyId: cis.name,\n                    consentReference: action.message.consentReference\n                })()\n            )\n        );\n    }\n}\n\nexport const validateConsentRef = addHandlerClass<ValidateConsentRefMessage, ValidateConsentRefMessageHandler>(ClientIS, ValidateConsentRefMessageHandler);\n","import * as React from \"react\";\nimport { ProcessAndArena, Message, message } from \"../Base\";\nimport { ClientState } from \"./types\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { SimpleSend } from \"../../components/SendButton\";\nimport { loginMessage, selectServiceMessage, fetchConsentReference, executeRequest, generateRequestReference } from \"./messages\";\nimport { connect } from \"react-redux\";\nimport { __, fullname } from \"../../i18n\";\n\ninterface ClientViewProps extends ProcessAndArena<ClientState> {\n    t: any;\n    send: (props: ClientViewProps, values?: any) => Message<any>;\n}\n\n\nconst LOGIN: ClientViewState = \"login\";  // no authenticated user\nconst SELECT_SERVICE: ClientViewState = \"selectService\"; // user authenticated, service not selected\nconst WAIT_FOR_CONSENT_REF: ClientViewState = \"waitForConsent\"; //  no idea if user has consent\nconst CONSENT_NOT_FOUND: ClientViewState = \"consentNotFound\"; // prompt for consent\nconst SERVICE_V1: ClientViewState = \"serviceV1\";\n\ntype ClientViewState = \"login\" | \"selectService\" | \"waitForConsent\" | \"consentNotFound\" | \"serviceV1\";\n\ninterface State {\n    view: ClientViewState;\n    loading: boolean;\n}\n  \n  const Header = ({t, props} : {t: any; props: ClientViewProps}) => (\n  <div className=\"app-header\">\n    <SimpleSend arena={props.arena} owner={props.process} className=\"btn btn-success btn-health\" text={ t('logout') } message={ loginMessage() }/>\n    <div className=\"app-user-icon\">\n      <img alt=\"user icon\" src={require('./../../static/assets/images/user-icon.svg')} />\n    </div>\n    <p className=\"app-user\">{ t('hello').replace(\"USERNAME\", fullname(props.process.mem.ui.user!)) }</p>\n  </div>\n);\n\nfunction send(props: ClientViewProps, values?: any): Message<any> {\n    return message(props.arena, props.process, [props.process.name], values());\n}\n\nfunction currentView(m: ClientState): ClientViewState {\n    if (m.ui.user === undefined) {\n        return LOGIN;\n    } else if (m.ui.service === undefined) {\n        return SELECT_SERVICE;\n    } else if (m.db.consentRefByUser[m.ui.user] === undefined || \n            m.db.consentRefByUser[m.ui.user][m.ui.service] === undefined) {\n        return WAIT_FOR_CONSENT_REF;\n    } else if (m.db.consentRefByUser[m.ui.user][m.ui.service] === null) {\n        return CONSENT_NOT_FOUND;\n    } else {\n        return SERVICE_V1;\n    }\n}\n\nclass ClientView_ extends React.PureComponent<ClientViewProps, State> {\n\n  constructor(props: ClientViewProps) {\n    super(props);\n      this.state = { loading: false, view: currentView(props.process.mem) };\n      switch (this.state.view) {\n        case WAIT_FOR_CONSENT_REF:\n          this.sendMessagesFor(this.state.view);\n      }\n  }\n\n  componentDidMount() {\n    this.componentDidUpdate();    \n  }\n\n  componentDidUpdate() {\n    let actualView = currentView(this.props.process.mem);\n    if (actualView !== this.state.view) {\n      this.setState({ view: actualView });\n    }\n  }\n\n  sendMessagesFor = (view: ClientViewState) => {\n    const mem = this.props.process.mem;\n    switch (view) {\n        case WAIT_FOR_CONSENT_REF:\n            if (mem.ui.user !== undefined && mem.ui.service !== undefined && (\n                    mem.db.consentRefByUser[mem.ui.user] === undefined ||\n                    mem.db.consentRefByUser[mem.ui.user][mem.ui.service] === undefined ||\n                    mem.db.consentRefByUser[mem.ui.user][mem.ui.service] === null)\n            ) {\n                this.props.send(this.props, fetchConsentReference({ purposeDeclarationId: mem.ui.service }));\n            }\n            return;\n\n        case SERVICE_V1:\n            this.props.send(this.props, executeRequest({\n                requestReference: generateRequestReference(),\n                purposeId: mem.ui.service }));\n            return;\n    }\n  }\n\n  state = {\n    view: LOGIN,\n    loading: false\n  };\n\n  changeView = (view: ClientViewState, withMessages = true) => {\n    this.setState({ loading: true });\n    if (withMessages) {\n        this.sendMessagesFor(view);\n    }\n    setTimeout(() => {\n      this.setState({loading: false, view: view});\n    }, 600);\n  };\n\n  render() {\n    const cis = this.props.process;\n    const m = cis.mem;\n    const t = this.props.t;\n\n    const returnButton = (\n      <SimpleSend\n        arena={this.props.arena}\n        owner={this.props.process}\n        className=\"btn btn-light border\"\n        onClick={() => this.changeView(SELECT_SERVICE)}\n        message={selectServiceMessage()}\n        text={ t(\"return\") }\n      />\n    );\n\n    switch (this.state.loading) {\n      case true:\n      return (\n        <div className=\"d-flex align-items-center\">\n          <strong>Loading...</strong>\n          <div className=\"spinner-border ml-auto\" role=\"status\" aria-hidden=\"true\"></div>\n        </div>\n      );\n      default:\n        switch (this.state.view) {\n          case LOGIN:\n          return (\n            <div><form>\n                <h4>{ t(\"please_login\") }</h4>\n                <div>\n                  <div className=\"input-group\">\n                    <input className=\"form-control\" size={10} name=\"user\" defaultValue=\"47302200234\"/>\n                    <div className=\"input-group-append\">\n                      <SimpleSend\n                          arena={this.props.arena}\n                          owner={this.props.process}\n                          className=\"btn btn-light border\"\n                          onClick={() => this.changeView(SELECT_SERVICE)}\n                          message={loginMessage()}\n                          text={ t(\"login\") }\n                      />\n                    </div>\n                  </div>\n                </div>\n                <p className=\"mt-4 mb-0\">\n                    <img alt=\"illustration\" src={require('./../../static/assets/images/login.svg')} width=\"280\" />\n                </p>\n            </form></div>\n          );\n          case SELECT_SERVICE:\n          return (\n            <div>\n              <Header t={t} props={this.props} />\n          <h4>{ t(\"choose_service\") }</h4>\n              {\n                  this.props.process.mem.config.map(\n                      service => {\n                          return (\n                            <SimpleSend \n                                key={ service.purposeDeclarationId }\n                                className=\"btn btn-dark mt-2 mr-2\"\n                                arena={this.props.arena}\n                                owner={this.props.process}\n                                onClick={() => this.changeView(WAIT_FOR_CONSENT_REF)}\n                                message={selectServiceMessage({ service: service.purposeDeclarationId })}\n                                text={ t(\"service\", service.purposeDeclarationId, \"name\") }\n                             />                \n                          )\n                      }\n                  )\n              }\n            </div>\n          );\n          case WAIT_FOR_CONSENT_REF:\n              return (\n                  <div>\n                      <Header t={t} props={this.props} />\n                      <h4>{ t(\"checking_consent\") }</h4>\n                      <p className=\"text-left\">{ t(\"retry_if_timed_out\") }</p>\n                      <SimpleSend\n                            className=\"btn btn-dark\"\n                            arena={this.props.arena}\n                            owner={this.props.process}\n                            message={fetchConsentReference({ purposeDeclarationId: m.ui.service })}\n                            text={ t('retry-fetch') }\n                      />\n                  </div>\n              );\n          case CONSENT_NOT_FOUND:\n          return (\n            <div>\n              <Header t={t} props={this.props} />\n              <h4>{ t(\"service\", m.ui.service!, \"consent-header\") }</h4>\n              <p className=\"text-left\">\n                <small dangerouslySetInnerHTML={{__html: t(\"service\", m.ui.service!, \"consent-intro\")}} />\n              </p>\n              <p>\n                 <button className=\"btn btn-lg btn-success btn-health\" onClick={ev => window.open(\"ui/csui/\", this.props.arena + \" - \" + m.db.consentServiceId) }>Annan nõusoleku</button>\n              </p>\n              <p>{ returnButton }</p>\n            </div>\n          );\n          case SERVICE_V1:\n              return (\n                  <div>\n                      <Header t={t} props={this.props} />\n                      <h4>{ t(\"consented_data\") }</h4>\n                      {\n                        (m.ui.response || []).filter(\n                            r => r.purposeDeclarationId === m.ui.service\n                        ).map(\n                            r => (\n                                <span className=\"card\" key={r.serviceAddress + \" \" + r.serviceName}>\n                                    <pre className=\"text-left\">\n                                        {r.serviceAddress}/{r.serviceName}: { JSON.stringify(r.data, undefined, \" \") }\n                                    </pre>\n                                </span>\n                            )\n                        )\n                      }\n                    <p>\n                      <SimpleSend\n                        owner={this.props.process}\n                        arena={this.props.arena}\n                        className=\"btn btn-success btn-health\"\n                        message={executeRequest({\n                          requestReference: generateRequestReference(),\n                          purposeId: m.ui.service\n                      })} text={ t('load-consented-data') } />\n                    </p>\n                    <p>{ returnButton }</p>\n                  </div>\n              )\n          default:\n          return <div>Unimplemented view: {this.state.view}</div>\n        }\n    }\n  }\n}\n\nconst ClientView = connect(null, { send })(ClientView_);\n\nconst EnduserUI : React.FC<ProcessAndArena<ClientState>> = ({process, arena}) => {\n\n    const t = (...k: string[]) => __({arena, process}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n\n    return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"lg\" bsPrefix=\"client-app modal\">\n          <Modal.Header>\n            <Modal.Title>{ t('title') }</Modal.Title>\n          </Modal.Header>\n          <Modal.Body>\n            <ClientView arena={arena} process={process} t={t}/>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"outline-dark\" onClick={handleClose}>{ t('close') }</Button>\n          </Modal.Footer>\n        </Modal>\n        <Button variant=\"success\" className=\"mr-2 btn-health\" onClick={handleShow}>{t('open-end-user-view')}</Button>\n        </>\n      )\n}\n  \n\nexport default EnduserUI;","import { ProcessAndArena } from \"../Base\";\nimport { ClientState, ClientPS, PurposeDeclarationTemplate, ClientConfig } from \"./types\";\nimport React from \"react\";\nimport { Modal, Button, Dropdown, ButtonProps } from \"react-bootstrap\";\nimport { SimpleSend } from \"../../components/SendButton\";\nimport { declarePurpose, executeRequest, fetchConsentReference, generateRequestReference, updateConsentRefInCache, validateConsentRef } from \"./messages\";\nimport EnduserUI from \"./EnduserUI\";\nimport { __, business } from \"../../i18n\";\nimport { address2org } from \"../../util\";\n\n\ninterface ClientViewProps extends ProcessAndArena<ClientState> {\n    process: ClientPS;\n}\n\ntype SDRef = {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n}\n\nfunction addSDRef(ev: any, opts: SDRef[], setOpts: React.Dispatch<React.SetStateAction<SDRef[]>> ) {\n    ev.preventDefault();\n    let f = ev.currentTarget.form;\n\n    let spId = f._spId.value;\n    let sdId = f._sdId.value;\n\n    if (!spId.match(\"^[!-~]+$\") || !sdId.match(\"^[!-~]+$\")) {\n        return;\n    }\n    \n    setOpts(old => old.concat({ serviceProviderId: spId, serviceDeclarationId: sdId }));\n    f._spId.value = f._sdId.value = \"\";\n}\n\nfunction prefillPurposeDeclaration(ev: any, decls: PurposeDeclarationTemplate[] | undefined, setOpts: React.Dispatch<React.SetStateAction<SDRef[]>> ) {\n    ev.preventDefault();\n  \n    let declId = ev.currentTarget.value;\n  \n    let form = ev.currentTarget.form;\n    let decl = decls!.find(d => d.purposeDeclarationId! === declId);\n    if (decl === undefined) {\n      return;\n    }\n  \n    form[\"name\"].value = decl.name;\n    form[\"purposeDeclarationId\"].value = decl.purposeDeclarationId;\n    form[\"description\"].value = decl.description;\n    if (decl.services !== undefined) {\n        setOpts(decl.services);\n    }\n  }\n  \n  function declarationPrefill(sp: ClientPS, setOpts: React.Dispatch<React.SetStateAction<SDRef[]>>) {\n    if (sp.mem.declTemplate === undefined || sp.mem.declTemplate.length === 0) {\n      return <></>;\n    }\n  \n    return (\n      <div className=\"form-group text-danger\">\n        <label htmlFor=\"prefilled\">Eeltäidetud deklaratsiooni kiirvalik</label>\n        <select \n            className=\"form-control\" \n            id=\"prefilled\" \n            onChange={ ev => prefillPurposeDeclaration(ev, sp.mem.declTemplate, setOpts) }\n            defaultValue=\"\">\n          <option key=\"none\" value=\"\">... vali eeltäidetud deklaratsioon ...</option>\n          {\n            sp.mem.declTemplate.map(dt => (\n              <option key={ dt.purposeDeclarationId } value={ dt.purposeDeclarationId }>{ dt.name! }</option>\n            ))\n          }\n        </select>\n      </div>\n    );\n  }\n  \n\nconst DeclarePurposePopup : React.FC<ClientViewProps> = ({process, arena}) => {\n\n  const t = (k: string) => __({arena, process}, k);\n  const [show, setShow] = React.useState(false);\n  const [sdrefs, setSDRefs] = React.useState([] as SDRef[]);\n  const handleClose = () => setShow(false);\n  const handleShow = () => setShow(true);\n    return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"xl\">\n        <Modal.Header closeButton>\n            <Modal.Title>Eesmärgideklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n            <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <small>\n                    { t('purpose-decl-intro') }\n                  </small>\n                </div>\n              </div>\n              <div className=\"row border-bottom mt-4 mb-2\">\n                <div className=\"col\">\n                  <h6>{t('declarer')} { business(address2org(process.name), \"name\") } ({ address2org(process.name) })</h6>\n                  <input name=\"clientId\" type=\"hidden\" value={ address2org(process.name) } />\n                </div>\n              </div>\n              <div className=\"row\">\n                <div className=\"col\">\n                  { declarationPrefill(process, setSDRefs) }\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dIdentifier\">Eesmärgideklaratsiooni identifikaator:</label>\n                    <input name=\"purposeDeclarationId\" type=\"text\" className=\"form-control\" id=\"dIdentifier\" />\n                    <small id=\"dIdentifierHelp\" className=\"form-text text-muted\">Klientrakenduse poolt määratud eesmärgideklaratsiooni identifikaator</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dName\">Eesmärgideklaratsiooni nimi:</label>\n                    <input name=\"name\" type=\"text\" className=\"form-control\" id=\"dName\" />\n                    <small id=\"dNameHelp\" className=\"form-text text-muted\">Eesmärgi lühike nimi kasutajale näitamiseks</small>\n                  </div>\n                </div>\n              </div>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dataUsage\">Andmete kasutamise eesmärk:</label>\n                    <textarea name=\"description\" className=\"form-control\" id=\"dataUsage\" rows={3} />\n                    <small id=\"dataUsageHelp\" className=\"form-text text-muted\">Andmesubjekti andmete töötlemise eesmärk. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"services\">Kasutatavad teenused:</label>\n                      <select name=\"services\"\n                          className=\"custom-select\"\n                          multiple\n                          id=\"services\"\n                          value={ sdrefs.map(s => JSON.stringify(s)) }\n                          onChange={ () => { /* nop. use X button and adding. */ } }\n                      >\n                          {\n                              sdrefs.map(sdref => (\n                                  <option \n                                      key={ JSON.stringify(sdref) }\n                                      value={ JSON.stringify(sdref) }\n                                  >\n                                          {sdref.serviceProviderId} {sdref.serviceDeclarationId}\n                                  </option>\n                              ))\n                          }\n                    </select>\n                    <input name=\"_spId\" placeholder=\"teenusepakkuja id\" size={10}/>\n                    <input name=\"_sdId\" placeholder=\"teenuse deklaratsiooni id\" size={10}/>\n                    <button className=\"btn-sm\" onClick={ev => addSDRef(ev, sdrefs, setSDRefs)}>+</button>\n                    <button className=\"btn-sm\" onClick={ev => { ev.preventDefault(); setSDRefs([]); }} title={ t('clear') }>X</button>\n                  </div>\n                </div>\n              </div>\n            </Modal.Body>\n            <Modal.Footer>\n              <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n              <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text={ t('declare') } message={declarePurpose()}/>\n            </Modal.Footer>\n        </form>\n        </Modal>\n        <Button variant=\"dark\" onClick={handleShow}>\n            {t('declare')}\n        </Button>\n        </>\n    )\n}\n\n/*\nfunction countConsentRefs(cis: ClientPS): number {\n    let out : number = 0;\n    Object.keys(cis.mem.db.consentRefByUser).forEach(\n        k => { out += Object.keys(cis.mem.db.consentRefByUser[k]).filter(\n            pd => !!(cis.mem.db.consentRefByUser[k][pd])\n        ).length; }\n    );\n    return out;\n}\n*/\n\nfunction purposeView(t: any, purpose: ClientConfig, process: ClientPS, arena: any): React.ReactElement {\n    const consentRef = (process.mem.db.consentRefByUser[process.mem.ui.user!] || {})[purpose.purposeDeclarationId];\n    const consentRefDesc = (consentRef === undefined ? t('consent-ref-not-asked') : consentRef === null ? t('consent-ref-not-found') : consentRef);\n\n    const dropdownToggle = React.forwardRef<HTMLButtonElement, ButtonProps & { onClick?: any }>(({ children, onClick }, ref) => (\n      <button className=\"btn-link\" onClick={onClick} ref={ref}>{children}</button>\n    ));\n    \n  \n    const updateConsentRefDropdown = React.forwardRef<HTMLDivElement, any>(\n      ({ style, className }, ref) => {\n        return (\n          <div\n            ref={ref}\n            style={style}\n            className={className}\n          >\n            <div className=\"row no-gutters flex-nowrap\">\n              <form>\n                <div className=\"form-group\">\n                  <input type=\"text\" size={6} className=\"form-control\" name=\"consentReference\"/>\n                   <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1 dropdown-close\" \n                    owner={process} arena={arena} \n                    message={updateConsentRefInCache({\n                      purposeDeclarationId: purpose.purposeDeclarationId\n                    })} text=\"Set\"/>\n                </div>\n              </form>\n            </div>\n          </div>\n        );\n      },\n    );\n\n    return (\n        <span className=\"card small mt-2\" key={purpose.purposeDeclarationId}>\n            <div className=\"w-100 row no-gutters p-1 align-items-center\">\n                <div className=\"col-auto flex-fill\"> \n                        { t(\"service\", purpose.purposeDeclarationId, \"name\") }<br/>\n                        { t('consent-ref') }\n                          <Dropdown className=\"d-inline-block\">\n                            <Dropdown.Toggle as={dropdownToggle} id={`consentref-update-dropdown-${purpose.purposeDeclarationId}`}>{ consentRefDesc }</Dropdown.Toggle>\n                            <Dropdown.Menu as={updateConsentRefDropdown}/>\n                          </Dropdown>\n                </div>\n                <div className=\"col-auto\">\n                    <SimpleSend className=\"btn btn-sm btn-outline-secondary\" owner={process} arena={arena} message={executeRequest({\n                        requestReference: generateRequestReference(),\n                        purposeId: purpose.purposeDeclarationId\n                    })} text=\"GO\" title=\"Tee päring kõigile selle eesmärgi teenustele\"/>\n                    <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1\" owner={process} arena={arena} message={fetchConsentReference({\n                        purposeDeclarationId: purpose.purposeDeclarationId\n                    })} text={ t('fcr') }\n                        title=\"Küsi nõusolekuviide uuesti\"\n                    />\n                    { consentRef &&\n                        <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1\" owner={process} arena={arena} message={validateConsentRef({\n                            consentReference: consentRef\n                        })} text=\"vcr\"\n                            title=\"Valideeri nõusolekuviide nõusolekuteenuses\"\n                        />\n                    }\n                    { consentRef &&\n                        <SimpleSend className=\"btn btn-sm btn-outline-secondary ml-1\" owner={process} arena={arena} message={updateConsentRefInCache({\n                            purposeDeclarationId: purpose.purposeDeclarationId\n                        })} text=\"rcr\"\n                            title=\"Unusta see nõusolekuviide\"\n                        />\n                    }\n\n                </div>\n            </div>\n            { /*\n            \n            <table className=\"table\">\n                <tbody>\n                    { purpose.services.map(\n                        s => {\n                            const resp = findFrom((process.mem.ui.response || []), { \n                                purposeDeclarationId: purpose.purposeDeclarationId,\n                                serviceAddress: s.serviceAddress,\n                                serviceName: s.serviceName,\n                            });\n\n                            return (\n                                <tr>\n                                    <td>{ s.serviceAddress }<br/>{ s.serviceName }</td>\n                                    <td>{ resp && resp.requestReferenceId }</td>\n                                    <td>{ resp && \n                                        (resp.data === null \n                                            ? t('response-has-no-data') \n                                            : <>{ resp.data.length }{t('data-items-returned')}</>\n                                        )\n                                    }</td>\n                                    <td>\n                                        <SimpleSend \n                                            className=\"btn btn-sm\"\n                                            owner={process}\n                                            arena={arena}\n                                            message={executeRequest({\n                                                requestReference: generateRequestReference(),\n                                                purposeId: purpose.purposeDeclarationId,\n                                                serviceAddress: s.serviceAddress,\n                                                serviceName: s.serviceName,\n                                            })} text=\"GO\"\n                                            title=\"Ainult see päring\"\n                                        />\n                                    </td>\n                                </tr>\n                            )\n                        }\n                    )}\n                </tbody>\n            </table>\n\n                    */}\n        </span>\n    )\n}\n\nfunction hasUser(cis: ClientPS): boolean {\n    return cis.mem.ui.user !== undefined;\n}\n\nexport const ClientRenderer : React.FC<ClientViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({arena, process}, ...k);\n\n    /* \n    const serviceCount = Object.keys(process.mem.db.purpose).length;\n    const consentRefCount = countConsentRefs(process);\n    const responseCount = (process.mem.ui.response || []).filter(r => r.data !== null).length;\n    */\n\n    return (<div>\n        <p>{ hasUser(process) ? `${t('active-user')} : ${process.mem.ui.user}` : `${t('no-active-user')}.` }</p>\n        { /*\n        <p className=\"small\">\n            { serviceCount } { t('services-configured') }<br/> \n            { consentRefCount } { t('consent-refs-cached') }{ consentRefCount > 0 && <SimpleSend className=\"btn-link mt-2\" owner={process} arena={arena} message={dumpConsentRefCache()} text={ t('dump-consent-ref-cache') }/> }<br/>\n            { responseCount } { t('responses-cached') }{ responseCount > 0 && <SimpleSend className=\"btn-link mt-2\" owner={process} arena={arena} message={selectServiceMessage({ service: process.mem.ui.service })} text={ t('dump-response-cache') }/> }\n          \n        </p>\n         */ }\n        <div className=\"row mx-1\">\n            <EnduserUI arena={arena} process={process}/>\n            <DeclarePurposePopup arena={arena} process={process}/>\n        </div>\n        { hasUser(process) && process.mem.config.map(p => purposeView(t, p, process, arena)) } \n      </div>);\n}\n\n\n","import { ClientPS, ClientDefaultView, ClientIS, PurposeDeclarationTemplate, ClientConfig } from './types';\nimport { addRenderer } from '../Base';\nimport { ClientRenderer } from './views';\n\n// Client IS is a small information system that:\n// - has a set of purposes that need data from service providers\n// - is able to declare the purpose \n// - tracks consent refs by user and by purpose declaration id. \n// - has UI that allows a user to authenticate\n// - allows to attempt to use the service as authenticated user\n\n\nexport function createClient(name: string, consentService: string, config: ClientConfig[], decls?: PurposeDeclarationTemplate[]): ClientPS {\n    return {\n        type: ClientIS,\n        view: ClientDefaultView,\n        name: name,\n        title: name,\n        mem: {\n            ui: {},\n            db: {\n                consentServiceId: consentService,\n                consentRefByUser: {},\n                purpose: {}\n            },\n            declTemplate: decls,\n            config: config,\n        },\n        queue: []\n    }\n}\n\naddRenderer(ClientIS, ClientDefaultView, ClientRenderer);","import { ConsentServicePS, ConsentServiceDefaultView, ConsentService } from './types'\nimport { addUi, addRenderer } from '../Base';\nimport { ConsentServiceRenderer } from './views';\n\nexport function createConsentService(name: string): ConsentServicePS {\n    return {\n        type: ConsentService,\n        view: ConsentServiceDefaultView,\n        name: name,\n        title: name,\n        mem: {\n            ui: {\n                activePurposeDeclaration: {},\n            },\n            db: {\n                serviceDeclarations: [],\n                purposeDeclarations: [],\n                consents: [],\n                usageLog: [],\n            }\n        },\n        queue: [],\n    };\n}\n\naddRenderer(ConsentService, ConsentServiceDefaultView, ConsentServiceRenderer);\naddUi(ConsentService, './ui/csui/');\n","import { ConsentServicePS, ConsentServiceState } from './types';\nimport { ProcessAndArena } from '../Base';\nimport React from 'react';\nimport { UILink } from '../../components/Process';\nimport { __ } from '../../i18n';\n\nexport interface CSViewProps extends ProcessAndArena<ConsentServiceState> {\n    process: ConsentServicePS;\n}\n\nexport const ConsentServiceRenderer : React.FC<CSViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({process, arena}, ...k);\n\n    const now = (Date.now() / 1000) | 0;\n\n    return (<div>\n        <p>{ process.mem.ui.user !== undefined ? `${t('active-user')} : ${process.mem.ui.user}` : `${t('no-active-user')}.` }</p>\n        <p className=\"small\">\n            { process.mem.db.serviceDeclarations.length } { t('service-declarations')}, <br/>\n            { process.mem.db.purposeDeclarations.length } { t('purpose-declarations')}, <br/>\n            { process.mem.db.consents.filter(c => (!c.revoked && c.validFrom <= now && c.validUntil >= now)).length } { t('active-consents')}, <br/>\n            { process.mem.db.consents.length } { t('total-consents')}\n        </p>\n        <UILink process={process} arena={arena} button={true}> { t('open-end-user-view') }</UILink>\n      </div>);\n}\n\n","import React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\n\nimport { ProcessAndArena } from \"../Base\";\nimport { SimpleSend } from \"../../components/SendButton\";\n\nimport { ServiceProviderState, ServiceProviderPS, ServiceDeclarationTemplate } from \"./types\";\nimport { declareService, addData } from './messages';\nimport { __, business } from \"../../i18n\";\nimport { address2org } from \"../../util\";\n\nexport interface ServiceProviderViewProps extends ProcessAndArena<ServiceProviderState> {\n    process: ServiceProviderPS;\n}\n\nconst updateMaxDuration = (ev: any) => {\n  let f = ev.currentTarget.form!;\n  let v = f[\"consentMaxDurationSeconds\"].value = \n    (f[\"_mdValue\"].value - 0) * (f[\"_mdUnit\"].value) * 24 * 3600;\n  f[\"_mdValue\"].className = \"form-control\" + (v < 1 ? \" is-invalid\" : \"\");\n};\n\nfunction prefillServiceDeclaration(ev: any, decls?: ServiceDeclarationTemplate[]) {\n  ev.preventDefault();\n\n  let declId = ev.currentTarget.value;\n\n  let form = ev.currentTarget.form;\n  let decl = decls!.find(d => d.serviceDeclarationId! === declId);\n  if (decl === undefined) {\n    return;\n  }\n\n  form[\"name\"].value = decl.name;\n  form[\"serviceDeclarationId\"].value = decl.serviceDeclarationId;\n  form[\"technicalDescription\"].value = decl.technicalDescription;\n  form[\"description\"].value = decl.description;\n  form[\"needSignature\"].checked = decl.needSignature === true;\n  let md = decl.consentMaxDurationSeconds || (1 * 365 * 24 * 3600);\n  md = ((md / (24 * 3600)) | 0);\n  if (md > 365) {\n    form[\"_mdValue\"].value = ((md / 365) | 0);\n    form[\"_mdUnit\"].value = 365;\n  } else if (md > 30) {\n    form[\"_mdValue\"].value = ((md / 30) | 0);\n    form[\"_mdUnit\"].value = 30;\n  } else {\n    form[\"_mdValue\"].value = md;\n    form[\"_mdUnit\"].value = 1;\n  }\n\n  updateMaxDuration({ currentTarget: form[\"consentMaxDurationSeconds\"]});\n}\n\nfunction declarationPrefill(sp: ServiceProviderPS) {\n  if (sp.mem.declTemplate === undefined || sp.mem.declTemplate.length === 0) {\n    return <></>;\n  }\n\n  return (\n    <div className=\"form-group text-danger\">\n      <label htmlFor=\"prefilled\">Eeltäidetud deklaratsiooni kiirvalik</label>\n      <select className=\"form-control\" id=\"prefilled\" onChange={ ev => prefillServiceDeclaration(ev, sp.mem.declTemplate) } defaultValue=\"\">\n        <option key=\"none\" value=\"\">... vali eeltäidetud deklaratsioon ...</option>\n        {\n          sp.mem.declTemplate.map(dt => (\n            <option key={ dt.serviceDeclarationId } value={ dt.serviceDeclarationId }>{ dt.name! }</option>\n          ))\n        }\n      </select>\n    </div>\n  );\n}\n\nconst DeclareServicePopup : React.FC<ServiceProviderViewProps> = ({process, arena}) => {\n\n    const t = (...k: string[]) => __({process, arena}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n   \n      return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"xl\">\n        <Modal.Header closeButton>\n          <Modal.Title>Teenusedeklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <small>\n                    { t('service-decl-intro') }\n                  </small>\n                </div>\n              </div>\n\n              <div className=\"row border-bottom mt-4 mb-2\">\n                <div className=\"col\">\n                  <h6>{t('declarer')} { business(address2org(process.name), \"name\") } ({ address2org(process.name) })</h6>\n                  <input name=\"serviceProviderId\" type=\"hidden\" value={ address2org(process.name) } />\n                </div>\n              </div>\n\n              <div className=\"row\">\n                <div className=\"col\">\n                  { declarationPrefill(process) }\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdIdentifier\">Teenusedeklaratsiooni identifikaator:</label>\n                    <input name=\"serviceDeclarationId\" type=\"text\" className=\"form-control\" id=\"sdIdentifier\" />\n                    <small id=\"sdIdentifierHelp\" className=\"form-text text-muted\">Andmekogu poolt määratud teenusedeklaratsiooni masinloetav identifikaator.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdName\">Teenusedeklaratsiooni nimi:</label>\n                    <input name=\"name\" type=\"text\" className=\"form-control\" id=\"sdName\" />\n                    <small id=\"sdNameHelp\" className=\"form-text text-muted\">Teenusedeklaratsiooni identifikaator inimloetaval kujul. Soovitatavalt teenuse kood/nimi ja vajadusel alamteenuse identifikaator.</small>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdTechDescription\">Teenuse tehniline kirjeldus:</label>\n                    <textarea name=\"technicalDescription\" className=\"form-control\" id=\"sdTechDescription\" rows={3} />\n                    <small id=\"sdTechDescriptionHelp\" className=\"form-text text-muted\">Teenuse ja selle osutamise tehniline kirjeldus. Kasutamiseks klientsüsteemide haldajatele</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdDescription\">Teenuse andmekoosseisu kirjeldus:</label>\n                    <textarea name=\"description\" className=\"form-control\" id=\"sdDescription\" rows={3}/>\n                    <small id=\"sdDescriptionHelp\" className=\"form-text text-muted\">Teenuse inimloetav kirjeldus. Tagastatavad andmed, teenuse sisu jne. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <input type=\"hidden\" name=\"consentMaxDurationSeconds\" value={1 * 365 * 24 * 3600 }/>\n                    <label htmlFor=\"maxDuration\">Nõusoleku maksimaalne kehtivusaeg:</label>\n                    <div className=\"form-row\">\n                      <div className=\"form-group col-md\">\n                        <input type=\"number\" size={3} className=\"form-control\" id=\"maxDuration\" name=\"_mdValue\" onChange={updateMaxDuration} defaultValue={1}/>\n                      </div>\n                      <div className=\"form-group col-md\">\n                        <select name=\"_mdUnit\" className=\"form-control input-group-append\" onChange={updateMaxDuration}>\n                          <option value={ 365 }>{ t('year') }</option>\n                          <option value={  30 }>{ t('month') }</option>\n                          <option value={   1 }>{ t('day') }</option>\n                        </select>\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"form-group\">\n                    <div className=\"form-check\">\n                      <input name=\"needSignature\" className=\"form-check-input\" type=\"checkbox\" id=\"signature\" value=\"true|false\"/>\n                      <label className=\"form-check-label\" htmlFor=\"signature\">Vajab digiallkirja?</label>\n                      <small id=\"signatureHelp\" className=\"form-text text-muted\">Märgista see väli, kui andmesubjekt peab selle teenuse andmetele nõusoleku andmisel nõusoleku digitaalselt allkirjastama.</small>\n                    </div>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>{ t('close')}</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text={ t('declare') } message={ declareService() }/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"dark\" onClick={handleShow}>\n        {t('declare')}\n      </Button>\n\n         </>\n      )\n  }\n\n\nfunction cutAt(s: string, n: number) {\n\tif (s && s.length < n) {\n\t\treturn s;\n\t}\n\n\treturn <span onClick={ev => alert(s)}>{ s.substring(0, n) + \"..\" }</span>;\n}\n\nexport const ServiceProviderRenderer : React.FC<ServiceProviderViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({process, arena}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n    const allValues : string[] = (() => {\n      let values = process.mem.services.map(s => s.returnedDatatypes).flat().concat(process.mem.db.map(r => r.type));\n      values.sort();\n      let out : string[] = [];\n      values.forEach((v) => { if (out.length === 0 || v !== out[out.length - 1]) out.push(v); });\n      return out;\n    })();\n    return (<div>\n        <p className=\"small\">\n          {/* process.mem.services.length } { t('services-defined') }<br/> //FIXME: Confusing for demo audience?*/ }\n          { process.mem.db.length } <button className=\"btn-link\" onClick={handleShow}>{ t('records-in-db') }</button>\n        </p>\n        <Modal show={show} onHide={handleClose} size=\"lg\">\n          <Modal.Header>\n            <Modal.Title>{ t('database') }: { t('title') }</Modal.Title>\n          </Modal.Header>\n          <Modal.Body>\n            <form>\n                <table className=\"table\">\n                    <thead>\n                        <tr>\n                            <th className=\"border-top-0\">id</th>\n                            <th className=\"border-top-0\">type</th>\n                            <th className=\"border-top-0\">subject</th>\n                            <th className=\"border-top-0\">data</th>\n                            <th className=\"border-top-0\"></th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                    { \n                        process.mem.db.map(r => (\n                            <tr key={ r.key }>\n                                <td>{ r.key }</td>\n                                <td>{ r.type }</td>\n                                <td>{ r.subject }</td>\n                                <td>{ cutAt(JSON.stringify(r.data, undefined, \" \"), 40) }</td>\n                                <td>\n                                    <SimpleSend arena={arena} owner={process} text=\"-\" message={\n                                        addData({ key: r.key, datatype: undefined, subject: undefined, data: undefined })\n                                    }/>\n                                </td>\n                            </tr>\n                        ))\n                    }\n                    <tr key=\"add\">\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"key\" defaultValue={ (Math.random() * 10000) | 0 }/></td>\n                        <td><input className=\"form-control\" type=\"text\" size={8} name=\"datatype\" \n                            defaultValue={ allValues.length > 0 ? allValues[0] : \"\" } /></td>\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"subject\"/></td>\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"data\"/></td>\n                        <td><SimpleSend arena={arena} owner={process} text=\"+\" message={addData()} onClick={(ev) => {\n                            let f = ev.currentTarget.form;\n                            f.key.value = (Math.random() * 10000) | 0;\n                            f.datatype.value = \"\";\n                            f.subject.value = \"\";\n                            f.data.value = \"\";\n                        }} /></td>\n                    </tr>\n                    </tbody>\n                </table>\n            </form>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>{ t('close') }</Button>\n          </Modal.Footer>\n        </Modal>\n        <DeclareServicePopup arena={arena} process={process}/>\n      </div>);\n}\n\n","import { ServiceConfig, ServiceProviderPS, ServiceProviderDefaultView, ServiceProviderIS, SecretRecord, ServiceDeclarationTemplate } from \"./types\";\nimport { addRenderer } from \"../Base\";\nimport { ServiceProviderRenderer } from \"./views\";\n\n\nexport function createServiceProvider(name: string, title: string, config: ServiceConfig[], db?: SecretRecord[], decls?: ServiceDeclarationTemplate[]): ServiceProviderPS {\n    return {\n        type: ServiceProviderIS,\n        view: ServiceProviderDefaultView,\n        name: name,\n        title: title,\n        mem: {\n            db: db === undefined ? [] : db,\n            services: config,\n            inflight: [],\n            declTemplate: decls,\n        },\n        queue: []\n    };\n}\n\naddRenderer(ServiceProviderIS, ServiceProviderDefaultView, ServiceProviderRenderer);\n","import { createCounter } from \"./process/Counter\";\nimport { createTokenNode } from \"./process/TokenRing\";\nimport { ProcessState } from \"./process/Base\";\nimport { createArena } from \"./components/Arena\";\nimport { fromArray } from \"./byNameStore\";\nimport { TheatreState } from \"./components/Theatre\";\nimport { createClient } from \"./process/client/constructor\";\nimport { createConsentService } from \"./process/consentService/constructor\";\nimport { createServiceProvider } from \"./process/serviceProvider/constructor\";\nimport { SecretRecord } from \"./process/serviceProvider/types\";\nimport { LogRendererMap, consentRefApiLogRenderers, addLogRenderers } from \"./components/LogRows\";\n\n// initial configuration\n\ntype ConfigType = { \n    defaultArena: string;\n    arenas: { [name: string]: { processes: ProcessState<any>[]; logRenderers?: LogRendererMap }; }\n};\n\n\nconst CS1Address = \"EE/GOV/70009770/nt\";\n\nconst config : ConfigType = {\n    defaultArena: \"demo\",\n    // arenas: arena -> [process]\n    arenas: {\n        \"demo\": {\n            processes: [\n                createClient(\"EE/COM/10112345/healthstartup\", CS1Address, [ // client configuration\n                    { // vaktsineerimise meeldetuletused\n                        purposeDeclarationId: \"tervisepaevik_vaktsineerimised\",\n                        services: [\n                            {\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.282\",\n                            }\n                        ]\n                    },\n                    { // terviseandmete visualiseerimine\n                        purposeDeclarationId: \"tervisepaevik_visualiseerimine\",\n                        services: [\n                            { // diagnoosid\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.32\",\n                            },\n                            { // uuringud\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.35\",\n                            }\n                        ]\n                    }\n                ], [ // prefilled service declaration templates\n                    {\n                        purposeDeclarationId: \"tervisepaevik_visualiseerimine\",\n                        name: \"Terviseandmete visualiseerimine\",\n                        description: \"HealthStartup diagnooside ja uuringute tulemuste visualiseerimist pakkuv teenus.\\n\\n\" +\n                            \"Nõusoleku tagasivõtmisel kustutab HealthStartup kõik Sinu kohta saadud andmed.\",\n                        services: [\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_diagnoosid\" },\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_uuringud\" }\n                        ]\n                    },\n                    {\n                        purposeDeclarationId: \"tervisepaevik_vaktsineerimised\",\n                        name: \"Vaktsineerimiste meeldetuletused\",\n                        description: \"HealthStartup vaktsineerimiste meeldetuletusi ja immuniseerimisplaani pakkuv teenus.\\n\\n\" +\n                           \"Nõusoleku tagasivõtmisel kustutab HealthStartup kõik Sinu kohta saadud andmed.\",\n                        services: [\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_immuniseerimispass\" }\n                        ]\n                    }\n                ]),\n            \n                createServiceProvider(\"EE/GOV/70009770/digilugu\", \"Tervise Infosüsteem\", [ // services\n                    { // immuniseerimispassi teenus\n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.282\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_immuniseerimispass\" ],\n                        returnedDatatypes: [ \"immuniseerimine\" ]\n                    },\n                    { // uuringute päringu teenus\n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.35\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_uuringud\" ],\n                        returnedDatatypes: [ \"uuring\" ]\n                    },\n                    { // \n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.32\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_diagnoosid\" ],\n                        returnedDatatypes: [ \"diagnoos\" ],\n                    }\n                ], [ // secret data\n                    createData(\"01234567890\", \"diagnoos\", { diagnoos: \"A01\", arst: \"D03677\" }),\n\t\t    createData(\"12345678901\", \"diagnoos\", { diagnoos: \"J01\", arst: \"D08031\"}),\n\t\t\tcreateData(\"47302200234\", \"diagnoos\", \n{\n   \"templateId\": {\n      \"@root\": \"1.3.6.1.4.1.28284.6.1.1\",\n      \"@extension\": \"1.3.6.1.4.1.28284.6.1.1.37.3\"\n   },\n   \"id\": {\n      \"@root\": \"1.3.6.1.4.1.28284.6.2.4.14\",\n      \"@extension\": \"EHR.3570338\"\n   },\n   \"creationTime\": {\n      \"@value\": \"20191127131137\"\n   },\n   \"versionCode\": {\n      \"@code\": \"V3-2007-09\"\n   },\n   \"interactionId\": {\n      \"@root\": \"2.16.840.1.113883\",\n      \"@extension\": \"RCMR_IN000030UV01\"\n   },\n   \"processingCode\": {\n      \"@code\": \"P\"\n   },\n   \"processingModeCode\": {\n      \"@code\": \"T\"\n   },\n   \"acceptAckCode\": {\n      \"@code\": \"NE\"\n   },\n   \"receiver\": {\n      \"@typeCode\": \"RCV\",\n      \"device\": {\n         \"@classCode\": \"DEV\",\n         \"@determinerCode\": \"INSTANCE\",\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.8.7.2.5\",\n            \"@extension\": \"Tallinn\"\n         }\n      }\n   },\n   \"sender\": {\n      \"@typeCode\": \"SND\",\n      \"device\": {\n         \"@classCode\": \"DEV\",\n         \"@determinerCode\": \"INSTANCE\",\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.6.2.2.18.2\",\n            \"@extension\": \"TL\"\n         }\n      }\n   },\n   \"acknowledgement\": {\n      \"typeCode\": {\n         \"@code\": \"AA\"\n      },\n      \"targetMessage\": {\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.8.7\",\n            \"@extension\": \"1.3.6.1.4.1.28284.8.7_637104570979090003\"\n         }\n      }\n   },\n   \"controlActProcess\": {\n      \"@moodCode\": \"EVN\",\n      \"@type\": \"ext:RCMR_IN000030UV01_Extension.ControlActProcess\",\n      \"@HL7-Domain\": \"QUQI_DM000000UV\",\n      \"@realmCode\": \"EE\",\n      \"subject\": {\n         \"clinicalDocument\": {\n            \"@type\": \"ext:RCMR_MT000001UV_Extension.ClinicalDocument\",\n            \"templateId\": {\n               \"@root\": \"1.3.6.1.4.1.28284.6.1.1\",\n               \"@extension\": \"1.3.6.1.4.1.28284.6.1.1.5.8\"\n            },\n            \"id\": {\n               \"@root\": \"1.3.6.1.4.1.28284.8.7.2.2.3\",\n               \"@extension\": \"11356823.S140.1\"\n            },\n            \"code\": {\n               \"@code\": \"2\",\n               \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.3.1\",\n               \"@codeSystemName\": \"Dokumendi tüüp\",\n               \"@displayName\": \"Ambulatoorne epikriis\"\n            },\n            \"statusCode\": {\n               \"@code\": \"completed\"\n            },\n            \"effectiveTime\": {\n               \"@value\": \"20191127131059\"\n            },\n            \"confidentialityCode\": {\n               \"@code\": \"N\",\n               \"@codeSystem\": \"2.16.840.1.113883.5.25\",\n               \"@codeSystemName\": \"Konfidentsiaalsus\",\n               \"@displayName\": \"avatud\",\n               \"translation\": [\n                  {\n                     \"@code\": \"N\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.39.1\",\n                     \"@codeSystemName\": \"Konfidentsiaalsus arstile\",\n                     \"@displayName\": \"avatud\"\n                  },\n                  {\n                     \"@code\": \"N\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.37.1\",\n                     \"@codeSystemName\": \"Konfidentsiaalsus eestkostjale\",\n                     \"@displayName\": \"avatud\"\n                  }\n               ]\n            },\n            \"languageCode\": {\n               \"@code\": \"EST\"\n            },\n            \"setId\": {\n               \"@root\": \"1.3.6.1.4.1.28284.8.7.2.1\",\n               \"@extension\": \"140.1\"\n            },\n            \"versionNumber\": {\n               \"@value\": \"1\"\n            },\n            \"recordTarget\": {\n               \"@typeCode\": \"RCT\",\n               \"realmCode\": {\n                  \"@code\": \"PAT\"\n               },\n               \"patient\": {\n                  \"@classCode\": \"PAT\",\n                  \"id\": {\n                     \"@root\": \"1.3.6.1.4.1.28284.6.2.2.16.1\",\n                     \"@extension\": \"47302200234\"\n                  },\n                  \"statusCode\": {\n                     \"@code\": \"A\"\n                  },\n                  \"patientPerson\": {\n                     \"@classCode\": \"PSN\",\n                     \"name\": {\n                        \"given\": \"MARI-LIIS\",\n                        \"family\": \"MÄNNIK\"\n                     }\n                  }\n               }\n            },\n            \"author\": {\n               \"@typeCode\": \"AUT\",\n               \"time\": {\n                  \"@value\": \"20191127131059\"\n               },\n               \"assignedAuthor\": {\n                  \"@classCode\": \"ASSIGNED\",\n                  \"@type\": \"ext:RCMR_MT000001UV_Extension.COCT_MT090000UV.AssignedEntity\",\n                  \"id\": {\n                     \"@root\": \"1.3.6.1.4.1.28284.6.2.4.9\",\n                     \"@extension\": \"D04220\"\n                  },\n                  \"code\": {\n                     \"@code\": \"DOCTOR\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.15.1\",\n                     \"@codeSystemName\": \"Tervishoiutöötaja tüüp\",\n                     \"@displayName\": \"arst\"\n                  },\n                  \"assignedPerson\": {\n                     \"@classCode\": \"PSN\",\n                     \"@determinerCode\": \"INSTANCE\",\n                     \"name\": {\n                        \"given\": \"MARI-LIIS\",\n                        \"family\": \"MÄNNIK\"\n                     }\n                  },\n                  \"asLicencedEntity\": {\n                     \"id\": {\n                        \"@root\": \"1.3.6.1.4.1.28284.6.2.1.4.2\",\n                        \"@extension\": \"E420\",\n                        \"@assigningAuthorityName\": \"üldkirurgia\"\n                     }\n                  }\n               }\n            },\n            \"componentOf\": {\n               \"encompassingEncounter\": {\n                  \"@classCode\": \"ENC\",\n                  \"@moodCode\": \"EVN\",\n                  \"id\": {\n                     \"@root\": \"1.3.6.1.4.1.28284.8.7.2.1\",\n                     \"@extension\": \"140.1\"\n                  },\n                  \"code\": {\n                     \"@code\": \"AMB\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.5.1\",\n                     \"@codeSystemName\": \"Haigusjuhtumi tüüp\",\n                     \"@displayName\": \"Ambulatoorne haigusjuht\"\n                  },\n                  \"effectiveTime\": {\n                     \"low\": {\n                        \"@value\": \"20191127131033\"\n                     },\n                     \"high\": {\n                        \"@value\": \"20191127131033\"\n                     }\n                  }\n               }\n            },\n            \"sourceOf\": {\n               \"@typeCode\": \"XCERPT\",\n               \"observation\": {\n                  \"@classCode\": \"OBS\",\n                  \"@moodCode\": \"EVN\",\n                  \"code\": {\n                     \"@code\": \"DGN\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.5.1\",\n                     \"@codeSystemName\": \"Observation liik\",\n                     \"@displayName\": \"Diagnoos\"\n                  },\n                  \"statusCode\": {\n                     \"@code\": \"completed\"\n                  },\n                  \"value\": {\n                     \"@code\": \"F02.2\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.13.3\",\n                     \"@codeSystemName\": \"RHK-10\",\n                     \"@displayName\": \"Dementsus Huntingtoni tõvest\",\n                     \"@type\": \"CD\",\n                     \"originalText\": null,\n                     \"qualifier\": {\n                        \"value\": {\n                           \"@code\": \"1\",\n                           \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.1.2\",\n                           \"@codeSystemName\": \"Diagnoosi statistiline liik\",\n                           \"@displayName\": \"esmajuhtum\"\n                        }\n                     }\n                  },\n                  \"interpretationCode\": {\n                     \"@code\": \"MAIN\",\n                     \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.2.1\",\n                     \"@codeSystemName\": \"Diagnoosi liik\",\n                     \"@displayName\": \"Põhihaigus\"\n                  }\n               }\n            }\n         }\n      },\n      \"queryAck\": {\n         \"queryId\": {\n            \"@root\": \"1.3.6.1.4.1.28284.8.7.2.7\",\n            \"@extension\": \"1.3.6.1.4.1.28284.8.7_637104570979090003\"\n         },\n         \"queryResponseCode\": {\n            \"@code\": \"OK\"\n         },\n         \"resultTotalQuantity\": {\n            \"@value\": \"1\"\n         }\n      },\n      \"queryByParameter\": {\n         \"@type\": \"ext:RCMR_MT000003UV_Extension.QueryByParameter\",\n         \"@HL7-Domain\": \"RCMR_RM000000\",\n         \"@realmCode\": \"EE\",\n         \"queryId\": {\n            \"@root\": \"1.3.6.1.4.1.28284.8.7.2.7\",\n            \"@extension\": \"1.3.6.1.4.1.28284.8.7_637104570979090003\"\n         },\n         \"patient.id\": {\n            \"value\": {\n               \"@root\": \"1.3.6.1.4.1.28284.6.2.2.16.1\",\n               \"@extension\": \"47302200234\"\n            }\n         },\n         \"serviceEvent.code\": {\n            \"value\": {\n               \"@code\": \"diagnosis\",\n               \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.32.2\"\n            }\n         },\n         \"observation.effectiveTime\": {\n            \"value\": {\n               \"low\": {\n                  \"@value\": \"20161127000000\"\n               },\n               \"high\": {\n                  \"@value\": \"20191128235959\"\n               }\n            }\n         }\n      }\n   }\n}\n\t\t    ),\n\t\t\tcreateData(\"47302200234\", \"uuring\",\n{\n   \"templateId\": {\n      \"@root\": \"1.3.6.1.4.1.28284.6.1.1\",\n      \"@extension\": \"1.3.6.1.4.1.28284.6.1.1.40.9\"\n   },\n   \"id\": {\n      \"@root\": \"1.3.6.1.4.1.28284.6.2.4.14\",\n      \"@extension\": \"EHR.3572157\"\n   },\n   \"creationTime\": {\n      \"@value\": \"20191129133942\"\n   },\n   \"versionCode\": {\n      \"@code\": \"V3-2007-09\"\n   },\n   \"interactionId\": {\n      \"@root\": \"2.16.840.1.113883\",\n      \"@extension\": \"RCMR_IN000030UV01\"\n   },\n   \"processingCode\": {\n      \"@code\": \"P\"\n   },\n   \"processingModeCode\": {\n      \"@code\": \"T\"\n   },\n   \"acceptAckCode\": {\n      \"@code\": \"NE\"\n   },\n   \"receiver\": {\n      \"@typeCode\": \"RCV\",\n      \"device\": {\n         \"@classCode\": \"DEV\",\n         \"@determinerCode\": \"INSTANCE\",\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.1.26.2.5\"\n         }\n      }\n   },\n   \"sender\": {\n      \"@typeCode\": \"SND\",\n      \"device\": {\n         \"@classCode\": \"DEV\",\n         \"@determinerCode\": \"INSTANCE\",\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.6.2.2.18.2\",\n            \"@extension\": \"TL\"\n         }\n      }\n   },\n   \"acknowledgement\": {\n      \"typeCode\": {\n         \"@code\": \"AA\"\n      },\n      \"targetMessage\": {\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.1.26.2.7\",\n            \"@extension\": \"SonumID\"\n         }\n      }\n   },\n   \"controlActProcess\": {\n      \"@moodCode\": \"EVN\",\n      \"@type\": \"ext:RCMR_IN000030UV01_Extension.ControlActProcess\",\n      \"@HL7-Domain\": \"QUQI_DM000000UV\",\n      \"@realmCode\": \"EE\",\n      \"subject\": [\n         {\n            \"clinicalDocument\": {\n               \"@type\": \"ext:RCMR_MT000001UV_Extension.ClinicalDocument\",\n               \"templateId\": {\n                  \"@root\": \"1.3.6.1.4.1.28284.6.1.1\",\n                  \"@extension\": \"1.3.6.1.4.1.28284.6.1.1.64.8\"\n               },\n               \"id\": {\n                  \"@root\": \"1.3.6.1.4.1.3516.13.1.2.3.1.3\",\n                  \"@extension\": \"1866393\"\n               },\n               \"code\": {\n                  \"@code\": \"64\",\n                  \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.3.9\",\n                  \"@codeSystemName\": \"Dokumendi tüüp\",\n                  \"@displayName\": \"saatekirja vastus\"\n               },\n               \"statusCode\": {\n                  \"@code\": \"completed\"\n               },\n               \"effectiveTime\": {\n                  \"@value\": \"20191129130504\"\n               },\n               \"confidentialityCode\": {\n                  \"@code\": \"N\",\n                  \"@codeSystem\": \"2.16.840.1.113883.5.25\",\n                  \"@codeSystemName\": \"Konfidentsiaalsus\",\n                  \"@displayName\": \"avatud\"\n               },\n               \"languageCode\": {\n                  \"@code\": \"EST\"\n               },\n               \"setId\": {\n                  \"@root\": \"1.3.6.1.4.1.29907.1.1.6.11\",\n                  \"@extension\": \"107233297\"\n               },\n               \"versionNumber\": {\n                  \"@value\": \"1\"\n               },\n               \"recordTarget\": {\n                  \"@typeCode\": \"RCT\",\n                  \"patient\": {\n                     \"@classCode\": \"PAT\",\n                     \"id\": {\n                        \"@root\": \"1.3.6.1.4.1.28284.6.2.2.1\",\n                        \"@extension\": \"47302200234\"\n                     },\n                     \"statusCode\": {\n                        \"@code\": \"A\"\n                     },\n                     \"patientPerson\": {\n                        \"name\": {\n                           \"given\": \"MARI-LIIS\",\n                           \"family\": \"MÄNNIK\"\n                        }\n                     }\n                  }\n               },\n               \"author\": {\n                  \"@typeCode\": \"AUT\",\n                  \"time\": {\n                     \"@value\": \"20191129130504\"\n                  },\n                  \"assignedAuthor\": {\n                     \"@classCode\": \"ASSIGNED\",\n                     \"@type\": \"ext:RCMR_MT000001UV_Extension.COCT_MT090000UV.AssignedEntity\",\n                     \"id\": {\n                        \"@nullFlavor\": \"NI\"\n                     },\n                     \"representedOrganization\": {\n                        \"@classCode\": \"ORG\",\n                        \"@determinerCode\": \"INSTANCE\",\n                        \"id\": {\n                           \"@root\": \"1.3.6.1.4.1.28284.4\",\n                           \"@extension\": \"10822068\"\n                        },\n                        \"name\": \"AS Ida-Tallinna Keskhaigla\",\n                        \"addr\": {\n                           \"@use\": \"PHYS\",\n                           \"country\": \"EST\",\n                           \"county\": \"Harju maakond\",\n                           \"city\": \"Tallinn\",\n                           \"streetName\": \"Ravi\",\n                           \"houseNumber\": \"18\",\n                           \"unitID\": \"0298\",\n                           \"postalCode\": \"10138\",\n                           \"unitType\": \"EHAK\"\n                        }\n                     }\n                  }\n               },\n               \"custodian\": {\n                  \"@typeCode\": \"CST\",\n                  \"assignedCustodian\": {\n                     \"representedOrganization\": {\n                        \"id\": {\n                           \"@root\": \"1.3.6.1.4.1.28284.4\",\n                           \"@extension\": \"10822068\"\n                        },\n                        \"name\": \"AS Ida-Tallinna Keskhaigla\"\n                     }\n                  }\n               },\n               \"componentOf\": {\n                  \"encompassingEncounter\": {\n                     \"@classCode\": \"ENC\",\n                     \"@moodCode\": \"EVN\",\n                     \"id\": {\n                        \"@root\": \"1.3.6.1.4.1.29907.1.1.6.11\",\n                        \"@extension\": \"107233297\"\n                     },\n                     \"effectiveTime\": {\n                        \"@nullFlavor\": \"NI\"\n                     }\n                  }\n               },\n               \"sourceOf\": {\n                  \"@typeCode\": \"XCERPT\",\n                  \"procedure\": {\n                     \"@classCode\": \"PROC\",\n                     \"@moodCode\": \"EVN\",\n                     \"code\": {\n                        \"@code\": \"3414-0\",\n                        \"@codeSystem\": \"2.16.840.1.113883.6.1\",\n                        \"@codeSystemName\": \"ELMÜ LOINC koodistik\",\n                        \"@displayName\": \"Buprenorfiin uriinis\"\n                     },\n                     \"statusCode\": {\n                        \"@code\": \"completed\"\n                     },\n                     \"effectiveTime\": {\n                        \"@value\": \"20191129130504\"\n                     },\n                     \"specimen\": {\n                        \"id\": {\n                           \"@root\": \"Barcode\",\n                           \"@extension\": \"IP0041250068\"\n                        },\n                        \"specimenNatural\": {\n                           \"code\": {\n                              \"@code\": \"U\",\n                              \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.244.5\",\n                              \"@codeSystemName\": \"ELMÜ proovimaterjali tüüp\",\n                              \"@displayName\": \"Uriin\"\n                           }\n                        },\n                        \"participation1\": {\n                           \"process\": {\n                              \"@moodCode\": \"EVN\",\n                              \"effectiveTime\": {\n                                 \"@value\": \"20191129125700\"\n                              }\n                           }\n                        }\n                     },\n                     \"sourceOf2\": [\n                        {\n                           \"@typeCode\": \"COMP\",\n                           \"observation\": {\n                              \"@classCode\": \"OBS\",\n                              \"@moodCode\": \"EVN\",\n                              \"id\": {\n                                 \"@root\": \"1.3.6.1.4.1.3516.13.1.2.3.1.5\",\n                                 \"@extension\": \"30591836\"\n                              },\n                              \"code\": {\n                                 \"@code\": \"ANA\",\n                                 \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.5.1\",\n                                 \"@codeSystemName\": \"Observation liik\",\n                                 \"@displayName\": \"Analüüs\"\n                              },\n                              \"value\": {\n                                 \"@type\": \"CD\",\n                                 \"@code\": \"N\",\n                                 \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.266.3\",\n                                 \"@codeSystemName\": \"Kvalitatiivse uuringu vastus\",\n                                 \"@displayName\": \"negatiivne\"\n                              },\n                              \"interpretationCode\": {\n                                 \"@code\": \"N\",\n                                 \"originalText\": null\n                              },\n                              \"referenceRange\": {\n                                 \"@typeCode\": \"REFV\",\n                                 \"observationRange\": {\n                                    \"value\": {\n                                       \"@type\": \"ED\",\n                                       \"#text\": \"negatiivne\"\n                                    },\n                                    \"interpretationCode\": {\n                                       \"@code\": \"N\"\n                                    }\n                                 }\n                              }\n                           }\n                        },\n                        {\n                           \"@typeCode\": \"COMP\",\n                           \"procedure\": {\n                              \"@classCode\": \"PROC\",\n                              \"@moodCode\": \"EVN\",\n                              \"code\": {\n                                 \"@code\": \"L-4888\",\n                                 \"@codeSystem\": \"2.16.840.1.113883.6.1\",\n                                 \"@codeSystemName\": \"ELMÜ LOINC koodistik\",\n                                 \"@displayName\": \"Nõusolek lisauuringuks\"\n                              },\n                              \"statusCode\": {\n                                 \"@code\": \"completed\"\n                              },\n                              \"specimen\": {\n                                 \"id\": {\n                                    \"@root\": \"Barcode\",\n                                    \"@extension\": \"IP0041250068\"\n                                 },\n                                 \"specimenNatural\": {\n                                    \"code\": {\n                                       \"@code\": \"U\",\n                                       \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.244.5\",\n                                       \"@codeSystemName\": \"ELMÜ proovimaterjali tüüp\",\n                                       \"@displayName\": \"Uriin\"\n                                    }\n                                 },\n                                 \"participation1\": {\n                                    \"process\": {\n                                       \"@moodCode\": \"EVN\",\n                                       \"effectiveTime\": {\n                                          \"@value\": \"20191129125700\"\n                                       }\n                                    }\n                                 }\n                              },\n                              \"sourceOf2\": {\n                                 \"@typeCode\": \"COMP\",\n                                 \"observation\": {\n                                    \"@classCode\": \"OBS\",\n                                    \"@moodCode\": \"EVN\",\n                                    \"id\": {\n                                       \"@root\": \"1.3.6.1.4.1.3516.13.1.2.3.1.5\",\n                                       \"@extension\": \"30591834\"\n                                    },\n                                    \"code\": {\n                                       \"@code\": \"ANA\",\n                                       \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.5.1\",\n                                       \"@codeSystemName\": \"Observation liik\",\n                                       \"@displayName\": \"Analüüs\"\n                                    },\n                                    \"value\": {\n                                       \"@type\": \"ED\",\n                                       \"#text\": \"JAH\"\n                                    },\n                                    \"interpretationCode\": {\n                                       \"@code\": \"N\",\n                                       \"originalText\": null\n                                    }\n                                 }\n                              }\n                           }\n                        }\n                     ]\n                  }\n               }\n            }\n         }\n      ],\n      \"queryAck\": {\n         \"queryId\": {\n            \"@root\": \"1.3.6.1.4.1.28284.1.26.2.8\",\n            \"@extension\": \"ParinguID\"\n         },\n         \"queryResponseCode\": {\n            \"@code\": \"OK\"\n         },\n         \"resultTotalQuantity\": {\n            \"@value\": \"283\"\n         }\n      },\n      \"queryByParameter\": {\n         \"@type\": \"ext:RCMR_MT000003UV_Extension.QueryByParameter\",\n         \"@HL7-Domain\": \"RCMR_RM000000\",\n         \"@realmCode\": \"EE\",\n         \"queryId\": {\n            \"@root\": \"1.3.6.1.4.1.28284.1.26.2.8\",\n            \"@extension\": \"ParinguID\"\n         },\n         \"patient.id\": {\n            \"value\": {\n               \"@root\": \"1.3.6.1.4.1.28284.6.2.2.1\",\n               \"@extension\": \"47302200234\"\n            }\n         },\n         \"serviceEvent.code\": {\n            \"value\": {\n               \"@code\": \"procedures\",\n               \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.32.10\"\n            }\n         },\n         \"procedure.effectiveTime\": {\n            \"value\": {\n               \"low\": {\n                  \"@value\": \"20190101\"\n               },\n               \"high\": {\n                  \"@value\": \"20191129\"\n               }\n            }\n         }\n      },\n      \"queryContinuation\": {\n         \"startResultNumber\": {\n            \"@value\": \"1\"\n         },\n         \"continuationQuantity\": {\n            \"@value\": \"15\"\n         },\n         \"statusCode\": {\n            \"@code\": \"deliveredResponse\"\n         }\n      }\n   }\n}\n\t\t\t),\n\t\t\tcreateData(\"47302200234\", \"immuniseerimine\", \n\t\t\t\t\n{\n   \"typeId\": {\n      \"@root\": \"2.16.840.1.113883.1.3\",\n      \"@extension\": \"POCD_HD000040\"\n   },\n   \"templateId\": {\n      \"@root\": \"1.3.6.1.4.1.28284.6.1.1\",\n      \"@extension\": \"1.3.6.1.4.1.28284.6.1.1.281.1\"\n   },\n   \"id\": {\n      \"@root\": \"1.3.6.1.4.1.28284.6.2.4.96\",\n      \"@extension\": \"db923307-d53c-4c07-bab3-144afa974d1c\"\n   },\n   \"code\": {\n      \"@code\": \"83\",\n      \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.1.3.5\",\n      \"@codeSystemName\": \"Dokumendi tüüp\",\n      \"@displayName\": \"Immuniseerimispass\"\n   },\n   \"title\": \"Immuniseerimispass\",\n   \"effectiveTime\": {\n      \"@value\": \"20191126134144\"\n   },\n   \"confidentialityCode\": {\n      \"@code\": \"N\",\n      \"@codeSystem\": \"2.16.840.1.113883.5.25\",\n      \"@codeSystemName\": \"Konfidentsiaalsus\",\n      \"@displayName\": \"avatud\"\n   },\n   \"languageCode\": {\n      \"@code\": \"EST\"\n   },\n   \"versionNumber\": {\n      \"@value\": \"1\"\n   },\n   \"recordTarget\": {\n      \"@typeCode\": \"RCT\",\n      \"realmCode\": {\n         \"@code\": \"PAT\"\n      },\n      \"patientRole\": {\n         \"@classCode\": \"PAT\",\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.6.2.2.1\",\n            \"@extension\": \"47302200234\"\n         },\n         \"patient\": {\n            \"@classCode\": \"PSN\",\n            \"@determinerCode\": \"INSTANCE\",\n            \"name\": {\n               \"given\": \"MARI-LIIS\",\n               \"family\": \"MÄNNIK\"\n            }\n         }\n      }\n   },\n   \"author\": {\n      \"@typeCode\": \"AUT\",\n      \"time\": {\n         \"@value\": \"20191126134144\"\n      },\n      \"assignedAuthor\": {\n         \"@classCode\": \"ASSIGNED\",\n         \"id\": {\n            \"@root\": \"1.3.6.1.4.1.28284.6.2.4.32\",\n            \"@extension\": \"DL\"\n         },\n         \"representedOrganization\": {\n            \"@classCode\": \"ORG\",\n            \"@determinerCode\": \"INSTANCE\",\n            \"id\": {\n               \"@root\": \"1.3.6.1.4.1.28284.6.2.4.32\",\n               \"@extension\": \"DL\"\n            },\n            \"name\": \"Tervise ja Heaolu Infosüsteemide Keskus\"\n         }\n      }\n   },\n   \"custodian\": {\n      \"@typeCode\": \"CST\",\n      \"assignedCustodian\": {\n         \"representedCustodianOrganization\": {\n            \"id\": {\n               \"@root\": \"1.3.6.1.4.1.28284.6.2.4.32\",\n               \"@extension\": \"DL\"\n            },\n            \"name\": \"Tervise infosüsteem\"\n         }\n      }\n   },\n   \"component\": {\n      \"@typeCode\": \"COMP\",\n      \"structuredBody\": {\n         \"@classCode\": \"DOCBODY\",\n         \"@moodCode\": \"EVN\",\n         \"component\": {\n            \"@typeCode\": \"COMP\",\n            \"section\": {\n               \"@classCode\": \"DOCSECT\",\n               \"@moodCode\": \"EVN\",\n               \"code\": {\n                  \"@code\": \"IMM\",\n                  \"@codeSystem\": \"1.3.6.1.4.1.28284.6.2.2.11.6\",\n                  \"@codeSystemName\": \"Sektsiooni kodeering\",\n                  \"@displayName\": \"Immuniseerimine\"\n               },\n               \"title\": \"Immuniseerimine\",\n               \"text\": {\n                  \"paragraph\": [\n                     {\n                        \"content\": {\n\t\t\t\t\t\t\t\"Immuniseerimine\": \"01.08.2008\",\n\t\t\t\t\t\t\t\"Mille vastu\": \"Tuberkuloos\",\n\t\t\t\t\t\t\t\"Vaktsiin\": \"\",\n\t\t\t\t\t\t\t\"Partii\": \"ABS&<32413\",\n\t\t\t\t\t\t\t\"ATC\": \"J07AN01, BCG VACCINE SSI\",\n\t\t\t\t\t\t\t\"Annus\": \"400 mg\",\n\t\t\t\t\t\t\t\"Annuse kordsus\": \"\",\n\t\t\t\t\t\t\t\"Immuniseerija\": \"Tatjana Katjuk, kood D06176\",\n\t\t\t\t\t\t\t\"Järgmine immuniseerimine\":\"\",\n\t\t\t\t\t\t\t\"Allikas\":\"\",\n\t\t\t\t\t\t\t\"Kuupäev\":\"05.08.2008 11:23:45\",\n\t\t\t\t\t\t\t\"Tervishoiutöötaja\":\"Ants Kass, kood D02488\",\n\t\t\t\t\t\t\t\"Asutus\":\"90006399 SA Põhja-Eesti Regionaalhaigla\",\n\t\t\t\t\t\t\t\"Dokumendi number\": \"27122016_0\",\n\t\t\t\t\t\t\t\"Dokumendi tüüp\": \"Ambulatoorne epikriis\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n                  }\n               }\n            }\n         }\n      }\n   }\n\t\t\t),\n\n                ], [ // prefilled service declaration templates\n                    {\n                        serviceDeclarationId: \"hl7_uuringud\",\n                        name: \"Uuringute päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.35\",\n                        description: \"Andmekogule saadetakse päringu parameetrina Sinu isikukood.\\n\\n\" +\n                            \"Andmekogust Tervise Infosüsteem saadakse iga Sinu uuringu kohta järgmised andmed:\\n\" +\n                            \"  * Sinu andmed: nimi ja isikukood:\\n\" +\n                            \"  * Uuringu andmed:\\n\" +\n                            \"    * Uuringu tegemise aeg ja koht (raviasutus)\\n\" +\n                            \"    * Proovimaterjali tüüp\\n\" +\n                            \"    * Uuringu tüüp\\n\" +\n                            \"    * Uuringu vastus\\n\" +\n                            \"  * Uuringu teostanud tervishoiutöötaja andmed: nimi, kood ja tervishoiuasutuse andmed\",\n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    {\n                        serviceDeclarationId: \"hl7_diagnoosid\",\n                        name: \"Diagnooside päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.32\",\n                        description: \"Andmekogust Tervise Infosüsteem saadakse iga Sinu diagnoosi kohta järgmised andmed:\\n\" +\n                            \"  * Sinu andmed: nimi ja isikukood\\n\" +\n                            \"  * Haigusjuhtumi andmed: diagnoosi andmise aeg, diagnoos\\n\" +\n                            \"  * Diagnoosi andnud tervishoiutöötaja andmed: nimi, kood ja tervishoiuasutuse andmed\",\n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    {\n                        serviceDeclarationId: \"hl7_immuniseerimispass\",\n                        name: \"Immuniseerimispassi päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.282\",\n                        description: \"Andmekogust Tervise Infosüsteem saadakse iga Sinu immuniseerimise kohta järgmised andmed:\\n\" +\n                        \"  * Sinu andmed: nimi ja isikukood\\n\" +\n                        \"  * Immuniseerimise andmed:\\n\" +\n                        \"    * Haigus mille vastu immuniseeriti\\n\" +\n                        \"    * Immuniseerimise kuupäev\\n\" +\n                        \"    * Immuunpreparaadi nimi, partii number ja manustatud annus\\n\" +\n                        \"    * Mitmes annus\\n\" +\n                        \"    * Järgmine immuniseerimise varaseim kuupäev\\n\" +\n                        \"  * Immuniseerija andmed: nimi, kood ja tervishoiuasutuse andmed\", \n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    \n                ]),\n\n                createConsentService(\"EE/GOV/70009770/nt\"),\n            ],\n            logRenderers: {\n                ...consentRefApiLogRenderers\n            },\n        },\n\n\n        \"singleCounter\": { processes: [\n          createCounter(\"counter1\"),\n        ]},\n\n        \"tokenRing\": { processes: [\n          createTokenNode(\"sd.title\", \"a\", \"b\"),\n          createTokenNode(\"pd.title\", \"b\", \"c\"),\n          createTokenNode(\"ca.title\", \"c\", \"c\"),\n        ]}\n    }\n};\n\nexport function createData(subjectId: string, type: string, data: any): SecretRecord {\n    return {\n        key: \"\" + ((Math.random() * 10000) | 0),\n        type: type,\n        subject: subjectId,\n        data: data\n    };\n}\n\n\n\nexport function initialTheatre(): TheatreState {\n    return {\n        name: \"theatre\",\n        arenas: fromArray(Object.keys(config.arenas).map(a => createArena(a, config.arenas[a].processes))),\n        active: config.defaultArena,\n    }\n}\n\nObject.keys(config.arenas).forEach(arena => {\n    if (config.arenas[arena].logRenderers !== undefined) {\n        addLogRenderers(arena, config.arenas[arena].logRenderers!);\n    }\n})\n","import React from 'react';\nimport { connect } from 'react-redux';\n\nimport { ArenaState, Arena, reduceArena, ArenaActionType } from './Arena';\nimport { AppState } from '../store';\nimport { ByNameStore, reduceByName } from '../byNameStore';\nimport { initialTheatre } from '../config';\nimport { AnyAction } from 'redux';\n\ntype Arenas = ByNameStore<ArenaState>;\n\nexport interface TheatreState {\n    name: string;\n    arenas: Arenas;\n    active: string;\n}\n\nexport function selectArena(state: AppState, arena: string) {\n    return state.theatre.arenas.byName[arena];\n}\n\nconst SELECT_ARENA = \"Theatre/SELECT_ARENA\";\ninterface SelectArenaAction extends AnyAction {\n    type: typeof SELECT_ARENA;\n    arena: string;\n}\n\n// function selectArenaMessage(arena: string): SelectArenaAction {\n//     return { type: SELECT_ARENA, arena: arena };\n// }\n\nexport function reduceTheatre(state: TheatreState = initialTheatre(), action: any): TheatreState {\n    switch (action.type) {\n        case SELECT_ARENA:\n            return ({ ...state, active: action.arena });\n        default:\n            return ({ ...state, arenas: reduceByName(state.arenas, (a) => reduceArena(a, action as ArenaActionType)) });\n        }\n}\n\ninterface TheatreProps {\n    theatre: TheatreState;\n}\n\nclass _Theatre extends React.PureComponent<TheatreProps> {\n    // <ArenaSelector arenaNames={ this.props.theatre.arenas.allNames }/>\n    componentDidMount() {\n        require('../App.css');\n        require('../bootstrap.css');\n    }\n\n    render() {\n        return (\n            <div>\n                <Arena arena={ this.props.theatre.arenas.byName[this.props.theatre.active] }/>\n            </div>\n\n        )\n    }\n}\n\nexport const Theatre = connect(mapStateToProps)(_Theatre);\n\nfunction mapStateToProps(state: AppState) {\n    return { theatre: state.theatre }\n}\n\n\n// interface ArenaSelectorProps {\n//     arenaNames: string[];\n//     selectArenaMessage: (arena: string) => void; \n// }\n\n// class ArenaSelectorComponent extends React.PureComponent<ArenaSelectorProps> {\n//     render() {\n//         return (\n//             <select onChange={(ev) => this.props.selectArenaMessage(ev.currentTarget.value)}>\n//                 { this.props.arenaNames.map(n => (<option value={n} key={n}>{n}</option>))}\n//             </select>\n//         );\n//     }\n// }\n\n// const ArenaSelector = connect(undefined, { selectArenaMessage })(ArenaSelectorComponent);\n","import { BackendAPI } from \"../../../postMessage\";\nimport { ConsentServiceState, PurposeDeclaration, Consent, UsageRecord, PurposeDeclarationRef, findFrom, ServiceDeclarationRef, ServiceDeclaration } from \"../types\";\nimport React, { useContext } from \"react\";\nimport { loginMessage, giveConsentMessage, revokeConsentMessage, activatePurposeDeclarationMessage } from \"../ui\";\nimport { hash } from \"../../../util\";\nimport { fixRevoked } from \"../referenceAPI\";\n\nexport class ConsentServiceBackend extends BackendAPI<ConsentServiceState> {\n    login(ev:any, user?: string) {\n        console.log(\"login(\", user, \")\");\n        ev.preventDefault();\n        this.post(loginMessage({ user }));\n    }\n\n    giveConsentByPurpose(ev: any, services : ServiceDeclarationRef[], clientId: string, purposeDeclarationId: string) {\n        console.log(`giveConsent(${clientId}, ${purposeDeclarationId})`);\n        ev.preventDefault();\n        this.post(giveConsentMessage({\n            dataSubject: this.mem!.ui.user,\n            clientId: clientId,\n            purposeDeclarationId: purposeDeclarationId,\n            validFrom: (Date.now() / 1000) | 0,\n            validUntil: this.getValidUntil(services),\n            revoked: false,\n            // for technical reasons, we issue consentReference here. \n            // in real system it happens in (real) backend. \n            consentReference: hash(clientId + purposeDeclarationId + Date.now())\n        }))\n    }\n\n    revokeConsent(ev: any, consentReference: string) {\n        console.log(`revokeConsent(${consentReference})`);\n        ev.preventDefault();\n        this.post(revokeConsentMessage({ consentReference, revokeAt : Math.floor(Date.now()/1000) }))\n    }\n\n    // parameetrita/valid === undefined -> k]ik aktiivse kasutaja konsendid\n    // parameetriga -> ainult need, mis kas kehtivad v]i mitte\n    getConsents(valid?: boolean): Consent[] {\n        if (this.mem === undefined) {\n            return [];\n        }\n\n        let now = (Date.now() / 1000) | 0;\n        let user = this.mem.ui.user!;\n\n        return (this.mem.db.consents\n            .map(fixRevoked(now))\n            .filter(\n                c => (c.dataSubject === user \n                    && (valid === undefined \n                        || (valid === (c.validFrom <= now && c.validUntil >= now && !c.revoked)))) \n        ));\n    }\n\n    // need asjad kõlbavad consendi andmiseks FIXME seda vist pole enam vaja\n    getPDsWithoutValidConsent(): PurposeDeclaration[] {\n        if (this.mem === undefined) {\n            console.error(\"Not connected? No local state yet\");\n            return [];\n        }\n\n        let consents = this.getConsents(true);\n\n        return this.mem!.db.purposeDeclarations.filter(\n            pd => consents.find(c => (c.clientId === pd.clientId && c.purposeDeclarationId === pd.purposeDeclarationId)) === undefined\n        );\n    }\n\n    getUsageLogRecords(): UsageRecord[] {\n        if (this.mem === undefined) {\n            return [];\n        }\n\n        return this.mem.db.usageLog.filter(ur => ur.subjectId === this.mem!.ui.user);\n    }\n\n    activatePurposeDeclaration(ev: any, ref: PurposeDeclarationRef) {\n        ev.preventDefault();\n        if (this.mem === undefined) {\n            return;\n        }\n\n        this.post(activatePurposeDeclarationMessage(ref));\n    }\n\n    getActivePurposeDeclaration(): PurposeDeclaration | undefined {\n        if (this.mem === undefined || this.mem.ui.activePurposeDeclaration === undefined || this.mem.ui.activePurposeDeclaration[this.mem.ui.user!] === undefined) {\n            return undefined;\n        }\n\n        let candidate = findFrom(\n            this.mem.db.purposeDeclarations,\n            { ...this.mem.ui.activePurposeDeclaration[this.mem.ui.user!], callbackURL: undefined } as PurposeDeclarationRef\n        );\n\n        if (candidate === undefined || \n            findFrom(this.getConsents(true), { // if there is a valid consent for that candidate\n                clientId: candidate.clientId,\n                purposeDeclarationId: candidate.purposeDeclarationId\n            }) !== undefined) {\n\n            return undefined;\n        }\n        return {...candidate, validUntil: this.getValidUntil(this.mem.db.serviceDeclarations)};\n    }\n\n    getServiceDeclaration(ref: ServiceDeclarationRef): ServiceDeclaration | undefined {\n        if (this.mem === undefined) {\n            return undefined;\n        }\n\n        return findFrom(this.mem.db.serviceDeclarations, ref);\n    }\n\n    getPurposeDeclaration(ref: PurposeDeclarationRef): PurposeDeclaration | undefined {\n        if (this.mem === undefined) {\n            return undefined;\n        }\n\n        return findFrom(this.mem.db.purposeDeclarations, ref);\n    }\n\n    getValidUntil(services : ServiceDeclarationRef[]) {\n        const expiresIn = services.map( s => this.getServiceDeclaration(s)!.consentMaxDurationSeconds).sort()[0];\n        return Number(Math.floor(Date.now() / 1000)) + Number(expiresIn)\n    }\n}\n\nexport const CSBackend = React.createContext(undefined as (ConsentServiceBackend | undefined));\n\nexport class Backend {\n  use() {\n    const ctx = useContext(CSBackend);\n    return (ctx === undefined || ctx === null) ? ctx : new ConsentServiceBackend(ctx);\n  }\n}\n","import * as React from 'react';\n\n// <div className=\"footer-logo\">\n//   <img className=\"logo-brand\" alt=\"logo\" src={require('./../../static/assets/images/logo-est.png')} />\n// </div>\nconst Footer = () => {\n  return(\n    <footer>\n      <div className=\"footer-top\">\n\n        <div className=\"footer-contact\">\n          <div>\n            <div className=\"footer-contact-icon\">\n              <i className=\"icon-phone\"></i>\n            </div>\n          </div>\n          <div className=\"footer-contact-text\">\n            <table>\n              <tbody>\n                <tr>\n                  <th><a className=\"link-phone\" href=\"tel:+372-555-1\">555 1234</a></th>\n                  <th>Üldinfo</th>\n                </tr>\n                <tr>\n                  <td><a className=\"link-phone\" href=\"tel:+372-555-1234\">555 1234</a></td>\n                  <td>Teine osakond</td>\n                </tr>\n                <tr>\n                  <td><a className=\"link-phone\" href=\"tel:+372-555-1234\">555 1234</a></td>\n                  <td>Kolmas osakond</td>\n                </tr>\n              </tbody>\n            </table>\n            <a className=\"link-orange\" href=\"http://www.digilugu.ee/\" target=\"_blank\" rel=\"noopener noreferrer\">Kõik kontaktandmed</a>\n          </div>\n        </div>\n      </div>\n    </footer>\n  )\n}\n\nexport default Footer;","import * as React from 'react';\nimport { fullname } from '../../i18n';\n\nconst Header = ({backend}: any) => {\n  let backendUse = backend.use();\n  return(\n    <>\n    <nav className=\"navbar\">\n      <ul className=\"navbar-nav desktop-nav\">\n        <li className=\"nav-item with-logo\">\n          <img className=\"logo-brand\" alt=\"logo\" width=\"170\" src={require('./../../static/assets/images/logo-est.png')} />\n        </li>\n        {backendUse && backendUse.mem.ui.user &&\n          <li className=\"nav-item with-title\">\n            <p className=\"nav-item-title\">Kasutaja</p>\n            <p>{ fullname(backendUse.mem.ui.user) }</p>\n          </li>\n        }\n        {backendUse && backendUse.mem.ui.user &&\n          <li className=\"nav-item nav-logout\">\n            <button className=\"btn btn-logout\" onClick={(ev) => backendUse.login(ev)}>Väljun</button>\n          </li>\n        }\n      </ul>\n    </nav>\n    </>\n  )\n}\n\nexport default Header;","import React from 'react';\nimport Footer from './footer';\nimport Header from './header';\n\nconst VeeraLayout = ({children, backend}: any) => {\n  let backendUse = backend.use();\n  return (\n    <div className={\"wrapper \" + (backendUse && backendUse.mem && backendUse.mem.ui.user ? 'push' : '')}>\n      { backendUse && backendUse.mem && backendUse.mem.ui.user &&\n        <Header backend={backend} />\n      }\n      <div className=\"content-wrapper\">\n      <div className=\"workarea\">\n        {children}\n      </div>\n      </div>\n      <Footer />\n    </div>\n  );\n}\nexport default VeeraLayout;","import React from 'react';\nimport PropTypes from 'prop-types';\n\ninterface Props {\n  activeTab: string;\n  label: string;\n  onClick: (tab: string) => void;\n}\n\nexport class Tab extends React.Component<Props, {}> {\n  static propTypes = {\n    activeTab: PropTypes.string.isRequired,\n    label: PropTypes.string.isRequired,\n    onClick: PropTypes.func.isRequired,\n  };\n\n  onClick = () => {\n    const { label, onClick } = this.props;\n    onClick(label);\n  }\n\n  render() {\n    const {\n      onClick,\n      props: {\n        activeTab,\n        label,\n      },\n    } = this;\n\n    let className = 'sidebar-item';\n\n    if (activeTab === label) {\n      className += ' active';\n    }\n\n    return (\n      <li\n        className={className}\n        onClick={onClick}\n        style={{cursor: 'pointer'}}\n      >\n        {label}\n      </li>\n    );\n  }\n}\n\nexport default Tab;","import React from 'react';\nimport PropTypes from 'prop-types';\nimport Tab from './Tab';\n\ninterface Props {\n  children: React.ReactElement<any>[];\n}\n\ninterface State {\n  activeTab: string;\n}\n\ndeclare module 'react' {\n  interface HTMLAttributes<T> extends AriaAttributes, DOMAttributes<T> {\n    // extends React's HTMLAttributes\n    label?: string;\n  }\n}\n\nclass Tabs extends React.Component<Props, State> {\n  static propTypes = {\n    children: PropTypes.instanceOf(Array).isRequired,\n  }\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      activeTab: this.props.children[0].props.label,\n    };\n  }\n\n  onClickTabItem = (tab: string) => {\n    this.setState({ activeTab: tab });\n  }\n\n  render() {\n    const {\n      onClickTabItem,\n      props: {\n        children,\n      },\n      state: {\n        activeTab,\n      }\n    } = this;\n\n    return (\n      <div>\n        <div id=\"sidebar\">\n          <ol>\n            {children.filter(c => c.props.label !== undefined).map((child) => {\n              const { label } = child.props;\n\n              return (\n                <Tab\n                  activeTab={activeTab}\n                  key={label}\n                  label={label}\n                  onClick={onClickTabItem}\n                />\n              );\n            })}\n          </ol>\n        </div>\n        <div className=\"section\">\n          {children.map((child) => {\n            if (child.props.label !== activeTab) return undefined;\n            return child.props.children;\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default Tabs;","import { ConsentServiceBackend } from \"./backendAPI\";\nimport { Consent } from \"../types\";\nimport React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { formatTimestamp } from \"./CSEnduserUI\";\nimport { isConsentActive } from \"./MyConsents\";\nimport { business } from \"../../../i18n\";\nimport { renderText } from \"../../../util\";\n\nexport const ConsentModal: React.FC<{backend: ConsentServiceBackend, consent: Consent, buttonText : string}> = ({backend, consent, buttonText}) => {\n\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n\n    const handleRevoke = (ev:any) => {\n      setShow(false);\n      backend.revokeConsent(ev, consent.consentReference);\n    }\n\n    if (backend.mem === undefined) {\n        return null;\n      }\n      const dec = backend.mem.db.purposeDeclarations.find(p => p.purposeDeclarationId === consent.purposeDeclarationId);\n      if (dec === undefined) {\n        return null;\n      }\n\n      const rowView = (name: string, value: any, last?: boolean) => {\n        return (\n          <div className=\"row\" key={name}>\n            <div className=\"col-md\">\n              <div className= { last ? \"d-flex align-items-end\" : \"d-flex align-items-baseline\" }>\n                <div><h4> { name }</h4></div>\n                <div>{ value }</div>\n              </div>\n              </div>\n          </div>\n        )\n      }\n\n    const Body = () => {\n      let services = dec.services.map(sdref => {\n        const sd = backend.getServiceDeclaration(sdref);\n        if (sd === undefined) {\n          return <></>;\n        }\n        return (\n          <>\n            <h4>{sd.name}</h4>\n            { renderText(sd.description) }\n          </>\n        )\n      })\n      return (\n        <div className=\"tab-info\">\n          { rowView('Nõusoleku saaja:', `${business(dec.clientId, \"name\")} (${business(dec.clientId, \"ntr\")})`) }\n          { rowView('Teenus:', `${ dec.name }` ) }\n          { rowView('Nõusolek antud:', formatTimestamp(consent.validFrom)) }\n          { isConsentActive(consent)\n              ? rowView('Nõusolek kehtib kuni:', formatTimestamp(consent.validUntil))\n              : rowView('Nõusolek tühistatud:', formatTimestamp(consent.validUntil)) }\n          { rowView('Eesmärk:', renderText(dec.description), true) }\n          { rowView(`Nõusoleku alusel saab ${business(dec.clientId, \"name\")} Sinu kohta järgmised andmed:`, services, true)}\n        </div>\n      )\n    }\n\n    return (\n    <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header>\n          <Modal.Title>Detailid</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <Body />\n        </Modal.Body>\n        <Modal.Footer>\n          { isConsentActive(consent) &&\n          <Button variant=\"primary\" onClick={(ev:any) => handleRevoke(ev)}>\n            Võtan nõusoleku tagasi\n          </Button>\n          }\n          <Button variant=\"secondary\" onClick={handleClose}>\n            Sule\n          </Button>\n        </Modal.Footer>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        { buttonText }\n      </Button>\n    </>\n    )\n};","import { ConsentServiceBackend } from './backendAPI';\nimport React from 'react';\nimport { Consent } from '../types';\nimport { formatTimestamp } from './CSEnduserUI';\nimport { ConsentModal } from './ConsentModal';\nimport { business } from '../../../i18n';\n\nexport function isConsentActive(consent : Consent) {\n  return !consent.revoked && consent.validUntil > Date.now()/1000;\n}\n\nfunction consentDescription(backend: ConsentServiceBackend, c : Consent) {\n  const a = backend.getPurposeDeclaration( { clientId: c.clientId, purposeDeclarationId : c.purposeDeclarationId});\n  return (\n    `${business(c.clientId, \"name\")}; ${a!.name}; Nõusolek antud ${formatTimestamp(c.validFrom)}` +\n    ` – ${ c.revoked ? \"nõusolek tühistatud\" : \"kehtib kuni\" } ${formatTimestamp(c.validUntil)}`\n  );\n}\n\nexport const MyConsents = (backend :  ConsentServiceBackend) => {\n\n  const Table = (consents : Consent[], header : JSX.Element) => {\n    return (\n      <>\n        <h4>{ header }</h4>\n        <table className=\"table align-middle\">\n          <tbody>\n            { consents.map( c => (\n              <tr key={c.clientId}>\n                <td>{ consentDescription(backend, c) }</td>\n                <td><ConsentModal backend={backend} consent={c} buttonText=\"Vaata lähemalt\"/></td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </>\n    )\n  }\n\n  const Body = (backend : ConsentServiceBackend) => {\n\n    if (backend.getConsents().length === 0) {\n      return (\n        <p>Nõusolekuid ei leitud.</p>\n      )\n    }\n\n    const header = (title: string, length: number) => (\n      <h4>\n        <span>{title}</span>\n        {length === 0 &&\n          <span className=\"badge badge-default ml-2\">\n            <span className=\"badge-text\">Puuduvad</span>\n          </span>\n        }\n      </h4>\n    )\n\n    return (\n      <>\n        { Table( backend.getConsents(true),  header(\"Kehtivad nõusolekud:\", backend.getConsents(true).length)) }\n        { Table( backend.getConsents(false), header(\"Kehtetud nõusolekud:\", backend.getConsents(false).length)) }\n      </>\n    )\n  }\n\n  return (\n    <div label = \"Minu nõusolekud\"> { Body(backend) } </div>\n  )\n}\n","import { ConsentServiceBackend } from './backendAPI';\nimport { UsageRecord } from '../types';\nimport React from 'react';\nimport { formatTimestamp } from './CSEnduserUI';\nimport { ConsentModal } from './ConsentModal';\nimport { business } from '../../../i18n';\n\nfunction usageRecordDescription(u: UsageRecord, backend: ConsentServiceBackend) {\n  const c = backend.getConsents().find(c => c.consentReference === u.consentReference);\n  if (!c) {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' küsis, kuid ei saanud Sinu andmeid nõusoleku puudumise tõttu';\n  }  \n  const p = backend.getPurposeDeclaration( { clientId: u.clientId, purposeDeclarationId : c.purposeDeclarationId });\n  if (u.result === 'OK') {\n    return formatTimestamp(u.usageTime, true) + ' - ' + business(u.clientId, \"name\") + ' teenus ' + p!.name + ' sai Sinu andmed nõusoleku alusel';\n  } else {\n    return formatTimestamp(u.usageTime, true) + ' - ' + business(u.clientId, \"name\") + ' teenus ' + p!.name + ' küsis, kuid ei saanud Sinu andmeid tühistatud nõusoleku alusel';\n  } \n} \n\nexport const ConsentHistory = (backend : ConsentServiceBackend) => {\n\n  const Modal = (backend : ConsentServiceBackend, consentReference : string) => {\n    if (!backend.mem) {\n      return;\n    }\n    const con = backend.mem.db.consents.find(c => c.consentReference === consentReference);\n    if (!con) {\n      return;\n    }\n    return (<td><ConsentModal backend={backend} consent={con} buttonText=\"Vaata nõusolekut\"/></td>)\n  }\n\n  const Body = (backend : ConsentServiceBackend) => {\n    if (backend.getUsageLogRecords().length === 0) {\n      return (\n        <p>Nõusolekute kasutamise sündmusi ei leitud.</p>\n      )\n    }\n    return (\n      <>\n        <h4>Ajalugu:</h4>\n        <table className=\"table align-middle\">\n          <tbody>\n          {\n            backend.getUsageLogRecords().map(\n              u => (\n                <tr key={u.clientId}>\n                  <td>{ usageRecordDescription(u, backend) }</td>\n                  { u.consentReference ? Modal(backend, u.consentReference) : (<></>) }\n                </tr>\n              )\n            )\n          }\n          </tbody>\n        </table>\n      </>\n    )\n  } \n\n  return (\n    <div label=\"Nõusolekute kasutamise ajalugu\">\n      { Body(backend) }\n    </div>\n  );\n};\n","import React from 'react';\nimport { BackendStateUpdater } from '../../../postMessage';\nimport { ConsentServiceState, PurposeDeclaration } from '../types';\nimport { ConsentServiceBackend, Backend, CSBackend } from './backendAPI';\nimport VeeraLayout from './../../../components/veera/layout';\nimport Tabs from './../../../components/tabs/Tabs';\nimport { MyConsents } from './MyConsents';\nimport { ConsentHistory } from './ConsentHistory';\nimport { business } from '../../../i18n';\nimport { renderText } from '../../../util';\nimport { Modal, Button } from \"react-bootstrap\";\n\n\nfunction LoginScreen() {\n  return (\n    <div className=\"section\">\n      <h4>Nõusoleku andmiseks sisene Tervise- ja Heaolu Infosüsteemide Keskuse nõusolekute andmise keskkonda:</h4>\n      <p className=\"mt-3\"><a href=\"../ria/\" className=\"btn btn-primary\">Sisene</a></p>\n    </div>\n  );\n}\n\ninterface APDProps {\n  backend: ConsentServiceBackend;\n  activeDecl?: PurposeDeclaration;\n  tabRef: React.RefObject<Tabs>;\n  label: string;\n}\n\ninterface State {\n  signPopup: boolean;\n  returnPopup: boolean;\n  savedClientId?: string;  \n}\n\nclass ActivePurposeDeclaration extends React.PureComponent<APDProps, State> {\n  state : State = {\n    signPopup: false,\n    returnPopup: false,\n  };\n\n  constructor(props: APDProps) {\n    super(props);\n    this.showConsentTab = this.showConsentTab.bind(this);\n  }\n\n  showSignPopup(show: boolean) {\n    this.setState(s => ({ ...s, signPopup: show }));\n  }\n\n  showReturnPopup(show = true, clientId?: string) {\n    this.setState(s => ({ ...s, returnPopup: show, savedClientId: clientId }))\n  }\n\n  toggleSignPopup() {\n    this.setState(s => ({ ...s, signPopup: !s.signPopup }))\n  }\n\n  showConsentTab(ev: any) {\n    ev.preventDefault();\n    if (this.props.tabRef.current) this.props.tabRef.current.onClickTabItem(\"Minu nõusolekud\");\n  };\n\n  Popover() {\n    return (\n      <>\n        <Modal show={this.state.signPopup} onHide={() => this.toggleSignPopup()}>\n          <Modal.Body>\n            <h4>Nõusoleku andmiseks allkirjasta nõusolek digitaalselt</h4>\n          </Modal.Body>\n          <Modal.Footer>\n            <button className=\"btn btn-primary\" onClick={(ev) => {\n              this.props.backend.giveConsentByPurpose(\n                ev,\n                this.props.activeDecl!.services,\n                this.props.activeDecl!.clientId,\n                this.props.activeDecl!.purposeDeclarationId\n              );\n              this.toggleSignPopup();\n              this.showReturnPopup(true, this.props.activeDecl!.clientId);\n            }}>Allkirjasta</button>\n            <Button variant=\"secondary\" onClick={(ev:any) => this.toggleSignPopup()}>\n              Tagasi\n            </Button>\n          </Modal.Footer>\n        </Modal>\n        <Button variant=\"primary\" className=\"mr-2\" onClick={(ev:any) => this.toggleSignPopup()}>\n          Anna nõusolek\n        </Button>\n        <Button variant=\"secondary\" onClick={(ev:any) => window.close()}>\n          Ei anna nõusolekut\n        </Button>\n      </>\n    );\n  }\n\n  ReturnScreen() {\n    return (\n    <div>\n      <h4>Nõusolek { business(this.state.savedClientId!, \"name\") }-le on antud!</h4>\n      <p>Kõiki oma antud nõusolekuid näed ja saad hallata siit <a href=\"../../ui/csui\" onClick={this.showConsentTab}>Minu nõusolekud</a></p>\n      <button className=\"btn btn-primary\" onClick={() => {\n          window.close();\n          this.showReturnPopup(false);\n        }}>Tagasi teenusesse</button>\n    </div>\n    );\n  }\n\n  render() {\n\n    const activeDecl = this.props.activeDecl;\n\n    if (activeDecl === undefined) {\n      if (this.state.returnPopup) {\n        return this.ReturnScreen();\n      } else {\n        return (<div>Avatud taotlust pole.</div>);\n      }\n    }\n\n    return (\n        <div className=\"tab-info\">\n          <h4 className=\"mb-4 title\">{ business(activeDecl.clientId, \"name\") } ({ business(activeDecl.clientId, \"ntr\") }) küsib nõusolekute järgmistel tingimustel:</h4>\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-baseline\">\n                  <div><h4>Andmete kasutamise eesmärk:</h4></div>\n                  <div>\n                    { renderText(activeDecl.description) }\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-end\">\n                  <div><h4>Kehtivus:</h4></div>\n                  <div>{activeDecl.validUntil && `Kehtib kuni: ${ formatTimestamp(activeDecl.validUntil)}`}</div>\n                </div>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-end\">\n                  <div><h4>Nõusoleku alusel saab { business(activeDecl.clientId, \"name\") } Sinu kohta järgmised andmed:</h4></div>\n                  <div>\n                    {\n                      activeDecl.services.map(sdref => {\n                        const sd = this.props.backend.getServiceDeclaration(sdref);\n                        if (sd === undefined) {\n                          return <></>;\n                        }\n                        return (\n                          <>\n                            <h4>{sd.name}</h4>\n                            { renderText(sd.description) }\n                          </>\n                        )\n                      })\n                    }\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col-md mt-4 mb-2 text-muted\">\n                Antud nõusoleku saad igal ajal tühistada oma nõusolekute vaatest <a href=\"../../ui/csui\" onClick={this.showConsentTab}>Minu nõusolekud</a>\n              </div>\n            </div>\n            <p className=\"mt-4\">\n              { this.Popover() }\n            </p>\n          </div>\n    );\n  }\n};\n\nconst MainView = ({backend, tabRef}: any) => {\n\n  let backendUse = backend.use();\n\n  if (backendUse === null || backendUse === undefined) {\n    return (\n      <>\n      <div className=\"section\">Wait, or reinit the client UI from the arena window... '{window.name}'</div>\n      </>\n    );\n  }\n\n  if (backendUse.mem!.ui.user === undefined) {\n    return LoginScreen();\n  }\n\n  const activeDecl = backendUse.getActivePurposeDeclaration();\n\n  return (\n    <Tabs ref={tabRef}>\n      <div label=\"Avatud taotlused\">\n        <ActivePurposeDeclaration label=\"Avatud taotlused\" backend={backendUse} activeDecl={activeDecl} tabRef={tabRef}/>\n      </div>\n      { MyConsents(backendUse) }\n      { ConsentHistory(backendUse) }\n    </Tabs>\n  )\n}\n\n\n\nexport class CSEnduserUI extends React.PureComponent<{}, ConsentServiceBackend> {\n  backendLink: BackendStateUpdater<ConsentServiceState, ConsentServiceBackend>;\n  backend: Backend;\n  ref: React.RefObject<any>;\n\n  constructor(props: any, context?: any) {\n    super(props, context);\n    this.backendLink = new BackendStateUpdater(csb => { this.setState(csb as ConsentServiceBackend); }, ConsentServiceBackend);\n    this.backend = new Backend();\n    this.ref = React.createRef();\n  }\n\n  componentDidMount() {\n    if (process.env.NODE_ENV === \"development\") {\n      require('../../../static/css/mta_visuaal.css');\n    }\n    document.body.classList.add('temp');\n    this.backendLink.resetState();\n  }\n\n  render() {\n    return (\n      <CSBackend.Provider value={this.state}>\n        <VeeraLayout backend={this.backend}>\n          <MainView backend={this.backend} tabRef={this.ref} />\n        </VeeraLayout>\n      </CSBackend.Provider>\n    );\n  }\n}\n\nexport function formatTimestamp(timestamp : number, withTime? : boolean) {\n  if (withTime) {\n    return Intl.DateTimeFormat(\n      'et',\n      {\n        year : 'numeric',\n        month : 'numeric',\n        day : 'numeric',\n        hour : 'numeric',\n        minute : 'numeric',\n        second : 'numeric'\n      }\n    ).format(new Date(timestamp*1000));\n  }\n  return Intl.DateTimeFormat('et').format(new Date(timestamp*1000));\n}\n","import React from 'react';\nimport { BackendStateUpdater } from '../../../postMessage';\nimport { ConsentServiceState } from '../types';\nimport { ConsentServiceBackend, Backend, CSBackend } from './backendAPI';\n\n\nexport class Ria extends React.PureComponent<{}, ConsentServiceBackend> {\n  backendLink: BackendStateUpdater<ConsentServiceState, ConsentServiceBackend>;\n  backend: Backend;\n\n  constructor(props: any, context?: any) {\n    super(props, context);\n    this.backendLink = new BackendStateUpdater(csb => { this.setState(csb as ConsentServiceBackend); }, ConsentServiceBackend);\n    this.backend = new Backend();\n  }\n\n  componentDidMount() {\n    if (process.env.NODE_ENV === \"development\") {\n      require('../../../static/assets/tara/main.css');\n    }\n    this.backendLink.resetState();\n  }\n\n  render() {\n    return (\n      <CSBackend.Provider value={this.state}>\n        <MainView backend={this.backend} />\n      </CSBackend.Provider>\n    )\n  }\n\n}\n\nconst MainView = ({backend}: any) => {\n  let backendUse = backend.use();\n  if (!backendUse) return (<p>Backend failed, close and reopen window.</p>)\n  let click = (ev: React.MouseEvent<HTMLButtonElement>) => {\n    ev.preventDefault();\n    backendUse.login(ev, (ev.currentTarget.form!.elements[0] as any).value)\n    window.location.href = \"../csui/\";\n  }\n  return(\n    <div className=\"c-layout\">\n      <div className=\"c-layout--full\">\n        <div className=\"c-header-bar\">\n          <div className=\"container\">\n            <div className=\"d-flex justify-content-between align-items-center\">\n              <header role=\"banner\">\n                <h1 aria-label=\"Riigi autentimisteenus\" aria-hidden=\"true\"></h1>\n                <p aria-label=\"Turvaline autentimine asutuste e-teenustes\">Turvaline autentimine asutuste e-teenustes</p>\n              </header>\n            </div>\n          </div>\n        </div>\n        <div className=\"c-header\">\n          <div className=\"container\">\n            <div className=\"c-header__logo\">\n              <div className=\"c-header__logo-link\">\n              <img src={require('./../../../static/assets/tara/tara-logo-et.png')} aria-hidden=\"true\" alt=\"\" /></div>\n            </div>\n          </div>\n        </div>\n        <div className=\"container\">\n          <div className=\"c-tab-login\">\n            <main role=\"main\" className=\"c-tab-login__main\">\n              <div className=\"c-tab-login__content is-active\" data-tab=\"mobile-id\" aria-hidden=\"false\">\n                <div className=\"c-tab-login__content-wrap\">\n                  <div className=\"c-tab-login__content-icon\">\n                    <svg role=\"img\" aria-label=\"\" className=\"icon icon-mobile-id\"><use href=\"#icon-mobile-id\"></use></svg>\n                  </div>\n                <div className=\"c-tab-login__content-text\">\n                  <div role=\"heading\">\n                    <h2>Mobiil-ID</h2>\n                  </div>\n                  <p>Sisselogimiseks vajate kehtivat Mobiil-ID lepingut. Sisenemiseks Mobiil-ID-ga sisestage oma isikukood ja telefoninumber. Seejärel saadetakse Teie mobiiltelefonile kontrollsõnum.</p>\n                  <form>\n                    <table>\n                      <tbody>\n                        <tr>\n                          <td className=\"col-label\">\n                            <label htmlFor=\"mid-personal-code\" className=\"form-label\">Isikukood</label>\n                          </td>\n                          <td>\n                            <div className=\"input-group\">\n                              <div className=\"input-group-prepend\">\n                                <span className=\"input-group-text\">EE</span>\n                              </div>\n                              <input type=\"text\" id=\"mid-personal-code\" className=\"form-control\" name=\"principalCode\" defaultValue=\"47302200234\" />\n                            </div>\n                          </td>\n                          </tr>\n                          <tr>\n                            <td className=\"col-label\">\n                              <label htmlFor=\"mid-phone-number\" className=\"form-label\">Telefoninumber</label>\n                            </td>\n                            <td>\n                              <div className=\"input-group\">\n                                <div className=\"input-group-prepend\">\n                                  <span className=\"input-group-text\">+372</span>\n                                </div>\n                                <input type=\"tel\" id=\"mid-phone-number\" className=\"form-control\" name=\"mobileNumber\" defaultValue=\"53883333\" /></div>\n                              </td>\n                            </tr>\n                            <tr>\n                              <td></td>\n                              <td>\n                                <button className=\"c-btn c-btn--primary\" onClick={(ev) => click(ev)}>Jätkan</button>\n                              </td>\n                            </tr>\n                          </tbody>\n                        </table>\n                      </form>\n                    </div>\n                  </div>\n                  <div className=\"c-tab-login__footer\">\n                    <p><a href=\"https://tim.www.eesti.ee/tim/cancel-auth\">Tagasi teenusepakkuja juurde</a></p>\n                    <p>\n                      <a href=\"https://www.id.ee/?id=35803&amp;group_id=1\" target=\"_blank\" rel=\"noopener noreferrer\">Abi id.ee lehelt</a>\n                    </p>\n                  </div>\n                </div>\n              </main>\n            </div>\n          </div>\n          <p className=\"link-back-mobile\">\n            <a href=\"https://tim.www.eesti.ee/tim/cancel-auth\">Tagasi teenusepakkuja juurde</a>\n          </p>\n          <svg aria-hidden=\"true\" className=\"c-inline-svg__hidden\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\">\n            <defs>\n            <symbol id=\"icon-mobile-id\" viewBox=\"0 0 20 32\">\n            <title>mobile-id</title>\n            <path d=\"M7.218 28.027h5.476v1.12h-5.476zM15.876 31.68h-12.089c-0 0-0 0-0 0-1.8 0-3.261-1.454-3.271-3.252v-24.854c0.005-1.803 1.468-3.262 3.271-3.262 0 0 0 0 0 0h12.089c0 0 0 0 0 0 1.803 0 3.266 1.459 3.271 3.262v24.845c-0.005 1.803-1.468 3.262-3.271 3.262 0 0 0 0 0 0v0zM3.787 1.422c0 0 0 0-0 0-1.19 0-2.155 0.962-2.16 2.151v22.045h16.409v-22.044c0 0 0 0 0-0 0-1.188-0.963-2.151-2.151-2.151-0.003 0-0.006 0-0.009 0h0zM1.627 28.418c0.005 1.189 0.97 2.151 2.16 2.151 0 0 0 0 0 0h12.089c0 0 0 0 0 0 1.19 0 2.155-0.962 2.16-2.151v-1.689h-16.409zM12.382 8.951c-0.721-0.218-1.55-0.343-2.408-0.343-0.544 0-1.076 0.050-1.592 0.147l0.053-0.008c-0.018 0.004-0.039 0.006-0.060 0.006-0.154 0-0.282-0.108-0.313-0.252l-0-0.002c-0.009-0.089 0-0.169 0.053-0.231 0.047-0.068 0.119-0.117 0.202-0.133l0.002-0c0.494-0.094 1.063-0.147 1.644-0.147 0.922 0 1.813 0.135 2.653 0.386l-0.065-0.017c0.132 0.040 0.226 0.16 0.226 0.302 0 0.174-0.141 0.315-0.315 0.315-0.032 0-0.062-0.005-0.091-0.013l0.002 0.001zM14.187 11.396c-0 0-0.001 0-0.001 0-0.066 0-0.127-0.020-0.178-0.054l0.001 0.001c-1.129-0.791-2.531-1.263-4.043-1.263-1.375 0-2.659 0.391-3.747 1.067l0.030-0.017c-0.049 0.032-0.109 0.051-0.174 0.051-0.113 0-0.213-0.059-0.27-0.148l-0.001-0.001c-0.033-0.049-0.053-0.108-0.053-0.173 0-0.116 0.064-0.217 0.158-0.271l0.002-0.001c1.151-0.716 2.547-1.141 4.043-1.141 1.65 0 3.18 0.517 4.435 1.397l-0.025-0.016c0.142 0.089 0.178 0.293 0.089 0.436-0.059 0.081-0.153 0.133-0.26 0.133-0.002 0-0.005-0-0.007-0h0zM5.236 13.92c-0.176-0.001-0.318-0.144-0.318-0.32 0-0.070 0.023-0.135 0.061-0.188l-0.001 0.001c1.147-1.527 2.954-2.505 4.99-2.505 1.961 0 3.709 0.907 4.85 2.324l0.009 0.012c0.107 0.142 0.089 0.338-0.053 0.444-0.053 0.041-0.121 0.066-0.195 0.066-0.101 0-0.19-0.046-0.249-0.119l-0-0.001c-1.035-1.279-2.604-2.090-4.364-2.090-1.826 0-3.448 0.874-4.471 2.227l-0.010 0.014c-0.057 0.078-0.146 0.13-0.248 0.133l-0.001 0zM5.556 17.138c-0.003 0-0.006 0-0.009 0-0.172 0-0.311-0.139-0.311-0.311 0-0 0-0 0-0v0-0.018c0.161-2.486 2.216-4.441 4.728-4.441 2.137 0 3.943 1.415 4.534 3.358l0.009 0.034c0.004 0.018 0.006 0.039 0.006 0.061 0 0.177-0.143 0.32-0.32 0.32-0.128 0-0.238-0.075-0.289-0.183l-0.001-0.002v-0.018c-0.511-1.722-2.079-2.956-3.936-2.956-2.181 0-3.963 1.703-4.091 3.852l-0.001 0.011c-0.010 0.164-0.145 0.293-0.311 0.293-0.003 0-0.007-0-0.010-0h0zM7.004 19.387c-0.176-0-0.319-0.144-0.319-0.32 0-0.025 0.003-0.050 0.008-0.073l-0 0.002c0.082-0.236 0.129-0.507 0.129-0.79 0-0.116-0.008-0.231-0.023-0.343l0.001 0.013c-0.085-0.277-0.134-0.596-0.134-0.926 0-1.802 1.461-3.262 3.262-3.262 1.579 0 2.896 1.122 3.197 2.612l0.004 0.021c0.142 0.587 0.213 1.182 0.204 1.778 0 0.178-0.142 0.32-0.32 0.32-0.17-0.005-0.306-0.141-0.311-0.311v-0c0-0.551-0.062-1.102-0.178-1.636-0.291-1.16-1.325-2.005-2.556-2.005-1.453 0-2.631 1.178-2.631 2.631 0 0.222 0.028 0.439 0.080 0.645l-0.004-0.018c0.080 0.329 0.044 0.809-0.107 1.422-0.036 0.137-0.157 0.236-0.302 0.24h-0zM8.311 20.151l-0.089-0.009c-0.128-0.041-0.219-0.158-0.219-0.297 0-0.034 0.005-0.066 0.015-0.096l-0.001 0.002c0.169-0.456 0.266-0.982 0.266-1.531 0-0.244-0.019-0.483-0.056-0.717l0.003 0.026c-0.059-0.17-0.093-0.367-0.093-0.571 0-0.992 0.804-1.796 1.796-1.796 0.892 0 1.632 0.65 1.772 1.503l0.001 0.010c0.213 0.836 0.222 1.804 0.027 2.88-0.001 0.176-0.144 0.319-0.32 0.319s-0.32-0.143-0.32-0.32c0-0.038 0.007-0.074 0.018-0.107l-0.001 0.002c0.178-0.987 0.169-1.867-0.018-2.631-0.128-0.51-0.583-0.882-1.124-0.882-0.639 0-1.158 0.518-1.158 1.158 0 0.098 0.012 0.193 0.035 0.284l-0.002-0.008c0.16 0.64 0.089 1.502-0.222 2.56-0.043 0.13-0.163 0.222-0.305 0.222-0.002 0-0.005-0-0.007-0h0zM9.804 20.329c-0.172-0.005-0.31-0.147-0.31-0.32 0-0.025 0.003-0.050 0.008-0.073l-0 0.002c0.159-0.552 0.256-1.187 0.267-1.843l0-0.006c0-0.311-0.036-0.622-0.107-0.916-0.001-0.008-0.001-0.017-0.001-0.026 0-0.177 0.143-0.32 0.32-0.32 0.131 0 0.244 0.079 0.294 0.192l0.001 0.002c0.089 0.356 0.124 0.711 0.116 1.067-0.010 0.716-0.113 1.403-0.298 2.056l0.014-0.056c-0.036 0.137-0.157 0.236-0.302 0.24h-0z\"></path>\n          </symbol>\n          </defs>\n        </svg>\n      </div>\n    </div>\n  )\n}","import React, { Suspense } from 'react';\nimport './App.css';\nimport { BrowserRouter as Router, Switch, Route } from \"react-router-dom\";\nimport { Theatre } from './components/Theatre';\nimport { useTranslation } from 'react-i18next';\nimport { CSEnduserUI } from './process/consentService/altUI/CSEnduserUI';\nimport { Ria } from './process/consentService/altUI/ria';\n\nconst Page = () => {\n  const { i18n } = useTranslation();\n\n  const changeLanguage = (lng: string) => {\n    i18n.changeLanguage(lng);\n  };\n\n  return (\n    <div className=\"App\">\n        <Router basename=\".\">\n          <Switch>\n            <Route path=\"(.*)/ui/ria\">\n              <Ria/>\n            </Route>\n            <Route path=\"(.*)/ui/csui\">\n              <CSEnduserUI/>\n            </Route>\n            <Route path=\"/\">\n              <nav className=\"navbar navbar-light bg-light mb-4\">\n                <span className=\"navbar-brand\">\n                  <img alt=\"logo\" src={require('./static/assets/images/arena-logo.png')} width=\"30\" />\n                </span>\n                <div className=\"language d-none\">\n                  <a href=\"#!\"\n                    onClick={(e) => {e.preventDefault(); changeLanguage('et')}}\n                    className={ i18n.language === 'et' ? 'active': '' }>et</a>\n                  <a href=\"#!\"\n                    onClick={(e) => {e.preventDefault(); changeLanguage('en')}}\n                    className={ i18n.language === 'en' || i18n.language === 'en-US' ? 'active': '' }>en</a>\n                </div>\n              </nav>\n              <div className=\"container-fluid\">\n                <Theatre/>\n              </div>\n            </Route>\n          </Switch>\n        </Router>\n    </div>\n  );\n}\n\n// loading component for suspense fallback\nconst Loader = () => (\n  <div className=\"App\">\n    <div>loading...</div>\n  </div>\n);\n\nconst App: React.FC = () => {\n  return (\n    <Suspense fallback={<Loader />}>\n      <Page />\n    </Suspense>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import { createStore, combineReducers, applyMiddleware } from \"redux\";\nimport thunkMiddleware from \"redux-thunk\";\nimport { composeWithDevTools } from \"redux-devtools-extension\";\n\nimport { queueListener } from \"./components/Arena\";\nimport { reduceTheatre } from \"./components/Theatre\";\nimport { registerGlobalListener } from \"./postMessage\";\n\nconst rootReducer = combineReducers({\n\ttheatre: reduceTheatre,\n});\n\n\nexport type AppState = ReturnType<typeof rootReducer>;\n\nexport default function configureStore() {\n\t  const middlewares = [thunkMiddleware];\n\t  const middleWareEnhancer = applyMiddleware(...middlewares);\n\n\t  const store = createStore(\n\t\t      rootReducer,\n\t\t      composeWithDevTools(middleWareEnhancer)\n\t  );\n\n\tstore.subscribe(() => queueListener(store));\n\n\tregisterGlobalListener(store);\n\n\treturn store;\n}\n\n\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport { Provider } from \"react-redux\";\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\nimport configureStore from './store';\nimport './i18n';\n\nconst store = configureStore();\n\nReactDOM.render(<Provider store={store}><App /></Provider>, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","module.exports = __webpack_public_path__ + \"static/media/user-icon.bdeaa261.svg\";","module.exports = __webpack_public_path__ + \"static/media/login.9f370677.svg\";"],"sourceRoot":""}